<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Smart Photo Assistant - v41 Final RC</title>
<style>
/* STILE BASE AD ALTO CONTRASTO */
body{font-family:'Segoe UI',Roboto,Arial,sans-serif;margin:0;padding:0;background:#000;color:#fff;height:100vh;display:flex;flex-direction:column;overflow:hidden}
.sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)}
.hidden{display:none !important}

/* AREA CAMERA */
#cam-container{position:relative;flex-grow:1;background:#111;display:flex;justify-content:center;align-items:center;overflow:hidden}
video{width:100%;height:100%;object-fit:cover;opacity:.8; transition: transform 0.3s ease-out; transform-origin: center;}
canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}

/* STATUS E COUNTDOWN */
#countdown-overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:10rem;color:#fff;font-weight:bold;text-shadow:0 0 20px #000;z-index:70;display:none}

/* INTERFACCIA PRINCIPALE */
#main-interface{min-height:45vh;width:100%;background:#000;border-top:2px solid #333;display:flex;flex-direction:column}
#camera-controls{flex-grow:1;display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px;overflow-y:auto}

/* MODALITÀ FOTO TOGGLE */
#mode-switch{grid-column:1/-1;display:flex;gap:5px;margin-bottom:5px}
.mode-btn{flex:1;padding:12px 2px;border:2px solid #555;background:#222;color:#aaa;border-radius:10px;font-weight:bold;font-size:0.9rem;text-transform:uppercase}
.mode-btn.active{background:#004080;border-color:#4a90e2;color:#fff;box-shadow:0 0 10px rgba(74,144,226,0.3)}

/* AREA SELEZIONE OGGETTI */
#selection-panel{background:#111;border:1px solid #444;border-radius:10px;padding:15px;display:flex;flex-direction:column;gap:10px;grid-column:1/-1;height:100%}
#detected-list{display:grid;grid-template-columns:1fr 1fr;gap:10px;overflow-y:auto;flex-grow:1}
.obj-btn{padding:15px;border:2px solid #555;background:#222;color:#fff;border-radius:12px;font-size:1.1rem;min-height:60px;display:flex;align-items:center;justify-content:center;text-align:center}
.obj-btn.selected{background:#006400;border-color:#0f0;color:#0f0;font-weight:bold}

/* PULSANTI */
button{border:2px solid #555;border-radius:12px;font-size:1.1rem;font-weight:bold;text-transform:uppercase;color:#fff;background:#222;min-height:65px;touch-action:manipulation}
button:active{background:#555;transform:scale(.98)}
.full-width{grid-column:1/-1}
.btn-primary{background:#004080;border-color:#4a90e2}
.btn-action{background:#006400;border-color:#0f0;color:#0f0}
.btn-download{background:#4B0082;border-color:#9370DB;color:#fff}
.btn-guide{background:#8B0000;border-color:#f00;font-size:1.3rem}

/* MENU CONTESTO & RISULTATO */
#context-menu, #result-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;z-index:80;padding:20px;display:flex;flex-direction:column;gap:15px;overflow-y:auto}
#result-text{flex-grow:1;background:#111;border:1px solid #555;padding:15px;font-size:1.3rem;line-height:1.6;white-space:pre-wrap}

/* SETTINGS */
#key-screen {position:absolute;top:0;left:0;width:100%;height:100%;background:#111;z-index:200;display:flex;flex-direction:column;justify-content:center;align-items:center}
</style>
</head>
<body>

<div id="sr-announcer" class="sr-only" aria-live="assertive" role="status"></div>

<div id="cam-container">
  <video id="webcam" playsinline muted autoplay></video>
  <div id="countdown-overlay"></div>
</div>

<div id="main-interface">
  <div id="camera-controls">
    <div id="mode-switch" role="group" aria-label="Modalità Scatto">
        <button id="btn-mode-memory" class="mode-btn active" onclick="setPhotoMode('memory')">RICORDO</button>
        <button id="btn-mode-social" class="mode-btn" onclick="setPhotoMode('social')">SOCIAL</button>
        <button id="btn-mode-objects" class="mode-btn" onclick="setPhotoMode('objects')">OGGETTI</button>
    </div>

    <div id="selection-panel" class="hidden">
      <div style="font-size:1.2rem;color:#D4AF37;margin-bottom:10px;text-align:center">
          Tocca per includere/escludere:
      </div>
      <div id="detected-list" aria-live="polite"></div>
      <button onclick="confirmSelection()" class="full-width btn-action" style="margin-top:10px">CONFERMA E CHIUDI</button>
      <button onclick="clearSelection()" class="full-width" style="margin-top:5px;background:#8B0000">RESETTA SELEZIONE</button>
    </div>

    <div id="standard-controls" style="display:contents">
        <button class="full-width btn-guide" id="btn-guide" onclick="toggleSmartGuide()">
        AVVIA GUIDA
        </button>

        <button class="full-width" id="btn-select-objects" onclick="toggleSelectionMode()" style="background:#333;border-color:#777">
        SCEGLI SFONDO (OPZIONALE)
        </button>
        
        <div id="local-ai-status" class="full-width" style="text-align:center;padding:10px;background:#222;border:1px solid #444;border-radius:8px;color:#ccc;grid-column:1/-1" aria-live="polite">
        Caricamento AI...
        </div>

        <button onclick="startCountdown(3)" class="btn-action">SCATTA SUBITO</button>
        <button onclick="cycleZoom()" id="btn-zoom">ZOOM 1x</button>
        
        <button onclick="flipCamera()" id="btn-flip">RUOTA CAM</button>
        <button onclick="toggleVoiceControl()" id="btn-voice">VOCALE</button>
        <button onclick="openSettings()" style="font-size:0.9rem;background:#333;grid-column:1/-1">IMPOSTAZIONI</button>
    </div>
  </div>
</div>

<div id="context-menu" class="hidden" aria-hidden="true">
  <h2 style="text-align:center;color:#D4AF37">FOTO PRONTA</h2>
  <button class="btn-primary" onclick="analyzeContext('environment')">DESCRIVI SCENA</button>
  <button class="btn-primary" onclick="analyzeContext('selfie')">ANALISI SELFIE</button>
  <button class="btn-primary" onclick="analyzeContext('document')">LEGGI TESTO</button>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
    <button class="btn-share-now" onclick="shareImageNative()" style="background:#006400">CONDIVIDI</button>
    <button class="btn-download" onclick="downloadImage()">SCARICA</button>
  </div>
  <button onclick="discardPhoto()" style="background:#8B0000;margin-top:10px">ELIMINA</button>
</div>

<div id="result-screen" class="hidden" aria-hidden="true">
  <h2 style="color:#D4AF37;text-align:center;margin:0">Risultato</h2>
  <div id="result-text" tabindex="0">Attendi...</div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <button onclick="shareImageNative()" class="btn-action">CONDIVIDI</button>
      <button onclick="discardPhoto()" style="background:#8B0000">CHIUDI</button>
  </div>
</div>

<div id="key-screen" class="hidden">
  <h2>Impostazioni</h2>
  <input type="text" id="key-input" placeholder="Gemini API Key" style="width:80%;padding:15px;color:black;margin-bottom:10px">
  
  <button id="btn-tts-toggle" onclick="toggleTTS()" style="width:80%;padding:20px;background:#555;margin-bottom:10px">
      VOCE SINTETICA: OFF
  </button>

  <button onclick="saveKey()" style="padding:20px;width:80%;background:#006400">SALVA KEY</button>
  <button onclick="clearKey()" style="margin-top:10px;padding:20px;width:80%;background:#8B0000">CANCELLA KEY</button>
  <button onclick="closeSettings()" style="margin-top:10px;padding:20px;width:80%;background:#333">CHIUDI</button>
</div>

<script>
let GEMINI_KEY = localStorage.getItem('gemini_key') || "";
const MODEL_NAME = "gemini-1.5-flash"; 
const API_ENDPOINT = "v1beta";

// SYSTEM
let video = document.getElementById('webcam');
const AI_W = 640, AI_H = 480;
let aiCanvas = document.createElement('canvas'); aiCanvas.width = AI_W; aiCanvas.height = AI_H;
let aiCtx = aiCanvas.getContext('2d');

let stream = null;
let currentPhotoBase64 = null;
let currentFacingMode = 'user'; 
let currentPhotoMode = 'memory'; 
let zoomLevel = 1; 
let lastFocus = null; 

// SETTINGS & TTS
let useTTS = (localStorage.getItem('gemini_tts') === '1'); 
let ttsTimer = null; // Per debounce
let pendingTTS = "";

// AI
let objectDetector = null;
let faceLandmarker = null;
let audioCtx;

// STATE
let isGuiding = false;
let isSelectionMode = false;
let guideInterval = null;
let selectionInterval = null; 
let lastGuideTime = 0;
let prevDetectedSet = ""; 
let isCountdownRunning = false;
let countdownTimerIds = [];
let selectedTargets = []; 
let lastAnnouncedMsg = ""; 
let lastAnnounceTime = 0; 
let eyeWarningTime = 0; 
let edgeWarningTime = 0; 

// STABILIZZAZIONE
let stabilityStartTime = 0;
let lastCentroid = {x:0, y:0};
const STABLE_DURATION = 1500; 
const MOVE_THRESHOLD = 0.03; 

const SpeechRecognitionClass = window.SpeechRecognition || window.webkitSpeechRecognition || null;
const OBJECT_TRANSLATIONS = {
    'person': 'Persona', 'bicycle': 'Bici', 'car': 'Auto', 'cat': 'Gatto', 'dog': 'Cane', 
    'chair': 'Sedia', 'bottle': 'Bottiglia', 'laptop': 'PC', 'cell phone': 'Cellulare', 
    'book': 'Libro', 'cup': 'Tazza', 'potted plant': 'Pianta', 'vase': 'Vaso', 'wine glass': 'Bicchiere',
    'tv': 'TV', 'remote': 'Telecomando', 'keyboard': 'Tastiera', 'mouse': 'Mouse', 'backpack':'Zaino',
    'handbag': 'Borsa', 'tie': 'Cravatta', 'suitcase': 'Valigia', 'bowl': 'Ciotola', 'banana':'Banana', 'apple':'Mela'
};

const mirrorX = (x) => (currentFacingMode === 'user' ? 1 - x : x);

function resetStability(){
    stabilityStartTime = 0;
    lastCentroid = {x: 0, y: 0};
}

// NUOVO: Aggiorna Live Region in base al TTS
function updateVoiceMode(){
    const el = document.getElementById('sr-announcer');
    // Se TTS è attivo, ARIA è 'off' (TalkBack muto). Se TTS è spento, ARIA è 'assertive' (TalkBack parla).
    el.setAttribute('aria-live', useTTS ? 'off' : 'assertive');
    
    // Aggiorna UI Pulsante
    const btn = document.getElementById('btn-tts-toggle');
    if(btn){
        btn.innerText = "VOCE SINTETICA: " + (useTTS ? "ON" : "OFF");
        btn.style.background = useTTS ? "#006400" : "#555";
    }
}

async function init(){
  document.body.addEventListener('click', initAudioContext, {once: true});
  updateVoiceMode(); // Applica subito la logica di esclusione
  
  await setupCamera();
  await loadLocalModels();
  setupModalKeyboardHandlers();
  updateButtonLabels();
  announce("App pronta. Tieni il telefono dritto davanti a te.");
}

function initAudioContext(){ try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended')audioCtx.resume(); }catch(e){} }

function setPhotoMode(mode){
    currentPhotoMode = mode;
    resetStability(); 
    document.getElementById('btn-mode-memory').classList.toggle('active', mode==='memory');
    document.getElementById('btn-mode-social').classList.toggle('active', mode==='social');
    document.getElementById('btn-mode-objects').classList.toggle('active', mode==='objects');
    
    updateButtonLabels();
    if(mode === 'objects') {
        announce("Oggetti. Seleziona cosa cercare.");
        if(!isSelectionMode) toggleSelectionMode();
    } else {
        announce("Modalità " + (mode==='memory'?"Ricordo":"Social"));
    }
}

function cycleZoom(){
    if(zoomLevel === 1) zoomLevel = 2;
    else if(zoomLevel === 2) zoomLevel = 3;
    else zoomLevel = 1;
    resetStability();
    video.style.transform = `scale(${zoomLevel})`;
    document.getElementById('btn-zoom').innerText = "ZOOM " + zoomLevel + "x";
    announce("Zoom " + zoomLevel + " per");
}

function updateButtonLabels(){
    const btn = document.getElementById('btn-select-objects');
    if(currentPhotoMode === 'objects'){
        btn.textContent = "SCEGLI COSA CERCARE";
    } else {
        btn.textContent = "SCEGLI SFONDO (OPZIONALE)";
    }
}

async function setupCamera(){
  try{
    if(stream) stream.getTracks().forEach(t=>t.stop());

    const tryGet = (w,h) => navigator.mediaDevices.getUserMedia({
      video:{ facingMode: currentFacingMode, width:{ideal:w}, height:{ideal:h}, frameRate:{ideal:30, max:30} }
    });

    try{
      // 1080p: Compromesso ideale
      stream = await tryGet(1920, 1080);
    }catch(e){
      try{
         stream = await tryGet(1280, 720);
      }catch(e2){
         stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } });
      }
    }

    video.srcObject = stream;
    await new Promise(r=>video.onloadedmetadata=r);
    await video.play();
    resetStability();

    const track = stream.getVideoTracks()[0];
    let caps = {};
    try { caps = track.getCapabilities ? track.getCapabilities() : {}; } catch(e) { caps = {}; }

    if(caps.focusMode && caps.focusMode.includes('continuous')){
      try{ await track.applyConstraints({advanced:[{focusMode:'continuous'}]}); }catch(e){}
    }

  }catch(e){ announce("Errore camera."); }
}

async function flipCamera(){
  currentFacingMode = (currentFacingMode==='environment')?'user':'environment';
  let msg = (currentFacingMode==='user') ? "Camera Frontale Selfie" : "Camera Posteriore Ambiente";
  announce(msg); 
  await setupCamera();
}

async function loadLocalModels(){
  try{
    document.getElementById('local-ai-status').innerText = "Carico AI...";
    const { ObjectDetector, FaceLandmarker, FilesetResolver } = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js");
    const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
    
    objectDetector = await ObjectDetector.createFromOptions(vision, { 
      baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite" }, 
      scoreThreshold: 0.4, runningMode: "VIDEO" 
    });
    
    faceLandmarker = await FaceLandmarker.createFromOptions(vision, { 
      baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task" }, 
      runningMode: "VIDEO", numFaces: 1 
    });
    document.getElementById('local-ai-status').innerText = "AI Pronta.";
  }catch(e){ announce("Errore AI."); }
}

function toggleSmartGuide(){
  isGuiding = !isGuiding;
  const btn = document.getElementById('btn-guide');
  if(isGuiding){
    if(isSelectionMode) toggleSelectionMode(); 
    resetStability(); 
    btn.textContent = "STOP GUIDA"; btn.style.background = "#006400";
    announce("Guida attiva. Braccio teso.");
    if(guideInterval) clearInterval(guideInterval);
    guideInterval = setInterval(processLocalFrame, 350);
  }else{
    btn.textContent = "AVVIA GUIDA"; btn.style.background = "#8B0000";
    if(guideInterval) clearInterval(guideInterval);
    guideInterval = null;
    cancelCountdown();
    announce("Guida ferma.");
  }
}

function drawZoomedFrame(targetCanvas, targetCtx){
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    if(vw === 0 || vh === 0) return false;
    const cropW = vw / zoomLevel;
    const cropH = vh / zoomLevel;
    const cropX = (vw - cropW) / 2;
    const cropY = (vh - cropH) / 2;
    targetCtx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, targetCanvas.width, targetCanvas.height);
    return true;
}

async function processLocalFrame(){
  if(video.readyState !== 4 || isCountdownRunning) return;
  if(video.videoWidth === 0) return;
  
  const now = performance.now(); 
  if(now - lastGuideTime < 1500 && stabilityStartTime === 0) return; 

  drawZoomedFrame(aiCanvas, aiCtx);
  
  if(currentPhotoMode !== 'objects' && faceLandmarker){
      const res = faceLandmarker.detectForVideo(aiCanvas, now);
      if(res.faceLandmarks.length > 0){
          const face = res.faceLandmarks[0];
          
          if(selectedTargets.length > 0){
             const bgMsg = checkBackgroundPresence(aiCanvas, now);
             if(bgMsg){ announce(bgMsg); lastGuideTime=now; stabilityStartTime=0; return; }
          }

          if(stabilityStartTime === 0 && now - lastGuideTime > 2000) announce("Vedo viso...");

          const posMsg = analyzeFacePosition(face, now);
          if(posMsg){ announce(posMsg); lastGuideTime=now; stabilityStartTime=0; return; }
          
          const exprMsg = analyzeExpressionAdaptive(face, now);
          if(exprMsg){ announce(exprMsg); lastGuideTime=now; stabilityStartTime=0; return; }

          checkStabilityAndSnap({x: mirrorX(face[1].x), y: face[1].y}, now, "Viso dentro");
          return;
      }
  }

  if(currentPhotoMode === 'objects' && objectDetector){
      if(selectedTargets.length === 0){
          announce("Nessun oggetto scelto.");
          if(isGuiding) toggleSmartGuide(); 
          if(!isSelectionMode) toggleSelectionMode();
          return;
      }
      
      const res = objectDetector.detectForVideo(aiCanvas, now);
      const target = res.detections.find(d => selectedTargets.includes(d.categories[0].categoryName));
      
      if(target){
          const guideMsg = analyzeObjectPosition(target);
          if(guideMsg){ announce(guideMsg); lastGuideTime=now; stabilityStartTime=0; return; }
          else {
              const box = target.boundingBox;
              const cx = mirrorX((box.originX + box.width/2)/AI_W);
              const cy = (box.originY + box.height/2)/AI_H;
              checkStabilityAndSnap({x:cx, y:cy}, now, target.categories[0].categoryName + " ok");
          }
      } else {
          if(now-lastGuideTime>3000){ announce("Cerco " + selectedTargets.map(t=>OBJECT_TRANSLATIONS[t]||t).join(", ")); lastGuideTime=now; }
      }
      return;
  }
  
  if(currentPhotoMode !== 'objects' && now-lastGuideTime>4000){ 
      announce("Non vedo volti. Allontana il telefono."); 
      lastGuideTime=now; 
  }
}

function analyzeExpressionAdaptive(face, now){
    const leftFace = face[234]; const rightFace = face[454];
    const faceWidth = Math.abs(rightFace.x - leftFace.x);
    if(faceWidth < 0.02) return null;

    const upperLip = face[13];
    const lowerLip = face[14];
    const lipDist = Math.abs(upperLip.y - lowerLip.y);
    if(lipDist / faceWidth > 0.13) return "Chiudi la bocca.";

    const nose = face[1];
    const leftEye = face[33];
    const rightEye = face[263];
    const midEyeY = (leftEye.y + rightEye.y) / 2;
    const noseEyeDist = Math.abs(nose.y - midEyeY);
    const noseMouthDist = Math.abs(nose.y - upperLip.y);
    if(noseMouthDist < 0.01) return null;
    const ratio = noseEyeDist / noseMouthDist;
    if(ratio < 0.60) return "Troppo dal basso. Alza il telefono.";

    if(now - eyeWarningTime > 4000){ 
        const leftH = Math.abs(face[159].y - face[145].y) / faceWidth;
        const rightH = Math.abs(face[386].y - face[374].y) / faceWidth;
        const EYE_OPEN_THRESH = 0.025; 
        
        let eyeMsg = "";
        if(leftH < EYE_OPEN_THRESH && rightH < EYE_OPEN_THRESH) eyeMsg = "Attenzione, occhi chiusi.";
        else if(leftH < EYE_OPEN_THRESH) eyeMsg = "Occhio sinistro chiuso.";
        else if(rightH < EYE_OPEN_THRESH) eyeMsg = "Occhio destro chiuso.";
        
        if(eyeMsg !== ""){
            announce(eyeMsg);
            eyeWarningTime = now;
        }
    }
    return null; 
}

function checkBackgroundPresence(canvas, now){
    if(!objectDetector) return null;
    const res = objectDetector.detectForVideo(canvas, now);
    const found = res.detections.some(d => selectedTargets.includes(d.categories[0].categoryName));
    if(!found){
        const missing = selectedTargets.map(t=>OBJECT_TRANSLATIONS[t]||t).join(", ");
        return "Viso ok, ma manca: " + missing + ".";
    }
    return null;
}

function analyzeFacePosition(face, now){
    let minX=1, maxX=0, minY=1, maxY=0, cx=0, cy=0;
    face.forEach(p=>{if(p.x<minX)minX=p.x;if(p.x>maxX)maxX=p.x;if(p.y<minY)minY=p.y;if(p.y>maxY)maxY=p.y;cx+=p.x;cy+=p.y;});
    cx /= face.length; cy /= face.length;
    
    const m1 = mirrorX(minX);
    const m2 = mirrorX(maxX);
    minX = Math.min(m1, m2);
    maxX = Math.max(m1, m2);
    cx = mirrorX(cx);
    
    const width = maxX - minX;

    if(width > 0.60) return "Molto vicina! Allontana il telefono.";

    if(minY < 0.05) return "Stop! Tagli la fronte. Abbassa.";
    if(maxY > 0.95) return "Stop! Tagli il mento. Alza.";
    
    if(currentPhotoMode === 'social' && now - edgeWarningTime > 5000){
        if(minY < 0.15 || maxY > 0.85){
            announce("Sei al limite bordi, ma scatto.");
            edgeWarningTime = now;
        }
        else if(minX < 0.15 || maxX > 0.85){
             announce("Sei ai lati, ma scatto.");
             edgeWarningTime = now;
        }
    }

    let minW = (currentPhotoMode==='social') ? 0.20 : 0.35;
    let maxW = (currentPhotoMode==='social') ? 0.40 : 0.60;
    
    if(width < minW) return "Troppo lontano. Avvicina.";
    if(width > maxW) return "Troppo vicino per questa modalità. Allontana.";

    if(currentPhotoMode === 'memory'){
        if(cx < 0.35) return "Sposta a Sinistra.";
        if(cx > 0.65) return "Sposta a Destra.";
        if(cy < 0.35) return "Alza.";
        if(cy > 0.65) return "Abbassa.";
    } else {
        if(cx < 0.30) return "Sposta a Sinistra.";
        if(cx > 0.70) return "Sposta a Destra.";
        if(cy < 0.28) return "Abbassa un po'."; 
        if(cy > 0.72) return "Alza un po'."; 
    }
    
    return null;
}

function analyzeObjectPosition(d){
    const box = d.boundingBox;
    let cx = (box.originX + box.width/2)/AI_W;
    cx = mirrorX(cx); 

    const cy = (box.originY + box.height/2)/AI_H;
    const w = box.width/AI_W;
    
    if(w < 0.15) return "Troppo lontano. Avvicina.";
    if(w > 0.85) return "Troppo vicino. Allontana.";
    if(cx < 0.35) return "Sposta a Sinistra.";
    if(cx > 0.65) return "Sposta a Destra.";
    if(cy < 0.35) return "Alza.";
    if(cy > 0.65) return "Abbassa.";
    return null;
}

function checkStabilityAndSnap(currentCenter, now, msgSuccess){
    const dx = Math.abs(currentCenter.x - lastCentroid.x);
    const dy = Math.abs(currentCenter.y - lastCentroid.y);
    lastCentroid = currentCenter;

    if(dx > MOVE_THRESHOLD || dy > MOVE_THRESHOLD){ stabilityStartTime = 0; return; }

    if(stabilityStartTime === 0){
        stabilityStartTime = now;
        announce(msgSuccess + ". Fermo immobile...");
    } else {
        if(now - stabilityStartTime > STABLE_DURATION){
            announce("Perfetto. Scatto.");
            startCountdown(3); 
            stabilityStartTime = 0; 
        }
    }
}

// GESTIONE INTERFACCIA
function toggleSelectionMode(){
    isSelectionMode = !isSelectionMode;
    const panel = document.getElementById('selection-panel');
    const modes = document.getElementById('mode-switch');
    const ctrls = document.getElementById('standard-controls');

    resetStability();

    if(isSelectionMode){
        lastFocus = document.activeElement; 
        panel.classList.remove('hidden');
        modes.classList.add('hidden');
        ctrls.classList.add('hidden');
        
        document.getElementById('detected-list').innerHTML='<div style="grid-column:1/-1;text-align:center">Scansiono oggetti...</div>';
        prevDetectedSet = ""; 
        if(selectionInterval) clearInterval(selectionInterval);
        selectionInterval = setInterval(scanObjectsForList, 1000);
        announce("Tocca per includere.");
    } else {
        if(currentPhotoMode === 'objects' && selectedTargets.length === 0){
             isSelectionMode = true; 
             announce("Devi scegliere almeno un oggetto per continuare.");
             return;
        }

        panel.classList.add('hidden');
        modes.classList.remove('hidden');
        ctrls.classList.remove('hidden');
        
        if(selectionInterval) clearInterval(selectionInterval); selectionInterval=null;
        
        if(selectedTargets.length > 0){
             const names = selectedTargets.map(t=>OBJECT_TRANSLATIONS[t]||t).join(", ");
             announce("Hai scelto: " + names + ".");
        } else {
             announce("Nessun oggetto scelto.");
        }
        if(lastFocus) setTimeout(()=>lastFocus.focus(),100);
    }
}

function clearSelection(){
    selectedTargets = [];
    prevDetectedSet = "";
    scanObjectsForList();
    announce("Selezione azzerata.");
}

function scanObjectsForList(){
    if(!objectDetector) return;
    if(video.videoWidth === 0) return; 
    try{
        drawZoomedFrame(aiCanvas, aiCtx);
        const res = objectDetector.detectForVideo(aiCanvas, performance.now());
        const categories = Array.from(new Set(res.detections.map(d=>d.categories[0].categoryName))).sort();
        
        const sig = JSON.stringify(categories) + JSON.stringify(selectedTargets);
        if(sig === prevDetectedSet) return;
        prevDetectedSet = sig;

        const list = document.getElementById('detected-list'); list.innerHTML='';
        if(categories.length===0) list.innerHTML='<div style="grid-column:1/-1;text-align:center;color:#777">Nessun oggetto visibile...</div>';

        categories.forEach(obj=>{
            const b = document.createElement('button'); b.className='obj-btn';
            const name = OBJECT_TRANSLATIONS[obj]||obj;
            const isSel = selectedTargets.includes(obj);
            b.innerHTML = name + (isSel ? "<br><b>(SCELTO)</b>" : "");
            if(isSel) b.classList.add('selected');
            b.onclick=()=>{ 
                if(selectedTargets.includes(obj)) selectedTargets=selectedTargets.filter(t=>t!==obj); 
                else {
                    if(currentPhotoMode==='objects') selectedTargets = [obj];
                    else selectedTargets.push(obj); 
                }
                prevDetectedSet = ""; 
                scanObjectsForList();
                announce(selectedTargets.includes(obj)?`Selezionato ${name}`:`Rimosso ${name}`);
            };
            list.appendChild(b);
        });
    }catch(e){}
}
function confirmSelection(){ toggleSelectionMode(); }

function playShutterSound(){ if(audioCtx){ const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.setValueAtTime(800,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.1);o.start();o.stop(audioCtx.currentTime+0.1); } }

function startCountdown(sec){
  if(isCountdownRunning) return;
  countdownTimerIds.forEach(clearTimeout); countdownTimerIds=[];
  isCountdownRunning = true;
  const ov = document.getElementById('countdown-overlay'); ov.style.display='block';
  announce("Scatto tra " + sec); ov.innerText=sec;
  for(let i=1; i<=sec; i++){
    countdownTimerIds.push(setTimeout(()=>{
       let c=sec-i; 
       if(c>0){ ov.innerText=c; if(c<=3&&audioCtx){const o=audioCtx.createOscillator();o.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.05);} }
       else{ 
           // FIX COUNTDOWN STATE
           ov.style.display='none'; 
           isCountdownRunning = false; 
           capture(); 
       }
    }, i*1000));
  }
}

function cancelCountdown(){ isCountdownRunning=false; document.getElementById('countdown-overlay').style.display='none'; countdownTimerIds.forEach(clearTimeout); countdownTimerIds=[]; }

function capture(){
  if(video.videoWidth === 0 || video.videoHeight === 0){ announce("Camera non pronta."); return; }
  playShutterSound(); isCountdownRunning=false; countdownTimerIds=[];
  const c = document.createElement('canvas'); c.width=video.videoWidth; c.height=video.videoHeight;
  
  const ctx = c.getContext('2d');
  
  const cropW = video.videoWidth / zoomLevel;
  const cropH = video.videoHeight / zoomLevel;
  const cropX = (video.videoWidth - cropW) / 2;
  const cropY = (video.videoHeight - cropH) / 2;
  ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, c.width, c.height);

  currentPhotoBase64 = c.toDataURL('image/jpeg',0.9);
  
  document.getElementById('main-interface').classList.add('hidden');
  document.getElementById('context-menu').classList.remove('hidden');
  document.getElementById('context-menu').removeAttribute('aria-hidden');
  lastFocus = document.activeElement; 
  if(isGuiding) toggleSmartGuide();
  announce("Foto scattata.");
  setTimeout(()=>document.querySelector('#context-menu button').focus(),100);
}

async function analyzeContext(context){
  if(!GEMINI_KEY){ announce("Serve API Key."); return; }
  document.getElementById('context-menu').classList.add('hidden');
  const scr = document.getElementById('result-screen');
  scr.classList.remove('hidden'); scr.removeAttribute('aria-hidden');
  document.getElementById('result-text').textContent = "Analisi in corso...";
  announce("Analizzo immagine...");

  let p = "Descrivi immagine.";
  if(context==='selfie') p = "Consulente immagine per non vedenti. Descrivi dettagliatamente: espressione, trucco, abbigliamento, capelli e sfondo. Sii onesto su qualità e appropriatezza.";
  if(context==='document') p = "Estrai tutto il testo.";
  if(context==='environment') p = "Descrivi la scena.";
  
  try{
    const res = await fetch(`https://generativelanguage.googleapis.com/${API_ENDPOINT}/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({contents:[{parts:[{text:p},{inline_data:{mime_type:'image/jpeg',data:currentPhotoBase64.split(',')[1]}}]}]})
    });
    if(!res.ok) throw new Error("Errore API");
    const d = await res.json();
    const txt = d.candidates?.[0]?.content?.parts?.[0]?.text || "Nessun testo.";
    document.getElementById('result-text').textContent = txt.replace(/\*/g,'');
    announce("Fatto."); setTimeout(()=>document.getElementById('result-text').focus(),100);
  }catch(e){ 
    document.getElementById('result-text').textContent = "Errore connessione.";
    announce("Errore analisi."); 
  }
}

function discardPhoto(){
    document.getElementById('context-menu').classList.add('hidden');
    document.getElementById('result-screen').classList.add('hidden');
    document.getElementById('main-interface').classList.remove('hidden');
    announce("Tornato alla camera.");
    if(lastFocus) setTimeout(()=>lastFocus.focus(),100); 
}

function openSettings(){ 
    lastFocus = document.activeElement; 
    document.getElementById('key-screen').classList.remove('hidden'); 
    const inp = document.getElementById('key-input');
    inp.value = GEMINI_KEY;
    updateVoiceMode();
    setTimeout(()=>inp.focus(),50);
}
function closeSettings(){ 
    document.getElementById('key-screen').classList.add('hidden'); 
    if(lastFocus) setTimeout(()=>lastFocus.focus(),50);
}
function saveKey(){ GEMINI_KEY=document.getElementById('key-input').value.trim(); localStorage.setItem('gemini_key', GEMINI_KEY); closeSettings(); }
function clearKey(){ GEMINI_KEY=""; localStorage.removeItem('gemini_key'); document.getElementById('key-input').value=""; announce("Key cancellata."); }
function downloadImage(){ const a=document.createElement('a'); a.href=currentPhotoBase64; a.download='foto.jpg'; a.click(); }
async function shareImageNative(){ try{const b=await(await fetch(currentPhotoBase64)).blob(); await navigator.share({files:[new File([b],'f.jpg',{type:'image/jpeg'})]});}catch(e){} }

function toggleTTS(){
    useTTS = !useTTS;
    localStorage.setItem('gemini_tts', useTTS ? '1' : '0'); 
    updateVoiceMode();
    announce("Voce sintetica " + (useTTS ? "attivata" : "disattivata"));
}

// NUOVO: DEBOUNCE SPEAK
function speakDebounced(text){
  if(!('speechSynthesis' in window)) return;
  pendingTTS = text;
  clearTimeout(ttsTimer);
  ttsTimer = setTimeout(() => {
    window.speechSynthesis.cancel(); // Stop immediato al precedente
    const u = new SpeechSynthesisUtterance(pendingTTS);
    u.lang = 'it-IT';
    window.speechSynthesis.speak(u);
  }, 450); // 450ms di pausa per accumulare messaggi rapidi
}

function announce(m){ 
    const now = performance.now();
    if(m === lastAnnouncedMsg && now - lastAnnounceTime < 2500) return; 
    lastAnnouncedMsg = m;
    lastAnnounceTime = now;
    
    // 1. ARIA Live (Solo se TTS è OFF, altrimenti è 'off')
    const e=document.getElementById('sr-announcer');
    e.textContent='';
    setTimeout(()=>e.textContent=m,50); 
    
    // 2. TTS Esplicito (con Debounce)
    if(useTTS) speakDebounced(m);
}

let voiceActive=false; let recog;
function toggleVoiceControl(){
    if(!SpeechRecognitionClass)return; voiceActive=!voiceActive;
    if(voiceActive){
        if(!recog){ recog=new SpeechRecognitionClass(); recog.lang='it-IT'; recog.continuous=true; recog.onresult=e=>{const t=e.results[e.results.length-1][0].transcript.toLowerCase(); if(t.includes('scatta'))startCountdown(3); if(t.includes('guida'))toggleSmartGuide();}; }
        recog.start(); announce("Vocale attivo.");
    } else { recog.stop(); announce("Vocale spento."); }
}
function setupModalKeyboardHandlers(){
  const esc = (id,fn)=>document.getElementById(id).addEventListener('keydown',e=>{if(e.key==='Escape')fn()});
  esc('context-menu',discardPhoto); esc('result-screen',discardPhoto); esc('key-screen',closeSettings);
}

window.onload = init;
</script>
</body>
</html>