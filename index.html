<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Visione AI Fusion</title>
<style>
body{font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:0;padding:0;background:#000;color:#fff;height:100vh;display:flex;flex-direction:column;overflow:hidden}
.sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)}
#cam-container{position:relative;flex-grow:1;width:100%;background:#111;display:flex;justify-content:center;align-items:center}
video{width:100%;height:100%;object-fit:cover;opacity:.6}
canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
#main-interface{height:60vh;width:100%;background:#000;border-top:4px solid #333;position:relative}
#camera-controls{height:100%;width:100%;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:auto auto 1fr 1fr 1fr 1fr auto auto;gap:8px;padding:8px;box-sizing:border-box;overflow-y:auto}
.top-bar{grid-column:1/-1;display:flex;gap:10px}
#result-screen{height:100%;width:100%;display:flex;flex-direction:column;padding:15px;box-sizing:border-box;background:#111;position:absolute;top:0;left:0;z-index:50}
#result-content{flex-grow:1;overflow-y:auto;margin-bottom:15px;padding:15px;border:1px solid #555;border-radius:8px;background:#000;font-size:1.3rem;line-height:1.5;color:#fff;white-space:pre-wrap}
.result-actions{display:flex;gap:10px;flex-shrink:0;min-height:70px}
button{border:2px solid #555;border-radius:12px;font-size:1rem;font-weight:bold;text-transform:uppercase;color:#fff;background:#222;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;touch-action:manipulation}
button:active{background:#555;transform:scale(.98)}
.small-btn{flex:1;font-size:.9rem;background:#111;border:1px solid #444;color:#ccc}
#btn-scene{background:#D4AF37;color:#000;border-color:#fff;font-size:1.1rem}
#btn-selfie{background:#004080;border-color:#fff}
#btn-outdoor{background:#3B6C2A;border-color:#fff}
#btn-indoor{background:#6A1B9A;border-color:#fff}
.active-tool{background:#006400!important;border-color:#0f0!important}
.guiding{background:#8B0000!important;border-color:#f00!important}
.active-discrete{border-color:#f00;color:#f00}
.overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;z-index:100;display:flex;flex-direction:column;justify-content:center;align-items:center}
.hidden{display:none!important}
.loader{border:6px solid #333;border-top:6px solid #D4AF37;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin-bottom:20px}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
input{background:#333;color:#fff;border:1px solid #777}
#download-link{text-align:center;font-size:.9rem;color:#D4AF37;text-decoration:underline;margin-bottom:10px}
</style>
</head>
<body>
<div id="sr-announcer" class="sr-only" aria-live="assertive" role="status"></div>

<div id="cam-container">
  <video id="webcam" playsinline muted autoplay></video>
  <canvas id="overlay"></canvas>
</div>

<div id="main-interface">
  <div id="camera-controls" aria-hidden="false">
    <div class="top-bar">
      <button class="small-btn" id="btn-guide" onclick="toggleGuidance()" aria-label="Attiva o disattiva guida di centraggio oggetto">GUIDA CENTRAGGIO</button>
      <button class="small-btn" id="btn-shot" onclick="takeShot()" aria-label="Scatta una foto senza analizzarla">SCATTA</button>
    </div>
    <div class="top-bar">
      <button class="small-btn" id="btn-light" onclick="toggleLight()" aria-label="Sonda luce">SONDA LUCE</button>
      <button class="small-btn" id="btn-color" onclick="toggleColor()" aria-label="Sonda colore">SONDA COLORE</button>
      <button class="small-btn" id="btn-level" onclick="toggleLevel()" aria-label="Livella">LIVELLA</button>
      <button class="small-btn" id="btn-torch" onclick="toggleTorch()" aria-label="Torcia">TORCIA</button>
    </div>
    <button id="btn-scene"  onclick="describeWithMode('scene')"  aria-label="Scatta e analizza come scena generale">SCENA GENERALE</button>
    <button id="btn-selfie" onclick="describeWithMode('selfie')" aria-label="Scatta e analizza come selfie o volto">SELFIE / VOLTO</button>
    <button id="btn-outdoor"onclick="describeWithMode('outdoor')"aria-label="Scatta e analizza ambiente esterno">ESTERNO</button>
    <button id="btn-indoor" onclick="describeWithMode('indoor')" aria-label="Scatta e analizza ambiente interno">INTERNO</button>
    <button id="btn-object" onclick="describeWithMode('object')" aria-label="Scatta e analizza per oggetto">OGGETTO</button>
    <button id="btn-text"   onclick="describeWithMode('text')"   aria-label="Scatta e analizza testo o documento">TESTO / DOCUMENTO</button>
    <button id="btn-food"   onclick="describeWithMode('food')"   aria-label="Scatta e analizza cibo">CIBO</button>
    <button id="btn-safety" onclick="describeWithMode('safety')" aria-label="Scatta e analizza per sicurezza">SICUREZZA</button>
    <div class="top-bar" style="margin-top:5px">
      <button class="small-btn" id="btn-discrete" onclick="toggleDiscrete()" aria-label="Attiva o disattiva modo discreto">MODO DISCRETO</button>
      <button class="small-btn" onclick="openSettings()" aria-label="Impostazioni chiave API">IMPOSTAZIONI API</button>
    </div>
  </div>

  <div id="result-screen" class="hidden" aria-hidden="true" inert role="main">
    <h2 style="margin:0 0 10px;color:#D4AF37;font-size:1.1rem">Risultato Analisi</h2>
    <div id="result-content" tabindex="0" aria-label="Testo della descrizione">In attesa...</div>
    <a id="download-link" href="#" class="hidden">Scarica foto</a>
    <div class="result-actions">
      <button class="small-btn" onclick="usePhoto()" style="background:#004080;border-color:#6699FF" aria-label="Usa o condividi la foto">USA</button>
      <button class="small-btn" onclick="editAndReviewPhoto()" aria-label="Modifica la foto e rianalizza">MODIFICA</button>
      <button class="small-btn" onclick="deletePhoto()" style="background:#8B0000;border-color:#FF5555" aria-label="Elimina la foto e torna alla fotocamera">ELIMINA</button>
    </div>
  </div>
</div>

<div id="start-screen" class="overlay">
  <h1 style="color:#fff;margin-bottom:20px">Visione AI Fusion</h1>
  <div id="loader" class="loader hidden"></div>
  <div id="load-msg" class="hidden" style="color:#fff;font-size:1.2rem">Avvio sensori...</div>
  <button onclick="startApp()" style="padding:30px;font-size:1.5rem;background:#D4AF37;color:#000;border-radius:12px;width:90%;border:none;font-weight:bold">AVVIA SISTEMA</button>
</div>

<div id="key-screen" class="overlay hidden" aria-hidden="true" inert>
  <h2 style="color:#fff">Chiave Gemini API</h2>
  <input type="text" id="key-input" placeholder="Incolla chiave qui..." style="width:80%;padding:15px;font-size:1.2rem;margin-bottom:20px;border-radius:8px">
  <button onclick="saveKey()" style="padding:15px;background:#fff;color:#000;width:50%;font-weight:bold;border-radius:8px;margin-bottom:10px">SALVA</button>
  <button onclick="closeSettings()" style="padding:15px;background:#333;color:#fff;width:50%;border-radius:8px">CHIUDI</button>
</div>

<script>
let GEMINI_KEY=localStorage.getItem('gemini_key')||"",MODEL_NAME="gemini-1.5-flash",API_ENDPOINT="v1beta";
let audioCtx,lightOsc,lightGain,objectDetector=null,isRunning=false,videoTrack=null;
const tempCanvas=document.createElement('canvas');let tempCtx=null;
let mode='idle',lightActive=false,colorActive=false,levelActive=false,torchActive=false,discreteMode=false,lastSpeak=0,centeredCount=0,lastGuideMessage="",lastGuideMessageTime=0;
const video=document.getElementById('webcam'),canvas=document.getElementById('overlay'),ctx=canvas.getContext('2d');
let lastShotB64=null,lastShotUrl=null;

// Annunci
function announce(t){if(discreteMode)return;const e=document.getElementById('sr-announcer');e.textContent="";setTimeout(()=>e.textContent=t,50)}
function vibrate(p){if(navigator.vibrate)navigator.vibrate(p)}

// Cambio vista camera/risultato
function showResultOnly(text){
  const cam=document.getElementById('camera-controls');
  const res=document.getElementById('result-screen');
  cam.classList.add('hidden');
  cam.setAttribute('aria-hidden','true');
  cam.setAttribute('inert','');
  res.classList.remove('hidden');
  res.removeAttribute('aria-hidden');
  res.removeAttribute('inert');
  const c=document.getElementById('result-content');
  c.textContent=text||"";
  setTimeout(()=>c.focus(),200);
}
function showCameraOnly(){
  const cam=document.getElementById('camera-controls');
  const res=document.getElementById('result-screen');
  res.classList.add('hidden');
  res.setAttribute('aria-hidden','true');
  res.setAttribute('inert','');
  cam.classList.remove('hidden');
  cam.setAttribute('aria-hidden','false');
  cam.removeAttribute('inert');
}
function deletePhoto(){
  lastShotB64=null;
  if(lastShotUrl){URL.revokeObjectURL(lastShotUrl);lastShotUrl=null}
  document.getElementById('download-link').classList.add('hidden');
  document.getElementById('result-content').textContent="";
  showCameraOnly();
  announce("Foto eliminata, torno alla fotocamera.");
}

// Scatto
function captureFrame(){if(tempCtx)tempCtx.drawImage(video,0,0);return tempCanvas.toDataURL('image/jpeg',0.8).split(',')[1]}
function playShutter(){if(!discreteMode&&audioCtx){const o=audioCtx.createOscillator(),g=audioCtx.createGain();g.gain.value=0.1;o.frequency.value=600;o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.1)}}
async function captureNewShot(){if(mode==='guiding')toggleGuidance();announce("Scatto in corso.");playShutter();lastShotB64=captureFrame();document.getElementById('download-link').classList.add('hidden');return lastShotB64}
async function takeShot(){await captureNewShot();announce("Foto scattata. Puoi avviare un'analisi.");}

// PROMPTS COMPLETI + QUALITÀ SOCIAL
function buildPromptForContext(c){
  const qualityBlock = `
Infine, valuta la qualità tecnica dello scatto e se è adatto ai vari usi sui social (feed, storie, foto profilo).
Basati su nitidezza, centratura, luce, eventuali tagli del volto o dell’oggetto.
Se noti problemi, spiega brevemente il problema principale e suggerisci da 1 a 3 consigli pratici, semplici e concreti
per migliorare lo scatto successivo. Usa un linguaggio chiaro e diretto.`;
  switch(c){
    case 'scene':
      return "Descrivi l'immagine per una persona non vedente. Parti dal soggetto principale in primo piano, poi sfondo, persone, oggetti, colori dominanti, atmosfera (serena, caotica, ecc.), eventuale direzione delle linee (orizzontale/verticale) che danno profondità. Evita frasi troppo lunghe e concentra le informazioni utili e concrete."+qualityBlock;
    case 'selfie':
      return "Analisi selfie/volto. 1) Di' quanti volti ci sono e se quello principale è ben centrato o tagliato (sopra, sotto, lato). 2) Descrivi espressione e direzione dello sguardo. 3) Descrivi la luce sul viso (troppo scuro, controluce, uniforme ecc.). 4) Di' se ci sono elementi fastidiosi sullo sfondo che distraggono."+qualityBlock;
    case 'outdoor':
      return "Descrivi l'ambiente esterno. Indica se è strada, parco, piazza, marciapiede, giardino o altro. Descrivi meteo, presenza di auto, bici, persone, elementi naturali (alberi, prato, acqua). Indica se la scena sembra affollata o tranquilla."+qualityBlock;
    case 'indoor':
      return "Descrivi l'ambiente interno. Indica se sembra casa, ufficio, negozio, bar o altro. Descrivi i mobili principali e dove si trovano (davanti, a sinistra, a destra), eventuale disordine, porte o passaggi e se sembrano liberi o ingombri."+qualityBlock;
    case 'object':
      return "Descrivi l'oggetto principale della foto come se dovessi farlo riconoscere a una persona non vedente. Di' cos'è, la forma, il materiale, i colori, se ci sono scritte o etichette leggibili, lo stato (nuovo, usato, rovinato)."+qualityBlock;
    case 'text':
      return "LEGGI TUTTO IL TESTO VISIBILE esattamente come scritto, riga per riga, mantenendo l'ordine e andando a capo dove vedi un cambio riga. Non riassumere, non correggere, non tradurre. Dopo la lettura, spiega se la foto è adatta per leggere chiaramente (messa a fuoco, tagli, luce, inclinazione).";
    case 'food':
      return "Descrivi il piatto o il cibo come se lo stessi raccontando a una persona non vedente: tipo di piatto, ingredienti visibili, disposizione nel piatto, eventuali salse, condimenti e contorni, aspetto generale (curato, semplice, disordinato, molto elaborato)."+qualityBlock;
    case 'safety':
      return "Analisi sicurezza. Ignora l'estetica. Descrivi solo elementi utili a capire se posso camminare in sicurezza: ostacoli a terra, gradini, buche, dislivelli, marciapiedi, scale, oggetti sporgenti all'altezza della testa, porte chiuse o aperte, veicoli in movimento. Concludi con una frase chiara: posso camminare dritto in sicurezza, devo fare attenzione, oppure è meglio fermarmi.";
    default:
      return "Descrivi l'immagine per una persona non vedente, dando informazioni pratiche e dettagli utili sulla scena, sugli oggetti e sulle persone."+qualityBlock;
  }
}

// ANALISI GEMINI – schermo risultato subito, testo aggiornato dopo
async function describeWithMode(c){
  if(!GEMINI_KEY){announce("Manca la chiave API, apro le impostazioni.");openSettings();return}
  await captureNewShot();
  showResultOnly("Analisi in corso, attendi qualche secondo...");
  announce("Analisi in corso.");
  const p=buildPromptForContext(c);
  const t=await callGemini(p,lastShotB64);
  const content=document.getElementById('result-content');
  if(!t){
    content.textContent="Errore durante l'analisi. Controlla la chiave API o la connessione e riprova.";
    announce("Analisi non riuscita.");
    return;
  }
  content.textContent=t;
  announce("Analisi pronta. Puoi usare, modificare o eliminare la foto.");
}

async function callGemini(prompt,b64){
  try{
    const r=await fetch(
      "https://generativelanguage.googleapis.com/"+API_ENDPOINT+
      "/models/"+MODEL_NAME+":generateContent?key="+GEMINI_KEY,
      {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          contents:[{
            parts:[
              {text:prompt},
              {inline_data:{mime_type:"image/jpeg",data:b64}}
            ]
          }]
        })
      }
    );
    if(!r.ok){
      console.error("Errore HTTP Gemini",r.status,r.statusText);
      announce("Errore server AI "+r.status);
      return null;
    }
    const d=await r.json();
    const parts=d.candidates&&d.candidates[0]&&d.candidates[0].content&&d.candidates[0].content.parts||[];
    const out=(parts.map(p=>p.text||"").join("\n").trim())||"Nessun testo.";
    return out;
  }catch(e){
    console.error("Errore rete Gemini",e);
    announce("Errore di rete verso intelligenza artificiale.");
    return null;
  }
}

// GUIDA CENTRAGGIO
function toggleGuidance(){
  const b=document.getElementById('btn-guide');
  if(mode==='guiding'){
    mode='idle';
    b.classList.remove('guiding');
    b.innerText="GUIDA CENTRAGGIO";
    ctx.clearRect(0,0,canvas.width,canvas.height);
    announce("Guida spenta.");
  }else{
    mode='guiding';
    centeredCount=0;lastGuideMessage="";
    b.classList.add('guiding');
    b.innerText="GUIDA ATTIVA";
    announce("Guida attiva. Cerco oggetti.");
  }
}
function processGuidance(){
  if(!objectDetector)return;
  try{
    const r=objectDetector.detectForVideo(video,performance.now()),d=r?r.detections:[];
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(!d.length){
      if(Date.now()-lastSpeak>2500){announce("Nessun oggetto.");lastSpeak=Date.now()}
      return;
    }
    const t=d.sort((a,b)=>b.boundingBox.width*b.boundingBox.height-a.boundingBox.width*a.boundingBox.height)[0],b=t.boundingBox;
    ctx.strokeStyle="#0f0";ctx.lineWidth=5;ctx.strokeRect(b.originX,b.originY,b.width,b.height);
    const cx=b.originX+b.width/2,cy=b.originY+b.height/2,sx=canvas.width/2,sy=canvas.height/2,tolX=canvas.width*0.15,tolY=canvas.height*0.2;
    let m="",label=t.categories[0].categoryName;
    const map={person:"Persona",cup:"Tazza",bottle:"Bottiglia",chair:"Sedia",tv:"TV",laptop:"PC","cell phone":"Telefono"};
    if(map[label])label=map[label];
    if(cx<sx-tolX)m=label+": sposta a sinistra";
    else if(cx>sx+tolX)m=label+": sposta a destra";
    else if(cy<sy-tolY)m=label+": alza fotocamera";
    else if(cy>sy+tolY)m=label+": abbassa fotocamera";
    else{m=label+": centrato!";centeredCount++}
    const now=Date.now();
    if(m!==lastGuideMessage||now-lastGuideMessageTime>3000){
      announce(m);if(m.toLowerCase().includes("centrato"))vibrate(50);
      lastGuideMessage=m;lastGuideMessageTime=now;
    }
  }catch(e){console.warn(e)}
}

// SONDA LUCE
function toggleLight(){
  lightActive=!lightActive;const b=document.getElementById('btn-light');
  if(lightActive){
    if(audioCtx&&audioCtx.state==='suspended')audioCtx.resume();
    lightOsc=audioCtx.createOscillator();lightGain=audioCtx.createGain();
    lightOsc.connect(lightGain);lightGain.connect(audioCtx.destination);
    lightGain.gain.value=0.05;lightOsc.start();
    b.classList.add('active-tool');b.innerText="LUCE: ON";announce("Sonda luce attiva.");
  }else{
    if(lightOsc){lightOsc.stop();lightOsc.disconnect()}
    b.classList.remove('active-tool');b.innerText="SONDA LUCE";announce("Sonda luce spenta.");
  }
}
function processLight(){
  if(!tempCtx)return;
  const p=tempCtx.getImageData(canvas.width/2-10,canvas.height/2-10,20,20).data;let s=0;
  for(let i=0;i<p.length;i+=4)s+=(p[i]+p[i+1]+p[i+2])/3;
  const level=s/(p.length/4);if(lightOsc)lightOsc.frequency.setValueAtTime(100+level*4,audioCtx.currentTime);
}

// SONDA COLORE
function toggleColor(){
  colorActive=!colorActive;const b=document.getElementById('btn-color');
  if(colorActive){b.classList.add('active-tool');b.innerText="COLORE: ON";announce("Sonda colore attiva.");}
  else{b.classList.remove('active-tool');b.innerText="SONDA COLORE";announce("Sonda colore spenta.");}
}
function processColor(){
  if(!tempCtx)return;if(Date.now()-lastSpeak<2000)return;
  const p=tempCtx.getImageData(canvas.width/2,canvas.height/2,1,1).data,r=p[0],g=p[1],b=p[2];
  const colors={'0,0,0':'Nero','255,255,255':'Bianco','128,128,128':'Grigio','255,0,0':'Rosso','0,255,0':'Verde','0,0,255':'Blu','255,255,0':'Giallo','255,165,0':'Arancione'};
  let min=Infinity,res="Indefinito";
  for(let k in colors){
    const[cr,cg,cb]=k.split(',').map(Number),d=Math.sqrt((r-cr)**2+(g-cg)**2+(b-cb)**2);
    if(d<min){min=d;res=colors[k]}
  }
  announce(res);lastSpeak=Date.now();
}

// LIVELLA
function toggleLevel(){
  const b=document.getElementById('btn-level');
  if(levelActive){
    levelActive=false;b.classList.remove('active-tool');b.innerText="LIVELLA";
    announce("Livella spenta.");window.removeEventListener('deviceorientation',handleLevel);return;
  }
  if(typeof DeviceOrientationEvent==='undefined'){announce("Sensori non disponibili.");return}
  const enable=()=>{levelActive=true;b.classList.add('active-tool');b.innerText="LIVELLA: ON";announce("Livella attiva.");window.addEventListener('deviceorientation',handleLevel)};
  if(typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(r=>{if(r==='granted')enable();else announce("Permesso negato.");}).catch(()=>announce("Errore permesso sensori."));
  }else enable();
}
function handleLevel(e){
  if(!levelActive)return;if(Date.now()-lastSpeak<1500)return;
  const t=e.gamma||0;
  if(t>10){announce("Pende a destra.");vibrate(30);lastSpeak=Date.now();}
  else if(t<-10){announce("Pende a sinistra.");vibrate(30);lastSpeak=Date.now();}
}

// TORCIA
function toggleTorch(){
  const b=document.getElementById('btn-torch');
  if(!videoTrack){announce("Fotocamera non pronta.");return}
  const caps=videoTrack.getCapabilities&&videoTrack.getCapabilities();
  if(!caps||!caps.torch){announce("Torcia non supportata.");torchActive=false;b.classList.remove('active-tool');b.innerText="TORCIA";return}
  const target=!torchActive;
  videoTrack.applyConstraints({advanced:[{torch:target}]}).then(()=>{
    torchActive=target;
    if(torchActive){b.classList.add('active-tool');b.innerText="TORCIA: ON";announce("Torcia accesa.");}
    else{b.classList.remove('active-tool');b.innerText="TORCIA";announce("Torcia spenta.");}
  }).catch(e=>{
    console.warn(e);torchActive=false;b.classList.remove('active-tool');b.innerText="TORCIA";announce("Torcia non disponibile.");
  });
}

// DISCRETO
function toggleDiscrete(){
  discreteMode=!discreteMode;
  document.getElementById('btn-discrete').classList.toggle('active-discrete');
  vibrate(100);
  if(!discreteMode)announce("Modo discreto spento.");
}

// USA / MODIFICA / SOCIAL OVERLAY
async function usePhoto(){
  if(!lastShotB64){announce("Nessuna foto da usare.");return}
  try{
    const blob=await(await fetch("data:image/jpeg;base64,"+lastShotB64)).blob();
    const file=new File([blob],"foto.jpg",{type:"image/jpeg"});
    if(navigator.share){
      await navigator.share({files:[file],title:"Scatto Visione AI"});
      announce("Condivisione aperta.");
    }else{
      lastShotUrl=URL.createObjectURL(blob);
      const l=document.getElementById('download-link');l.href=lastShotUrl;l.download="scatto.jpg";l.classList.remove('hidden');
      announce("Link di download pronto.");
    }
  }catch(e){console.error(e);announce("Errore condivisione.");}
}

async function editAndReviewPhoto(){
  if(!lastShotB64){announce("Nessuna foto da modificare.");return}
  const text=prompt("Testo da scrivere sulla foto:");if(!text)return;
  announce("Modifico la foto...");
  const img=new Image();
  img.onload=async()=>{
    const c=document.createElement('canvas');c.width=img.width;c.height=img.height;
    const ct=c.getContext('2d');ct.drawImage(img,0,0);
    const fs=c.height*0.05;ct.font=fs+"px sans-serif";
    ct.fillStyle="rgba(0,0,0,0.6)";ct.fillRect(0,c.height-fs*3,c.width,fs*3);
    ct.fillStyle="#fff";ct.textAlign="center";ct.fillText(text,c.width/2,c.height-fs*1.5);
    lastShotB64=c.toDataURL("image/jpeg",0.9).split(',')[1];
    showResultOnly("Analisi in corso sulla foto modificata...");
    if(GEMINI_KEY){
      const overlayPrompt=
        "Questa foto ha del testo sovrapposto in stile grafica social. "+
        "1) Descrivi brevemente la scena. "+
        "2) Indica dove appare il testo (alto, centro, basso) e se si legge chiaramente. "+
        "3) Valuta se la composizione funziona come immagine per i social (ad esempio storia o post), "+
        "considerando leggibilità del testo, posizione del soggetto, equilibrio fra foto e scritta. "+
        "4) Se vedi problemi, suggerisci uno o due cambiamenti pratici (spostare il testo, cambiare posizione del soggetto, ecc.). "+
        "Il testo aggiunto è: \""+text+"\".";
      const nd=await callGemini(overlayPrompt,lastShotB64);
      document.getElementById('result-content').textContent=nd||"Foto modificata.";
      announce("Nuova analisi pronta.");
    }else{
      document.getElementById('result-content').textContent="Foto modificata con il testo: "+text+" (manca chiave AI per analisi social).";
      announce("Foto modificata, ma manca la chiave AI.");
    }
  };
  img.src="data:image/jpeg;base64,"+lastShotB64;
}

// CAMERA + MEDIAPIPE
async function initCamera(){
  try{
    let s;
    try{s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}}})}
    catch(e){s=await navigator.mediaDevices.getUserMedia({video:true})}
    return s;
  }catch(e){console.error(e);throw new Error("Impossibile avviare la fotocamera.");}
}
async function initObjectDetectorSafe(){
  try{
    const{ObjectDetector,FilesetResolver}=await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js");
    const vision=await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
    return await ObjectDetector.createFromOptions(vision,{
      baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite",delegate:"GPU"},
      scoreThreshold:0.1,maxResults:5,runningMode:"VIDEO"
    });
  }catch(e){console.warn(e);return null}
}
async function startApp(){
  const btn=document.querySelector('#start-screen button');
  btn.style.display='none';
  document.getElementById('loader').classList.remove('hidden');
  document.getElementById('load-msg').classList.remove('hidden');
  announce("Avvio sistema.");
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  let stream;
  try{stream=await initCamera()}catch(e){alert(e.message);announce("Errore fotocamera.");return}
  video.srcObject=stream;videoTrack=stream.getVideoTracks()[0];
  try{await video.play()}catch(e){console.warn(e)}
  objectDetector=await initObjectDetectorSafe();
  if(!objectDetector)announce("Rilevamento oggetti non disponibile.");
  function ready(){
    video.removeEventListener('loadeddata',ready);
    document.getElementById('start-screen').classList.add('hidden');
    showCameraOnly();
    canvas.width=video.videoWidth;canvas.height=video.videoHeight;
    tempCanvas.width=video.videoWidth;tempCanvas.height=video.videoHeight;
    tempCtx=tempCanvas.getContext('2d',{willReadFrequently:true});
    isRunning=true;announce("Sistema pronto.");
    if(!GEMINI_KEY)setTimeout(()=>announce("Manca la chiave AI. Puoi comunque scattare e usare le foto."),1000);
    loop();
  }
  if(video.readyState>=2)ready();else video.addEventListener('loadeddata',ready);
}
function loop(){
  if(!isRunning)return;
  const now=performance.now();
  if(lightActive||colorActive||mode==='guiding'){if(tempCtx)tempCtx.drawImage(video,0,0)}
  if(lightActive)processLight();
  if(colorActive)processColor();
  if(mode==='guiding'&&now-lastGuideMessageTime>200)processGuidance();
  requestAnimationFrame(loop);
}

// IMPOSTAZIONI CHIAVE
window.openSettings=()=>{
  const k=document.getElementById('key-screen');
  k.classList.remove('hidden');k.removeAttribute('aria-hidden');k.removeAttribute('inert');
  const i=document.getElementById('key-input');i.value=GEMINI_KEY||"";setTimeout(()=>i.focus(),200);
};
window.closeSettings=()=>{
  const k=document.getElementById('key-screen');
  k.classList.add('hidden');k.setAttribute('aria-hidden','true');k.setAttribute('inert','');
};
window.saveKey=()=>{
  GEMINI_KEY=document.getElementById('key-input').value.trim();
  localStorage.setItem('gemini_key',GEMINI_KEY);
  closeSettings();announce("Chiave salvata.");
};
</script>
</body>
</html>
