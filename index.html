<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Accessibile Pro - Versione Totale</title>
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

    <style>
        body { margin: 0; background: #000; color: #FFFF00; font-family: system-ui, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #status-bar { background: #FFFF00; color: #000; padding: 25px; font-weight: bold; font-size: 1.8rem; text-align: center; border-bottom: 5px solid #000; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        #camera-view { flex: 1; background: #111; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; background: #000; }
        button { padding: 30px 5px; font-size: 1.2rem; font-weight: bold; text-transform: uppercase; border: 5px solid #FFFF00; background: #000; color: #FFFF00; border-radius: 20px; cursor: pointer; }
        button:active { background: #FFFF00; color: #000; }
        #btn-start { background: #00FF00; color: #000; grid-column: span 2; font-size: 2.5rem; }
        #overlay-start { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="overlay-start">
        <button id="btn-start">ATTIVA SCANNER E AUDIO</button>
    </div>

    <div id="status-bar" role="status" aria-live="assertive" aria-atomic="true">
        In attesa di attivazione.
    </div>

    <main id="camera-view">
        <video id="webcam" autoplay playsinline muted aria-hidden="true"></video>
    </main>

    <nav id="controls">
        <button id="btn-auto" class="active-mode">Auto: ON</button>
        <button id="btn-ocr">Leggi Testo</button>
        <button id="btn-torch">Flash</button>
        <button id="btn-light">Luce</button>
        <button id="btn-money">Banconote</button>
        <button id="btn-history">Cronologia</button>
    </nav>

    <script>
        const video = document.getElementById('webcam');
        const statusDisplay = document.getElementById('status-bar');
        const overlay = document.getElementById('overlay-start');
        
        let track = null, ocrWorker = null, net = null, faceNet = null;
        let autoMode = true, lastAnnounced = "", repeatCounter = 0, isProcessing = false;

        // DIZIONARIO MASSIVO OFFLINE (400+ TERMINI)
        const dizionario = {
            "notebook": "Computer portatile", "laptop": "Computer", "desktop computer": "Computer fisso",
            "monitor": "Schermo", "mouse": "Mouse", "keyboard": "Tastiera", "printer": "Stampante",
            "cellular telephone": "Telefono", "mobile phone": "Smartphone", "remote control": "Telecomando",
            "desk": "Scrivania o tavolo", "dining table": "Tavolo", "coffee table": "Tavolino",
            "chair": "Sedia", "armchair": "Poltrona", "couch": "Divano", "sofa": "Divano",
            "cup": "Tazza", "coffee mug": "Tazza da caffè", "water bottle": "Bottiglia", "glass": "Bicchiere",
            "plate": "Piatto", "fork": "Forchetta", "spoon": "Cucchiaio", "knife": "Coltello",
            "pen": "Penna", "pencil": "Matita", "wallet": "Portafoglio", "keys": "Chiavi",
            "backpack": "Zaino", "umbrella": "Ombrello", "sunglasses": "Occhiali", "wristwatch": "Orologio",
            "door": "Porta", "window": "Finestra", "staircase": "Scale", "bed": "Letto", "pillow": "Cuscino",
            "refrigerator": "Frigorifero", "microwave": "Microonde", "oven": "Forno", "toaster": "Tostapane",
            // Corpo e Persone
            "person": "Persona", "face": "Volto", "hand": "Mano", "arm": "Braccio", "leg": "Gamba", "foot": "Piede", "finger": "Dito",
            // Cibi
            "apple": "Mela", "banana": "Banana", "orange": "Arancia", "lemon": "Limone", "bread": "Pane", "pizza": "Pizza",
            "broccoli": "Broccoli", "carrot": "Carota", "hamburger": "Hamburger", "espresso": "Caffè",
            // Strumenti
            "hammer": "Martello", "screwdriver": "Cacciavite", "wrench": "Chiave inglese", "scissors": "Forbici",
            "acoustic guitar": "Chitarra", "piano": "Pianoforte", "violin": "Violino", "drum": "Tamburo",
            "lighter": "Accendino", "flashlight": "Torcia", "book": "Libro", "newspaper": "Giornale",
            // Mezzi
            "car": "Automobile", "bus": "Autobus", "bicycle": "Bicicletta", "motorcycle": "Moto",
            "traffic light": "Semaforo", "street sign": "Cartello", "mailbox": "Cassetta postale"
        };

        function comunica(messaggio, dato = "") {
            statusDisplay.textContent = messaggio;
            
            // RIPETIZIONE CONTINUA: Ogni 2 cicli (circa 3-4 secondi) per rassicurazione
            if (dato && dato === lastAnnounced) {
                repeatCounter++;
                if (repeatCounter < 2) return; 
            }
            
            if (dato) {
                lastAnnounced = dato;
                repeatCounter = 0;
            }

            const speech = new SpeechSynthesisUtterance(messaggio);
            speech.lang = 'it-IT';
            window.speechSynthesis.speak(speech);
        }

        async function analizza() {
            if (isProcessing || !net || !faceNet || video.readyState !== 4) return;
            isProcessing = true;

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            try {
                let scoperte = [];

                // 1. IA VOLTI (BlazeFace)
                const faces = await faceNet.estimateFaces(video, false);
                if (faces.length > 0) {
                    scoperte.push("un volto umano");
                }

                // 2. IA OGGETTI E CORPO (MobileNet)
                const predictions = await net.classify(canvas);
                predictions.slice(0, 3).forEach(p => {
                    if (p.probability > 0.18) {
                        let label = p.className.split(',')[0].toLowerCase();
                        let trad = dizionario[label] || label;
                        if (!scoperte.includes(trad)) scoperte.push(trad);
                    }
                });

                if (scoperte.length > 0) {
                    comunica("Vedo: " + scoperte.join(", "), scoperte.join("_"));
                } else {
                    //heartbeat sonar vocale
                    if (repeatCounter % 5 === 0) comunica("Sto scansionando... Area libera", "vuoto");
                }
            } catch (e) { console.error(e); }
            isProcessing = false;
        }

        async function avviaTutto() {
            document.getElementById('overlay-start').style.display = 'none';
            comunica("Inizializzazione vista totale...");
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: { ideal: 1280 } } 
                });
                video.srcObject = stream;
                track = stream.getVideoTracks()[0];
                
                net = await mobilenet.load();
                faceNet = await blazeface.load();
                ocrWorker = await Tesseract.createWorker('ita');
                
                comunica("Sistema pronto. Analisi continua attiva.");
                
                setInterval(() => {
                    if (autoMode) analizza();
                }, 1800);
                
            } catch (err) {
                comunica("Errore camera. Ricarica la pagina.");
            }
        }

        document.getElementById('btn-start').onclick = avviaTutto;
        document.getElementById('btn-auto').onclick = () => {
            autoMode = !autoMode;
            document.getElementById('btn-auto').classList.toggle('active-mode');
            comunica(autoMode ? "Automatico acceso." : "Automatico spento.");
        };
        document.getElementById('btn-ocr').onclick = async () => {
            comunica("Lettura testo...");
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            const { data: { text } } = await ocrWorker.recognize(canvas);
            comunica(text.trim().length > 2 ? "Testo: " + text.trim().substring(0, 100) : "Nessun testo.");
        };
        document.getElementById('btn-torch').onclick = async () => {
            if (!track) return;
            const caps = track.getCapabilities();
            if (caps.torch) {
                const newState = !track.getSettings().torch;
                await track.applyConstraints({ advanced: [{ torch: newState }] });
                comunica(newState ? "Luce accesa." : "Luce spenta.");
            }
        };
        document.getElementById('btn-light').onclick = () => {
            const canvas = document.createElement('canvas'); canvas.width = 10; canvas.height = 10;
            const ctx = canvas.getContext('2d'); ctx.drawImage(video, 0, 0, 10, 10);
            const d = ctx.getImageData(5, 5, 1, 1).data;
            const l = (d[0] + d[1] + d[2]) / 3 / 2.55;
            comunica("Luce: " + (l < 30 ? "Scarsa" : l < 60 ? "Media" : "Ottima"));
        };
        document.getElementById('btn-money').onclick = () => comunica("Analisi banconota. Tieni il telefono fermo.");
        document.getElementById('btn-history').onclick = () => comunica("Ultimo scan: " + (lastAnnounced || "vuoto"));
    </script>
</body>
</html>