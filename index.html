<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Smart Photo Assistant - Il Tuo Occhio Fotografico</title>
<style>
/* STILE GENERALE */
body{font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:0;padding:0;background:#000;color:#fff;height:100vh;display:flex;flex-direction:column;overflow:hidden}
.sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)}

/* VIDEO */
#cam-container{position:relative;flex-grow:1;width:100%;background:#111;display:flex;justify-content:center;align-items:center}
video{width:100%;height:100%;object-fit:cover;opacity:.6}
canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}

/* STATUS VOCALE */
#voice-status{position:absolute;top:10px;right:10px;padding:5px 10px;border-radius:20px;background:rgba(0,0,0,0.7);border:1px solid #555;font-size:0.8rem;z-index:60;display:none}
.listening{border-color:#0f0!important;color:#0f0!important}

/* INTERFACCIA */
#main-interface{height:65vh;width:100%;background:#000;border-top:4px solid #333;position:relative;display:flex;flex-direction:column}
#camera-controls{flex-grow:1;width:100%;display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:min-content;gap:10px;padding:10px;box-sizing:border-box;overflow-y:auto}

/* UTILIT√Ä */
.full-width{grid-column:1/-1}
.top-bar{display:flex;gap:10px;width:100%}

/* RISULTATO */
#result-screen{height:100%;width:100%;display:flex;flex-direction:column;padding:15px;box-sizing:border-box;background:#111;position:absolute;top:0;left:0;z-index:50}
#result-content{flex-grow:1;overflow-y:auto;margin-bottom:15px;padding:15px;border:1px solid #555;border-radius:8px;background:#000;font-size:1.3rem;line-height:1.5;color:#fff;white-space:pre-wrap}
.result-actions{display:flex;flex-wrap:wrap;gap:10px;flex-shrink:0;min-height:70px}

/* BADGE QUALIT√Ä */
.quality-badge{display:inline-block;padding:5px 12px;border-radius:20px;font-weight:bold;font-size:0.9rem;margin:5px 5px 5px 0}
.badge-excellent{background:#006400;color:#0f0;border:2px solid #0f0}
.badge-good{background:#8B6914;color:#FFD700;border:2px solid #FFD700}
.badge-acceptable{background:#4B4B00;color:#FFFF00;border:2px solid #FFFF00}
.badge-poor{background:#8B0000;color:#ff5555;border:2px solid #ff5555}

/* GALLERIA FOTO */
#photo-gallery{display:none;flex-direction:column;gap:10px;max-height:400px;overflow-y:auto;margin-top:15px;padding:10px;border:2px solid #555;border-radius:8px;background:#1a1a1a}
.gallery-item{display:flex;align-items:center;gap:10px;padding:10px;background:#000;border:1px solid #444;border-radius:8px}
.gallery-item.selected{border-color:#0f0;background:#002200}
.gallery-thumbnail{width:60px;height:60px;object-fit:cover;border-radius:4px;border:2px solid #555}
.gallery-info{flex-grow:1}
.gallery-controls{display:flex;gap:5px}

/* PULSANTI */
button{border:2px solid #555;border-radius:12px;font-size:1rem;font-weight:bold;text-transform:uppercase;color:#fff;background:#222;cursor:pointer;min-height:60px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;touch-action:manipulation}
button:active{background:#555;transform:scale(.98)}
.small-btn{flex:1;font-size:.9rem;background:#111;border:1px solid #444;color:#ccc;min-width:80px}

/* COLORI E STATI */
#btn-voice{background:#00008B;border-color:#4169E1} 
#btn-guide{border:2px solid #fff;background:#002200;font-size:1.1rem}
#btn-find{background:#2F4F4F;border-color:#008080;color:#fff}
#btn-custom{background:#4B0082;border-color:#DA70D6}
.active-tool{background:#006400!important;border-color:#0f0!important}
.guiding{background:#8B0000!important;border-color:#f00!important}
.searching{background:#DAA520!important;border-color:#FFD700!important;color:#000!important}

/* STILE SOCIAL / RISULTATO */
.btn-primary-wide{flex:1 1 100%;font-size:1rem;background:#004080;border-color:#88b4ff}
.btn-analyze{flex:1 1 45%;font-size:.9rem;background:#333;border-color:#777}
.btn-danger{flex:1 1 45%;background:#8B0000;border-color:#ff5555}
.btn-social-check{flex:1 1 45%;background:#E1306C!important;border-color:#fff!important;color:#fff!important}
.btn-use-photo{flex:1 1 45%;background:#006400!important;border-color:#0f0!important;color:#0f0!important}
.btn-view-gallery{flex:1 1 45%;background:#4B0082!important;border-color:#DA70D6!important}

/* OVERLAY AVVIO */
.overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;z-index:100;display:flex;flex-direction:column;justify-content:center;align-items:center}
.hidden{display:none!important}
.loader{border:6px solid #333;border-top:6px solid #D4AF37;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin-bottom:20px}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
input{background:#333;color:#fff;border:1px solid #777}
#download-link{text-align:center;font-size:.9rem;color:#D4AF37;text-decoration:underline;margin-bottom:10px}

/* SELEZIONE OGGETTI */
#selected-objects-container{display:none;flex-direction:column;gap:8px;padding:10px;border:2px solid #0f0;border-radius:8px;background:#001100;margin-bottom:10px}
#selected-objects-list{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.selected-object-tag{padding:6px 12px;background:#004400;border:1px solid #0f0;border-radius:20px;font-size:0.9rem;color:#0f0;display:flex;align-items:center;gap:6px}
.remove-object-btn{background:transparent;border:none;color:#ff5555;font-size:1.2rem;cursor:pointer;padding:0;min-height:auto}

/* LISTA OGGETTI RILEVATI */
#detected-objects-list{display:flex;flex-direction:column;gap:6px;max-height:200px;overflow-y:auto}
.object-item-btn{min-height:50px;background:#222;border:1px solid #555;font-size:0.95rem;text-align:left;padding:10px;justify-content:flex-start}
.object-item-btn:active{background:#444}
</style>
</head>
<body>
<div id="sr-announcer" class="sr-only" aria-live="assertive" role="status"></div>

<div id="cam-container">
  <video id="webcam" playsinline muted autoplay></video>
  <canvas id="overlay"></canvas>
  <div id="voice-status">Ascolto in corso...</div>
</div>

<div id="main-interface" class="hidden" aria-hidden="true">
  <div id="camera-controls">
    
    <button class="full-width" id="btn-find" onclick="manualFind()" aria-label="Cerca un oggetto specifico ignorando gli altri.">CERCA OGGETTO</button>

    <div class="full-width" style="height:1px;background:#333;margin:5px 0"></div>

    <button class="full-width" id="btn-guide" onclick="startObjectSelection()" aria-label="Seleziona oggetti da fotografare e avvia guida intelligente.">SELEZIONA E FOTOGRAFA</button>
    
    <div id="selected-objects-container" class="full-width">
      <div style="font-weight:bold;margin-bottom:5px">Elementi selezionati:</div>
      <div id="selected-objects-list"></div>
      <button onclick="startLiveGuidance()" style="background:#006400;border-color:#0f0;color:#0f0;min-height:50px">AVVIA GUIDA FOTOGRAFICA</button>
    </div>

    <div id="detected-objects-list" class="full-width"></div>
    
    <div class="top-bar full-width">
       <button class="small-btn" id="btn-shot" onclick="startCountdown()" aria-label="Scatta foto manuale con conto alla rovescia di 5 secondi">SCATTA MANUALE</button>
       <button class="small-btn" onclick="flipCamera()" aria-label="Ruota fotocamera">RUOTA CAMERA</button>
    </div>

    <button id="btn-custom" class="full-width" onclick="askCustomDetail()" aria-label="Scatta e poni una domanda specifica sulla scena">CHIEDI DETTAGLIO</button>

    <button id="btn-describe" class="full-width" onclick="quickDescribeScene()" aria-label="Descrizione rapida di cosa vede la fotocamera">COSA VEDE LA CAMERA</button>

    <div class="full-width" style="height:1px;background:#333;margin:5px 0"></div>
    <div class="top-bar full-width">
      <button class="small-btn" id="btn-light" onclick="toggleLight()" aria-label="Sonda luce">LUCE</button>
      <button class="small-btn" id="btn-color" onclick="toggleColor()" aria-label="Colore">COLORE</button>
      <button class="small-btn" id="btn-level" onclick="toggleLevel()" aria-label="Livella">LIVELLA</button>
    </div>

    <div class="top-bar full-width" style="margin-top:10px">
      <button class="small-btn" id="btn-voice" onclick="toggleVoiceControl()" aria-label="Comandi vocali opzionali">COMANDI VOCALI</button>
      <button class="small-btn" id="btn-guide-mode" onclick="cycleGuideMode()" aria-label="Cambia livello di dettaglio">GUIDA: STANDARD</button>
      <button class="small-btn" onclick="openSettings()" aria-label="Impostazioni">IMPOSTAZIONI</button>
    </div>
  </div>

  <div id="result-screen" class="hidden" aria-hidden="true" inert role="main">
    <h2 style="margin:0 0 10px;color:#D4AF37;font-size:1.1rem">Foto Acquisita</h2>
    <div id="result-content" tabindex="0">In attesa...</div>
    <a id="download-link" href="#" class="hidden">Scarica foto</a>
    
    <div class="result-actions" id="action-buttons"></div>
    
    <div id="photo-gallery"></div>
  </div>
</div>

<div id="start-screen" class="overlay">
  <h1 style="color:#fff;margin-bottom:20px">Smart Photo Assistant</h1>
  <p style="color:#ccc;text-align:center;max-width:80%;margin-bottom:30px">Il tuo occhio fotografico personale per selfie perfetti e foto pubblicabili</p>
  <button id="btn-start" onclick="startApp()" style="padding:40px;font-size:1.8rem;background:#D4AF37;color:#000;border-radius:15px;width:95%;border:4px solid #fff;font-weight:bold">AVVIA SISTEMA</button>
</div>

<div id="key-screen" class="overlay hidden" aria-hidden="true" inert>
  <h2 style="color:#fff">Chiave Gemini API</h2>
  <input type="text" id="key-input" placeholder="Incolla chiave qui..." style="width:80%;padding:15px;font-size:1.2rem;margin-bottom:20px;border-radius:8px">
  <button onclick="saveKey()" style="padding:15px;background:#fff;color:#000;width:50%;font-weight:bold;border-radius:8px;margin-bottom:10px">SALVA</button>
  <button onclick="closeSettings()" style="padding:15px;background:#333;color:#fff;width:50%;border-radius:8px">CHIUDI</button>
  <p style="width:80%;margin-top:20px;font-size:0.9rem;color:#ddd;text-align:center">
    Le foto vengono analizzate da Gemini AI per valutarne qualit√† e pubblicabilit√†.
  </p>
</div>

<script>
let GEMINI_KEY = localStorage.getItem('gemini_key') || "";
const MODEL_NAME = "gemini-2.0-flash-exp"; 
const API_ENDPOINT = "v1beta";

// MODELLI VISIVI
let audioCtx, lightOsc, lightGain;
let objectDetector = null;
let poseLandmarker = null;
let faceLandmarker = null;

let modelsReady = { detector:false, pose:false, face:false };
let guideVerbosity = 'standard';

// SISTEMA SELEZIONE OGGETTI
let selectedObjects = []; // Array di oggetti selezionati per la foto
let detectedObjectsCache = []; // Cache degli oggetti rilevati
let isSelectingObjects = false;

// SISTEMA GUIDA LIVE INTELLIGENTE
let liveGuidanceActive = false;
let guidanceInterval = null;
let guidanceTimeout = null;
let guidanceStartTime = 0;
const GUIDANCE_DURATION = 30000; // 30 secondi
const GUIDANCE_CHECK_INTERVAL = 2500; // Controllo ogni 2.5 secondi

// CRITERI QUALIT√Ä FOTOGRAFICA
let photoQualityCriteria = {
  allObjectsVisible: false,
  wellLit: false,
  centered: false,
  notTooClose: false,
  notTooFar: false,
  straightAngle: false,
  goodMargins: false
};

// STATO FOTO
let currentPhotoAnalysis = null;
let currentPhotoType = null; // 'scene', 'text', 'selfie', 'environment', 'social'

// Stato camera
let stream = null;
let video = document.getElementById('webcam');
let canvas = document.getElementById('overlay');
let ctx = canvas.getContext('2d');
let tempCanvas = document.createElement('canvas');
let tempCtx = tempCanvas.getContext('2d');
let facing = 'user';
let isRunning = false;
let mode = 'idle';

// Sonde attive
let lightActive = false;
let colorActive = false;
let levelActive = false;

// Ultima foto
let lastShotB64 = null;
let savedPhotos = [];
let currentPhotoIndex = -1;

// Riconoscimento vocale
let recognition = null;
let voiceActive = false;

function announce(text){
  const sr = document.getElementById('sr-announcer');
  sr.textContent = text;
  setTimeout(()=>sr.textContent="",100);
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'it-IT';
    u.rate = 1.1;
    speechSynthesis.speak(u);
  }catch(e){}
}

async function setupCamera(facingMode){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
  }
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode},
      audio:false
    });
    video.srcObject = stream;
    await video.play();
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    tempCanvas.width = video.videoWidth;
    tempCanvas.height = video.videoHeight;
  }catch(e){
    announce("Errore accesso camera: "+e.message);
  }
}

function flipCamera(){
  facing = facing==='user'?'environment':'user';
  setupCamera(facing);
  announce("Camera "+(facing==='user'?'frontale':'posteriore'));
}

// ============================================
// SELEZIONE OGGETTI E GUIDA LIVE
// ============================================

async function startObjectSelection(){
  if(isSelectingObjects){
    // Stop selezione
    isSelectingObjects = false;
    selectedObjects = [];
    document.getElementById('selected-objects-container').style.display = 'none';
    document.getElementById('detected-objects-list').innerHTML = '';
    document.getElementById('btn-guide').textContent = 'SELEZIONA E FOTOGRAFA';
    announce("Selezione annullata");
    return;
  }
  
  isSelectingObjects = true;
  selectedObjects = [];
  document.getElementById('btn-guide').textContent = 'ANNULLA SELEZIONE';
  document.getElementById('selected-objects-container').style.display = 'none';
  
  announce("Analizzo cosa vede la camera. Attendi...");
  
  // Cattura frame e analizza
  const frame = captureFrame();
  if(!frame){
    announce("Errore cattura frame");
    isSelectingObjects = false;
    return;
  }
  
  try{
    const detectedObjects = await analyzeFrameForObjects(frame);
    
    if(detectedObjects.length === 0){
      announce("Nessun oggetto rilevato. Riprova o avvicina la camera.");
      isSelectingObjects = false;
      document.getElementById('btn-guide').textContent = 'SELEZIONA E FOTOGRAFA';
      return;
    }
    
    detectedObjectsCache = detectedObjects;
    displayDetectedObjects(detectedObjects);
    announce(`Rilevati ${detectedObjects.length} elementi. Tocca per selezionarli.`);
    
  }catch(e){
    announce("Errore analisi: " + e.message);
    isSelectingObjects = false;
    document.getElementById('btn-guide').textContent = 'SELEZIONA E FOTOGRAFA';
  }
}

async function analyzeFrameForObjects(base64Image){
  if(!GEMINI_KEY){
    announce("Inserisci la chiave Gemini nelle impostazioni");
    throw new Error("Chiave mancante");
  }
  
  const payload = {
    contents:[{
      parts:[
        {text: "Analizza questa immagine e elenca TUTTI gli oggetti, persone, animali e elementi visibili. Per ogni elemento fornisci: nome breve e descrittivo. Formato: ogni elemento su una riga, solo il nome. Esempi: 'Persona', 'Computer portatile', 'Finestra', 'Tavolo', 'Cellulare', 'Lampada', 'Pianta', 'Gatto'. Sii specifico ma conciso."},
        {inline_data:{mime_type:"image/jpeg",data:base64Image.split(',')[1]}}
      ]
    }]
  };
  
  const resp = await fetch(`https://generativelanguage.googleapis.com/${API_ENDPOINT}/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });
  
  if(!resp.ok){
    const err = await resp.text();
    throw new Error("Errore API: "+err);
  }
  
  const data = await resp.json();
  const text = data.candidates[0].content.parts[0].text;
  
  // Parse risultati
  const lines = text.split('\n').filter(l => l.trim().length > 0);
  const objects = lines.map(line => {
    // Rimuovi numerazione, trattini, asterischi
    return line.replace(/^\d+[\.\)]\s*/, '').replace(/^[-*]\s*/, '').trim();
  }).filter(obj => obj.length > 0 && obj.length < 50);
  
  return objects;
}

function displayDetectedObjects(objects){
  const container = document.getElementById('detected-objects-list');
  container.innerHTML = '';
  
  objects.forEach(obj => {
    const btn = document.createElement('button');
    btn.className = 'object-item-btn';
    btn.textContent = obj;
    btn.setAttribute('aria-label', `Seleziona ${obj}`);
    btn.onclick = () => addObjectToSelection(obj);
    container.appendChild(btn);
  });
}

function addObjectToSelection(objectName){
  if(selectedObjects.includes(objectName)){
    announce(`${objectName} gi√† selezionato`);
    return;
  }
  
  selectedObjects.push(objectName);
  updateSelectedObjectsDisplay();
  announce(`${objectName} aggiunto. Totale: ${selectedObjects.length} elementi`);
}

function removeObjectFromSelection(objectName){
  selectedObjects = selectedObjects.filter(o => o !== objectName);
  updateSelectedObjectsDisplay();
  announce(`${objectName} rimosso. Totale: ${selectedObjects.length} elementi`);
  
  if(selectedObjects.length === 0){
    document.getElementById('selected-objects-container').style.display = 'none';
  }
}

function updateSelectedObjectsDisplay(){
  const container = document.getElementById('selected-objects-container');
  const list = document.getElementById('selected-objects-list');
  
  if(selectedObjects.length === 0){
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'flex';
  list.innerHTML = '';
  
  selectedObjects.forEach(obj => {
    const tag = document.createElement('div');
    tag.className = 'selected-object-tag';
    tag.innerHTML = `
      <span>${obj}</span>
      <button class="remove-object-btn" onclick="removeObjectFromSelection('${obj}')" aria-label="Rimuovi ${obj}">‚úï</button>
    `;
    list.appendChild(tag);
  });
}

async function startLiveGuidance(){
  if(selectedObjects.length === 0){
    announce("Seleziona almeno un elemento prima di avviare la guida");
    return;
  }
  
  // Nascondi selezione e avvia guida
  isSelectingObjects = false;
  document.getElementById('detected-objects-list').innerHTML = '';
  document.getElementById('btn-guide').textContent = 'SELEZIONA E FOTOGRAFA';
  
  liveGuidanceActive = true;
  guidanceStartTime = Date.now();
  
  announce(`Guida attivata. Hai 30 secondi. Ti aiuto a fotografare: ${selectedObjects.join(', ')}`);
  
  // Prima verifica immediata
  await checkGuidanceQuality();
  
  // Verifica periodica ogni 2.5 secondi
  guidanceInterval = setInterval(async () => {
    if(liveGuidanceActive){
      await checkGuidanceQuality();
    }
  }, GUIDANCE_CHECK_INTERVAL);
  
  // Timeout 30 secondi - scatto automatico
  guidanceTimeout = setTimeout(async () => {
    if(liveGuidanceActive){
      announce("Tempo scaduto. Scatto!");
      await finalizeLiveGuidance();
    }
  }, GUIDANCE_DURATION);
}

async function checkGuidanceQuality(){
  const frame = captureFrame();
  if(!frame) return;
  
  try{
    const analysis = await analyzePhotoQuality(frame, selectedObjects);
    provideGuidanceFeedback(analysis);
  }catch(e){
    console.error("Errore verifica qualit√†:", e);
  }
}

async function analyzePhotoQuality(base64Image, targetObjects){
  if(!GEMINI_KEY) return null;
  
  const objectsList = targetObjects.join(', ');
  
  const prompt = `Analizza questa foto per guidare una persona cieca a scattare una buona foto.

ELEMENTI DA FOTOGRAFARE: ${objectsList}

Valuta questi criteri e rispondi in formato JSON:
{
  "allObjectsVisible": true/false,
  "missingObjects": ["lista oggetti mancanti"],
  "visibleObjects": ["lista oggetti visibili"],
  "lighting": "buona/scarsa/controluce",
  "framing": "centrato/spostato a sinistra/spostato a destra/troppo alto/troppo basso",
  "distance": "perfetta/troppo vicino/troppo lontano",
  "angle": "dritto/storto",
  "margins": "buoni/stretti/tagliati",
  "mainIssue": "descrizione problema principale se presente",
  "nextInstruction": "istruzione vocale chiara e concisa (es: 'Spostati a destra', 'Allontanati', 'Alza la fotocamera')"
}

Regole:
- Se mancano oggetti, priorit√† assoluta a trovarli
- Se tutti gli oggetti ci sono, ottimizza composizione
- Istruzioni brevi e chiare (max 5-6 parole)
- Se tutto √® perfetto: nextInstruction = "Perfetto cos√¨"`;

  const payload = {
    contents:[{
      parts:[
        {text: prompt},
        {inline_data:{mime_type:"image/jpeg",data:base64Image.split(',')[1]}}
      ]
    }]
  };
  
  const resp = await fetch(`https://generativelanguage.googleapis.com/${API_ENDPOINT}/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });
  
  if(!resp.ok) return null;
  
  const data = await resp.json();
  let text = data.candidates[0].content.parts[0].text;
  
  // Estrai JSON
  const jsonMatch = text.match(/\{[\s\S]*\}/);
  if(jsonMatch){
    return JSON.parse(jsonMatch[0]);
  }
  
  return null;
}

function provideGuidanceFeedback(analysis){
  if(!analysis) return;
  
  const elapsed = Date.now() - guidanceStartTime;
  const remaining = Math.ceil((GUIDANCE_DURATION - elapsed) / 1000);
  
  let feedback = analysis.nextInstruction;
  
  // Aggiungi contesto oggetti
  if(!analysis.allObjectsVisible && analysis.missingObjects.length > 0){
    const missing = analysis.missingObjects.join(', ');
    feedback = `Mancano: ${missing}. ${feedback}`;
  } else if(analysis.allObjectsVisible){
    feedback = `Tutti gli elementi presenti. ${feedback}`;
  }
  
  // Aggiungi tempo rimanente ogni tanto
  if(remaining <= 10 || remaining % 10 === 0){
    feedback += `. ${remaining} secondi rimasti`;
  }
  
  announce(feedback);
}

async function finalizeLiveGuidance(){
  liveGuidanceActive = false;
  
  if(guidanceInterval){
    clearInterval(guidanceInterval);
    guidanceInterval = null;
  }
  
  if(guidanceTimeout){
    clearTimeout(guidanceTimeout);
    guidanceTimeout = null;
  }
  
  // Scatta foto
  const photo = captureFrame();
  if(photo){
    lastShotB64 = photo;
    showPhotoAnalysisOptions();
  }
  
  // Reset selezione
  selectedObjects = [];
  updateSelectedObjectsDisplay();
}

// ============================================
// CATTURA FOTO E ANALISI POST-SCATTO
// ============================================

function captureFrame(){
  if(!video || video.readyState !== 4) return null;
  const c = document.createElement('canvas');
  c.width = video.videoWidth;
  c.height = video.videoHeight;
  const ctx = c.getContext('2d');
  ctx.drawImage(video,0,0);
  return c.toDataURL('image/jpeg',0.9);
}

function showPhotoAnalysisOptions(){
  const rs = document.getElementById('result-screen');
  const rc = document.getElementById('result-content');
  const ab = document.getElementById('action-buttons');
  
  rs.classList.remove('hidden');
  rs.removeAttribute('aria-hidden');
  rs.removeAttribute('inert');
  
  rc.textContent = "Foto acquisita. Scegli come analizzarla:";
  
  // Reset stato
  currentPhotoAnalysis = null;
  currentPhotoType = null;
  
  // Pulsanti analisi contenuto
  ab.innerHTML = `
    <button class="btn-analyze" onclick="analyzePhoto('scene')">üì∑ DESCRIZIONE SCENA</button>
    <button class="btn-analyze" onclick="analyzePhoto('text')">üìù RILEVA TESTO</button>
    <button class="btn-analyze" onclick="analyzePhoto('selfie')">üë§ ANALISI SELFIE</button>
    <button class="btn-analyze" onclick="analyzePhoto('environment')">üèûÔ∏è ANALISI AMBIENTE</button>
  `;
  
  announce("Foto acquisita. Scegli tipo di analisi: descrizione scena, rileva testo, analisi selfie, o analisi ambiente");
}

async function analyzePhoto(type){
  if(!lastShotB64){
    announce("Nessuna foto da analizzare");
    return;
  }
  
  if(!GEMINI_KEY){
    announce("Inserisci la chiave Gemini nelle impostazioni");
    return;
  }
  
  currentPhotoType = type;
  const rc = document.getElementById('result-content');
  rc.textContent = "Analisi in corso...";
  announce("Analisi in corso");
  
  let prompt = "";
  
  switch(type){
    case 'scene':
      prompt = `Descrivi questa scena in modo molto dettagliato come se parlassi a una persona cieca. Includi:
- Cosa c'√® nell'immagine (persone, oggetti, ambiente)
- Posizione e disposizione degli elementi
- Colori dominanti
- Illuminazione e atmosfera
- Qualsiasi dettaglio rilevante
Rispondi in italiano, in modo naturale e completo.`;
      break;
      
    case 'text':
      prompt = `Estrai e trascrivi TUTTO il testo presente in questa immagine. Includi:
- Testo principale (titoli, paragrafi)
- Testo piccolo (note, didascalie)
- Testo su oggetti (etichette, scritte)
- Numeri, date, orari
Mantieni la formattazione quando possibile. Se non c'√® testo, dillo chiaramente.`;
      break;
      
    case 'selfie':
      prompt = `Analizza questo selfie in modo dettagliato per una persona cieca:

TIPO DI SELFIE:
- √à un primo piano (solo volto) o corpo intero?

DETTAGLI VOLTO (se visibile):
- Espressione facciale
- Posizione dello sguardo
- Capelli (stile, colore)
- Trucco o accessori sul viso

DETTAGLI CORPO INTERO (se presente):
- Postura
- Abbigliamento (descrizione completa)
- Posizione delle braccia/mani
- Background visibile

QUALIT√Ä TECNICA:
- Inquadratura (centrato, tagliato, margini)
- Illuminazione del soggetto
- Nitidezza

Rispondi in italiano, in modo naturale e dettagliato.`;
      break;
      
    case 'environment':
      prompt = `Analizza l'ambiente e il contesto di questa foto per una persona cieca:
- Tipo di location (interno/esterno, pubblico/privato)
- Arredamento o elementi architettonici
- Atmosfera e mood
- Ora del giorno stimata dalla luce
- Condizioni meteo (se esterno)
- Oggetti e dettagli ambientali
- Persone presenti e loro attivit√†
Rispondi in italiano, in modo narrativo e immersivo.`;
      break;
  }
  
  try{
    const analysis = await callGeminiVision(prompt, lastShotB64);
    currentPhotoAnalysis = analysis;
    rc.textContent = analysis;
    
    // Mostra pulsanti post-analisi
    showPostAnalysisOptions();
    
    announce("Analisi completata");
    
  }catch(e){
    rc.textContent = "Errore: " + e.message;
    announce("Errore durante l'analisi");
  }
}

function showPostAnalysisOptions(){
  const ab = document.getElementById('action-buttons');
  
  ab.innerHTML = `
    <button class="btn-use-photo" onclick="usePhoto()">‚úÖ USA FOTO</button>
    <button class="btn-social-check" onclick="analyzeSocialMedia()">üì± ANALISI SOCIAL</button>
    <button class="btn-danger" onclick="deletePhoto()">üóëÔ∏è ELIMINA</button>
  `;
}

async function analyzeSocialMedia(){
  if(!lastShotB64 || !currentPhotoAnalysis){
    announce("Effettua prima un'analisi della foto");
    return;
  }
  
  const rc = document.getElementById('result-content');
  rc.textContent = "Analisi social in corso...";
  announce("Analisi pubblicabilit√† social in corso");
  
  const prompt = `Analizza questa foto per determinare la pubblicabilit√† sui social media.

CONTESTO FOTO:
${currentPhotoAnalysis.substring(0, 500)}

Valuta e rispondi in italiano:

üì∏ QUALIT√Ä TECNICA (0-10):
- Nitidezza
- Illuminazione
- Composizione
- Punteggio totale

üì± INSTAGRAM STORIES:
- Pubblicabile: S√å/NO
- Motivo
- Orientamento ideale (verticale/quadrato)
- Dove aggiungere testo/sticker

üì∑ POST INSTAGRAM:
- Pubblicabile: S√å/NO
- Motivo
- Orientamento migliore
- Suggerimenti caption

üë• FACEBOOK:
- Pubblicabile: S√å/NO
- Motivo
- Tipo di post consigliato

üéµ TIKTOK:
- Pubblicabile: S√å/NO
- Motivo
- Considerazioni per video/clip

‚úçÔ∏è SPAZIO PER TESTO:
- Dove si pu√≤ aggiungere testo senza coprire elementi importanti
- Zone libere per sticker/grafiche

üí° SUGGERIMENTI:
- Se non √® ottimale, cosa migliorare
- Alternative o modifiche consigliate

Rispondi in modo chiaro e pratico.`;

  try{
    const analysis = await callGeminiVision(prompt, lastShotB64);
    rc.textContent = analysis;
    
    // Mostra pulsanti finali
    const ab = document.getElementById('action-buttons');
    ab.innerHTML = `
      <button class="btn-use-photo" onclick="usePhoto()">‚úÖ USA FOTO</button>
      <button class="btn-danger" onclick="deletePhoto()">üóëÔ∏è ELIMINA</button>
    `;
    
    announce("Analisi social completata");
    
  }catch(e){
    rc.textContent = "Errore: " + e.message;
    announce("Errore durante l'analisi social");
  }
}

async function callGeminiVision(prompt, base64Image){
  const payload = {
    contents:[{
      parts:[
        {text: prompt},
        {inline_data:{mime_type:"image/jpeg",data:base64Image.split(',')[1]}}
      ]
    }]
  };
  
  const resp = await fetch(`https://generativelanguage.googleapis.com/${API_ENDPOINT}/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });
  
  if(!resp.ok){
    const err = await resp.text();
    throw new Error("Errore API: "+err);
  }
  
  const data = await resp.json();
  return data.candidates[0].content.parts[0].text;
}

// ============================================
// USA FOTO - SALVATAGGIO E CONDIVISIONE
// ============================================

async function usePhoto(){
  if(!lastShotB64){
    announce("Nessuna foto da usare");
    return;
  }
  
  // Converti base64 in blob
  const blob = await (await fetch(lastShotB64)).blob();
  const file = new File([blob], `photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
  
  // Controlla se il browser supporta Web Share API
  if(navigator.canShare && navigator.canShare({ files: [file] })){
    // Mostra opzioni
    showUsePhotoOptions(file);
  } else {
    // Fallback: solo download
    downloadPhoto();
  }
}

function showUsePhotoOptions(file){
  const ab = document.getElementById('action-buttons');
  
  ab.innerHTML = `
    <button class="btn-use-photo" onclick="downloadPhoto()">üíæ SALVA IN GALLERIA</button>
    <button class="btn-use-photo" onclick="sharePhoto()">üì§ CONDIVIDI</button>
    <button class="btn-danger" onclick="deletePhoto()">üóëÔ∏è ELIMINA</button>
  `;
  
  announce("Scegli come usare la foto: salva in galleria o condividi");
}

function downloadPhoto(){
  if(!lastShotB64){
    announce("Nessuna foto da scaricare");
    return;
  }
  
  const link = document.createElement('a');
  link.href = lastShotB64;
  link.download = `photo_${Date.now()}.jpg`;
  link.click();
  
  announce("Foto salvata nella galleria");
}

async function sharePhoto(){
  if(!lastShotB64){
    announce("Nessuna foto da condividere");
    return;
  }
  
  try{
    const blob = await (await fetch(lastShotB64)).blob();
    const file = new File([blob], `photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
    
    if(navigator.canShare && navigator.canShare({ files: [file] })){
      await navigator.share({
        files: [file],
        title: 'Foto Smart Photo Assistant',
        text: currentPhotoAnalysis ? currentPhotoAnalysis.substring(0, 200) : 'La mia foto'
      });
      announce("Foto condivisa");
    } else {
      announce("Condivisione non supportata su questo dispositivo. Usa salva in galleria.");
      downloadPhoto();
    }
  }catch(e){
    if(e.name !== 'AbortError'){
      announce("Errore condivisione: " + e.message);
    }
  }
}

function deletePhoto(){
  lastShotB64 = null;
  currentPhotoAnalysis = null;
  currentPhotoType = null;
  
  const rs = document.getElementById('result-screen');
  rs.classList.add('hidden');
  rs.setAttribute('aria-hidden','true');
  rs.setAttribute('inert','');
  
  announce("Foto eliminata. Torno alla home");
}

// ============================================
// FUNZIONI ORIGINALI (SEMPLICI)
// ============================================

function startCountdown(){
  let count = 5;
  announce(`Scatto in ${count} secondi`);
  const iv = setInterval(()=>{
    count--;
    if(count>0){
      announce(count.toString());
    }else{
      clearInterval(iv);
      const photo = captureFrame();
      if(photo){
        lastShotB64 = photo;
        showPhotoAnalysisOptions();
      }
    }
  },1000);
}

async function manualFind(){
  const q = prompt("Quale oggetto vuoi trovare?");
  if(!q) return;
  
  announce(`Cerco ${q}`);
  const frame = captureFrame();
  if(!frame) return;
  
  try{
    const prompt = `C'√® "${q}" in questa immagine? Rispondi S√å o NO e spiega brevemente dove si trova o perch√© non c'√®.`;
    const result = await callGeminiVision(prompt, frame);
    announce(result);
  }catch(e){
    announce("Errore ricerca: " + e.message);
  }
}

async function askCustomDetail(){
  const q = prompt("Cosa vuoi sapere sulla scena?");
  if(!q) return;
  
  announce("Scatto e analizzo");
  const photo = captureFrame();
  if(!photo) return;
  
  lastShotB64 = photo;
  
  try{
    const result = await callGeminiVision(q, photo);
    
    const rs = document.getElementById('result-screen');
    const rc = document.getElementById('result-content');
    const ab = document.getElementById('action-buttons');
    
    rs.classList.remove('hidden');
    rs.removeAttribute('aria-hidden');
    rs.removeAttribute('inert');
    
    rc.textContent = result;
    ab.innerHTML = `
      <button class="btn-primary-wide" onclick="deletePhoto()">CHIUDI</button>
    `;
    
    announce("Analisi completata");
  }catch(e){
    announce("Errore: " + e.message);
  }
}

async function quickDescribeScene(){
  announce("Analizzo cosa vede la camera");
  const frame = captureFrame();
  if(!frame) return;
  
  try{
    const prompt = "Descrivi brevemente cosa c'√® in questa immagine in 2-3 frasi.";
    const result = await callGeminiVision(prompt, frame);
    announce(result);
  }catch(e){
    announce("Errore: " + e.message);
  }
}

// ============================================
// SONDE (LUCE, COLORE, LIVELLA)
// ============================================

function toggleLight(){
  lightActive = !lightActive;
  document.getElementById('btn-light').classList.toggle('active-tool',lightActive);
  if(lightActive){
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    lightOsc = audioCtx.createOscillator();
    lightGain = audioCtx.createGain();
    lightOsc.connect(lightGain);
    lightGain.connect(audioCtx.destination);
    lightGain.gain.value = 0.1;
    lightOsc.start();
    announce("Sonda luce attiva. Pi√π acuto = pi√π luminoso");
  }else{
    if(lightOsc){
      lightOsc.stop();
      lightOsc = null;
    }
    announce("Sonda luce disattivata");
  }
}

function processLight(){
  if(!tempCtx || !lightOsc) return;
  const id = tempCtx.getImageData(0,0,tempCanvas.width,tempCanvas.height);
  const d = id.data;
  let sum = 0;
  for(let i=0;i<d.length;i+=4){
    sum += (d[i]+d[i+1]+d[i+2])/3;
  }
  const avg = sum/(d.length/4);
  const freq = 200 + (avg/255)*600;
  lightOsc.frequency.setValueAtTime(freq, audioCtx.currentTime);
}

function toggleColor(){
  colorActive = !colorActive;
  document.getElementById('btn-color').classList.toggle('active-tool',colorActive);
  announce(colorActive ? "Analisi colore attiva" : "Analisi colore disattivata");
}

function processColor(){
  if(!tempCtx) return;
  const id = tempCtx.getImageData(tempCanvas.width/2-50, tempCanvas.height/2-50, 100, 100);
  const d = id.data;
  let r=0,g=0,b=0;
  for(let i=0;i<d.length;i+=4){
    r+=d[i];g+=d[i+1];b+=d[i+2];
  }
  const n = d.length/4;
  r=Math.round(r/n);g=Math.round(g/n);b=Math.round(b/n);
  
  let color = "grigio";
  if(r>150&&g<100&&b<100) color="rosso";
  else if(g>150&&r<100&&b<100) color="verde";
  else if(b>150&&r<100&&g<100) color="blu";
  else if(r>150&&g>150&&b<100) color="giallo";
  else if(r>200&&g>200&&b>200) color="bianco";
  else if(r<50&&g<50&&b<50) color="nero";
  
  announce(`Colore dominante: ${color}`);
  colorActive = false;
  document.getElementById('btn-color').classList.remove('active-tool');
}

function toggleLevel(){
  levelActive = !levelActive;
  document.getElementById('btn-level').classList.toggle('active-tool',levelActive);
  if(levelActive){
    if(window.DeviceOrientationEvent){
      window.addEventListener('deviceorientation', handleOrientation);
      announce("Livella attiva. Ti guido per raddrizzare");
    }else{
      announce("Livella non disponibile su questo dispositivo");
      levelActive = false;
    }
  }else{
    window.removeEventListener('deviceorientation', handleOrientation);
    announce("Livella disattivata");
  }
}

let lastOrientationAnnounce = 0;
function handleOrientation(e){
  if(!levelActive) return;
  const now = Date.now();
  if(now - lastOrientationAnnounce < 2000) return;
  
  const tilt = Math.abs(e.gamma || 0);
  if(tilt < 5){
    announce("Perfetto, dritto");
    lastOrientationAnnounce = now;
  }else if(tilt < 15){
    announce(e.gamma > 0 ? "Leggermente inclinato a destra" : "Leggermente inclinato a sinistra");
    lastOrientationAnnounce = now;
  }else{
    announce(e.gamma > 0 ? "Molto inclinato a destra" : "Molto inclinato a sinistra");
    lastOrientationAnnounce = now;
  }
}

// ============================================
// CONTROLLI VOCALI
// ============================================

function toggleVoiceControl(){
  if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)){
    announce("Riconoscimento vocale non supportato");
    return;
  }
  
  voiceActive = !voiceActive;
  document.getElementById('btn-voice').classList.toggle('active-tool',voiceActive);
  
  if(voiceActive){
    if(!recognition){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = 'it-IT';
      recognition.continuous = true;
      recognition.interimResults = false;
      
      recognition.onresult = (e) => {
        const transcript = e.results[e.results.length-1][0].transcript.toLowerCase().trim();
        handleVoiceCommand(transcript);
      };
      
      recognition.onerror = () => {
        announce("Errore riconoscimento vocale");
      };
    }
    recognition.start();
    announce("Comandi vocali attivi. Di' 'scatta', 'ruota', 'luce', 'colore', 'livella'");
  }else{
    if(recognition) recognition.stop();
    announce("Comandi vocali disattivati");
  }
}

function handleVoiceCommand(cmd){
  if(cmd.includes('scatta')){
    startCountdown();
  }else if(cmd.includes('ruota') || cmd.includes('gira')){
    flipCamera();
  }else if(cmd.includes('luce')){
    toggleLight();
  }else if(cmd.includes('colore')){
    toggleColor();
  }else if(cmd.includes('livella')){
    toggleLevel();
  }else if(cmd.includes('guida')){
    startObjectSelection();
  }else{
    announce("Comando non riconosciuto");
  }
}

// ============================================
// MODALIT√Ä GUIDA
// ============================================

function cycleGuideMode(){
  const modes = ['minimo','standard','dettagliato'];
  const idx = modes.indexOf(guideVerbosity);
  guideVerbosity = modes[(idx+1)%modes.length];
  updateGuideModeLabel();
  announce(`Guida ${guideVerbosity}`);
}

function updateGuideModeLabel(){
  const btn = document.getElementById('btn-guide-mode');
  btn.textContent = `GUIDA: ${guideVerbosity.toUpperCase()}`;
}

// ============================================
// SETUP INIZIALE
// ============================================

async function startApp(){
  document.getElementById('main-interface').classList.remove('hidden');
  document.getElementById('main-interface').removeAttribute('aria-hidden');
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('start-screen').setAttribute('aria-hidden','true');
  document.getElementById('btn-shot').focus();
  updateGuideModeLabel();
  announce("Smart Photo Assistant avviato.");
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  await setupCamera('user');
  
  try{
    const {
      ObjectDetector,
      PoseLandmarker,
      FaceLandmarker,
      FilesetResolver
    } = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js");
    
    const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
    
    try{
      objectDetector = await ObjectDetector.createFromOptions(vision,{
        baseOptions:{
          modelAssetPath:"https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite",
          delegate:"GPU"
        },
        scoreThreshold:0.3,
        runningMode:"VIDEO"
      });
      modelsReady.detector = true;
    }catch(e){
      console.error("ObjectDetector error", e);
    }
    
    try{
      poseLandmarker = await PoseLandmarker.createFromOptions(vision,{
        baseOptions:{
          modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",
          delegate:"GPU"
        },
        runningMode:"VIDEO",
        numPoses:1
      });
      modelsReady.pose = true;
    }catch(e){
      console.error("PoseLandmarker error", e);
    }
    
    try{
      faceLandmarker = await FaceLandmarker.createFromOptions(vision,{
        baseOptions:{
          modelAssetPath:"https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
          delegate:"GPU"
        },
        runningMode:"VIDEO",
        numFaces:1
      });
      modelsReady.face = true;
    }catch(e){
      console.error("FaceLandmarker error", e);
    }
    
    if(modelsReady.face && modelsReady.pose){
      announce("Riconoscimento volto e corpo attivo. Pronto per selfie intelligenti.");
    }else if(modelsReady.detector){
      announce("Riconoscimento oggetti attivo.");
    }
    
  }catch(e){
    console.error("Errore import MediaPipe", e);
    announce("Modelli di riconoscimento limitati. Funzioni base disponibili.");
  }
  
  isRunning = true;
  loop();
}

function loop(){
  if(!isRunning){
    requestAnimationFrame(loop);
    return;
  }
  if(video.readyState===4 && tempCtx){
    if(tempCanvas.width!==video.videoWidth){
      tempCanvas.width=video.videoWidth;
      tempCanvas.height=video.videoHeight;
      canvas.width=video.videoWidth;
      canvas.height=video.videoHeight;
    }
    tempCtx.drawImage(video,0,0,tempCanvas.width,tempCanvas.height);
    if(lightActive)processLight();
    if(colorActive)processColor();
  }
  requestAnimationFrame(loop);
}

window.openSettings=()=>{
  const ks = document.getElementById('key-screen');
  ks.classList.remove('hidden');
  ks.removeAttribute('aria-hidden');
  ks.removeAttribute('inert');
  document.getElementById('key-input').value = GEMINI_KEY;
};

window.closeSettings=()=>{
  const ks = document.getElementById('key-screen');
  ks.classList.add('hidden');
  ks.setAttribute('aria-hidden','true');
  ks.setAttribute('inert','');
};

window.saveKey=()=>{
  GEMINI_KEY=document.getElementById('key-input').value.trim();
  localStorage.setItem('gemini_key',GEMINI_KEY);
  closeSettings();
  announce("Chiave Gemini salvata.");
};
</script>
</body>
</html>