<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Visione AI Pro</title>
    <style>
        body {
            font-family: 'Arial', sans-serif; margin: 0; padding: 0;
            background-color: #000; color: #fff;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* Accessibilità: testo per Screen Reader */
        .sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }

        /* Area Fotocamera */
        #cam-container {
            position: relative; flex-grow: 1; width: 100%;
            background: #111; display: flex; justify-content: center; align-items: center;
        }
        video { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        /* Griglia Comandi */
        #controls {
            height: 60vh; width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr 0.3fr; 
            gap: 10px; padding: 10px; box-sizing: border-box;
            background: #000; border-top: 4px solid #333;
        }

        button {
            border: 2px solid #555; border-radius: 12px;
            font-size: 1.2rem; font-weight: bold; text-transform: uppercase;
            color: #FFF; background: #222; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }
        button:active { background: #555; transform: scale(0.98); }

        /* Colori Pulsanti per Alto Contrasto */
        #btn-desc { background-color: #D4AF37; color: #000; border-color: #FFF; } /* Oro */
        #btn-guide { background-color: #004080; border-color: #FFF; } /* Blu */
        
        .active-tool { background-color: #006400 !important; border-color: #00FF00 !important; } /* Verde scuro */
        .guiding { background-color: #8B0000 !important; border-color: #FF0000 !important; } /* Rosso scuro */

        /* Riga impostazioni */
        .bottom-bar { grid-column: 1 / -1; display: flex; gap: 10px; }
        .small-btn { flex: 1; font-size: 1rem; background: #111; border: 1px solid #444; color: #CCC; }
        .active-discrete { border-color: #FF0000; color: #FF0000; }

        /* Overlay Caricamento */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .hidden { display: none !important; }
        .loader { border: 6px solid #333; border-top: 6px solid #FFF; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="sr-announcer" class="sr-only" aria-live="assertive" role="status"></div>

    <div id="cam-container">
        <video id="webcam" playsinline muted autoplay></video>
        <canvas id="overlay"></canvas>
    </div>

    <div id="controls" class="hidden">
        <button id="btn-desc" onclick="quickDescribe()">DESCRIVI SCENA</button>
        <button id="btn-guide" onclick="toggleGuidance()">GUIDA CENTRAGGIO</button>
        
        <button id="btn-light" onclick="toggleLight()">SONDA LUCE</button>
        <button id="btn-color" onclick="toggleColor()">SONDA COLORE</button>

        <button id="btn-level" onclick="toggleLevel()">LIVELLA</button>
        <button id="btn-torch" onclick="toggleTorch()">TORCIA</button>

        <div class="bottom-bar">
            <button class="small-btn" id="btn-discrete" onclick="toggleDiscrete()">MODO DISCRETO</button>
            <button class="small-btn" onclick="openSettings()">IMPOSTAZIONI API</button>
        </div>
    </div>

    <div id="start-screen" class="overlay">
        <h1 style="color: #FFF; margin-bottom: 20px;">Visione AI</h1>
        <div id="loader" class="loader hidden"></div>
        <div id="load-msg" class="hidden" style="color:#FFF;">Caricamento in corso...</div>
        <button onclick="startApp()" style="padding: 30px; font-size: 1.5rem; background: #D4AF37; color: #000; border-radius: 12px; width: 90%; border:none; font-weight: bold;">AVVIA SISTEMA</button>
    </div>

    <div id="key-screen" class="overlay hidden">
        <h2 style="color: #FFF;">Chiave Gemini API</h2>
        <input type="text" id="key-input" placeholder="Incolla chiave qui..." style="width: 80%; padding: 15px; font-size: 1.2rem; margin-bottom: 20px;">
        <button onclick="saveKey()" style="padding: 15px; background: #FFF; color:#000; width: 50%; font-weight:bold;">SALVA</button>
        <button onclick="closeSettings()" style="margin-top:10px; background:#333; color:#FFF; width:50%;">CHIUDI</button>
    </div>

    <script>
        // --- CONFIGURAZIONE ---
        let GEMINI_KEY = localStorage.getItem('gemini_key') || "";
        let audioCtx, lightOsc, lightGain;
        let objectDetector = null;
        let isRunning = false;
        let videoTrack = null;
        
        // Stati dell'app
        let mode = 'idle'; // 'idle' o 'guiding'
        let lightActive = false, colorActive = false, levelActive = false, torchActive = false;
        let discreteMode = false;
        let lastSpeak = 0;
        let centeredCount = 0;
        const SNAP_THRESHOLD = 15; // Frame necessari per scatto automatico

        const video = document.getElementById('webcam');
        const canvas = document.getElementById('overlay');
        const ctx = canvas.getContext('2d');

        // Funzione parlante
        function announce(text) {
            if(discreteMode) return;
            const el = document.getElementById('sr-announcer');
            el.textContent = ""; 
            setTimeout(() => el.textContent = text, 50);
        }

        function vibrate(pattern) {
            if(navigator.vibrate) navigator.vibrate(pattern);
        }

        // --- 1. AVVIO DEL SISTEMA ---
        async function startApp() {
            const startBtn = document.querySelector('#start-screen button');
            startBtn.style.display = 'none';
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('load-msg').classList.remove('hidden');
            
            announce("Avvio sistema. Attendi.");
            
            // Sblocca AudioContext con interazione utente
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            try {
                // Carica librerie visione
                const { ObjectDetector, FilesetResolver } = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js");
                const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
                
                objectDetector = await ObjectDetector.createFromOptions(vision, {
                    baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite", delegate: "GPU" },
                    scoreThreshold: 0.3, 
                    runningMode: "VIDEO"
                });

                // Avvia Camera (Correzione per compatibilità Windows/Android)
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                video.srcObject = stream;
                videoTrack = stream.getVideoTracks()[0];

                video.addEventListener('loadeddata', () => {
                    document.getElementById('start-screen').classList.add('hidden');
                    document.getElementById('controls').classList.remove('hidden');
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    isRunning = true;
                    announce("Pronto. Pulsanti attivi.");
                    
                    if(!GEMINI_KEY) openSettings();
                    loop(); // Inizia ciclo continuo
                });
            } catch(e) { 
                alert("Errore avvio: " + e.message); 
                announce("Errore critico fotocamera.");
            }
        }

        // Ciclo principale (60 volte al secondo)
        function loop() {
            if(!isRunning) return;
            if(lightActive) processLight();
            if(colorActive) processColor();
            if(mode === 'guiding') processGuidance();
            requestAnimationFrame(loop);
        }

        // --- 2. DESCRIZIONE SCENA (AI) ---
        async function quickDescribe() {
            if(mode === 'guiding') toggleGuidance(); // Spegni guida se attiva
            announce("Scatto e analizzo.");
            playShutter();
            const b64 = captureFrame();
            // Prompt ottimizzato per Screen Reader
            const prompt = "Descrivi brevemente cosa vedi. Se c'è testo leggilo. Sii utile per un non vedente.";
            // Correzione: passiamo 'b64' invece di 'base64'
            await callGemini(prompt, b64);
        }

        // --- 3. GUIDA AL CENTRAGGIO ---
        function toggleGuidance() {
            const btn = document.getElementById('btn-guide');
            if(mode === 'guiding') {
                mode = 'idle'; 
                btn.classList.remove('guiding'); 
                btn.innerText = "GUIDA CENTRAGGIO";
                ctx.clearRect(0,0,canvas.width,canvas.height); 
                announce("Guida spenta.");
            } else {
                mode = 'guiding'; 
                centeredCount = 0; 
                btn.classList.add('guiding'); 
                btn.innerText = "CERCO SOGGETTO...";
                announce("Cerco soggetto.");
            }
        }

        function processGuidance() {
            const detections = objectDetector.detectForVideo(video, performance.now()).detections;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            
            if(detections.length === 0) return;

            // Prendi l'oggetto più grande
            const target = detections.sort((a,b)=>(b.boundingBox.width*b.boundingBox.height)-(a.boundingBox.width*a.boundingBox.height))[0];
            const box = target.boundingBox;
            
            // Coordinate
            const cx = box.originX + box.width/2;
            const cy = box.originY + box.height/2;
            const sx = canvas.width/2, sy = canvas.height/2;
            const tol = canvas.width * 0.15; // Tolleranza 15%

            // Feedback Visivo (Quadrato verde)
            ctx.strokeStyle = "#00FF00"; ctx.lineWidth = 5; 
            ctx.strokeRect(box.originX, box.originY, box.width, box.height);

            let msg = "";
            if(cx < sx - tol) msg = "Sposta a DESTRA";
            else if(cx > sx + tol) msg = "Sposta a SINISTRA";
            else if(cy < sy - tol) msg = "ALZA il telefono";
            else if(cy > sy + tol) msg = "ABBASSA il telefono";
            
            if(msg) {
                centeredCount = 0;
                // Parla ogni 1.2 secondi per non sovrapporsi
                if(Date.now() - lastSpeak > 1200) { 
                    announce(msg); 
                    vibrate(50); 
                    lastSpeak=Date.now(); 
                }
            } else {
                // Centrato
                centeredCount++;
                if(centeredCount === 1) { 
                    announce("Centrato. Tieni fermo."); 
                    vibrate([50,50,50]); 
                }
                
                // Se rimane centrato per ~0.5 secondi
                if(centeredCount > SNAP_THRESHOLD) {
                    mode = 'idle'; 
                    document.getElementById('btn-guide').classList.remove('guiding');
                    document.getElementById('btn-guide').innerText = "ANALISI IN CORSO...";
                    announce("Scatto automatico."); 
                    playShutter();
                    const b64 = captureFrame();
                    callGemini("Descrivi in dettaglio l'oggetto che ho appena inquadrato.", b64).then(()=>{
                        document.getElementById('btn-guide').innerText = "GUIDA CENTRAGGIO";
                    });
                }
            }
        }

        // --- 4. SONDA LUCE ---
        function toggleLight() {
            lightActive = !lightActive;
            const btn = document.getElementById('btn-light');
            if(lightActive) {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                lightOsc = audioCtx.createOscillator(); 
                lightGain = audioCtx.createGain();
                lightOsc.connect(lightGain); 
                lightGain.connect(audioCtx.destination);
                lightGain.gain.value = 0.1; 
                lightOsc.start();
                btn.classList.add('active-tool'); btn.innerText = "LUCE: ON"; 
                announce("Suono luce attivo.");
            } else {
                if(lightOsc) lightOsc.stop();
                btn.classList.remove('active-tool'); btn.innerText = "SONDA LUCE"; 
                announce("Suono luce spento.");
            }
        }
        
        function processLight() {
            const size=10, cx=Math.floor(canvas.width/2), cy=Math.floor(canvas.height/2);
            // Legge luminosità media al centro
            const p = createTempContext().getImageData(cx-size/2, cy-size/2, size, size).data;
            let sum=0; 
            for(let i=0; i<p.length; i+=4) sum += (p[i]+p[i+1]+p[i+2])/3;
            const level = sum/(p.length/4);
            // Modula frequenza: Buio(0)=100Hz, Luce(255)=1100Hz
            if(lightOsc) lightOsc.frequency.setValueAtTime(100+(level*4), audioCtx.currentTime);
        }

        // --- 5. SONDA COLORE ---
        function toggleColor() {
            colorActive = !colorActive;
            const btn = document.getElementById('btn-color');
            if(colorActive) { 
                btn.classList.add('active-tool'); btn.innerText = "COLORE: ON"; 
                announce("Lettura colori attiva."); 
            } else { 
                btn.classList.remove('active-tool'); btn.innerText = "SONDA COLORE"; 
                announce("Lettura colori spenta."); 
            }
        }
        
        function processColor() {
            if(Date.now()-lastSpeak<2000) return;
            const cx=Math.floor(canvas.width/2), cy=Math.floor(canvas.height/2);
            const p = createTempContext().getImageData(cx,cy,1,1).data;
            announce(getColorName(p[0],p[1],p[2])); 
            lastSpeak=Date.now();
        }

        // --- 6. LIVELLA ---
        function toggleLevel() {
            levelActive = !levelActive;
            const btn = document.getElementById('btn-level');
            if(levelActive) {
                btn.classList.add('active-tool'); btn.innerText = "LIVELLA: ON"; 
                announce("Livella attiva.");
                // Richiesta permessi iOS
                if(typeof DeviceOrientationEvent.requestPermission==='function') {
                    DeviceOrientationEvent.requestPermission().then(r=>{if(r==='granted') window.addEventListener('deviceorientation', handleLevel)});
                } else {
                    window.addEventListener('deviceorientation', handleLevel);
                }
            } else {
                btn.classList.remove('active-tool'); btn.innerText = "LIVELLA"; 
                announce("Livella spenta.");
                window.removeEventListener('deviceorientation', handleLevel);
            }
        }
        
        function handleLevel(e) {
            if(Date.now()-lastSpeak<1500) return;
            if(e.gamma > 10) { announce("Pende a destra"); vibrate(50); lastSpeak=Date.now(); }
            else if(e.gamma < -10) { announce("Pende a sinistra"); vibrate(50); lastSpeak=Date.now(); }
        }

        // --- 7. TORCIA (CON CONTROLLO REALE) ---
        function toggleTorch() {
            if(!videoTrack) { announce("Fotocamera non pronta."); return; }
            
            const targetState = !torchActive; // Lo stato che vorremmo
            const btn = document.getElementById('btn-torch');

            videoTrack.applyConstraints({advanced:[{torch: targetState}]})
            .then(() => {
                // CONTROLLO DI REALTA': Chiediamo alla videocamera come sta
                const settings = videoTrack.getSettings();
                
                // Se il browser supporta la lettura dello stato
                if ('torch' in settings) {
                    const actualState = settings.torch;
                    if (actualState === targetState) {
                        torchActive = actualState;
                        if(torchActive) {
                            btn.classList.add('active-tool'); btn.innerText = "TORCIA: ON"; announce("Luce accesa.");
                        } else {
                            btn.classList.remove('active-tool'); btn.innerText = "TORCIA"; announce("Luce spenta.");
                        }
                    } else {
                        announce("La torcia non risponde.");
                    }
                } else {
                    // Fallback per dispositivi che non riportano lo stato (es. alcuni Android vecchi)
                    torchActive = targetState;
                    if(torchActive) {
                        btn.classList.add('active-tool'); btn.innerText = "TORCIA: ON"; announce("Luce attivata.");
                    } else {
                        btn.classList.remove('active-tool'); btn.innerText = "TORCIA"; announce("Luce disattivata.");
                    }
                }
            })
            .catch(err => {
                announce("Impossibile attivare torcia.");
                torchActive = false;
                btn.classList.remove('active-tool'); btn.innerText = "TORCIA";
            });
        }

        // --- MODO DISCRETO ---
        function toggleDiscrete() {
            discreteMode = !discreteMode;
            const btn = document.getElementById('btn-discrete');
            if(discreteMode) { 
                btn.classList.add('active-discrete'); btn.innerText = "MODO DISCRETO: ON";
                vibrate([100,50,100]); 
            } else {
                btn.classList.remove('active-discrete'); btn.innerText = "MODO DISCRETO";
                announce("Modo discreto spento. Voce attiva.");
            }
        }

        // --- FUNZIONI DI SUPPORTO ---
        function captureFrame() {
            const c = document.createElement('canvas'); c.width = video.videoWidth; c.height = video.videoHeight;
            c.getContext('2d').drawImage(video, 0, 0);
            return c.toDataURL('image/jpeg', 0.7).split(',')[1]; // Compressione 0.7
        }

        async function callGemini(prompt, b64) {
            if(!GEMINI_KEY) { announce("Manca chiave API. Inseriscila nelle impostazioni."); openSettings(); return; }
            try {
                // CORREZIONE APPLICATA QUI SOTTO (b64 invece di base64)
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{text: prompt}, {inline_data: {mime_type: "image/jpeg", data: b64}}] }] })
                });
                const d = await res.json();
                if(d.error) throw new Error(d.error.message);
                const text = d.candidates[0].content.parts[0].text;
                
                if(!discreteMode) announce(text);
                else alert("RISPOSTA AI:\n" + text); 
            } catch(e) { 
                console.error(e);
                announce("Errore connessione intelligenza artificiale."); 
            }
        }

        function createTempContext() { 
            const c=document.createElement('canvas'); c.width=canvas.width; c.height=canvas.height; 
            c.getContext('2d').drawImage(video,0,0); return c.getContext('2d'); 
        }
        
        function playShutter() { 
            if(!discreteMode && audioCtx){ 
                const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); 
                g.gain.value=0.1; o.connect(g); g.connect(audioCtx.destination); 
                o.start(); o.stop(audioCtx.currentTime+0.1); 
            } 
        }
        
        // Dizionario Colori Semplice
        const colors={'0,0,0':'Nero','255,255,255':'Bianco','255,0,0':'Rosso','0,255,0':'Verde','0,0,255':'Blu','255,255,0':'Giallo','128,128,128':'Grigio','165,42,42':'Marrone','255,165,0':'Arancione','128,0,128':'Viola'};
        function getColorName(r,g,b){ 
            let min=Infinity,res="Sconosciuto"; 
            for(let k in colors){ 
                const[cr,cg,cb]=k.split(',').map(Number); 
                const d=Math.sqrt((r-cr)**2+(g-cg)**2+(b-cb)**2); 
                if(d<min){min=d;res=colors[k];}
            } 
            return res;
        }

        // Gestione Impostazioni
        window.openSettings = () => document.getElementById('key-screen').classList.remove('hidden');
        window.closeSettings = () => document.getElementById('key-screen').classList.add('hidden');
        window.saveKey = () => { 
            GEMINI_KEY=document.getElementById('key-input').value.trim(); 
            localStorage.setItem('gemini_key',GEMINI_KEY); 
            closeSettings(); 
            announce("Chiave salvata."); 
        };

    </script>
</body>
</html>