<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Visione AI - PRO 3 (Multi-modo)</title>
    <style>
        body {
            font-family: 'Arial', sans-serif; margin: 0; padding: 0;
            background-color: #000; color: #fff;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* Accessibilità: SR Only */
        .sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }

        /* Area Fotocamera */
        #cam-container {
            position: relative; flex-grow: 1; width: 100%;
            background: #111; display: flex; justify-content: center; align-items: center;
        }
        video { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        /* Griglia Comandi */
        #controls {
            height: 60vh; width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr 1fr 1fr 1fr auto auto auto; 
            gap: 8px; padding: 8px; box-sizing: border-box;
            background: #000; border-top: 4px solid #333;
        }

        button {
            border: 2px solid #555; border-radius: 12px;
            font-size: 1.0rem; font-weight: bold; text-transform: uppercase;
            color: #FFF; background: #222; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; touch-action: manipulation;
        }
        button:active { background: #555; transform: scale(0.98); }

        /* Barra superiore */
        .top-bar { 
            grid-column: 1 / -1; 
            display: flex; 
            gap: 10px; 
        }

        /* Colori e Stati Pulsanti principali */
        #btn-scene { background-color: #D4AF37; color: #000; border-color: #FFF; font-size: 1.1rem; }
        #btn-selfie { background-color: #004080; border-color: #FFF; }
        #btn-outdoor { background-color: #3B6C2A; border-color: #FFF; }
        #btn-indoor { background-color: #6A1B9A; border-color: #FFF; }

        .active-tool { background-color: #006400 !important; border-color: #00FF00 !important; }
        .guiding { background-color: #8B0000 !important; border-color: #FF0000 !important; }

        /* Barre inferiori */
        .bottom-bar { grid-column: 1 / -1; display: flex; gap: 10px; }
        .small-btn { flex: 1; font-size: 0.9rem; background: #111; border: 1px solid #444; color: #CCC; }
        .active-discrete { border-color: #FF0000; color: #FF0000; }

        /* Barra azioni foto (usa / modifica / elimina) */
        .shot-bar { grid-column: 1 / -1; display: flex; gap: 10px; }

        /* Overlay Caricamento e Settings */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .hidden { display: none !important; }
        .loader { border: 6px solid #333; border-top: 6px solid #D4AF37; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        input { background: #333; color: #FFF; border: 1px solid #777; }

        /* Link download fallback */
        #download-link {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 0.9rem;
            color: #D4AF37;
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <div id="sr-announcer" class="sr-only" aria-live="assertive" role="status"></div>

    <div id="cam-container">
        <video id="webcam" playsinline muted autoplay></video>
        <canvas id="overlay"></canvas>
    </div>

    <div id="controls" class="hidden">

        <!-- RIGA 0: GUIDA + SCATTA -->
        <div class="top-bar">
            <button class="small-btn" id="btn-guide" onclick="toggleGuidance()" aria-label="Attiva o disattiva guida di centraggio oggetto">
                GUIDA CENTRAGGIO
            </button>
            <button class="small-btn" id="btn-shot" onclick="takeShot()" aria-label="Scatta una foto senza analizzarla, poi scegli come farla descrivere">
                SCATTA
            </button>
        </div>

        <!-- RIGA 1: scena generale + selfie -->
        <button id="btn-scene" 
                onclick="describeWithMode('scene')" 
                aria-label="Analizza la foto scattata come scena generale con descrizione dettagliata e qualità della foto">
            SCENA GENERALE
        </button>
        <button id="btn-selfie" 
                onclick="describeWithMode('selfie')" 
                aria-label="Analizza la foto scattata come selfie o volto e controlla se è adatta come foto profilo">
            SELFIE / VOLTO
        </button>
        
        <!-- RIGA 2: esterno + interno -->
        <button id="btn-outdoor" 
                onclick="describeWithMode('outdoor')" 
                aria-label="Analizza la foto scattata come ambiente esterno o paesaggio, con descrizione e qualità foto">
            ESTERNO / PAESAGGIO
        </button>
        <button id="btn-indoor" 
                onclick="describeWithMode('indoor')" 
                aria-label="Analizza la foto scattata come ambiente interno, come stanza o negozio">
            INTERNO / STANZA
        </button>

        <!-- RIGA 3: oggetto + testo -->
        <button id="btn-object" 
                onclick="describeWithMode('object')" 
                aria-label="Analizza la foto scattata per descrivere un oggetto in dettaglio, con qualità foto">
            OGGETTO
        </button>
        <button id="btn-text" 
                onclick="describeWithMode('text')" 
                aria-label="Analizza la foto scattata leggendo il testo o documento nell’immagine">
            TESTO / DOCUMENTO
        </button>

        <!-- RIGA 4: cibo + sicurezza -->
        <button id="btn-food" 
                onclick="describeWithMode('food')" 
                aria-label="Analizza la foto scattata per descrivere un piatto o del cibo, con qualità foto">
            CIBO / PIATTO
        </button>
        <button id="btn-safety" 
            onclick="describeWithMode('safety')" 
            aria-label="Analizza la foto scattata per ostacoli e sicurezza">
            SICUREZZA / OSTACOLI
        </button>

        <!-- Barra azioni dopo lo scatto -->
        <div id="shot-actions" class="shot-bar hidden">
            <button class="small-btn" id="btn-use" onclick="usePhoto()">USA FOTO</button>
            <button class="small-btn" id="btn-edit" onclick="editAndReviewPhoto()">MODIFICA E ANALIZZA</button>
            <button class="small-btn" id="btn-delete" onclick="deletePhoto()">ELIMINA</button>
        </div>

        <div class="bottom-bar">
            <button class="small-btn" id="btn-light" onclick="toggleLight()">SONDA LUCE</button>
            <button class="small-btn" id="btn-color" onclick="toggleColor()">SONDA COLORE</button>
        </div>

        <div class="bottom-bar">
            <button class="small-btn" id="btn-level" onclick="toggleLevel()">LIVELLA</button>
            <button class="small-btn" id="btn-torch" onclick="toggleTorch()">TORCIA</button>
            <button class="small-btn" id="btn-discrete" onclick="toggleDiscrete()">MODO DISCRETO</button>
            <button class="small-btn" onclick="openSettings()">IMPOSTAZIONI API</button>
        </div>

        <!-- Link fallback per download foto -->
        <a id="download-link" href="#" class="hidden">
            Scarica la foto scattata
        </a>
    </div>

    <div id="start-screen" class="overlay">
        <h1 style="color: #FFF; margin-bottom: 20px;">Visione AI Pro 3</h1>
        <div id="loader" class="loader hidden"></div>
        <div id="load-msg" class="hidden" style="color:#FFF; font-size: 1.2rem;">Avvio sensori...</div>
        <button onclick="startApp()" style="padding: 30px; font-size: 1.5rem; background: #D4AF37; color: #000; border-radius: 12px; width: 90%; border:none; font-weight: bold;">AVVIA SISTEMA</button>
    </div>

    <div id="key-screen" class="overlay hidden">
        <h2 style="color: #FFF;">Chiave Gemini API</h2>
        <p style="color: #AAA; padding: 0 20px; text-align: center;">Inserisci la tua API Key (Gemini 3 Pro consigliata)</p>
        <input type="text" id="key-input" placeholder="Incolla chiave qui..." style="width: 80%; padding: 15px; font-size: 1.2rem; margin-bottom: 20px; border-radius: 8px;">
        <button onclick="saveKey()" style="padding: 15px; background: #FFF; color:#000; width: 50%; font-weight:bold; border-radius: 8px; margin-bottom: 10px;">SALVA</button>
        <button onclick="closeSettings()" style="padding: 15px; background:#333; color:#FFF; width:50%; border-radius: 8px;">CHIUDI</button>
    </div>

    <script>
        // --- CONFIGURAZIONE ---
        let GEMINI_KEY = localStorage.getItem('gemini_key') || "";
        const MODEL_NAME = "gemini-3-pro-preview"; 
        const API_ENDPOINT = "v1beta";

        let audioCtx, lightOsc, lightGain;
        let objectDetector = null;
        let isRunning = false;
        let videoTrack = null;
        
        const tempCanvas = document.createElement('canvas');
        let tempCtx = null;

        let mode = 'idle'; 
        let lightActive = false, colorActive = false, levelActive = false, torchActive = false;
        let discreteMode = false;
        let lastSpeak = 0;
        let centeredCount = 0;
        const SNAP_THRESHOLD = 20; 

        const video = document.getElementById('webcam');
        const canvas = document.getElementById('overlay');
        const ctx = canvas.getContext('2d');

        let lastShotB64 = null;
        let lastShotUrl = null;

        function announce(text) {
            if(discreteMode) return;
            const el = document.getElementById('sr-announcer');
            el.textContent = ""; 
            setTimeout(() => el.textContent = text, 50);
        }

        function vibrate(pattern) {
            if(navigator.vibrate) navigator.vibrate(pattern);
        }

        // --- AVVIO SISTEMA ---
        async function startApp() {
            const startBtn = document.querySelector('#start-screen button');
            startBtn.style.display = 'none';
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('load-msg').classList.remove('hidden');
            
            announce("Avvio sistema Pro 3. Attendi.");
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            try {
                const { ObjectDetector, FilesetResolver } = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js");
                const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
                
                objectDetector = await ObjectDetector.createFromOptions(vision, {
                    baseOptions: { 
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite", 
                        delegate: "GPU" 
                    },
                    scoreThreshold: 0.1,
                    maxResults: 5,
                    runningMode: "VIDEO"
                });

                let stream;
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment', 
                            width: { ideal: 1280 }, 
                            height: { ideal: 720 },
                            focusMode: 'continuous' 
                        } 
                    });
                } catch (err) {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                }
                
                video.srcObject = stream;
                videoTrack = stream.getVideoTracks()[0];

                video.addEventListener('loadeddata', () => {
                    document.getElementById('start-screen').classList.add('hidden');
                    document.getElementById('controls').classList.remove('hidden');
                    
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    tempCanvas.width = video.videoWidth; tempCanvas.height = video.videoHeight;
                    tempCtx = tempCanvas.getContext('2d', { willReadFrequently: true });

                    isRunning = true;
                    announce("Sistema Pro 3 attivo.");
                    
                    if(!GEMINI_KEY) setTimeout(() => {
                        announce("Attenzione. Chiave API mancante. Puoi comunque scattare e usare le foto.");
                    }, 1000);
                    
                    loop(); 
                });
            } catch(e) { 
                alert("Errore avvio: " + e.message); 
                announce("Errore critico avvio fotocamera.");
            }
        }

        function loop() {
            if(!isRunning) return;
            
            if(lightActive || colorActive) {
                if(tempCtx) tempCtx.drawImage(video, 0, 0);
            }

            if(lightActive) processLight();
            if(colorActive) processColor();
            if(mode === 'guiding') processGuidance();
            
            requestAnimationFrame(loop);
        }

        // --- SCATTA FOTO (senza analisi) ---
        async function takeShot() {
            if (mode === 'guiding') toggleGuidance();

            announce("Scatto foto. Attendi un istante.");
            playShutter();

            const b64 = captureFrame();
            lastShotB64 = b64;

            if (lastShotUrl) {
                URL.revokeObjectURL(lastShotUrl);
                lastShotUrl = null;
            }

            const dlLink = document.getElementById('download-link');
            dlLink.classList.add('hidden');
            dlLink.removeAttribute('href');
            dlLink.removeAttribute('download');

            const actions = document.getElementById('shot-actions');
            actions.classList.remove('hidden');

            if (GEMINI_KEY) {
                announce("Foto scattata. Ora puoi scegliere una modalità di analisi, oppure usare o modificare la foto.");
            } else {
                announce("Foto scattata. Puoi usare o modificare la foto. Per avere descrizioni automatiche, inserisci una chiave API nelle impostazioni.");
            }
        }

        // --- DESCRIZIONI PER CONTESTO (usano ultima foto scattata) ---
        async function describeWithMode(context) {
            if (!lastShotB64) {
                announce("Prima scatta una foto con il pulsante Scatta, poi scegli il tipo di analisi.");
                return;
            }

            if (!GEMINI_KEY) {
                announce("Per questa analisi serve una chiave API Gemini. Apro le impostazioni.");
                openSettings();
                return;
            }

            let intro;
            switch (context) {
                case 'scene':
                    intro = "Analisi in modalità scena generale. Attendi descrizione dettagliata e qualità della foto.";
                    break;
                case 'selfie':
                    intro = "Analisi in modalità selfie o volto. Attendi valutazione del viso e qualità foto.";
                    break;
                case 'outdoor':
                    intro = "Analisi in modalità ambiente esterno o paesaggio. Attendi descrizione e qualità foto.";
                    break;
                case 'indoor':
                    intro = "Analisi in modalità ambiente interno o stanza. Attendi descrizione e qualità foto.";
                    break;
                case 'object':
                    intro = "Analisi in modalità oggetto. Attendi descrizione dell’oggetto e qualità foto.";
                    break;
                case 'text':
                    intro = "Analisi in modalità testo o documento. Attendi lettura del testo e qualità della foto.";
                    break;
                case 'food':
                    intro = "Analisi in modalità cibo o piatto. Attendi descrizione del piatto e qualità foto.";
                    break;
                case 'safety':
                    intro = "Analisi in modalità sicurezza e ostacoli. Attendi analisi e qualità foto.";
                    break;
                default:
                    intro = "Analisi della foto. Attendi.";
            }

            announce(intro);

            const prompt = buildPromptForContext(context);
            await callGemini(prompt, lastShotB64);

            announce("Analisi completata. Puoi usare la foto, modificarla e farla analizzare di nuovo, oppure eliminarla.");
        }

        function buildPromptForContext(context) {
            const qualityBlock = `
Infine, valuta in modo sintetico la qualità tecnica della foto e se è pronta per essere condivisa sui social (Instagram, Facebook, WhatsApp). 
Basati solo su criteri oggettivi:
- nitidezza (foto nitida oppure sfocata),
- centratura del soggetto principale,
- luminosità (troppo scura, troppo chiara, luce equilibrata),
- colori (naturali oppure strani o slavati),
- eventuali ostacoli davanti all’obiettivo o elementi che coprono il soggetto.

Se noti problemi concreti (ad esempio: soggetto tagliato, troppo lontano, troppo vicino, luce insufficiente, foto mossa, dito davanti alla lente, zona importante fuori inquadratura):
- indica chiaramente qual è il problema principale;
- proponi da 1 a 3 consigli molto concreti e semplici per migliorare un prossimo scatto, ad esempio: “avvicina un po’ il telefono”, “sposta la fotocamera leggermente verso sinistra”, “scegli un punto più illuminato”, “tieni il telefono più fermo”, “alza leggermente l’inquadratura”.

Se la foto è già chiaramente adatta e non vedi problemi rilevanti, dillo esplicitamente e non inventare correzioni.

Quando rispondi, usa sempre questa struttura con tre parti:

1) Descrizione:
- descrivi solo ciò che vedi chiaramente, con frasi brevi e dirette;
- indica la posizione degli elementi rispetto al centro dell’immagine (sinistra, destra, in alto, in basso, vicino, lontano);
- se qualcosa non è chiaro, usa espressioni come “sembra” oppure “non è chiaro se…”.

2) Qualità tecnica:
- in poche frasi valuta nitidezza, centratura, luminosità e colori;
- specifica se la foto è “adatta ai social” oppure “non consigliata per i social” e perché.

3) Suggerimenti pratici (solo se necessari):
- se hai individuato problemi concreti, dai suggerimenti semplici e azionabili;
- se non hai individuato problemi rilevanti, scrivi che non sono necessari cambiamenti importanti.

Evita giudizi personali o psicologici sulle persone (non dire se sono belle o brutte, tristi o felici), limita la descrizione a espressioni del volto, postura, vestiti e contesto visibile.
`;

            switch (context) {
                case 'scene':
                    return `
Descrivi questa immagine come se la stessi spiegando a una persona non vedente. 
Concentrati su:
- cosa c’è in primo piano,
- cosa c’è al centro dell’immagine,
- cosa c’è sullo sfondo,
- posizione degli elementi (sinistra, destra, alto, basso, vicino, lontano),
- presenza di persone, animali, oggetti, segnali, testo o elementi rilevanti,
- colori principali e contrasti,
- eventuali interazioni tra gli oggetti o le persone.

Usa frasi semplici e dirette. Non inventare dettagli se non sei sicuro.
` + qualityBlock;

                case 'selfie':
                    return `
Analizza la foto concentrandoti sulle persone e in particolare sul volto principale. 
Dimmi:
- se è presente un volto e dove si trova,
- se il volto è centrato o tagliato,
- se gli occhi sembrano aperti oppure chiusi,
- se l’espressione è neutra, seria o sorridente,
- se la luce valorizza il volto o crea ombre forti o zone troppo scure,
- se l’immagine è adatta come selfie o foto profilo (ad esempio per social o app di messaggistica),
- se ci sono altre persone attorno e quanto sono vicine.

Non descrivere lo sfondo se non è importante per la qualità del ritratto. Non inventare dettagli non visibili.
` + qualityBlock;

                case 'outdoor':
                    return `
Descrivi lo scenario esterno presente nella foto. 
Concentrati su:
- tipo di luogo (strada, parco, mare, montagna, piazza, giardino),
- cosa si vede al centro dell’immagine,
- elementi naturali (alberi, erba, cielo, acqua, montagne),
- edifici, marciapiedi, strade o strutture,
- profondità e distanza degli elementi (vicino, lontano, sullo sfondo),
- eventuali persone o animali presenti e cosa stanno facendo,
- condizioni meteo (sole, nuvoloso, pioggia).

Usa una descrizione ordinata e chiara per aiutare una persona non vedente a immaginare la scena.
` + qualityBlock;

                case 'indoor':
                    return `
Descrivi l’ambiente interno visibile nella foto. 
Concentrati su:
- che tipo di stanza è (ad esempio cucina, salotto, bagno, camera, negozio, ufficio),
- cosa c’è al centro dell’immagine,
- mobili e oggetti principali (tavoli, sedie, letti, scaffali, elettrodomestici),
- disposizione spaziale (sinistra, destra, alto, basso, più vicino o più lontano),
- eventuale disordine o ordine (oggetti sparsi, superfici libere, cose accatastate),
- porte, finestre o passaggi che si vedono.

Non inventare dettagli, descrivi solo ciò che è visibile.
` + qualityBlock;

                case 'object':
                    return `
Descrivi l’oggetto principale dell’immagine. 
Concentrati su:
- che oggetto è, se è riconoscibile,
- forma e dimensioni approssimative,
- materiali e colori principali,
- condizioni (nuovo, usato, consumato, rotto, sporco, pulito),
- dettagli rilevanti (etichette, loghi, pulsanti, scritte visibili),
- posizione dell’oggetto rispetto al centro dell’immagine,
- presenza di altri oggetti vicini che potrebbero creare confusione.

Se l’oggetto non è chiaro, spiega cosa ti fa dubitare, senza inventare.
` + qualityBlock;

                case 'text':
                    return `
Leggi soltanto il testo presente nell’immagine. 
Riporta il testo nell’ordine più naturale possibile, come se lo stessi leggendo a voce alta, riga per riga.
Non aggiungere interpretazioni o descrizioni della scena visiva, leggi solo ciò che è scritto.

Poi valuta se la foto è tecnicamente adatta a mostrare il testo (ad esempio per condividerla con qualcuno o sui social):
- se il testo è sufficientemente leggibile,
- se la foto è nitida o sfocata,
- se l’inquadratura contiene tutto il testo importante oppure se parti vengono tagliate,
- se ci sono ombre o riflessi che disturbano molto la lettura.

Se noti problemi concreti (ad esempio testo sfocato, tagliato, troppo piccolo, in ombra):
- indica chiaramente qual è il problema principale;
- suggerisci da 1 a 3 azioni semplici per migliorare un prossimo scatto, ad esempio: “avvicina il telefono”, “centra meglio il foglio”, “evita il controluce”, “appoggia il foglio su una superficie uniforme”.

Se la foto è già chiaramente adatta alla lettura del testo, dillo esplicitamente e non inventare difetti.

Organizza la risposta in tre parti:
1) Testo letto (solo il contenuto del testo);
2) Qualità tecnica per la lettura del testo;
3) Suggerimenti pratici (solo se necessari).
`;

                case 'food':
                    return `
Descrivi il piatto o il cibo presente nella foto. 
Concentrati su:
- tipo di piatto (ad esempio pasta, carne, insalata, dolce),
- ingredienti visibili,
- colori e consistenze (cremoso, croccante, liquido, denso),
- disposizione sul piatto (ordinato, decorato, disordinato),
- se il piatto appare pieno, parzialmente vuoto o quasi finito,
- presenza di stoviglie, bicchieri, tovaglioli o altri elementi sul tavolo.

Non inventare ingredienti non visibili. Descrivi solo ciò che si vede.
` + qualityBlock;

                case 'safety':
                    return `
Analizza l’immagine come se dovessi aiutare una persona non vedente a orientarsi in sicurezza. 
Concentrati SOLO su:
- ostacoli davanti alla persona (sedie, tavoli, oggetti a terra),
- gradini, dislivelli o buche visibili,
- bordi di marciapiedi o piattaforme,
- porte aperte o chiuse,
- oggetti sporgenti ad altezza gambe, busto o testa,
- veicoli vicini o potenzialmente in movimento,
- persone molto vicine che potrebbero ostacolare il passaggio.

Ignora dettagli estetici non legati alla sicurezza. 
Se non sei sicuro di un potenziale ostacolo, dillo chiaramente.
` + `
Poi valuta anche la qualità tecnica dello scatto:
- se la zona importante per la sicurezza (pavimento, percorso, ostacoli) è nitida e visibile,
- se la luce è sufficiente per capire gli ostacoli,
- se l’inquadratura è centrata sulla zona dove si cammina.

Se la foto non è adatta per valutare bene la sicurezza, spiega qual è il problema e suggerisci cosa fare per migliorare il prossimo scatto (ad esempio “abbassa un po’ la fotocamera verso il pavimento”, “fai un passo indietro”, “cerca una zona più illuminata”).

Organizza la risposta in tre parti:
1) Analisi sicurezza (ostacoli e percorso);
2) Qualità tecnica per la valutazione della sicurezza;
3) Suggerimenti pratici (solo se necessari).
`;

                default:
                    return `
Descrivi questa immagine in modo chiaro per una persona non vedente.
` + qualityBlock;
            }
        }

        // --- GUIDA CENTRAGGIO ---
        function toggleGuidance() {
            const btn = document.getElementById('btn-guide');
            if(mode === 'guiding') {
                mode = 'idle'; 
                btn.classList.remove('guiding'); 
                btn.innerText = "GUIDA CENTRAGGIO";
                ctx.clearRect(0,0,canvas.width,canvas.height); 
                announce("Guida spenta.");
            } else {
                mode = 'guiding'; 
                centeredCount = 0; 
                btn.classList.add('guiding'); 
                btn.innerText = "GUIDA ATTIVA";
                announce("Guida centraggio attiva. Cerco un oggetto da centrare.");
            }
        }

        function processGuidance() {
            if (!objectDetector) return;

            let result;
            try {
                result = objectDetector.detectForVideo(video, performance.now());
            } catch (e) {
                console.warn("Errore objectDetector in processGuidance:", e);
                return;
            }

            const detections = (result && result.detections) ? result.detections : [];

            ctx.clearRect(0,0,canvas.width,canvas.height);

            if (detections.length === 0) {
                if (Date.now() - lastSpeak > 1800) {
                    announce("Non vedo nessun oggetto distinto. Prova ad avvicinare o cambiare leggermente angolazione.");
                    lastSpeak = Date.now();
                }
                centeredCount = 0;
                return;
            }

            let scored = detections.map(d => {
                const cat = (d.categories && d.categories[0]) ? d.categories[0] : null;
                const score = cat ? cat.score : 0;
                return { d, score };
            });

            let strong = scored.filter(x => x.score >= 0.5);
            if (strong.length === 0) {
                strong = scored.filter(x => x.score >= 0.2);
            }

            if (strong.length === 0) {
                centeredCount = 0;
                return;
            }

            const target = strong
                .sort((a, b) => {
                    const boxA = a.d.boundingBox;
                    const boxB = b.d.boundingBox;
                    return (boxB.width * boxB.height) - (boxA.width * boxA.height);
                })[0].d;

            const box = target.boundingBox;
            
            const cx = box.originX + box.width/2;
            const cy = box.originY + box.height/2;
            const sx = canvas.width/2, sy = canvas.height/2;
            const tolX = canvas.width * 0.15; 
            const tolY = canvas.height * 0.20; 

            ctx.strokeStyle = "#00FF00"; ctx.lineWidth = 6; 
            ctx.strokeRect(box.originX, box.originY, box.width, box.height);

            let label = null;
            if (target.categories && target.categories.length > 0) {
                label = target.categories[0].categoryName;
            }
            const oggetto = labelToItalian(label);

            let msg = "";

            if (cx < sx - tolX) {
                msg = oggetto + " un po' a sinistra. Sposta a sinistra.";
                centeredCount = 0;
            } else if (cx > sx + tolX) {
                msg = oggetto + " un po' a destra. Sposta a destra.";
                centeredCount = 0;
            } else if (cy < sy - tolY) {
                msg = oggetto + " in alto. Alza la fotocamera.";
                centeredCount = 0;
            } else if (cy > sy + tolY) {
                msg = oggetto + " in basso. Abbassa la fotocamera.";
                centeredCount = 0;
            } else {
                msg = oggetto + " centrato.";
                centeredCount++;
            }

            if (Date.now() - lastSpeak > 1200) {
                announce(msg);
                vibrate(30);
                lastSpeak = Date.now();
            }

            if (centeredCount > SNAP_THRESHOLD) {
                mode = 'idle';
                document.getElementById('btn-guide').classList.remove('guiding');
                document.getElementById('btn-guide').innerText = "GUIDA CENTRAGGIO";
                centeredCount = 0;

                announce("Oggetto centrato. Ora puoi scattare una foto con il pulsante Scatta.");
            }
        }

        // --- STRUMENTI SENSORIALI ---
        function toggleLight() {
            lightActive = !lightActive;
            const btn = document.getElementById('btn-light');
            
            if(lightActive) {
                if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
                lightOsc = audioCtx.createOscillator(); 
                lightGain = audioCtx.createGain();
                lightOsc.connect(lightGain); 
                lightGain.connect(audioCtx.destination);
                lightGain.gain.value = 0.05; 
                lightOsc.start();
                
                btn.classList.add('active-tool'); btn.innerText = "LUCE: ON"; 
                announce("Suono luce attivo.");
            } else {
                if(lightOsc) { lightOsc.stop(); lightOsc.disconnect(); }
                btn.classList.remove('active-tool'); btn.innerText = "SONDA LUCE"; 
                announce("Suono luce spento.");
            }
        }
        
        function processLight() {
            if(!tempCtx) return;
            const size = 20; 
            const cx = Math.floor(canvas.width / 2);
            const cy = Math.floor(canvas.height / 2);
            
            const x = Math.max(0, cx - size / 2);
            const y = Math.max(0, cy - size / 2);
            
            const p = tempCtx.getImageData(x, y, size, size).data;
            
            let sum=0; 
            for(let i=0; i<p.length; i+=4) sum += (p[i]+p[i+1]+p[i+2])/3;
            const level = sum/(p.length/4); 
            
            if(lightOsc) lightOsc.frequency.setValueAtTime(100+(level*4), audioCtx.currentTime);
        }

        function toggleColor() {
            colorActive = !colorActive;
            const btn = document.getElementById('btn-color');
            if(colorActive) { 
                btn.classList.add('active-tool'); btn.innerText = "COLORE: ON"; 
                announce("Lettura colore attiva."); 
            } else { 
                btn.classList.remove('active-tool'); btn.innerText = "SONDA COLORE"; 
                announce("Lettura colore spenta."); 
            }
        }
        
        function processColor() {
            if(Date.now()-lastSpeak<2000) return; 
            if(!tempCtx) return;

            const boxSize = 20; 
            const cx = Math.floor(canvas.width / 2);
            const cy = Math.floor(canvas.height / 2);
            
            const x = Math.max(0, cx - boxSize / 2);
            const y = Math.max(0, cy - boxSize / 2);
            
            const data = tempCtx.getImageData(x, y, boxSize, boxSize).data;
            let r=0, g=0, b=0;
            const pixelCount = (boxSize*boxSize);
            
            for(let i=0; i<data.length; i+=4) {
                r += data[i]; g += data[i+1]; b += data[i+2];
            }
            
            r = Math.round(r/pixelCount);
            g = Math.round(g/pixelCount);
            b = Math.round(b/pixelCount);

            announce(getColorName(r,g,b)); 
            lastSpeak=Date.now();
        }

        function toggleLevel() {
            levelActive = !levelActive;
            const btn = document.getElementById('btn-level');
            if(levelActive) {
                btn.classList.add('active-tool'); btn.innerText = "LIVELLA: ON"; 
                announce("Livella attiva.");
                if(typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(r=>{if(r==='granted') window.addEventListener('deviceorientation', handleLevel)})
                        .catch(()=>announce("Permesso sensori negato."));
                } else {
                    window.addEventListener('deviceorientation', handleLevel);
                }
            } else {
                btn.classList.remove('active-tool'); btn.innerText = "LIVELLA"; 
                announce("Livella spenta.");
                window.removeEventListener('deviceorientation', handleLevel);
            }
        }
        
        function handleLevel(e) {
            if(Date.now()-lastSpeak<1500) return;
            const tilt = e.gamma || 0; 
            
            if(tilt > 10) { announce("Pende a destra"); vibrate(50); lastSpeak=Date.now(); }
            else if(tilt < -10) { announce("Pende a sinistra"); vibrate(50); lastSpeak=Date.now(); }
        }

        function toggleTorch() {
            if(!videoTrack) { announce("Fotocamera non pronta."); return; }
            const targetState = !torchActive;
            const btn = document.getElementById('btn-torch');

            videoTrack.applyConstraints({advanced:[{torch: targetState}]})
            .then(() => {
                torchActive = targetState; 
                if(torchActive) {
                     btn.classList.add('active-tool'); btn.innerText = "TORCIA: ON"; announce("Torcia accesa.");
                } else {
                     btn.classList.remove('active-tool'); btn.innerText = "TORCIA"; announce("Torcia spenta.");
                }
            })
            .catch(err => {
                console.warn("Errore torcia:", err);
                announce("Torcia non disponibile su questo dispositivo o in questa modalità.");
                torchActive = false;
                btn.classList.remove('active-tool'); btn.innerText = "TORCIA";
            });
        }

        function toggleDiscrete() {
            discreteMode = !discreteMode;
            const btn = document.getElementById('btn-discrete');
            if(discreteMode) { 
                btn.classList.add('active-discrete'); btn.innerText = "MODO DISCRETO: ON";
                vibrate([100,50,100]); 
            } else {
                btn.classList.remove('active-discrete'); btn.innerText = "MODO DISCRETO";
                announce("Modo discreto spento.");
            }
        }

        // --- UTILITIES GEMINI / FOTO ---
        function captureFrame() {
            if (tempCtx) {
                tempCtx.drawImage(video, 0, 0);
            }
            return tempCanvas.toDataURL('image/jpeg', 0.8).split(',')[1]; 
        }

        async function callGemini(prompt, b64) {
            if(!GEMINI_KEY) { 
                announce("Chiave API mancante."); 
                openSettings(); 
                return; 
            }
            let res;
            try {
                res = await fetch(`https://generativelanguage.googleapis.com/${API_ENDPOINT}/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        contents: [{ 
                            parts: [
                                { text: prompt }, 
                                { inline_data: { mime_type: "image/jpeg", data: b64 } }
                            ] 
                        }] 
                    })
                });
            } catch (e) {
                console.error("Errore di rete chiamando Gemini:", e);
                announce("Errore di rete durante la chiamata all'intelligenza artificiale. Controlla la connessione e riprova.");
                return;
            }

            let d;
            try {
                d = await res.json();
            } catch (e) {
                console.error("Errore parsing JSON Gemini:", e);
                announce("Risposta non valida dal server AI.");
                return;
            }

            if(!res.ok) {
                console.error("Errore HTTP Gemini:", res.status, d);
                const msg = d.error && d.error.message ? d.error.message : "Errore sconosciuto";
                announce("Errore API: " + msg);
                alert("ERRORE API (" + res.status + "): " + msg);
                return;
            }

            if(d.error) {
                console.error("Errore API Gemini:", d.error);
                announce("Errore API: " + d.error.message);
                alert("ERRORE API: " + d.error.message);
                return;
            }
            
            const candidates = d.candidates || [];
            const first = candidates[0];
            const parts = first?.content?.parts || [];
            const textParts = parts
                .map(p => typeof p.text === "string" ? p.text : "")
                .filter(Boolean);

            const text = textParts.join("\n\n").trim();

            if(!text) {
                console.warn("Nessun testo leggibile da Gemini:", d);
                announce("Non ho ricevuto una risposta comprensibile dall'AI.");
                return;
            }

            if(!discreteMode) {
                announce(text);
            } else {
                alert("RISPOSTA AI:\n" + text);
            }
        }

        function playShutter() { 
            if(!discreteMode && audioCtx){ 
                const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); 
                g.gain.value=0.1; o.frequency.value=600; 
                o.connect(g); g.connect(audioCtx.destination); 
                o.start(); o.stop(audioCtx.currentTime+0.1); 
            } 
        }

        // --- USA FOTO / MODIFICA E ANALIZZA / ELIMINA ---
        async function usePhoto() {
            if (!lastShotB64) {
                announce("Nessuna foto disponibile da usare.");
                return;
            }

            let shared = false;

            try {
                if (navigator.share) {
                    const blob = await (await fetch(`data:image/jpeg;base64,${lastShotB64}`)).blob();
                    const file = new File([blob], "foto-visione-ai.jpg", { type: "image/jpeg" });

                    const canShareFiles = !navigator.canShare || navigator.canShare({ files: [file] });

                    if (canShareFiles) {
                        await navigator.share({
                            title: "Scatto Visione AI",
                            text: "Foto scattata da Visione AI.",
                            files: [file]
                        });
                        shared = true;
                        announce("Finestra di condivisione aperta. Scegli l'app con cui vuoi inviare la foto.");
                    }
                }
            } catch (e) {
                console.warn("Condivisione non riuscita o annullata:", e);
            }

            if (!shared) {
                try {
                    const blob = await (await fetch(`data:image/jpeg;base64,${lastShotB64}`)).blob();
                    lastShotUrl = URL.createObjectURL(blob);
                    const link = document.getElementById('download-link');
                    link.href = lastShotUrl;
                    link.download = "scatto-visione-ai.jpg";
                    link.classList.remove('hidden');
                    announce("Questo dispositivo non supporta la condivisione diretta della foto. Usa il link 'Scarica la foto scattata' per salvarla e condividerla dall'app Foto.");
                } catch (e) {
                    console.error(e);
                    announce("Errore nel preparare la foto per la condivisione.");
                }
            }
        }

        async function editAndReviewPhoto() {
            if (!lastShotB64) {
                announce("Nessuna foto disponibile da modificare.");
                return;
            }

            const text = window.prompt("Testo da sovrapporre sulla foto, ad esempio una frase per la storia o il post:");
            if (!text || !text.trim()) {
                announce("Nessun testo inserito. Foto non modificata.");
                return;
            }

            const position = chooseTextPositionAutomatically();
            if (position === "alto") {
                announce("Ho posizionato il testo nella parte alta della foto, per non coprire il soggetto principale.");
            } else if (position === "centro") {
                announce("Ho posizionato il testo al centro, su una zona che sembra meno importante della scena.");
            } else {
                announce("Ho posizionato il testo nella parte bassa della foto, per non coprire il soggetto principale.");
            }

            announce("Creo una versione della foto con la scritta sovrapposta. Attendi.");
            try {
                const editedB64 = await createEditedPhoto(text.trim(), position);
                lastShotB64 = editedB64;
                const overlayPrompt = buildOverlayReviewPrompt();
                if (GEMINI_KEY) {
                    await callGemini(overlayPrompt, editedB64);
                    announce("Analisi della foto modificata completata. Puoi ora usare la foto oppure eliminarla.");
                } else {
                    announce("Foto modificata con il testo. Per analizzarla automaticamente, inserisci una chiave API nelle impostazioni.");
                }
            } catch (e) {
                console.error(e);
                announce("Errore nella modifica o analisi della foto. Riprova.");
            }
        }

        function deletePhoto() {
            lastShotB64 = null;
            if (lastShotUrl) {
                URL.revokeObjectURL(lastShotUrl);
                lastShotUrl = null;
            }

            const actions = document.getElementById('shot-actions');
            actions.classList.add('hidden');

            const dlLink = document.getElementById('download-link');
            dlLink.classList.add('hidden');
            dlLink.removeAttribute('href');
            dlLink.removeAttribute('download');

            announce("Foto eliminata. Sei tornata alla schermata principale. Puoi scattare una nuova foto quando vuoi.");
        }

        // --- PROMPT PER ANALISI DEL TESTO SOVRAPPOSTO ---
        function buildOverlayReviewPrompt() {
            return `
Osserva questa immagine con del testo sovrapposto, come se dovessi aiutare una persona non vedente a capire se la foto è pronta per essere pubblicata sui social.

Concentrati in modo molto preciso su cosa il riquadro di testo COPRE, anche solo in parte:
- elenca TUTTI gli elementi visivi che vengono coperti totalmente o parzialmente dal testo, anche se piccoli (ad esempio oggetti sul tavolo, dettagli sullo sfondo, parti di vestiti, mani, oggetti decorativi);
- per ogni elemento coperto, specifica se è coperto poco, in parte oppure in modo significativo;
- indica sempre la posizione di questi elementi (sinistra, destra, in alto, in basso, vicino, lontano).

Descrivi poi:
- dove si trova il riquadro di testo (in alto, al centro o in basso);
- quanto è grande rispetto all’intera immagine (piccolo, medio, molto grande, copre quasi tutta la foto);
- se il testo copre parti molto importanti dell’immagine, come volti, oggetto principale o zona centrale;
- se il testo è leggibile: contrasto tra colore del testo e sfondo, dimensione del carattere, eventuali parti tagliate.

Poi valuta se questa versione della foto, con il testo sopra, è adatta per essere condivisa sui social (storia o post):
- se l’immagine rimane ancora comprensibile,
- se il soggetto principale è ancora chiaramente riconoscibile,
- se la composizione generale rimane gradevole oppure se il testo è troppo invadente.

Se noti problemi concreti (ad esempio: il testo copre il volto, copre l’oggetto principale, copre piccoli dettagli importanti, è troppo grande, è poco leggibile):
- indica chiaramente qual è o quali sono i problemi principali;
- suggerisci da 1 a 3 azioni semplici per migliorare, ad esempio: “metti il testo più in alto”, “riduci la quantità di testo”, “usa meno righe”, “abbassa un po’ la fascia di testo”, “sposta il testo lontano dal volto o dall’oggetto principale”.

Se la foto con il testo è già ben bilanciata e non vedi problemi rilevanti, dillo esplicitamente e non inventare correzioni.

Organizza la risposta in tre parti:
1) Elementi coperti dal testo (anche piccoli), posizione e importanza;
2) Impatto sulla foto e sulla leggibilità del testo;
3) Suggerimenti pratici (solo se necessari).
`;
        }

        // --- SCELTA AUTOMATICA POSIZIONE TESTO ---
        function chooseTextPositionAutomatically() {
            if (!objectDetector || !video || video.readyState < 2) return "basso";

            try {
                const result = objectDetector.detectForVideo(video, performance.now());
                const detections = (result && result.detections) ? result.detections : [];
                if (!detections.length) {
                    return "basso";
                }

                const target = detections
                    .sort((a, b) => {
                        const boxA = a.boundingBox;
                        const boxB = b.boundingBox;
                        return (boxB.width * boxB.height) - (boxA.width * boxA.height);
                    })[0];

                const box = target.boundingBox;
                const cy = box.originY + box.height / 2;
                const h = canvas.height || video.videoHeight || 1;
                const rel = cy / h;

                if (rel < 0.4) return "basso";
                if (rel > 0.6) return "alto";
                return "alto";
            } catch (e) {
                console.warn("Errore scelta posizione testo:", e);
                return "basso";
            }
        }

        // --- DISEGNA TESTO SULLA FOTO ---
        function createEditedPhoto(text, position) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const c = document.createElement('canvas');
                    c.width = img.width;
                    c.height = img.height;
                    const cctx = c.getContext('2d');
                    cctx.drawImage(img, 0, 0);

                    const fontSize = Math.round(c.height * 0.05);
                    cctx.font = fontSize + "px system-ui, -apple-system, sans-serif";
                    cctx.textBaseline = "middle";
                    cctx.textAlign = "center";

                    const lines = text.split(/\r?\n/);
                    const lineHeight = fontSize * 1.3;

                    let maxWidth = 0;
                    lines.forEach(line => {
                        const w = cctx.measureText(line).width;
                        if (w > maxWidth) maxWidth = w;
                    });

                    const padding = fontSize * 0.6;
                    const boxWidth = maxWidth + padding * 2;
                    const boxHeight = lineHeight * lines.length + padding * 2;

                    const centerX = c.width / 2;
                    let boxY;

                    if (position === "alto") {
                        boxY = padding;
                    } else if (position === "centro") {
                        boxY = (c.height - boxHeight) / 2;
                    } else {
                        boxY = c.height - boxHeight - padding;
                    }

                    cctx.fillStyle = "rgba(0, 0, 0, 0.6)";
                    cctx.fillRect(centerX - boxWidth / 2, boxY, boxWidth, boxHeight);

                    cctx.fillStyle = "#FFFFFF";
                    lines.forEach((line, i) => {
                        const lineY = boxY + padding + i * lineHeight + lineHeight / 2;
                        cctx.fillText(line, centerX, lineY);
                    });

                    const b64 = c.toDataURL("image/jpeg", 0.9).split(",")[1];
                    resolve(b64);
                };
                img.onerror = reject;
                img.src = `data:image/jpeg;base64,${lastShotB64}`;
            });
        }

        // Palette Colori per Non Vedenti (nomi stabili)
        const colors={
            '0,0,0':'Nero','255,255,255':'Bianco','200,200,200':'Grigio Chiaro','80,80,80':'Grigio Scuro',
            '255,0,0':'Rosso','0,255,0':'Verde','0,0,255':'Blu','255,255,0':'Giallo',
            '0,255,255':'Azzurro','255,0,255':'Fucsia','165,42,42':'Marrone','255,165,0':'Arancione',
            '128,0,128':'Viola','245,245,220':'Beige','255,192,203':'Rosa'
        };
        
        function getColorName(r,g,b){ 
            let min=Infinity,res="Indefinito"; 
            for(let k in colors){ 
                const[cr,cg,cb]=k.split(',').map(Number); 
                const d=Math.sqrt((r-cr)**2*0.3 + (g-cg)**2*0.59 + (b-cb)**2*0.11); 
                if(d<min){min=d;res=colors[k];}
            } 
            return res;
        }

        // Mappe etichette rilevatore -> italiano
        const labelMap = {
            person: "una persona",
            face: "un volto",
            bottle: "una bottiglia",
            cup: "una tazza",
            book: "un libro",
            cellphone: "un telefono",
            laptop: "un portatile",
            chair: "una sedia",
            tv: "un televisore"
        };

        function labelToItalian(label) {
            if (!label) return "un oggetto";
            return labelMap[label] || "un oggetto";
        }

        // Settings Manager
        window.openSettings = () => { 
            document.getElementById('key-screen').classList.remove('hidden');
            const input = document.getElementById('key-input');
            input.value = GEMINI_KEY || "";
            announce("Impostazioni aperte.");
        };
        window.closeSettings = () => {
            document.getElementById('key-screen').classList.add('hidden');
            announce("Chiudo impostazioni.");
        };
        window.saveKey = () => { 
            const val = document.getElementById('key-input').value.trim();
            if(val.length > 10) {
                GEMINI_KEY=val; 
                localStorage.setItem('gemini_key',GEMINI_KEY); 
                closeSettings(); 
                announce("Chiave salvata."); 
            } else {
                announce("Chiave non valida.");
            }
        };

    </script>
</body>
</html>
