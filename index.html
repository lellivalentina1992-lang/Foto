<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Accessibile Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>

    <style>
        body { margin: 0; background: #000; color: #FFFF00; font-family: system-ui, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #status-bar { background: #FFFF00; color: #000; padding: 25px; font-weight: bold; font-size: 1.6rem; text-align: center; border-bottom: 5px solid #000; min-height: 150px; display: flex; align-items: center; justify-content: center; }
        #camera-view { flex: 1; background: #111; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; background: #000; }
        button { padding: 25px 5px; font-size: 1.1rem; font-weight: bold; text-transform: uppercase; border: 5px solid #FFFF00; background: #000; color: #FFFF00; border-radius: 20px; cursor: pointer; }
        button:active { background: #FFFF00; color: #000; }
        #btn-open-link { display: none; background: #0044cc; color: white; border-color: white; grid-column: span 2; }
        .full-width { grid-column: span 2; }
        .active-mode { background: #FFFF00 !important; color: #000 !important; }
        .btn-mute { background: #550000; color: white; border-color: white; }
    </style>
</head>
<body>

    <div id="status-bar" role="status" aria-live="assertive" aria-atomic="true">
        Attivazione sistemi...
    </div>

    <main id="camera-view">
        <video id="webcam" autoplay playsinline muted aria-hidden="true"></video>
    </main>

    <nav id="controls">
        <button id="btn-open-link">Apri Link Trovato</button>
        <button id="btn-auto" class="active-mode">Auto-Scan: ON</button>
        <button id="btn-mute">Pausa Voce</button>
        <button id="btn-switch" class="full-width">Cambia Camera</button>
        <button id="btn-light">Info Luce</button>
        <button id="btn-color">Colore</button>
        <button id="btn-money">Banconota</button>
        <button id="btn-ocr">Leggi Testo</button>
        <button id="btn-torch">Luce Flash</button>
        <button id="btn-zoom">Zoom</button>
        <button id="btn-copy">Copia</button>
        <button id="btn-history">Cronologia</button>
    </nav>

    <script>
        const video = document.getElementById('webcam');
        const statusDisplay = document.getElementById('status-bar');
        const btnAuto = document.getElementById('btn-auto');
        const btnMute = document.getElementById('btn-mute');
        const btnOpenLink = document.getElementById('btn-open-link');
        
        let track = null, ocrWorker = null, net = null;
        let lastResult = "", isProcessing = false;
        let autoMode = true, voiceMuted = false, lastAnnounced = "";
        let currentUrl = "", torchActive = false, currentFacingMode = "environment";
        let inactivityTimer = 0, lastObject = "";

        function comunica(messaggio, dato = "", tipo = "testo") {
            statusDisplay.textContent = messaggio;
            if (voiceMuted) return;
            if (dato && dato === lastAnnounced && tipo !== "colore" && tipo !== "luce" && tipo !== "torch") return;
            if (dato) {
                lastResult = dato;
                lastAnnounced = dato;
                localStorage.setItem('lastScan', dato);
                inactivityTimer = 0;
                if (tipo === "link") {
                    currentUrl = dato.startsWith('www') ? 'https://' + dato : dato;
                    btnOpenLink.style.display = "block";
                } else {
                    btnOpenLink.style.display = "none";
                }
            }
        }

        async function toggleTorch(forceState = null) {
            if (!track || currentFacingMode === "user") return;
            const capabilities = track.getCapabilities();
            if (!capabilities.torch) return;
            const newState = (forceState !== null) ? forceState : !torchActive;
            try {
                await track.applyConstraints({ advanced: [{ torch: newState }] });
                torchActive = newState;
                comunica(newState ? "Torcia accesa." : "Torcia spenta.", newState ? "on" : "off", "torch");
            } catch (e) {}
        }

        async function cercaProdotto(barcode) {
            if (!navigator.onLine) { comunica("Connessione assente."); return; }
            comunica("Ricerca prodotto in corso...");
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json?fields=product_name,brands,categories_tags`);
                const data = await response.json();
                if (data.status === 1) {
                    const p = data.product;
                    const cats = p.categories_tags ? p.categories_tags.join(' ') : "";
                    let sugg = ". Generalmente la scadenza è sulla confezione.";
                    if (cats.includes('biscuits')) sugg = ". Generalmente sui lati corti o sul fondo.";
                    else if (cats.includes('pastas')) sugg = ". Generalmente sulla cresta o sul retro.";
                    else if (cats.includes('dairy')) sugg = ". Generalmente sul coperchio.";
                    
                    let alertSic = (cats.includes('health') || cats.includes('drugs') || cats.includes('cleaning')) 
                        ? ". Attenzione: Prodotto sensibile. Verifica con un vedente prima dell'uso." : "";
                    
                    comunica(`Prodotto: ${p.product_name || "Ignoto"} ${p.brands || ""}${sugg}${alertSic}`, barcode, "testo");
                } else { comunica(`Codice: ${barcode}. Non trovato.`, barcode, "testo"); }
            } catch (e) { comunica("Errore database."); }
        }

        async function analizza(isManual = false) {
            if (isProcessing || !ocrWorker || !net) return;
            isProcessing = true;

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Luce automatica
            const pLuce = ctx.getImageData(canvas.width/2, canvas.height/2, 1, 1).data;
            const lum = (pLuce[0] + pLuce[1] + pLuce[2]) / 3 / 2.55;
            if (lum < 25 && currentFacingMode === "environment" && !torchActive) {
                await toggleTorch(true);
            }

            // Oggetti
            const predictions = await net.classify(video);
            if (predictions.length > 0) {
                const ogg = predictions[0].className.split(',')[0];
                if (ogg !== lastObject) { comunica("Vedo: " + ogg, ogg, "oggetto"); lastObject = ogg; }
            }

            // OCR
            if (isManual) comunica("Elaborazione foto...");
            try {
                const { data: { text, confidence, orientation_degrees } } = await ocrWorker.recognize(canvas);
                if (orientation_degrees === 180) comunica("Attenzione: Testo capovolto.");
                
                const money = text.match(/\b(5|10|20|50|100|200)\b/);
                if (money) comunica("Banconota da " + money[0] + " Euro", money[0], "testo");
                else if (text.trim().length > 3 && confidence > 50) {
                    comunica("Testo: " + text.trim().substring(0, 100), text.trim(), "testo");
                } else if (isManual) comunica("Nessun testo trovato.");
            } catch (e) {}
            isProcessing = false;
        }

        // Sensore Inclinazione
        window.addEventListener('deviceorientation', (e) => {
            if (Math.abs(e.beta) < 70 && Math.abs(e.beta) > 20 && inactivityTimer % 15 === 0) {
                comunica("Telefono inclinato. Tienilo parallelo alla superficie.");
            }
        });

        setInterval(() => {
            if (autoMode && !isProcessing) {
                inactivityTimer++;
                if (inactivityTimer > 150) {
                    autoMode = false;
                    btnAuto.classList.remove('active-mode');
                    comunica("Scanner in pausa per inattività.");
                } else { analizza(false); }
            }
        }, 2200);

        async function avviaCamera(mode) {
            if (track) track.stop();
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode, focusMode: "continuous" } });
                video.srcObject = stream;
                track = stream.getVideoTracks()[0];
                currentFacingMode = mode;
                comunica(mode === "environment" ? "Camera posteriore pronta." : "Camera selfie pronta.");
                
                if ('BarcodeDetector' in window) {
                    const detector = new BarcodeDetector();
                    setInterval(async () => {
                        const codes = await detector.detect(video);
                        if (codes.length > 0) {
                            const val = codes[0].rawValue;
                            if (val.includes('http')) comunica("Link trovato.", val, "link");
                            else cercaProdotto(val);
                        }
                    }, 1200);
                }
            } catch (err) { comunica("Errore camera."); }
        }

        btnAuto.onclick = () => { autoMode = !autoMode; btnAuto.classList.toggle('active-mode'); comunica(autoMode ? "Radar attivo." : "Radar spento."); };
        btnMute.onclick = () => { voiceMuted = !voiceMuted; btnMute.classList.toggle('btn-mute'); btnMute.textContent = voiceMuted ? "Voce: OFF" : "Pausa Voce"; };
        document.getElementById('btn-torch').onclick = () => toggleTorch();
        document.getElementById('btn-switch').onclick = () => avviaCamera(currentFacingMode === "environment" ? "user" : "environment");
        document.getElementById('btn-money').onclick = () => analizza(true);
        document.getElementById('btn-ocr').onclick = () => analizza(true);
        document.getElementById('btn-light').onclick = () => {
            const canvas = document.createElement('canvas'); canvas.width = 10; canvas.height = 10;
            const ctx = canvas.getContext('2d'); ctx.drawImage(video, 0, 0, 10, 10);
            const d = ctx.getImageData(5, 5, 1, 1).data;
            const l = (d[0] + d[1] + d[2]) / 3 / 2.55;
            comunica("Luce: " + (l < 15 ? "Buio" : l < 45 ? "Scarsa" : l < 85 ? "Buona" : "Accecante"));
        };
        document.getElementById('btn-color').onclick = () => comunica("Analisi colore... Punta l'oggetto.");
        document.getElementById('btn-copy').onclick = async () => { if (lastResult) { await navigator.clipboard.writeText(lastResult); comunica("Copiato."); } };
        document.getElementById('btn-history').onclick = () => comunica("Ultima: " + lastResult);
        btnOpenLink.onclick = () => { if (currentUrl) window.open(currentUrl, '_blank'); };

        window.onload = () => { 
            avviaCamera("environment"); 
            setTimeout(() => {
                comunica("Caricamento AI...");
                Tesseract.createWorker('ita', 1).then(w => { ocrWorker = w; mobilenet.load().then(m => { net = m; comunica("Sistema pronto."); }); });
            }, 1000); 
        };
    </script>
</body>
</html>