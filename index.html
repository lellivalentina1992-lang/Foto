<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Visione AI Fusion - V24 Windows Fix</title>
<style>
/* STILE GENERALE */
body{font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:0;padding:0;background:#000;color:#fff;height:100vh;display:flex;flex-direction:column;overflow:hidden}
.sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)}

/* VIDEO */
#cam-container{position:relative;flex-grow:1;width:100%;background:#111;display:flex;justify-content:center;align-items:center}
video{width:100%;height:100%;object-fit:cover;opacity:.6}
canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}

/* STATUS VOCALE */
#voice-status{position:absolute;top:10px;right:10px;padding:5px 10px;border-radius:20px;background:rgba(0,0,0,0.7);border:1px solid #555;font-size:0.8rem;z-index:60;display:none}
.listening{border-color:#0f0!important;color:#0f0!important}

/* INTERFACCIA */
#main-interface{height:65vh;width:100%;background:#000;border-top:4px solid #333;position:relative;display:flex;flex-direction:column}
#camera-controls{flex-grow:1;width:100%;display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:min-content;gap:10px;padding:10px;box-sizing:border-box;overflow-y:auto}

/* UTILIT√Ä */
.full-width { grid-column: 1 / -1; }
.top-bar{display:flex;gap:10px;width:100%}

/* RISULTATO */
#result-screen{height:100%;width:100%;display:flex;flex-direction:column;padding:15px;box-sizing:border-box;background:#111;position:absolute;top:0;left:0;z-index:50}
#result-content{flex-grow:1;overflow-y:auto;margin-bottom:15px;padding:15px;border:1px solid #555;border-radius:8px;background:#000;font-size:1.3rem;line-height:1.5;color:#fff;white-space:pre-wrap}
.result-actions{display:flex;flex-wrap:wrap;gap:10px;flex-shrink:0;min-height:70px}

/* PULSANTI */
button{border:2px solid #555;border-radius:12px;font-size:1rem;font-weight:bold;text-transform:uppercase;color:#fff;background:#222;cursor:pointer;min-height:60px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;touch-action:manipulation}
button:active{background:#555;transform:scale(.98)}
.small-btn{flex:1;font-size:.9rem;background:#111;border:1px solid #444;color:#ccc;min-width: 80px;}

/* COLORI */
#btn-voice{background:#00008B;border-color:#4169E1} 
#btn-guide{border: 2px solid #fff; background: #002200; font-size: 1.1rem;}
#btn-find{background:#2F4F4F;border-color:#008080;color:#fff}
#btn-custom{background:#4B0082;border-color:#DA70D6}
#btn-scene{background:#D4AF37;color:#000}
#btn-text{background:#fff;color:#000}
.active-tool{background:#006400!important;border-color:#0f0!important}
.guiding{background:#8B0000!important;border-color:#f00!important}
.searching{background:#DAA520!important;border-color:#FFD700!important;color:#000!important}
.active-discrete{border-color:#f00;color:#f00}

/* STILE SOCIAL */
.btn-social-check { background: #E1306C !important; border-color: #fff !important; color: #fff !important; width: 100%; margin-bottom: 5px; }
.btn-add-text { background: #833AB4 !important; border-color: #fff !important; width: 100%; margin-bottom: 5px; }

/* OVERLAY AVVIO */
.overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;z-index:100;display:flex;flex-direction:column;justify-content:center;align-items:center}
.hidden{display:none!important}
.loader{border:6px solid #333;border-top:6px solid #D4AF37;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin-bottom:20px}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
input{background:#333;color:#fff;border:1px solid #777}
#download-link{text-align:center;font-size:.9rem;color:#D4AF37;text-decoration:underline;margin-bottom:10px}
</style>
</head>
<body>
<div id="sr-announcer" class="sr-only" aria-live="assertive" role="status"></div>

<div id="cam-container">
  <video id="webcam" playsinline muted autoplay></video>
  <canvas id="overlay"></canvas>
  <div id="voice-status">üé§ Ascolto...</div>
</div>

<div id="main-interface" class="hidden" aria-hidden="true">
  <div id="camera-controls">
    
    <button class="full-width" id="btn-find" onclick="manualFind()" aria-label="Cerca un oggetto specifico ignorando gli altri.">üîç CERCA OGGETTO (MANUALE)</button>

    <div class="full-width" style="height:1px;background:#333;margin:5px 0"></div>

    <button class="full-width" id="btn-guide" onclick="toggleGuidance()" aria-label="Attiva guida scena live.">GUIDA SCENA LIVE</button>
    
    <div class="top-bar full-width">
       <button class="small-btn" id="btn-shot" onclick="startCountdown()" aria-label="Scatta foto (Timer 5s)">SCATTA (5s)</button>
       <button class="small-btn" onclick="flipCamera()" aria-label="Ruota fotocamera">RUOTA CAMERA</button>
    </div>

    <div class="full-width" style="height:1px;background:#333;margin:5px 0"></div>
    
    <button id="btn-scene"  onclick="describeWithMode('scene')"  aria-label="Scena">SCENA GENERALE</button>
    <button id="btn-text"   onclick="describeWithMode('text')"   aria-label="Testo">TESTO</button>
    <button id="btn-object" onclick="describeWithMode('object')" aria-label="Oggetto">OGGETTO</button>
    <button id="btn-selfie" onclick="describeWithMode('selfie')" aria-label="Selfie">SELFIE</button>
    
    <button id="btn-custom" class="full-width" onclick="askCustomDetail()" aria-label="Chiedi dettaglio">CHIEDI DETTAGLIO</button>

    <div class="full-width" style="height:1px;background:#333;margin:5px 0"></div>
    <div class="top-bar full-width">
      <button class="small-btn" id="btn-light" onclick="toggleLight()" aria-label="Sonda luce">LUCE</button>
      <button class="small-btn" id="btn-color" onclick="toggleColor()" aria-label="Colore">COLORE</button>
      <button class="small-btn" id="btn-level" onclick="toggleLevel()" aria-label="Livella">LIVELLA</button>
    </div>

    <div class="top-bar full-width" style="margin-top:10px">
      <button class="small-btn" id="btn-discrete" onclick="toggleDiscrete()" aria-label="Modo discreto">MODO DISCRETO</button>
      <button class="small-btn" id="btn-voice" onclick="toggleVoiceControl()" aria-label="Comandi vocali opzionali">COMANDI VOCALI (OPZ)</button>
      <button class="small-btn" onclick="openSettings()" aria-label="Impostazioni">IMPOSTAZIONI</button>
    </div>
  </div>

  <div id="result-screen" class="hidden" aria-hidden="true" inert role="main">
    <h2 style="margin:0 0 10px;color:#D4AF37;font-size:1.1rem">Risultato Analisi</h2>
    <div id="result-content" tabindex="0">In attesa...</div>
    <a id="download-link" href="#" class="hidden">Scarica foto</a>
    
    <div class="result-actions" id="action-buttons">
      </div>
  </div>
</div>

<div id="start-screen" class="overlay">
  <h1 style="color:#fff;margin-bottom:20px" aria-hidden="true">Visione AI</h1>
  <div id="loader" class="loader hidden"></div>
  <div id="load-msg" class="hidden" style="color:#fff;font-size:1.2rem">Avvio sensori...</div>
  <button id="btn-start" onclick="startApp()" style="padding:40px;font-size:1.8rem;background:#D4AF37;color:#000;border-radius:15px;width:95%;border:4px solid #fff;font-weight:bold">AVVIA SISTEMA</button>
</div>

<div id="key-screen" class="overlay hidden" aria-hidden="true" inert>
  <h2 style="color:#fff">Chiave Gemini API</h2>
  <input type="text" id="key-input" placeholder="Incolla chiave qui..." style="width:80%;padding:15px;font-size:1.2rem;margin-bottom:20px;border-radius:8px">
  <button onclick="saveKey()" style="padding:15px;background:#fff;color:#000;width:50%;font-weight:bold;border-radius:8px;margin-bottom:10px">SALVA</button>
  <button onclick="closeSettings()" style="padding:15px;background:#333;color:#fff;width:50%;border-radius:8px">CHIUDI</button>
</div>

<script>
let GEMINI_KEY=localStorage.getItem('gemini_key')||"";
const MODEL_NAME="gemini-2.0-flash-exp"; const API_ENDPOINT="v1beta";

let audioCtx,lightOsc,lightGain,objectDetector=null,isRunning=false,stream=null;
const tempCanvas=document.createElement('canvas');let tempCtx=null;
let mode='idle',lightActive=false,colorActive=false,levelActive=false,discreteMode=false;
let lastSpeak=0,centeredCount=0,lastGuideMessage="",lastGuideMessageTime=0;
let lastLowLightWarning=0; 
let lastLightAnnounce=0; 
let currentFacingMode='environment'; 
const video=document.getElementById('webcam'),canvas=document.getElementById('overlay'),ctx=canvas.getContext('2d');
let lastShotB64=null;
let targetClass = null;
let hasPerformedSocialCheck = false;

const objectDict = {
    'person': 'Persona', 'cup': 'Tazza', 'chair': 'Sedia', 'bottle': 'Bottiglia', 
    'cell phone': 'Cellulare', 'laptop': 'Computer', 'book': 'Libro', 
    'tv': 'TV', 'potted plant': 'Pianta', 'keyboard': 'Tastiera', 
    'mouse': 'Mouse', 'remote': 'Telecomando', 'dining table': 'Tavolo',
    'cat': 'Gatto', 'dog': 'Cane', 'bowl': 'Ciotola', 'car': 'Auto', 
    'bicycle': 'Bici', 'motorcycle': 'Moto', 'bed': 'Letto', 'couch': 'Divano', 
    'toilet': 'WC', 'vase': 'Vaso', 'suitcase': 'Valigia', 'backpack': 'Zaino'
};

// GESTIONE VOCALE
let recognition=null, voiceActive=false;
if('webkitSpeechRecognition' in window){
    recognition=new webkitSpeechRecognition();
    recognition.continuous=true;recognition.interimResults=false;recognition.lang='it-IT';
    recognition.onresult=(e)=>{
        const t=e.results[e.results.length-1][0].transcript.trim().toLowerCase();
        if(t.includes("scatta")) startCountdown();
        else if(t.includes("stop")||t.includes("basta")) {
             if(targetClass) manualFind(); 
             else if(mode==='guiding') toggleGuidance();
             announce("Stop.");
        }
    };
    recognition.onerror=(e)=>{if(voiceActive)setTimeout(()=>recognition.start(),1000);};
}

function toggleVoiceControl(){
    if(!recognition){announce("Non supportato.");return;}
    voiceActive=!voiceActive;
    const b=document.getElementById('btn-voice');
    if(voiceActive){
        recognition.start();
        b.classList.add('active-tool');b.innerText="üéôÔ∏è VOCE: ON";
        announce("Voce attiva.");
    }else{
        recognition.stop();
        b.classList.remove('active-tool');b.innerText="COMANDI VOCALI (OPZ)";
        announce("Voce spenta.");
    }
}

function manualFind(){
    const b = document.getElementById('btn-find');
    if(targetClass){
        targetClass = null;
        b.innerText = "üîç CERCA OGGETTO (MANUALE)";
        b.classList.remove('searching');
        announce("Ricerca terminata.");
        return;
    }
    const input = prompt("Scrivi cosa cercare:");
    if(!input) return;
    const query = input.trim().toLowerCase();
    let foundKey = null; let foundName = "";
    for(let [eng, ita] of Object.entries(objectDict)){
        if(ita.toLowerCase() === query || eng === query){ foundKey = eng; foundName = ita; break; }
    }
    if(foundKey){
        targetClass = foundKey;
        b.innerText = "‚ùå STOP RICERCA: " + foundName.toUpperCase();
        b.classList.add('searching');
        announce("Ok, cerco: " + foundName);
        if(mode !== 'guiding') toggleGuidance();
    } else {
        announce("Oggetto non riconosciuto.");
    }
}

function announce(t){if(!discreteMode){const e=document.getElementById('sr-announcer');e.textContent="";setTimeout(()=>e.textContent=t,50);}}
function vibrate(p){if(navigator.vibrate)navigator.vibrate(p);}

function showCameraOnly(){
  document.getElementById('result-screen').classList.add('hidden');document.getElementById('result-screen').setAttribute('aria-hidden','true');document.getElementById('result-screen').setAttribute('inert','');
  document.getElementById('camera-controls').classList.remove('hidden');document.getElementById('camera-controls').removeAttribute('aria-hidden');document.getElementById('camera-controls').removeAttribute('inert');
  setTimeout(()=>document.getElementById('btn-scene').focus(),200);
}
function showResultOnly(text){
  document.getElementById('camera-controls').classList.add('hidden');document.getElementById('camera-controls').setAttribute('aria-hidden','true');document.getElementById('camera-controls').setAttribute('inert','');
  document.getElementById('result-screen').classList.remove('hidden');document.getElementById('result-screen').removeAttribute('aria-hidden');document.getElementById('result-screen').removeAttribute('inert');
  const c=document.getElementById('result-content');c.textContent=text||"";setTimeout(()=>c.focus(),200);
  renderResultButtons(); 
}

// GESTIONE PULSANTI DINAMICI
function renderResultButtons(){
    const container = document.getElementById('action-buttons');
    container.innerHTML = ''; 

    // 1. Social Validator
    if(!hasPerformedSocialCheck){
        const btnSocial = document.createElement('button');
        btnSocial.className = 'btn-social-check';
        btnSocial.innerText = 'üîç VALIDATOR SOCIAL DETTAGLIATO';
        btnSocial.onclick = performSocialCheck;
        container.appendChild(btnSocial);
    } 
    // 2. Aggiungi Testo
    else {
        const btnText = document.createElement('button');
        btnText.className = 'btn-add-text';
        btnText.innerText = '‚úèÔ∏è AGGIUNGI SCRITTA AI';
        btnText.onclick = startTextAddition;
        container.appendChild(btnText);
    }

    const btnUse = document.createElement('button');
    btnUse.className = 'small-btn';
    btnUse.style.background = '#004080';
    btnUse.innerText = 'USA / SALVA';
    btnUse.onclick = usePhoto;
    container.appendChild(btnUse);

    const btnReview = document.createElement('button');
    btnReview.className = 'small-btn';
    btnReview.innerText = 'CHIEDI ANCORA';
    btnReview.onclick = editAndReviewPhoto;
    container.appendChild(btnReview);

    const btnDel = document.createElement('button');
    btnDel.className = 'small-btn';
    btnDel.style.background = '#8B0000';
    btnDel.innerText = 'ELIMINA';
    btnDel.onclick = deletePhoto;
    container.appendChild(btnDel);
}

async function setupCamera(facing){
    if(stream) stream.getTracks().forEach(t=>t.stop());
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facing, width: { ideal: 1280 }, height: { ideal: 720 } } });
        video.srcObject = stream; await video.play();
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        tempCanvas.width = video.videoWidth; tempCanvas.height = video.videoHeight;
    } catch(e) { announce("Errore fotocamera."); }
}
async function flipCamera(){
    currentFacingMode=(currentFacingMode==='environment')?'user':'environment';
    vibrate(50); await setupCamera(currentFacingMode);
    announce(currentFacingMode==='user'?"Frontale." : "Posteriore.");
}
function captureFrame(){
  if(video.videoWidth>0&&(tempCanvas.width!==video.videoWidth)){tempCanvas.width=video.videoWidth;tempCanvas.height=video.videoHeight;}
  if(tempCtx)tempCtx.drawImage(video,0,0,tempCanvas.width,tempCanvas.height);
  return tempCanvas.toDataURL('image/jpeg',0.8).split(',')[1];
}

async function startCountdown(andAnalyzeMode = null) {
    if(mode==='guiding') toggleGuidance(); 
    announce("5"); vibrate(50); await new Promise(r => setTimeout(r, 1000));
    announce("4"); vibrate(50); await new Promise(r => setTimeout(r, 1000));
    announce("3"); vibrate(50); await new Promise(r => setTimeout(r, 1000));
    announce("2"); vibrate(50); await new Promise(r => setTimeout(r, 1000));
    announce("1"); vibrate(50); await new Promise(r => setTimeout(r, 1000));
    announce("Click"); playShutter(); vibrate(200);
    lastShotB64 = captureFrame();
    hasPerformedSocialCheck = false; 
    
    // --- MODIFICA WINDOWS: Salvataggio automatico ---
    const filename = "foto_visione_" + Date.now() + ".jpg";
    const dLink = document.getElementById('download-link');
    dLink.href = "data:image/jpeg;base64,"+lastShotB64;
    dLink.download = filename;
    dLink.classList.remove('hidden');
    dLink.click(); // Questo forza il download sul PC
    // ------------------------------------------------

    if(andAnalyzeMode) processAnalysis(andAnalyzeMode);
    else announce("Foto salvata.");
}
async function takeShot(){ await startCountdown(); }

function playShutter(){
  if(!discreteMode&&audioCtx){
    if(audioCtx.state==='suspended')audioCtx.resume();
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    g.gain.value=0.1;o.frequency.value=600;o.connect(g);g.connect(audioCtx.destination);
    o.start();o.stop(audioCtx.currentTime+0.1);
  }
}

function toggleGuidance(){
  if(!objectDetector){announce("Non pronto.");return;}
  const b=document.getElementById('btn-guide');vibrate(50);
  if(mode==='guiding'){
    mode='idle';b.classList.remove('guiding');b.innerText="GUIDA SCENA LIVE";
    ctx.clearRect(0,0,canvas.width,canvas.height);announce("Guida spenta.");
    if(targetClass) manualFind(); 
  }else{
    mode='guiding';centeredCount=0;lastGuideMessage="";
    b.classList.add('guiding');b.innerText="GUIDA ATTIVA";announce("Guida attiva.");
  }
}

function processGuidance(){
  if(tempCtx && Date.now() - lastLowLightWarning > 8000) {
      const size = 100; 
      const startX = Math.max(0, tempCanvas.width/2 - size/2);
      const startY = Math.max(0, tempCanvas.height/2 - size/2);
      const p = tempCtx.getImageData(startX, startY, size, size).data;
      let total = 0, count = 0;
      for(let i=0; i<p.length; i+=40) { total += (p[i] + p[i+1] + p[i+2]) / 3; count++; }
      if((total / count) < 40) { announce("Luce insufficiente."); lastLowLightWarning = Date.now(); }
  }

  if(!objectDetector||video.readyState<2)return;

  try{
    const r=objectDetector.detectForVideo(video,performance.now()),d=r?r.detections:[];
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    let relevantObjects = [];
    if(targetClass) {
        relevantObjects = d.filter(o => o.categories[0].categoryName === targetClass);
        if(relevantObjects.length === 0 && d.length > 0 && Date.now() - lastGuideMessageTime > 3000) {
             const visible = d.slice(0,2).map(o=> objectDict[o.categories[0].categoryName] || o.categories[0].categoryName).join(", ");
             announce("Cerco " + objectDict[targetClass] + " ma vedo solo: " + visible);
             lastGuideMessageTime = Date.now();
             return;
        } else if(relevantObjects.length === 0) return;
    } else {
        relevantObjects = d;
    }

    if(!relevantObjects.length){
        if(Date.now()-lastGuideMessageTime>4000){announce("Scena vuota.");lastGuideMessageTime=Date.now();}
        return;
    }

    const rx=canvas.width/video.videoWidth, ry=canvas.height/video.videoHeight;
    relevantObjects.forEach(obj => {
        const b = obj.boundingBox;
        ctx.strokeStyle = targetClass ? "#FFD700" : "#0f0"; 
        ctx.lineWidth=4;
        ctx.strokeRect(b.originX*rx, b.originY*ry, b.width*rx, b.height*ry);
    });

    const now=Date.now();
    if (now - lastGuideMessageTime > 2000) { 
        const sorted = relevantObjects.sort((a,b)=>b.boundingBox.width*b.boundingBox.height - a.boundingBox.width*a.boundingBox.height);
        const mainObj = sorted[0]; 
        const box = mainObj.boundingBox;
        const imgW = video.videoWidth;
        const xMin = box.originX; const xMax = box.originX + box.width;
        const cx = (xMin + xMax) / 2 / imgW; 
        const widthPct = box.width / imgW; 
        
        const rawName = mainObj.categories[0].categoryName;
        const mainName = objectDict[rawName] || rawName;

        let msg = "";
        const LIMIT_LEFT = 0.35; const LIMIT_RIGHT = 0.65;
        const isSelfie = (currentFacingMode === 'user');
        const txtLeft = isSelfie ? "Sposta a Destra" : "Ruota a Sinistra";
        const txtRight = isSelfie ? "Sposta a Sinistra" : "Ruota a Destra";

        if (xMin < (imgW * 0.01)) msg = mainName + " tagliato! " + txtLeft;
        else if (xMax > (imgW * 0.99)) msg = mainName + " tagliato! " + txtRight;
        else if (widthPct < 0.20) msg = mainName + " lontano. Avvicinati."; 
        else {
            if (cx < LIMIT_LEFT) msg = txtLeft; 
            else if (cx > LIMIT_RIGHT) msg = txtRight; 
            else {
                msg = mainName + " Centrato. Ferma.";
                if(navigator.vibrate) navigator.vibrate([50, 50, 50]); 
            }
        }
        announce(msg); 
        lastGuideMessageTime = now;
    }
  }catch(e){ console.error(e); }
}

function toggleLight(){
  lightActive=!lightActive;const b=document.getElementById('btn-light');vibrate(50);
  if(lightActive){
    if(audioCtx.state==='suspended')audioCtx.resume();
    lightOsc=audioCtx.createOscillator();lightGain=audioCtx.createGain();
    lightOsc.connect(lightGain);lightGain.connect(audioCtx.destination);
    lightGain.gain.value=0;lightOsc.start();
    lastLightAnnounce = Date.now();
    b.classList.add('active-tool');b.innerText="LUCE: ON";announce("Luce on.");
  }else{
    if(lightOsc){lightOsc.stop();lightOsc.disconnect();}
    b.classList.remove('active-tool');b.innerText="SONDA LUCE";announce("Luce off.");
  }
}
function processLight(){
  if(!tempCtx)return;
  const p=tempCtx.getImageData(tempCanvas.width/2-10,tempCanvas.height/2-10,20,20).data;
  let s=0; for(let i=0;i<p.length;i+=4)s+=(p[i]+p[i+1]+p[i+2])/3;
  const level=s/(p.length/4); 
  if(lightOsc){
      lightGain.gain.setTargetAtTime(0.02+(level/255)*0.1,audioCtx.currentTime,0.1);
      lightOsc.frequency.setTargetAtTime(100+level*4,audioCtx.currentTime,0.1);
      if(Date.now() - lastLightAnnounce > 3000) {
          const percent = Math.round((level/255)*100);
          announce("Luce " + percent + " percento");
          lastLightAnnounce = Date.now();
      }
  }
}
function toggleColor(){
  colorActive=!colorActive;const b=document.getElementById('btn-color');vibrate(50);
  if(colorActive){b.classList.add('active-tool');b.innerText="COLORE: ON";announce("Colore on.");}
  else{b.classList.remove('active-tool');b.innerText="SONDA COLORE";announce("Colore off.");}
}
function processColor(){
  if(Date.now()-lastSpeak<2000)return;
  const size = 20;
  const p = tempCtx.getImageData(tempCanvas.width/2 - size/2, tempCanvas.height/2 - size/2, size, size).data;
  let rT=0, gT=0, bT=0;
  for(let i=0; i<p.length; i+=4) { rT += p[i]; gT += p[i+1]; bT += p[i+2]; }
  const count = p.length/4; const r = rT/count; const g = gT/count; const b = bT/count;
  if(r<30&&g<30&&b<30){announce("Nero");lastSpeak=Date.now();return;}
  if(r>220&&g>220&&b>220){announce("Bianco");lastSpeak=Date.now();return;}
  const colors={'Rosso':[255,0,0],'Verde':[0,255,0],'Blu':[0,0,255],'Giallo':[255,255,0],'Arancione':[255,165,0],'Grigio':[128,128,128]};
  let min=Infinity,res="Indefinito";
  for(let k in colors){const c=colors[k],d=Math.sqrt((r-c[0])**2+(g-c[1])**2+(b-c[2])**2);if(d<min){min=d;res=k;}}
  announce(res);lastSpeak=Date.now();
}
function toggleLevel(){
  const b=document.getElementById('btn-level');vibrate(50);
  if(levelActive){
     levelActive=false;b.classList.remove('active-tool');b.innerText="LIVELLA";
     announce("Livella off.");window.removeEventListener('deviceorientation',handleLevel);
  }else{
     const enable=()=>{levelActive=true;b.classList.add('active-tool');b.innerText="LIVELLA: ON";announce("Livella on.");window.addEventListener('deviceorientation',handleLevel)};
     if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
         DeviceOrientationEvent.requestPermission().then(r=>{if(r==='granted')enable();}).catch(()=>{});
     }else enable();
  }
}
function handleLevel(e){
  if(!levelActive||Date.now()-lastSpeak<1500)return;
  const t=e.gamma||0;
  if(t>10){announce("Destra");vibrate(20);lastSpeak=Date.now();}
  else if(t<-10){announce("Sinistra");vibrate(20);lastSpeak=Date.now();}
}
function toggleDiscrete(){discreteMode=!discreteMode;document.getElementById('btn-discrete').classList.toggle('active-discrete');vibrate(200);if(!discreteMode)announce("Voce attiva.");}

async function callGemini(prompt,b64){
  try{
    const r=await fetch(`https://generativelanguage.googleapis.com/${API_ENDPOINT}/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:prompt},{inline_data:{mime_type:"image/jpeg",data:b64}}]}]})});
    if(!r.ok)return null;const d=await r.json();return d.candidates?.[0]?.content?.parts?.map(p=>p.text).join("\n").trim()||"Nessun testo.";
  }catch(e){return null;}
}

// ----------------------------------------------------
// LOGICA SOCIAL & AI DIRECTOR
// ----------------------------------------------------

function buildPrompt(mode){
  let basePrompt = `
  Sei un assistente visivo per un non vedente.
  PRIMA di tutto, valida la foto.
  
  1. VERDETTO RAPIDO (Obbligatorio):
  - "‚úÖ FOTO VALIDA" (Se soggetto intero, anche se decentrato).
  - "‚ùå FOTO NON VALIDA: [Motivo]" (Se tagliato, sfocato, disordine grave).

  2. DESCRIZIONE:
  `;
  if(mode === 'text') basePrompt += `- Leggi tutto il testo visibile.`;
  else if(mode === 'object') basePrompt += `- Descrivi l'oggetto principale.`;
  else if(mode === 'selfie') basePrompt += `- Descrivi espressione e vestiti.`;
  else basePrompt += `- Descrivi la scena.`;
  return basePrompt;
}

// 1. ANALISI SOCIAL
async function performSocialCheck(){
    announce("Analisi Social in corso...");
    const prompt = `
    Analizza questa foto per i Social Media (Instagram/TikTok).
    Considera le zone di interfaccia (pulsanti in basso, nome profilo in alto).

    1. VERDETTO STORIE (9:16): 
       - Ci sono elementi importanti ai bordi che verrebbero coperti dall'interfaccia?
    
    2. VERDETTO POST (4:5 o 1:1):
       - Se la foto viene ritagliata quadrata, il soggetto si salva?
    
    3. SPAZI SICURI ("Safe Zones"):
       - Dove c'√® spazio vuoto per aggiungere testo senza coprire il volto? (Es. "C'√® spazio in alto a destra").
    `;
    
    showResultOnly("Analisi Social...");
    const text = await callGemini(prompt, lastShotB64);
    
    document.getElementById('result-content').textContent = "--- ANALISI SOCIAL ---\n" + text;
    hasPerformedSocialCheck = true; 
    renderResultButtons(); 
    announce("Report Social pronto. Puoi aggiungere testo.");
}

// 2. AGGIUNTA TESTO CON AI DIRECTOR E WORD WRAP
async function startTextAddition(){
    const textToAdd = prompt("Cosa vuoi scrivere sulla foto?");
    if(!textToAdd) return;

    announce("Chiedo all'AI dove metterlo...");
    
    const placementPrompt = `
    L'utente vuole scrivere: "${textToAdd}".
    Guarda la foto. Devi decidere la posizione MIGLIORE per questo testo in modo che:
    1. NON copra il volto o dettagli importanti.
    2. Sia ben leggibile (su sfondo uniforme).
    3. Sia esteticamente bilanciato.

    Rispondi SOLO con uno di questi codici:
    - TOP_CENTER (Alto centro)
    - BOTTOM_CENTER (Basso centro)
    - TOP_LEFT (Alto sinistra)
    - TOP_RIGHT (Alto destra)
    - CENTER (Centro esatto)
    `;

    const positionCode = await callGemini(placementPrompt, lastShotB64);
    if(!positionCode) { announce("Errore AI."); return; }
    
    const cleanCode = positionCode.trim().toUpperCase();
    let pos = 'BOTTOM_CENTER'; 
    if(cleanCode.includes('TOP_CENTER')) pos = 'TOP_CENTER';
    else if(cleanCode.includes('TOP_LEFT')) pos = 'TOP_LEFT';
    else if(cleanCode.includes('TOP_RIGHT')) pos = 'TOP_RIGHT';
    else if(cleanCode.includes('BOTTOM')) pos = 'BOTTOM_CENTER';
    else if(cleanCode.includes('CENTER')) pos = 'CENTER';

    drawTextOnCanvas(textToAdd, pos);
}

function drawTextOnCanvas(text, position){
    const img = new Image();
    img.onload = function(){
        const c = document.createElement('canvas');
        c.width = img.width; c.height = img.height;
        const ctx = c.getContext('2d');
        ctx.drawImage(img, 0, 0);
        
        // Setup Font
        const fontSize = c.width * 0.06; // 6% width
        ctx.font = `bold ${fontSize}px Arial`;
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 4;
        
        // WORD WRAP LOGIC
        const maxWidth = c.width * 0.8; // Max 80% larghezza foto
        const words = text.split(' ');
        let line = '';
        let lines = [];
        
        for(let n = 0; n < words.length; n++) {
          let testLine = line + words[n] + ' ';
          let metrics = ctx.measureText(testLine);
          let testWidth = metrics.width;
          if (testWidth > maxWidth && n > 0) {
            lines.push(line);
            line = words[n] + ' ';
          } else {
            line = testLine;
          }
        }
        lines.push(line);

        // Calcolo coordinate Y
        let x = c.width / 2;
        let startY = c.height - (lines.length * fontSize * 1.5) - 50; // Default bottom

        if(position === 'TOP_CENTER') { startY = 100 + fontSize; }
        else if(position === 'TOP_LEFT') { x = c.width * 0.25; startY = 100 + fontSize; }
        else if(position === 'TOP_RIGHT') { x = c.width * 0.75; startY = 100 + fontSize; }
        else if(position === 'CENTER') { startY = (c.height/2) - ((lines.length * fontSize)/2); }
        
        // Disegno righe
        for(let i = 0; i<lines.length; i++){
            ctx.strokeText(lines[i], x, startY + (i * fontSize * 1.2));
            ctx.fillText(lines[i], x, startY + (i * fontSize * 1.2));
        }

        lastShotB64 = c.toDataURL('image/jpeg', 0.9).split(',')[1];
        
        // MODIFICA WINDOWS: Forziamo download anche dopo modifica testo
        const dLink = document.getElementById('download-link');
        const filename = "foto_visione_edit_" + Date.now() + ".jpg";
        dLink.href = "data:image/jpeg;base64,"+lastShotB64;
        dLink.download = filename;
        dLink.click(); // Scarica subito la versione modificata
        
        reAnalyzeAfterEdit(position);
    };
    img.src = "data:image/jpeg;base64," + lastShotB64;
}

async function reAnalyzeAfterEdit(posName){
    announce("Testo aggiunto. Controllo finale...");
    const prompt = `Ho aggiunto il testo alla foto. Conferma che sia leggibile e non copra nulla. Descrivi il risultato finale.`;
    const text = await callGemini(prompt, lastShotB64);
    document.getElementById('result-content').textContent = "--- FOTO MODIFICATA ---\n" + text;
    announce("Foto modificata pronta.");
}

async function describeWithMode(c){
  if(!GEMINI_KEY){announce("Manca chiave.");openSettings();return;}
  if(c === 'selfie' && currentFacingMode !== 'user') {
      await flipCamera(); setTimeout(() => startCountdown(c), 1000); return;
  }
  await startCountdown(c); 
}
async function processAnalysis(c){
  showResultOnly("Analisi...");announce("Analisi AI in corso...");
  const t=await callGemini(buildPrompt(c),lastShotB64);
  document.getElementById('result-content').textContent=t||"Errore connessione.";vibrate(200);announce("Risultato pronto.");
}
async function askCustomDetail(){
  if(!GEMINI_KEY){announce("Manca chiave.");openSettings();return;}
  await captureNewShot(); 
  const q=prompt("Domanda sulla scena?");if(!q){announce("Annullato.");return;}
  showResultOnly("Cerco...");announce("Analizzo...");
  const t=await callGemini("Domanda: \""+q+"\". Valida foto poi rispondi.",lastShotB64);
  document.getElementById('result-content').textContent="D: "+q+"\n\nR: "+(t||"Errore.");vibrate(200);announce("Risultato pronto.");
}
async function editAndReviewPhoto(){
   if(!lastShotB64)return;const q=prompt("Altra domanda?");if(!q)return;
   announce("Analizzo...");const t=await callGemini("Domanda: \""+q+"\".",lastShotB64);
   document.getElementById('result-content').textContent+="\n\n================\nD: "+q+"\nR: "+(t||"Errore");vibrate(200);announce("Aggiornato.");
}
async function usePhoto(){
    if(!lastShotB64)return;
    const filename = "foto_visione_" + Date.now() + ".jpg";
    
    // Tentativo condivisione mobile (Share Sheet)
    if(navigator.share && navigator.canShare){
        try {
            const b=await(await fetch("data:image/jpeg;base64,"+lastShotB64)).blob();
            const f=new File([b], filename ,{type:"image/jpeg"});
            await navigator.share({files:[f]});
            return;
        } catch(e) { console.log("Share fallito o annullato, passo al download"); }
    }
    
    // Fallback Desktop: Download forzato se Share non va
    const dLink = document.getElementById('download-link');
    dLink.href = "data:image/jpeg;base64,"+lastShotB64;
    dLink.download = filename;
    dLink.click();
    announce("Foto scaricata.");
}
function deletePhoto(){lastShotB64=null;showCameraOnly();announce("Camera attiva.");}
async function captureNewShot(){
  if(mode==='guiding')toggleGuidance();
  playShutter();lastShotB64=captureFrame();
}

async function startApp(){
  document.getElementById('main-interface').classList.remove('hidden');document.getElementById('main-interface').removeAttribute('aria-hidden');
  document.getElementById('start-screen').classList.add('hidden');document.getElementById('start-screen').setAttribute('aria-hidden','true');
  document.getElementById('btn-scene').focus();
  announce("Visione AI Avviata.");
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  await setupCamera(currentFacingMode);
  try{
     const{ObjectDetector,FilesetResolver}=await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js");
     const vision=await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
     objectDetector=await ObjectDetector.createFromOptions(vision,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite",delegate:"GPU"},scoreThreshold:0.3,runningMode:"VIDEO"});
     announce("Riconoscimento oggetti pronto.");
  }catch(e){announce("Attenzione: Riconoscimento oggetti non disponibile.");}
  isRunning=true;tempCtx=tempCanvas.getContext('2d',{willReadFrequently:true});loop();
}
function loop(){
  if(!isRunning){requestAnimationFrame(loop);return;}
  if(video.readyState===4&&tempCtx){
      if(tempCanvas.width!==video.videoWidth){tempCanvas.width=video.videoWidth;tempCanvas.height=video.videoHeight;canvas.width=video.videoWidth;canvas.height=video.videoHeight;}
      tempCtx.drawImage(video,0,0,tempCanvas.width,tempCanvas.height);
      if(lightActive)processLight();if(colorActive)processColor();if(mode==='guiding')processGuidance();
  }
  requestAnimationFrame(loop);
}
window.openSettings=()=>{document.getElementById('key-screen').classList.remove('hidden');document.getElementById('key-screen').removeAttribute('aria-hidden');document.getElementById('key-screen').removeAttribute('inert');};
window.closeSettings=()=>{document.getElementById('key-screen').classList.add('hidden');document.getElementById('key-screen').setAttribute('aria-hidden','true');document.getElementById('key-screen').setAttribute('inert');};
window.saveKey=()=>{GEMINI_KEY=document.getElementById('key-input').value.trim();localStorage.setItem('gemini_key',GEMINI_KEY);closeSettings();announce("Chiave salvata.");};
</script>
</body>
</html>