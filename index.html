<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Smart Photo Assistant - Ultimate</title>
<style>
/* STILE BASE */
body{font-family:'Segoe UI',Roboto,Arial,sans-serif;margin:0;padding:0;background:#000;color:#fff;height:100vh;display:flex;flex-direction:column;overflow:hidden}
.sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)}

/* AREA CAMERA */
#cam-container{position:relative;flex-grow:1;background:#111;display:flex;justify-content:center;align-items:center}
video{width:100%;height:100%;object-fit:cover;opacity:.8}
canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}

/* STATUS E COUNTDOWN */
#voice-status{position:absolute;top:10px;right:10px;padding:8px 12px;border-radius:20px;background:rgba(0,0,0,0.8);border:1px solid #777;font-size:0.9rem;z-index:60;display:none}
.listening{border-color:#0f0!important;color:#0f0!important}
#countdown-overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:8rem;color:#fff;font-weight:bold;text-shadow:0 0 15px #000;z-index:70;display:none}

/* INTERFACCIA PRINCIPALE */
#main-interface{height:55vh;width:100%;background:#000;border-top:2px solid #333;display:flex;flex-direction:column}
#camera-controls{flex-grow:1;display:grid;grid-template-columns:1fr;grid-auto-rows:min-content;gap:15px;padding:20px;overflow-y:auto}

/* AREA SELEZIONE OGGETTI */
#selection-panel{background:#111;border:1px solid #444;border-radius:8px;padding:10px;display:none;flex-direction:column;gap:5px}
#detected-list{display:flex;flex-wrap:wrap;gap:8px;max-height:120px;overflow-y:auto;padding:5px}
/* Stile bottone oggetto migliorato per focus */
.obj-btn{padding:10px 15px;border:2px solid #555;background:#222;color:#fff;border-radius:20px;font-size:1rem;min-height:44px;}
.obj-btn:focus{outline:3px solid #fff;border-color:#fff}
.obj-btn.selected{background:#006400;border-color:#0f0;color:#0f0;font-weight:bold}

/* PULSANTI */
button{border:2px solid #555;border-radius:12px;font-size:1.1rem;font-weight:bold;text-transform:uppercase;color:#fff;background:#222;min-height:65px;touch-action:manipulation}
button:active{background:#555;transform:scale(.98)}
.full-width{grid-column:1/-1}
.btn-primary{background:#004080;border-color:#4a90e2}
.btn-action{background:#006400;border-color:#0f0;color:#0f0}
.btn-download{background:#4B0082;border-color:#9370DB;color:#fff}
.btn-guide{background:#8B0000;border-color:#f00;font-size:1.2rem}
.active-tool{background:#DAA520!important;border-color:#FFD700!important;color:#000!important}

/* MENU CONTESTO */
#context-menu{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;z-index:80;padding:15px;display:flex;flex-direction:column;gap:10px;overflow-y:auto}
.context-title{font-size:1.2rem;color:#D4AF37;text-align:center;margin-bottom:10px}
.btn-share-now{background:#2F4F4F!important;border-color:#00CED1!important;color:#fff!important;min-height:60px;font-size:1.1rem}

/* SCHERMATA RISULTATO */
#result-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:#111;z-index:90;display:flex;flex-direction:column;padding:15px}
#result-text{flex-grow:1;background:#000;border:1px solid #555;padding:15px;overflow-y:auto;font-size:1.2rem;line-height:1.5;white-space:pre-wrap;margin-bottom:10px}

/* EDITOR TESTO */
#text-editor{position:absolute;bottom:0;left:0;width:100%;background:#222;padding:15px;z-index:100;border-top:2px solid #D4AF37;display:none}
#caption-input{width:100%;padding:15px;font-size:1.2rem;margin-bottom:10px}

/* SETTINGS */
.overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:200;display:flex;flex-direction:column;justify-content:center;align-items:center}
.hidden{display:none!important}
</style>
</head>
<body>

<div id="sr-announcer" class="sr-only" aria-live="assertive" role="status"></div>

<div id="cam-container">
  <video id="webcam" playsinline muted autoplay></video>
  <canvas id="overlay"></canvas>
  <div id="voice-status">Ascolto...</div>
  <div id="countdown-overlay"></div>
</div>

<div id="main-interface">
  <div id="camera-controls">
    <button class="full-width" id="btn-select-mode" onclick="toggleSelectionMode()" style="background:#333;border-color:#777">
      SELEZIONA COSA FOTOGRAFARE
    </button>
    <div id="selection-panel">
      <div style="font-size:1rem;color:#fff;margin-bottom:10px;font-weight:bold" id="sel-instructions">
          Oggetti rilevati (tocca per selezionare):
      </div>
      <div id="detected-list" aria-live="polite">
          <span style="color:#777">In attesa di oggetti...</span>
      </div>
      <button onclick="confirmSelection()" class="full-width btn-action" style="min-height:50px;margin-top:10px">CONFERMA E CHIUDI</button>
    </div>
    
    <button class="full-width btn-guide" id="btn-guide" onclick="toggleSmartGuide()">
      AVVIA GUIDA AUTO-SCATTO
    </button>
    
    <div id="local-ai-status" class="full-width" style="text-align:center;padding:10px;background:#222;border:1px solid #444;border-radius:8px;color:#ccc" aria-live="polite">
      In attesa...
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
        <button onclick="startCountdown(5)" class="btn-action">SCATTA (5s)</button>
        <button onclick="flipCamera()">RUOTA CAMERA</button>
    </div>
    
    <button onclick="toggleVoiceControl()" id="btn-voice" style="min-height:50px">COMANDI VOCALI</button>
    <button class="full-width" onclick="openSettings()" style="min-height:50px;font-size:0.9rem;background:#333">IMPOSTAZIONI API</button>
  </div>
</div>

<div id="context-menu" class="hidden" aria-hidden="true" role="dialog" aria-label="Menu foto acquisita">
  <h2 class="context-title">Foto Acquisita</h2>
  <p style="text-align:center;color:#ccc;margin:5px 0 10px 0">Cosa hai fotografato?</p>
  
  <button class="btn-primary" onclick="analyzeContext('selfie')">SELFIE / RITRATTO</button>
  <button class="btn-primary" onclick="analyzeContext('group')">GRUPPO</button>
  <button class="btn-primary" onclick="analyzeContext('environment')">AMBIENTE</button>
  <button class="btn-primary" onclick="analyzeContext('document')">LEGGI TESTO</button>
  
  <div style="height:1px;background:#555;margin:15px 0"></div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
    <button class="btn-share-now" onclick="shareImageNative()">CONDIVIDI</button>
    <button class="btn-download" onclick="downloadImage()">SCARICA</button>
  </div>
  
  <button onclick="discardPhoto()" style="background:#8B0000;margin-top:10px" class="full-width">ELIMINA E TORNA</button>
</div>

<div id="result-screen" class="hidden" aria-hidden="true" role="dialog" aria-label="Risultato analisi">
  <h2 style="color:#D4AF37;text-align:center;margin:0 0 10px 0">Risultato</h2>
  <div id="result-text" tabindex="0">Elaborazione...</div>
  
  <button onclick="analyzeContext('social')" class="full-width" style="background:#E1306C;margin-bottom:15px;border:1px solid #fff;font-size:1rem">
    CHIEDI PARERE TECNICO "SOCIAL"
  </button>

  <div id="after-analysis-buttons">
    <button onclick="openTextEditor()" class="full-width btn-primary" style="background:#006400;border-color:#0f0;min-height:50px;margin-bottom:15px">AGGIUNGI TESTO (IA POSIZIONA)</button>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <button onclick="shareImageNative()" class="btn-action">CONDIVIDI</button>
        <button onclick="downloadImage()" class="btn-download">SCARICA</button>
        <button onclick="discardPhoto()" class="full-width" style="background:#8B0000;grid-column:1/-1">ELIMINA</button>
    </div>
  </div>
</div>

<div id="text-editor" role="dialog" aria-label="Editor testo immagine">
  <h3 style="color:#fff;margin-top:0">Scrivi Testo</h3>
  <input type="text" id="caption-input" placeholder="Il tuo messaggio..." style="color:black" aria-label="Testo da aggiungere all'immagine">
  <div style="display:flex;gap:10px">
    <button onclick="applyTextToImage()" class="btn-action" style="flex:1">CONFERMA</button>
    <button onclick="closeTextEditor()" style="flex:1">ANNULLA</button>
  </div>
</div>

<div id="key-screen" class="overlay hidden" role="dialog" aria-label="Impostazioni chiave API">
  <h2>Chiave Gemini API</h2>
  <input type="text" id="key-input" style="width:80%;padding:15px;margin-bottom:20px;color:#000" aria-label="Inserisci chiave API Gemini">
  <button onclick="saveKey()" style="padding:20px;width:80%">SALVA</button>
  <button onclick="closeSettings()" style="margin-top:10px;padding:20px;width:80%;background:#333">CHIUDI</button>
</div>

<script>
let GEMINI_KEY = localStorage.getItem('gemini_key') || "";
const MODEL_NAME = "gemini-2.0-flash-exp"; 
const API_ENDPOINT = "v1beta";

// VARIABILI GLOBALI
let video = document.getElementById('webcam');
let canvas = document.getElementById('overlay');
let ctx = canvas.getContext('2d');
let tempCanvas = document.createElement('canvas');
let tempCtx = tempCanvas.getContext('2d');
let stream = null;
let currentPhotoBase64 = null;
let finalPhotoBase64 = null;

let currentFacingMode = 'environment';
let aiTextConfig = { pos: "bottom", color: "white", bg: "box" };

// TOOLS
let audioCtx;
let objectDetector = null;
let faceLandmarker = null;
let isGuiding = false;
let isSelectionMode = false;
let guideInterval = null;
let lastGuideTime = 0;
let isCountdownRunning = false;
let countdownTimerIds = [];
let selectedTargets = []; 
let availableObjects = []; 
let currentFramingMode = "closeup"; 

const SpeechRecognitionClass = window.SpeechRecognition || window.webkitSpeechRecognition || null;

// DIZIONARIO COMPLETO COCO-SSD (80 Classi)
const OBJECT_TRANSLATIONS = {
    'person': 'Persona', 'bicycle': 'Bicicletta', 'car': 'Auto', 'motorcycle': 'Moto', 
    'airplane': 'Aereo', 'bus': 'Autobus', 'train': 'Treno', 'truck': 'Camion', 'boat': 'Barca',
    'traffic light': 'Semaforo', 'fire hydrant': 'Idrante', 'stop sign': 'Segnale Stop', 
    'parking meter': 'Parchimetro', 'bench': 'Panchina', 'bird': 'Uccello', 'cat': 'Gatto', 
    'dog': 'Cane', 'horse': 'Cavallo', 'sheep': 'Pecora', 'cow': 'Mucca', 'elephant': 'Elefante', 
    'bear': 'Orso', 'zebra': 'Zebra', 'giraffe': 'Giraffa', 'backpack': 'Zaino', 'umbrella': 'Ombrello', 
    'handbag': 'Borsa', 'tie': 'Cravatta', 'suitcase': 'Valigia', 'frisbee': 'Frisbee', 'skis': 'Sci', 
    'snowboard': 'Snowboard', 'sports ball': 'Palla', 'kite': 'Aquilone', 'baseball bat': 'Mazza', 
    'baseball glove': 'Guanto', 'skateboard': 'Skateboard', 'surfboard': 'Surf', 'tennis racket': 'Racchetta', 
    'bottle': 'Bottiglia', 'wine glass': 'Bicchiere', 'cup': 'Tazza', 'fork': 'Forchetta', 
    'knife': 'Coltello', 'spoon': 'Cucchiaio', 'bowl': 'Ciotola', 'banana': 'Banana', 'apple': 'Mela', 
    'sandwich': 'Panino', 'orange': 'Arancia', 'broccoli': 'Broccoli', 'carrot': 'Carota', 
    'hot dog': 'Hot dog', 'pizza': 'Pizza', 'donut': 'Ciambella', 'cake': 'Torta', 'chair': 'Sedia', 
    'couch': 'Divano', 'potted plant': 'Pianta', 'bed': 'Letto', 'dining table': 'Tavolo', 'toilet': 'WC', 
    'tv': 'TV/Schermo', 'laptop': 'Computer', 'mouse': 'Mouse', 'remote': 'Telecomando', 
    'keyboard': 'Tastiera', 'cell phone': 'Cellulare', 'microwave': 'Microonde', 'oven': 'Forno', 
    'toaster': 'Tostapane', 'sink': 'Lavandino', 'refrigerator': 'Frigo', 'book': 'Libro', 
    'clock': 'Orologio', 'vase': 'Vaso', 'scissors': 'Forbici', 'teddy bear': 'Peluche', 
    'hair drier': 'Phon', 'toothbrush': 'Spazzolino'
};

async function init(){
  document.body.addEventListener('click', initAudioContext, {once: true});
  document.body.addEventListener('touchstart', initAudioContext, {once: true});
  await setupCamera();
  await loadLocalModels();
  setupModalKeyboardHandlers();
  announce("App pronta. Usa Avvia Guida Auto-Scatto.");
}

function initAudioContext(){
  try{
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    if(audioCtx.state === 'suspended') audioCtx.resume();
  }catch(e){ console.warn(e); }
}

async function setupCamera(){
  try{
    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode: currentFacingMode, width:{ideal:1280}, height:{ideal:720} }
    });
    video.srcObject = stream;
    await new Promise((resolve) => {
      if(video.readyState >= 2) resolve();
      else video.addEventListener('loadedmetadata', () => resolve(), {once:true});
    });
    try{ await video.play(); }catch(e){}
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    tempCanvas.width = video.videoWidth; tempCanvas.height = video.videoHeight;
  }catch(e){
    announce("Errore fotocamera.");
    document.getElementById('local-ai-status').innerText = "Errore fotocamera.";
  }
}

async function flipCamera(){
  currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
  announce(currentFacingMode === 'environment' ? "Camera posteriore." : "Camera frontale.");
  await setupCamera();
}

async function loadLocalModels(){
  try{
    document.getElementById('local-ai-status').innerText = "Carico AI...";
    const { ObjectDetector, FaceLandmarker, FilesetResolver } = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js");
    const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
    objectDetector = await ObjectDetector.createFromOptions(vision, { 
      baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite" }, 
      scoreThreshold: 0.4, runningMode: "VIDEO" 
    });
    faceLandmarker = await FaceLandmarker.createFromOptions(vision, { 
      baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task" }, 
      runningMode: "VIDEO", numFaces: 1 
    });
    document.getElementById('local-ai-status').innerText = "AI pronta.";
  }catch(e){
    announce("AI Locale non disponibile.");
    document.getElementById('local-ai-status').innerText = "AI KO.";
  }
}

// --- SELEZIONE ---
function toggleSelectionMode(){
  isSelectionMode = !isSelectionMode;
  const panel = document.getElementById('selection-panel');
  const btn = document.getElementById('btn-select-mode');
  const list = document.getElementById('detected-list');
  
  if(isSelectionMode){
    if(isGuiding) toggleSmartGuide();
    panel.style.display = 'flex';
    btn.classList.add('active-tool');
    btn.textContent = "CHIUDI SELEZIONE";
    announce("Modalità selezione. Tocca lo schermo in basso per cercare oggetti.");
    
    selectedTargets = []; 
    list.innerHTML = '<span style="color:#777">In attesa di oggetti...</span>';
    
    if(guideInterval) clearInterval(guideInterval);
    guideInterval = setInterval(scanForSelection, 1000);
  } else {
    panel.style.display = 'none';
    btn.classList.remove('active-tool');
    btn.textContent = "SELEZIONA COSA FOTOGRAFARE";
    if(guideInterval) clearInterval(guideInterval);
    guideInterval = null;
    announce("Selezione chiusa.");
  }
}

async function scanForSelection(){
  if(video.readyState !== 4 || !objectDetector) return;
  try{
    const detections = objectDetector.detectForVideo(video, performance.now());
    const currentSet = new Set();
    detections.detections.forEach(d => currentSet.add(d.categories[0].categoryName));
    availableObjects = Array.from(currentSet);
    updateSelectionUI();
  }catch(e){}
}

function updateSelectionUI(){
  const list = document.getElementById('detected-list');
  
  if((availableObjects.length > 0 || list.children.length > 0) && list.querySelector('span')){
      const sp = list.querySelector('span');
      if(sp) sp.remove();
  }

  availableObjects.forEach(objName => {
    const btnId = 'btn-obj-' + objName.replace(/\s+/g, '-');
    let btn = document.getElementById(btnId);

    if (!btn) {
      let display = OBJECT_TRANSLATIONS[objName] || objName;

      btn = document.createElement('button');
      btn.id = btnId;
      btn.className = 'obj-btn';
      
      btn.onclick = () => {
        if(selectedTargets.includes(objName)){
          selectedTargets = selectedTargets.filter(t => t !== objName);
          announce(`Rimosso ${display}`);
        } else {
          selectedTargets.push(objName);
          announce(`Selezionato ${display}`);
        }
        updateSelectionUI(); 
      };
      
      btn.dataset.label = display;
      btn.textContent = display;
      list.appendChild(btn);
    }

    const isSelected = selectedTargets.includes(objName);
    if(isSelected){
        btn.classList.add('selected');
        if(!btn.textContent.includes("(V)")) btn.textContent = btn.dataset.label + " (V)";
    } else {
        btn.classList.remove('selected');
        if(btn.textContent.includes("(V)")) btn.textContent = btn.dataset.label;
    }
    
    btn.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
  });
}

function confirmSelection(){ toggleSelectionMode(); }

// --- GUIDA PRINCIPALE ---
function toggleSmartGuide(){
  isGuiding = !isGuiding;
  const btn = document.getElementById('btn-guide');
  if(isGuiding){
    if(isSelectionMode) toggleSelectionMode();
    btn.textContent = "STOP GUIDA"; 
    btn.style.background = "#006400";
    announce(selectedTargets.length > 0 ? "Guida Selettiva Attiva." : "Guida Automatica Attiva.");
    isCountdownRunning = false;
    if(guideInterval) clearInterval(guideInterval);
    guideInterval = setInterval(processLocalFrame, 200);
  }else{
    btn.textContent = "AVVIA GUIDA AUTO-SCATTO";
    btn.style.background = "#8B0000";
    if(guideInterval) clearInterval(guideInterval);
    guideInterval = null;
    cancelCountdown();
    announce("Guida ferma.");
  }
}

async function processLocalFrame(){
  if(video.readyState !== 4) return;
  const now = Date.now();
  if(!isCountdownRunning && now - lastGuideTime < 1200) return;

  // 0. CONTROLLO LUCE
  if(!isCountdownRunning){
      tempCtx.drawImage(video, 0, 0, 50, 50);
      const d = tempCtx.getImageData(0,0,50,50).data;
      let b = 0; for(let i=0; i<d.length; i+=4) b+=(d[i]+d[i+1]+d[i+2])/3;
      if((b/(d.length/4)) < 60){ 
          announce("Troppo buio! Cerca luce.");
          lastGuideTime = now;
          return;
      }
  }

  let targetsFound = [];
  let errorState = null;
  let faceSizeRatio = 0; 
  let isPersonMode = (selectedTargets.length === 0 || selectedTargets.includes('person'));

  // 1. VISO (Priorità alta)
  if(faceLandmarker && isPersonMode){
    try{
      const faces = faceLandmarker.detectForVideo(video, performance.now());
      if(faces.faceLandmarks && faces.faceLandmarks.length > 0){
           let points = faces.faceLandmarks[0];
           let minX=1, maxX=0, minY=1, maxY=0, cx=0, cy=0;
           points.forEach(p => { 
               if(p.x<minX)minX=p.x; if(p.x>maxX)maxX=p.x;
               if(p.y<minY)minY=p.y; if(p.y>maxY)maxY=p.y;
               cx+=p.x; cy+=p.y; 
           });
           faceSizeRatio = maxX - minX; 
           targetsFound.push({ x: cx/points.length, y: cy/points.length, name: "Volto" });

           let cuts = [];
           if(minX < 0.02) cuts.push("a sinistra");
           if(maxX > 0.98) cuts.push("a destra");
           if(minY < 0.02) cuts.push("in alto");
           if(maxY > 0.98) cuts.push("in basso");
           
           if(cuts.length > 0){
               errorState = "Viso tagliato " + cuts.join(" e ") + ".";
           } else {
               if(faceSizeRatio > 0.70) errorState = "Troppo vicino! Allontanati.";
               else if(faceSizeRatio < 0.15) errorState = "Troppo lontano! Avvicinati.";
           }
      }
    }catch(e){}
  }

  // 2. OGGETTI (Con logica di taglio migliorata)
  if(objectDetector && !errorState){
    try{
      const dets = objectDetector.detectForVideo(video, performance.now());
      dets.detections.forEach(det => {
        const cat = det.categories[0].categoryName;
        // Traduzione
        const displayCat = OBJECT_TRANSLATIONS[cat] || cat;

        let isRel = false;
        if(selectedTargets.length>0){ if(selectedTargets.includes(cat)) isRel=true; } 
        else if (!isPersonMode) { isRel=true; } 
        else { if(cat !== 'person' && targetsFound.length === 0) isRel=true; }

        if(isRel){
            const box = det.boundingBox;
            const nx = (box.originX + box.width/2) / video.videoWidth;
            const ny = (box.originY + box.height/2) / video.videoHeight;
            const nw = box.width / video.videoWidth;
            const nh = box.height / video.videoHeight;
            const oMinX=box.originX/video.videoWidth, oMaxX=(box.originX+box.width)/video.videoWidth;
            const oMinY=box.originY/video.videoHeight, oMaxY=(box.originY+box.height)/video.videoHeight;

            targetsFound.push({x: nx, y: ny, name: cat}); // Name originale per logica interna

            // LOGICA TAGLIO ESPANSA
            let cuts = [];
            if(oMinX < 0.01) cuts.push("a sinistra");
            if(oMaxX > 0.99) cuts.push("a destra");
            if(oMinY < 0.01) cuts.push("in alto");
            if(oMaxY > 0.99) cuts.push("in basso");

            if(cuts.length > 0){
                // Esempio: "Tazza tagliata a sinistra e in basso"
                errorState = `${displayCat} tagliato ${cuts.join(" e ")}.`;
            } else {
                if(nw>0.85 || nh>0.85) errorState = "Oggetto troppo vicino.";
                else if(nw<0.10) errorState = "Oggetto troppo lontano.";
            }
        }
      });
    }catch(e){}
  }

  // 3. LOGICA FINALE
  if(errorState){
      if(isCountdownRunning) cancelCountdown();
      announce(errorState);
      lastGuideTime = now;
      return;
  }

  if(targetsFound.length > 0){
    let avgX=0, avgY=0;
    targetsFound.forEach(t => { avgX+=t.x; avgY+=t.y; });
    avgX /= targetsFound.length; avgY /= targetsFound.length;
    
    let dName = targetsFound[0].name;
    // Usa la traduzione globale per l'annuncio
    let translatedName = OBJECT_TRANSLATIONS[dName] || dName;
    
    if(targetsFound.length>1) translatedName='Soggetti';

    let idealY = 0.5; 
    if(dName==='Volto' || dName==='person'){ // person per compatibilità
        if(faceSizeRatio < 0.40 && currentFramingMode !== "bust"){
            currentFramingMode = "bust"; announce("Mezzo Busto.");
        } else if(faceSizeRatio > 0.50 && currentFramingMode !== "closeup"){
            currentFramingMode = "closeup"; announce("Primo Piano.");
        }
        idealY = (currentFramingMode === "bust") ? 0.42 : 0.5;
    }
    handleCentering(avgX, avgY, translatedName, now, idealY);
  } else {
    if(isCountdownRunning){ cancelCountdown(); announce("Soggetto perso."); }
    else if (now - lastGuideTime > 3000) {
       if(selectedTargets.length>0){
           announce("Cerco selezione...");
       } else {
           announce("Inquadra un volto o un oggetto.");
       }
       lastGuideTime = now; 
    }
  }
}

function handleCentering(x, y, label, now, targetY = 0.5){
  const th = 0.06; 
  const dx = Math.abs(x - 0.5);      
  const dy = Math.abs(y - targetY);  
  
  const perfect = (dx < th && dy < th);
  const safe = (dx < 0.2 && dy < 0.2); 

  if(isCountdownRunning){
    if(!safe){ cancelCountdown(); announce("Ti sei mosso! Timer fermato."); }
    return; 
  }

  if(perfect){ 
      announce(`Eccellente! Scatto in 3 secondi.`); 
      startCountdown(3); return; 
  }
  
  let msg = "";
  if(x < 0.5 - th) msg += "Sposta a Sinistra. ";
  else if(x > 0.5 + th) msg += "Sposta a Destra. ";
  if(y < targetY - th) msg += "Sposta in Alto. "; 
  else if(y > targetY + th) msg += "Sposta in Basso. ";

  if(msg){ announce(msg.trim()); lastGuideTime = now; }
}

// --- SCATTO ---
function playShutterSound(){
  if(audioCtx && audioCtx.state !== 'suspended'){
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.type='square';
    o.frequency.setValueAtTime(800, audioCtx.currentTime);
    o.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime+0.1);
    g.gain.setValueAtTime(0.3, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.1);
    o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime+0.1);
  }
}

function startCountdown(sec){
  if(isCountdownRunning) return;
  isCountdownRunning = true;
  const ov = document.getElementById('countdown-overlay');
  ov.style.display = 'block';
  announce(sec.toString());
  ov.innerText = sec;
  countdownTimerIds.forEach(id => clearTimeout(id));
  countdownTimerIds = [];
  
  for(let i=1; i<=sec; i++){
    const id = setTimeout(() => {
      let c = sec - i;
      if(c > 0){ ov.innerText = c; announce(c.toString()); } 
      else { ov.style.display = 'none'; captureAndOpenMenu(); }
    }, i * 1000);
    countdownTimerIds.push(id);
  }
}

function cancelCountdown(){
  if(!isCountdownRunning) return;
  isCountdownRunning = false;
  document.getElementById('countdown-overlay').style.display = 'none';
  countdownTimerIds.forEach(id => clearTimeout(id));
  countdownTimerIds = [];
}

function captureAndOpenMenu(){
  playShutterSound(); // CLICK!
  isCountdownRunning = false; 
  countdownTimerIds = [];
  const c = document.createElement('canvas'); 
  c.width = video.videoWidth; c.height = video.videoHeight;
  c.getContext('2d').drawImage(video, 0, 0);
  currentPhotoBase64 = c.toDataURL('image/jpeg', 0.85); 
  finalPhotoBase64 = currentPhotoBase64;
  document.getElementById('main-interface').classList.add('hidden');
  document.getElementById('context-menu').classList.remove('hidden');
  document.getElementById('context-menu').removeAttribute('aria-hidden');
  if(isGuiding) toggleSmartGuide();
  announce("Foto scattata! Scegli azione.");
  setTimeout(() => {
    const firstBtn = document.querySelector('#context-menu button');
    if(firstBtn) firstBtn.focus();
  }, 100);
}

// --- GEMINI & PROMPT ---
async function analyzeContext(context){
  if(!GEMINI_KEY){ announce("Manca chiave API."); return; }
  
  if(context !== 'social'){
      document.getElementById('context-menu').classList.add('hidden');
  }
  
  document.getElementById('result-screen').classList.remove('hidden');
  document.getElementById('result-screen').removeAttribute('aria-hidden');
  document.getElementById('result-text').textContent = "Gemini sta analizzando...";
  announce("Gemini sta analizzando...");
  
  const layoutPrompt = `
  ALLA FINE DELLA RISPOSTA, aggiungi una riga: ###LAYOUT:POS|COLORE|SFONDO###
  Dove POS=TOP/MIDDLE/BOTTOM, COLORE=WHITE/BLACK, SFONDO=BOX/SHADOW/NONE.`;

  let prompt = "";
  if (context === 'selfie') {
      prompt = `Agisci come consulente per non vedenti. Descrivi: sguardo, viso/trucco, vestiti, inquadratura, privacy sfondo.` + layoutPrompt;
  }
  else if (context === 'group') {
      prompt = `Analizza foto gruppo per non vedenti. Chi c'è, sguardi, qualcuno tagliato?` + layoutPrompt;
  }
  else if (context === 'environment') {
      prompt = `Descrivi scena, luogo, luce. Ostacoli o dati sensibili?` + layoutPrompt;
  }
  else if (context === 'document') {
      prompt = `Trascrivi tutto il testo.` + layoutPrompt;
  }
  else if(context === 'social') {
      prompt = `Analisi Tecnica per Social (Instagram). Qualità, Estetica (1-10), Verdetto.` + layoutPrompt;
  }

  try {
    const b64 = currentPhotoBase64.split(',')[1];
    const res = await fetch(`https://generativelanguage.googleapis.com/${API_ENDPOINT}/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ contents: [{ parts: [{text: prompt}, {inline_data: {mime_type: 'image/jpeg', data: b64}}] }] })
    });
    
    if (!res.ok) throw new Error("Errore API.");
    
    const data = await res.json();
    let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Errore.";
    
    if(text.includes("###LAYOUT:")){
      const extract = text.split("###LAYOUT:")[1].split("###")[0].split("|");
      if(extract.length === 3) aiTextConfig = { pos: extract[0].toLowerCase(), color: extract[1].toLowerCase(), bg: extract[2].toLowerCase() };
      text = text.split("###LAYOUT:")[0];
    }
    
    const sanitized = text.replace(/\*\*/g, '').replace(/[<>]/g, '').replace(/\n/g, '<br><br>');
    document.getElementById('result-text').innerHTML = sanitized;
    announce("Analisi completata.");
    setTimeout(() => document.getElementById('result-text').focus(), 100);
  } catch(e) { 
    announce("Errore analisi."); 
    document.getElementById('result-text').textContent = "Errore: " + e.message;
  }
}

function downloadImage(){
  const link = document.createElement('a');
  link.href = finalPhotoBase64 || currentPhotoBase64;
  link.download = `smart_foto_${Date.now()}.jpg`;
  document.body.appendChild(link); link.click(); document.body.removeChild(link);
  announce("Scaricato.");
}

async function shareImageNative(){
  try{
    const res = await fetch(finalPhotoBase64 || currentPhotoBase64); 
    const blob = await res.blob(); 
    const file = new File([blob], "smart_foto.jpg", {type: "image/jpeg"});
    if(navigator.share){ await navigator.share({files:[file], title:'Smart Photo'}); announce("Condiviso."); }
    else downloadImage();
  }catch(e){ downloadImage(); }
}

function discardPhoto(){ 
  document.getElementById('context-menu').classList.add('hidden'); 
  document.getElementById('result-screen').classList.add('hidden'); 
  document.getElementById('main-interface').classList.remove('hidden'); 
  closeTextEditor();
  announce("Foto eliminata."); 
}

// EDITOR TESTO
function openTextEditor(){ 
    document.getElementById('text-editor').style.display = 'block'; 
    setTimeout(() => document.getElementById('caption-input').focus(), 100); 
}
function closeTextEditor(){ document.getElementById('text-editor').style.display = 'none'; }
function applyTextToImage(){
  const txt = document.getElementById('caption-input').value.trim();
  if(!txt){ announce("Nessun testo."); return; }
  const img = new Image();
  img.onload = () => {
    const c = document.createElement('canvas'); 
    c.width = img.width; c.height = img.height; 
    const ctx = c.getContext('2d');
    ctx.drawImage(img, 0, 0);
    const fs = c.width * 0.06; ctx.font = `bold ${fs}px Arial`; ctx.textAlign = "center";
    let x = c.width/2, y = c.height - (fs*2);
    if(aiTextConfig.pos === "top") y = fs * 2.5; else if(aiTextConfig.pos === "middle") y = c.height/2;
    
    if(aiTextConfig.bg === "box"){
      ctx.fillStyle = aiTextConfig.color==="white"?"rgba(0,0,0,0.6)":"rgba(255,255,255,0.7)";
      const tw = ctx.measureText(txt).width;
      ctx.fillRect(x - tw/2 - 10, y - fs, tw + 20, fs * 1.4);
    } else if (aiTextConfig.bg === "shadow"){
      ctx.shadowColor = "rgba(0,0,0,0.8)"; ctx.shadowBlur = 15;
    }
    ctx.fillStyle = aiTextConfig.color === "white" ? "#fff" : "#000"; 
    ctx.fillText(txt, x, y);
    finalPhotoBase64 = c.toDataURL('image/jpeg', 0.9);
    announce("Testo applicato."); closeTextEditor();
  };
  img.src = currentPhotoBase64;
}

// SETTINGS
function announce(msg){ 
  const el = document.getElementById('sr-announcer'); 
  el.textContent = ''; setTimeout(() => el.textContent = msg, 100); 
}
function openSettings(){ 
    document.getElementById('key-screen').classList.remove('hidden'); 
    setTimeout(() => document.getElementById('key-input').focus(), 100); 
}
function closeSettings(){ document.getElementById('key-screen').classList.add('hidden'); }
function saveKey(){ 
    GEMINI_KEY = document.getElementById('key-input').value.trim(); 
    localStorage.setItem('gemini_key', GEMINI_KEY); 
    closeSettings(); announce("Chiave salvata."); 
}

// VOCALE
let recognition, voiceActive = false;
function toggleVoiceControl(){
  if(!SpeechRecognitionClass){ announce("No supporto vocale."); return; }
  voiceActive = !voiceActive;
  const btn = document.getElementById('btn-voice');
  if(voiceActive){
    btn.classList.add('active-tool'); document.getElementById('voice-status').style.display='block';
    if(!recognition){
      recognition = new SpeechRecognitionClass(); 
      recognition.lang = 'it-IT'; recognition.continuous = true;
      recognition.onresult = (e) => { 
        const cmd = e.results[e.results.length-1][0].transcript.toLowerCase();
        if(cmd.includes('scatta')) startCountdown(5); 
        else if(cmd.includes('guida')) toggleSmartGuide();
      };
      recognition.onerror = () => { try{recognition.stop();}catch(e){} voiceActive=false; btn.classList.remove('active-tool'); };
      recognition.onend = () => { if(voiceActive) try{recognition.start();}catch(e){} };
    }
    try{ recognition.start(); announce("Vocale attivo. Dì: scatta o guida."); }catch(e){}
  }else{ 
    if(recognition) try{ recognition.stop(); }catch(e){}
    btn.classList.remove('active-tool'); document.getElementById('voice-status').style.display='none'; announce("Vocale spento.");
  }
}

function setupModalKeyboardHandlers(){
  const closeOnEsc = (id, fn) => document.getElementById(id).addEventListener('keydown', e => { if(e.key==='Escape') fn(); });
  closeOnEsc('context-menu', discardPhoto);
  closeOnEsc('result-screen', discardPhoto);
  closeOnEsc('text-editor', closeTextEditor);
  closeOnEsc('key-screen', closeSettings);
}

window.onload = init;
</script>
</body>
</html>