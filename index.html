<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Visione AI Fusion - Layout Accessibile</title>
<style>
/* STILE GENERALE */
body{font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:0;padding:0;background:#000;color:#fff;height:100vh;display:flex;flex-direction:column;overflow:hidden}
.sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)}

/* AREA VIDEO */
#cam-container{position:relative;flex-grow:1;width:100%;background:#111;display:flex;justify-content:center;align-items:center}
video{width:100%;height:100%;object-fit:cover;opacity:.6}
canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}

/* INTERFACCIA PRINCIPALE */
#main-interface{height:65vh;width:100%;background:#000;border-top:4px solid #333;position:relative;display:flex;flex-direction:column}
#camera-controls{flex-grow:1;width:100%;display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:min-content;gap:10px;padding:10px;box-sizing:border-box;overflow-y:auto}

/* CLASSI DI UTILITÀ PER GRIGLIA */
.full-width { grid-column: 1 / -1; } /* Pulsante che occupa tutta la larghezza */
.top-bar{display:flex;gap:10px;width:100%}

/* SCHERMATA RISULTATO (sovrapposta) */
#result-screen{height:100%;width:100%;display:flex;flex-direction:column;padding:15px;box-sizing:border-box;background:#111;position:absolute;top:0;left:0;z-index:50}
#result-content{flex-grow:1;overflow-y:auto;margin-bottom:15px;padding:15px;border:1px solid #555;border-radius:8px;background:#000;font-size:1.3rem;line-height:1.5;color:#fff;white-space:pre-wrap}
.result-actions{display:flex;gap:10px;flex-shrink:0;min-height:70px}

/* STILE PULSANTI */
button{border:2px solid #555;border-radius:12px;font-size:1rem;font-weight:bold;text-transform:uppercase;color:#fff;background:#222;cursor:pointer;min-height:60px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;touch-action:manipulation}
button:active{background:#555;transform:scale(.98)}
.small-btn{flex:1;font-size:.9rem;background:#111;border:1px solid #444;color:#ccc}

/* COLORI SPECIFICI */
#btn-guide{border: 2px solid #fff; background: #002200; font-size: 1.1rem;} /* Verde scuro per evidenziare */
#btn-custom{background:#4B0082;border-color:#DA70D6} /* Viola */
#btn-scene{background:#D4AF37;color:#000} /* Oro */
#btn-text{background:#fff;color:#000}
.active-tool{background:#006400!important;border-color:#0f0!important}
.guiding{background:#8B0000!important;border-color:#f00!important}
.active-discrete{border-color:#f00;color:#f00}

/* OVERLAY AVVIO */
.overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;z-index:100;display:flex;flex-direction:column;justify-content:center;align-items:center}
.hidden{display:none!important}
.loader{border:6px solid #333;border-top:6px solid #D4AF37;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin-bottom:20px}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
input{background:#333;color:#fff;border:1px solid #777}
#download-link{text-align:center;font-size:.9rem;color:#D4AF37;text-decoration:underline;margin-bottom:10px}
</style>
</head>
<body>
<div id="sr-announcer" class="sr-only" aria-live="assertive" role="status"></div>

<div id="cam-container">
  <video id="webcam" playsinline muted autoplay></video>
  <canvas id="overlay"></canvas>
</div>

<div id="main-interface" class="hidden" aria-hidden="true">
  <div id="camera-controls">
    
    <button class="full-width" id="btn-guide" onclick="toggleGuidance()" aria-label="Attiva o disattiva guida di centraggio oggetto. Essenziale.">GUIDA CENTRAGGIO</button>
    
    <div class="top-bar full-width">
       <button class="small-btn" id="btn-shot" onclick="takeShot()" aria-label="Scatta foto senza analizzare">SCATTA</button>
       <button class="small-btn" onclick="flipCamera()" aria-label="Ruota fotocamera. Ti dirà quale usi.">RUOTA CAMERA</button>
    </div>

    <div class="full-width" style="height:1px;background:#333;margin:5px 0"></div>

    <button id="btn-custom" class="full-width" onclick="askCustomDetail()" aria-label="Chiedi un dettaglio specifico alla foto">CHIEDI DETTAGLIO</button>
    
    <button id="btn-scene"  onclick="describeWithMode('scene')"  aria-label="Descrivi scena generale">SCENA</button>
    <button id="btn-text"   onclick="describeWithMode('text')"   aria-label="Leggi testo e documenti">TESTO</button>
    
    <button id="btn-object" onclick="describeWithMode('object')" aria-label="Riconosci oggetto">OGGETTO</button>
    <button id="btn-food"   onclick="describeWithMode('food')"   aria-label="Descrivi cibo">CIBO</button>
    
    <button id="btn-selfie" onclick="describeWithMode('selfie')" aria-label="Analizza selfie o volto">SELFIE</button>
    <button id="btn-safety" onclick="describeWithMode('safety')" aria-label="Controllo sicurezza e ostacoli">SICUREZZA</button>
    
    <button id="btn-outdoor"onclick="describeWithMode('outdoor')"aria-label="Ambiente esterno">ESTERNO</button>
    <button id="btn-indoor" onclick="describeWithMode('indoor')" aria-label="Ambiente interno">INTERNO</button>

    <div class="full-width" style="height:1px;background:#333;margin:5px 0"></div>

    <div class="top-bar full-width">
      <button class="small-btn" id="btn-light" onclick="toggleLight()" aria-label="Sonda intensità luce">SONDA LUCE</button>
      <button class="small-btn" id="btn-color" onclick="toggleColor()" aria-label="Sonda colore">SONDA COLORE</button>
      <button class="small-btn" id="btn-level" onclick="toggleLevel()" aria-label="Livella digitale">LIVELLA</button>
    </div>

    <div class="top-bar full-width" style="margin-top:10px">
      <button class="small-btn" id="btn-discrete" onclick="toggleDiscrete()" aria-label="Modo discreto: silenzia voce e suoni">MODO DISCRETO</button>
      <button class="small-btn" onclick="openSettings()" aria-label="Impostazioni chiave API">IMPOSTAZIONI</button>
    </div>

  </div>

  <div id="result-screen" class="hidden" aria-hidden="true" inert role="main">
    <h2 style="margin:0 0 10px;color:#D4AF37;font-size:1.1rem">Risultato</h2>
    <div id="result-content" tabindex="0">In attesa...</div>
    <a id="download-link" href="#" class="hidden">Scarica foto</a>
    <div class="result-actions">
      <button class="small-btn" onclick="usePhoto()" style="background:#004080" aria-label="Condividi">USA</button>
      <button class="small-btn" onclick="editAndReviewPhoto()" aria-label="Domanda extra">CHIEDI ANCORA</button>
      <button class="small-btn" onclick="deletePhoto()" style="background:#8B0000" aria-label="Chiudi e torna alla camera">CHIUDI</button>
    </div>
  </div>
</div>

<div id="start-screen" class="overlay">
  <h1 style="color:#fff;margin-bottom:20px" aria-hidden="true">Visione AI</h1>
  <div id="loader" class="loader hidden"></div>
  <div id="load-msg" class="hidden" style="color:#fff;font-size:1.2rem">Avvio sensori...</div>
  <button onclick="startApp()" style="padding:40px;font-size:1.8rem;background:#D4AF37;color:#000;border-radius:15px;width:95%;border:4px solid #fff;font-weight:bold">AVVIA SISTEMA</button>
</div>

<div id="key-screen" class="overlay hidden" aria-hidden="true" inert>
  <h2 style="color:#fff">Chiave Gemini API</h2>
  <input type="text" id="key-input" placeholder="Incolla chiave qui..." style="width:80%;padding:15px;font-size:1.2rem;margin-bottom:20px;border-radius:8px">
  <button onclick="saveKey()" style="padding:15px;background:#fff;color:#000;width:50%;font-weight:bold;border-radius:8px;margin-bottom:10px">SALVA</button>
  <button onclick="closeSettings()" style="padding:15px;background:#333;color:#fff;width:50%;border-radius:8px">CHIUDI</button>
</div>

<script>
/* CONFIGURAZIONE */
let GEMINI_KEY=localStorage.getItem('gemini_key')||"";
const MODEL_NAME="gemini-3-pro-preview"; // O "gemini-1.5-flash"
const API_ENDPOINT="v1beta";

/* VARIABILI DI STATO */
let audioCtx,lightOsc,lightGain,objectDetector=null,isRunning=false,stream=null;
const tempCanvas=document.createElement('canvas');let tempCtx=null;
let mode='idle',lightActive=false,colorActive=false,levelActive=false,discreteMode=false;
let lastSpeak=0,centeredCount=0,lastGuideMessage="",lastGuideMessageTime=0;
let currentFacingMode='environment'; // Parte con la posteriore
const video=document.getElementById('webcam'),canvas=document.getElementById('overlay'),ctx=canvas.getContext('2d');
let lastShotB64=null,lastShotUrl=null;

/* FUNZIONI ACCESSIBILITÀ E UTILITÀ */
function announce(t){
  if(discreteMode)return; // Se discreto è attivo, sto zitto
  const e=document.getElementById('sr-announcer');
  e.textContent="";
  setTimeout(()=>e.textContent=t,50);
}
function vibrate(p){if(navigator.vibrate)navigator.vibrate(p)}

function showCameraOnly(){
  const cam=document.getElementById('main-interface');
  const res=document.getElementById('result-screen');
  res.classList.add('hidden');res.setAttribute('aria-hidden','true');res.setAttribute('inert','');
  document.getElementById('camera-controls').classList.remove('hidden');
  document.getElementById('camera-controls').removeAttribute('aria-hidden');
  document.getElementById('camera-controls').removeAttribute('inert');
}

function showResultOnly(text){
  const cam=document.getElementById('camera-controls');
  const res=document.getElementById('result-screen');
  cam.classList.add('hidden');cam.setAttribute('aria-hidden','true');cam.setAttribute('inert','');
  res.classList.remove('hidden');res.removeAttribute('aria-hidden');res.removeAttribute('inert');
  const c=document.getElementById('result-content');c.textContent=text||"";
  setTimeout(()=>c.focus(),200);
}

/* GESTIONE FOTOCAMERA */
async function setupCamera(facing){
    if(stream) stream.getTracks().forEach(t=>t.stop());
    const constraints = { video: { facingMode: facing, width: { ideal: 1280 }, height: { ideal: 720 } } };
    try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        tempCanvas.width = video.videoWidth; tempCanvas.height = video.videoHeight;
    } catch(e) { console.error(e); announce("Errore avvio fotocamera."); }
}

async function flipCamera(){
    announce("Ruoto...");
    currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
    await setupCamera(currentFacingMode);
    // ANNUNCIO FONDAMENTALE
    if(currentFacingMode === 'user') announce("Fotocamera frontale attiva (Selfie).");
    else announce("Fotocamera posteriore attiva.");
}

function captureFrame(){
  if(video.videoWidth>0 && (tempCanvas.width!==video.videoWidth)){
     tempCanvas.width=video.videoWidth; tempCanvas.height=video.videoHeight;
  }
  if(tempCtx)tempCtx.drawImage(video,0,0,tempCanvas.width,tempCanvas.height);
  return tempCanvas.toDataURL('image/jpeg',0.8).split(',')[1];
}

async function takeShot(){
    announce("Scatto foto.");
    playShutter();
    lastShotB64 = captureFrame();
    announce("Foto scattata e salvata in memoria.");
}

/* SENSORI E STRUMENTI */
function playShutter(){
  if(!discreteMode && audioCtx){
    if(audioCtx.state==='suspended')audioCtx.resume();
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    g.gain.value=0.1;o.frequency.value=600;o.connect(g);g.connect(audioCtx.destination);
    o.start();o.stop(audioCtx.currentTime+0.1);
  }
}

// GUIDA CENTRAGGIO
function toggleGuidance(){
  if(!objectDetector){announce("Sistema oggetti non pronto.");return;}
  const b=document.getElementById('btn-guide');
  if(mode==='guiding'){
    mode='idle';b.classList.remove('guiding');b.innerText="GUIDA CENTRAGGIO";
    ctx.clearRect(0,0,canvas.width,canvas.height);announce("Guida spenta.");
  }else{
    mode='guiding';centeredCount=0;lastGuideMessage="";
    b.classList.add('guiding');b.innerText="GUIDA ATTIVA";announce("Guida attiva. Cerco oggetti.");
  }
}
function processGuidance(){
  if(!objectDetector || video.readyState<2)return;
  try{
    const r=objectDetector.detectForVideo(video,performance.now()),d=r?r.detections:[];
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(!d.length){
      if(Date.now()-lastSpeak>3000){announce("Nessun oggetto.");lastSpeak=Date.now();}
      return;
    }
    const t=d.sort((a,b)=>b.boundingBox.width*b.boundingBox.height-a.boundingBox.width*a.boundingBox.height)[0],b=t.boundingBox;
    
    // Disegno Box
    const rx=canvas.width/video.videoWidth, ry=canvas.height/video.videoHeight;
    ctx.strokeStyle="#0f0";ctx.lineWidth=5;
    ctx.strokeRect(b.originX*rx, b.originY*ry, b.width*rx, b.height*ry);

    const cx=b.originX+b.width/2, cy=b.originY+b.height/2;
    const sx=video.videoWidth/2, sy=video.videoHeight/2;
    const tolX=video.videoWidth*0.15, tolY=video.videoHeight*0.2;
    
    let m="",label=t.categories[0].categoryName;
    const map={person:"Persona",cup:"Tazza",bottle:"Bottiglia",chair:"Sedia",tv:"TV",laptop:"PC","cell phone":"Telefono",book:"Libro"};
    if(map[label])label=map[label];
    
    if(cx<sx-tolX)m=label+": sinistra";
    else if(cx>sx+tolX)m=label+": destra";
    else if(cy<sy-tolY)m=label+": in alto"; // Coordinate video invertite rispetto al movimento mano
    else if(cy>sy+tolY)m=label+": in basso";
    else{m=label+": centrato!";centeredCount++}
    
    const now=Date.now();
    if(m!==lastGuideMessage || now-lastGuideMessageTime>3000){
      announce(m);if(m.toLowerCase().includes("centrato"))vibrate(50);
      lastGuideMessage=m;lastGuideMessageTime=now;
    }
  }catch(e){}
}

// SONDA LUCE
function toggleLight(){
  lightActive=!lightActive;const b=document.getElementById('btn-light');
  if(lightActive){
    if(audioCtx.state==='suspended')audioCtx.resume();
    lightOsc=audioCtx.createOscillator();lightGain=audioCtx.createGain();
    lightOsc.connect(lightGain);lightGain.connect(audioCtx.destination);
    lightGain.gain.value=0;lightOsc.start();
    b.classList.add('active-tool');b.innerText="LUCE: ON";announce("Sonda luce attiva.");
  }else{
    if(lightOsc){lightOsc.stop();lightOsc.disconnect();}
    b.classList.remove('active-tool');b.innerText="SONDA LUCE";announce("Sonda luce spenta.");
  }
}
function processLight(){
  if(!tempCtx)return;
  const p=tempCtx.getImageData(tempCanvas.width/2-5,tempCanvas.height/2-5,10,10).data;
  let s=0; for(let i=0;i<p.length;i+=4)s+=(p[i]+p[i+1]+p[i+2])/3;
  const level=s/(p.length/4);
  if(lightOsc) {
      lightGain.gain.setTargetAtTime(0.02+(level/255)*0.1,audioCtx.currentTime,0.1);
      lightOsc.frequency.setTargetAtTime(100+level*4,audioCtx.currentTime,0.1);
  }
}

// SONDA COLORE
function toggleColor(){
  colorActive=!colorActive;const b=document.getElementById('btn-color');
  if(colorActive){b.classList.add('active-tool');b.innerText="COLORE: ON";announce("Sonda colore attiva.");}
  else{b.classList.remove('active-tool');b.innerText="SONDA COLORE";announce("Sonda colore spenta.");}
}
function processColor(){
  if(Date.now()-lastSpeak<2000)return;
  const p=tempCtx.getImageData(tempCanvas.width/2,tempCanvas.height/2,1,1).data;
  const r=p[0],g=p[1],b=p[2];
  if(r<30&&g<30&&b<30){announce("Nero");lastSpeak=Date.now();return;}
  if(r>220&&g>220&&b>220){announce("Bianco");lastSpeak=Date.now();return;}
  const colors={'Rosso':[255,0,0],'Verde':[0,255,0],'Blu':[0,0,255],'Giallo':[255,255,0],'Arancione':[255,165,0],'Grigio':[128,128,128]};
  let min=Infinity,res="Indefinito";
  for(let k in colors){
     const c=colors[k], d=Math.sqrt((r-c[0])**2+(g-c[1])**2+(b-c[2])**2);
     if(d<min){min=d;res=k;}
  }
  announce(res);lastSpeak=Date.now();
}

// LIVELLA
function toggleLevel(){
  const b=document.getElementById('btn-level');
  if(levelActive){
     levelActive=false;b.classList.remove('active-tool');b.innerText="LIVELLA";
     announce("Livella spenta.");window.removeEventListener('deviceorientation',handleLevel);
  }else{
     const enable=()=>{levelActive=true;b.classList.add('active-tool');b.innerText="LIVELLA: ON";announce("Livella attiva.");window.addEventListener('deviceorientation',handleLevel)};
     if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
         DeviceOrientationEvent.requestPermission().then(r=>{if(r==='granted')enable();}).catch(()=>{});
     }else enable();
  }
}
function handleLevel(e){
  if(!levelActive || Date.now()-lastSpeak<1500)return;
  const t=e.gamma||0;
  if(t>10){announce("Destra");vibrate(30);lastSpeak=Date.now();}
  else if(t<-10){announce("Sinistra");vibrate(30);lastSpeak=Date.now();}
}

// MODO DISCRETO
function toggleDiscrete(){
  discreteMode=!discreteMode;
  document.getElementById('btn-discrete').classList.toggle('active-discrete');
  vibrate(100);
  if(!discreteMode) announce("Modo discreto disattivato. Voce riattivata.");
}

/* INTELLIGENZA ARTIFICIALE (GEMINI) */
async function callGemini(prompt,b64){
  try{
    const url=`https://generativelanguage.googleapis.com/${API_ENDPOINT}/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`;
    const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:prompt},{inline_data:{mime_type:"image/jpeg",data:b64}}]}]})});
    if(!r.ok)return null;
    const d=await r.json();
    return d.candidates?.[0]?.content?.parts?.map(p=>p.text).join("\n").trim()||"Nessun testo.";
  }catch(e){return null;}
}

function buildPrompt(c){
  const q="Valuta brevemente qualità foto.";
  if(c==='scene')return "Descrivi la scena per un non vedente. Soggetto, ambiente, atmosfera."+q;
  if(c==='text')return "LEGGI TUTTO il testo visibile riga per riga.";
  if(c==='object')return "Descrivi l'oggetto per identificarlo. Forma, colore, marca, dettagli."+q;
  if(c==='food')return "Descrivi il cibo nel piatto.";
  if(c==='selfie')return "Descrivi il volto, l'espressione e se è centrato."+q;
  if(c==='safety')return "SOLO SICUREZZA: Ostacoli, gradini, pericoli per camminare. Risposta breve.";
  if(c==='outdoor')return "Descrivi ambiente esterno, meteo, traffico.";
  if(c==='indoor')return "Descrivi stanza, mobili, porte.";
  return "Descrivi immagine.";
}

async function describeWithMode(c){
  if(!GEMINI_KEY){announce("Manca chiave API.");openSettings();return;}
  await captureNewShot(); // Scatta ora se non fatto
  showResultOnly("Analisi in corso...");announce("Analisi in corso...");
  const t=await callGemini(buildPrompt(c),lastShotB64);
  document.getElementById('result-content').textContent=t||"Errore.";
  announce("Risposta pronta.");
}

async function askCustomDetail(){
  if(!GEMINI_KEY){announce("Manca chiave API.");openSettings();return;}
  await captureNewShot();
  const q=prompt("Cosa vuoi sapere?");
  if(!q){announce("Annullato.");return;}
  showResultOnly("Cerco risposta...");announce("Analizzo domanda...");
  const t=await callGemini("L'utente non vedente chiede: \""+q+"\". Rispondi solo a questo.",lastShotB64);
  document.getElementById('result-content').textContent="Domanda: "+q+"\n\nRisposta: "+(t||"Errore.");
  announce("Risposta pronta.");
}

// AZIONI RISULTATO
async function captureNewShot(){
  if(mode==='guiding')toggleGuidance();
  playShutter();
  lastShotB64=captureFrame();
  return lastShotB64;
}
function deletePhoto(){
  lastShotB64=null;
  showCameraOnly();
  announce("Chiuso. Fotocamera attiva.");
}
async function editAndReviewPhoto(){
   // Qui usiamo il tasto per chiedere altro sulla stessa foto senza scattare di nuovo
   if(!lastShotB64)return;
   const q=prompt("Altra domanda su questa foto?");
   if(!q)return;
   announce("Analizzo...");
   const t=await callGemini("Sulla stessa foto, l'utente chiede: \""+q+"\".",lastShotB64);
   document.getElementById('result-content').textContent+="\n\nDomanda: "+q+"\nRisposta: "+(t||"Errore");
   announce("Aggiornato.");
}
async function usePhoto(){
  if(!lastShotB64)return;
  const b=await(await fetch("data:image/jpeg;base64,"+lastShotB64)).blob();
  const f=new File([b],"foto.jpg",{type:"image/jpeg"});
  if(navigator.share)navigator.share({files:[f]});
}

/* AVVIO */
async function startApp(){
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('start-screen').setAttribute('aria-hidden','true');
  
  // RIVELA INTERFACCIA
  const main=document.getElementById('main-interface');
  main.classList.remove('hidden');
  main.removeAttribute('aria-hidden');
  
  announce("Sistema avviato.");
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  
  await setupCamera(currentFacingMode);
  
  // Carica AI Oggetti
  try{
     const{ObjectDetector,FilesetResolver}=await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js");
     const vision=await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
     objectDetector=await ObjectDetector.createFromOptions(vision,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite",delegate:"GPU"},scoreThreshold:0.3,runningMode:"VIDEO"});
     announce("Riconoscimento oggetti attivo.");
  }catch(e){announce("Guida oggetti non disponibile.");}

  isRunning=true;
  tempCtx=tempCanvas.getContext('2d',{willReadFrequently:true});
  loop();
}

function loop(){
  if(!isRunning){requestAnimationFrame(loop);return;}
  if(video.readyState===4 && tempCtx){
      if(tempCanvas.width!==video.videoWidth){tempCanvas.width=video.videoWidth;tempCanvas.height=video.videoHeight;canvas.width=video.videoWidth;canvas.height=video.videoHeight;}
      tempCtx.drawImage(video,0,0,tempCanvas.width,tempCanvas.height);
      if(lightActive)processLight();
      if(colorActive)processColor();
      if(mode==='guiding')processGuidance();
  }
  requestAnimationFrame(loop);
}

// IMPOSTAZIONI
window.openSettings=()=>{document.getElementById('key-screen').classList.remove('hidden');document.getElementById('key-screen').removeAttribute('aria-hidden');document.getElementById('key-screen').removeAttribute('inert');};
window.closeSettings=()=>{document.getElementById('key-screen').classList.add('hidden');document.getElementById('key-screen').setAttribute('aria-hidden','true');document.getElementById('key-screen').setAttribute('inert','');};
window.saveKey=()=>{GEMINI_KEY=document.getElementById('key-input').value.trim();localStorage.setItem('gemini_key',GEMINI_KEY);closeSettings();announce("Salvata.");};

</script>
</body>
</html>