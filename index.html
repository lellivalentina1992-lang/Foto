<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Accessibile Pro - Feedback Probabilistico</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>

    <style>
        body { margin: 0; background: #000; color: #FFFF00; font-family: system-ui, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #status-bar { background: #FFFF00; color: #000; padding: 25px; font-weight: bold; font-size: 1.6rem; text-align: center; border-bottom: 5px solid #000; min-height: 150px; display: flex; align-items: center; justify-content: center; }
        #camera-view { flex: 1; background: #111; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; background: #000; }
        button { padding: 25px 5px; font-size: 1.1rem; font-weight: bold; text-transform: uppercase; border: 5px solid #FFFF00; background: #000; color: #FFFF00; border-radius: 20px; cursor: pointer; }
        button:active { background: #FFFF00; color: #000; }
        #btn-open-link { display: none; background: #0044cc; color: white; border-color: white; grid-column: span 2; }
        .full-width { grid-column: span 2; }
        .active-mode { background: #FFFF00 !important; color: #000 !important; }
        .btn-mute { background: #550000; color: white; border-color: white; }
    </style>
</head>
<body>

    <div id="status-bar" role="status" aria-live="assertive" aria-atomic="true">
        Inizializzazione vista...
    </div>

    <main id="camera-view">
        <video id="webcam" autoplay playsinline muted aria-hidden="true"></video>
    </main>

    <nav id="controls">
        <button id="btn-open-link">Apri Link Trovato</button>
        <button id="btn-auto" class="active-mode">Auto-Scan: ON</button>
        <button id="btn-mute">Pausa Voce</button>
        <button id="btn-switch" class="full-width">Cambia Camera</button>
        <button id="btn-light">Info Luce</button>
        <button id="btn-color">Colore</button>
        <button id="btn-money">Banconota</button>
        <button id="btn-ocr">Leggi Testo</button>
        <button id="btn-torch">Luce Flash</button>
        <button id="btn-zoom">Zoom</button>
        <button id="btn-copy">Copia</button>
        <button id="btn-history">Cronologia</button>
    </nav>

    <script>
        const video = document.getElementById('webcam');
        const statusDisplay = document.getElementById('status-bar');
        const btnAuto = document.getElementById('btn-auto');
        const btnMute = document.getElementById('btn-mute');
        
        let track = null, ocrWorker = null, net = null;
        let lastResult = "", isProcessing = false;
        let autoMode = true, voiceMuted = false, lastAnnounced = "";
        let currentUrl = "", torchActive = false, currentFacingMode = "environment";
        let inactivityTimer = 0, lastObject = "";
        let noObjectCounter = 0;

        const dizionario = {
            "notebook": "Computer portatile",
            "laptop": "Computer",
            "desk": "Tavolo",
            "dining table": "Tavolo da pranzo",
            "monitor": "Schermo",
            "mouse": "Mouse",
            "keyboard": "Tastiera",
            "cellular telephone": "Telefono",
            "cup": "Tazza",
            "water bottle": "Bottiglia",
            "remote control": "Telecomando",
            "coffee mug": "Tazza da caffè"
        };

        function comunica(messaggio, dato = "", tipo = "testo") {
            statusDisplay.textContent = messaggio;
            if (voiceMuted) return;
            
            // Filtro per evitare ripetizioni inutili
            if (dato && dato === lastAnnounced && tipo !== "manuale") return;
            
            if (dato) {
                lastResult = dato;
                lastAnnounced = dato;
                localStorage.setItem('lastScan', dato);
                inactivityTimer = 0;
                noObjectCounter = 0;
            }

            // Sintesi vocale per feedback immediato [cite: 2025-10-20]
            const speech = new SpeechSynthesisUtterance(messaggio);
            speech.lang = 'it-IT';
            window.speechSynthesis.speak(speech);
        }

        async function toggleTorch(forceState = null) {
            if (!track || currentFacingMode === "user") return;
            try {
                const capabilities = track.getCapabilities();
                if (!capabilities.torch) return;
                const newState = (forceState !== null) ? forceState : !torchActive;
                await track.applyConstraints({ advanced: [{ torch: newState }] });
                torchActive = newState;
                comunica(newState ? "Luce accesa." : "Luce spenta.");
            } catch (e) {}
        }

        async function analizza(isManual = false) {
            if (isProcessing || !net || video.readyState !== 4) return;
            isProcessing = true;

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            try {
                const predictions = await net.classify(canvas);
                
                if (predictions.length > 0) {
                    const prob = predictions[0].probability;
                    let oggInglese = predictions[0].className.split(',')[0].toLowerCase();
                    let oggItaliano = dizionario[oggInglese] || oggInglese;
                    
                    // Logica "Forse" basata sulla probabilità richiesta
                    if (prob > 0.60) {
                        if (oggItaliano !== lastObject || isManual) {
                            comunica("Vedo: " + oggItaliano, oggItaliano, isManual ? "manuale" : "oggetto");
                            lastObject = oggItaliano;
                        }
                    } else if (prob > 0.25) {
                        if (oggItaliano !== lastObject || isManual) {
                            comunica("Forse vedo: " + oggItaliano, "forse_" + oggItaliano, isManual ? "manuale" : "oggetto");
                            lastObject = oggItaliano;
                        }
                    } else {
                        noObjectCounter++;
                    }
                }

                // Feedback se non trova nulla per diversi secondi [cite: 2025-10-20]
                if (noObjectCounter > 6) {
                    comunica("Sto ancora cercando. Prova a muovere il telefono.");
                    noObjectCounter = 0;
                }

                // OCR periodico o manuale
                if (isManual || (autoMode && inactivityTimer % 12 === 0)) {
                    if (ocrWorker) {
                        const { data: { text, confidence } } = await ocrWorker.recognize(canvas);
                        const txt = text.trim();
                        if (txt.length > 3 && confidence > 45) {
                            comunica("Testo rilevato: " + txt.substring(0, 60));
                            noObjectCounter = 0;
                        }
                    }
                }
            } catch (e) { console.error(e); }
            isProcessing = false;
        }

        // Loop scansione automatica [cite: 2025-10-20]
        setInterval(() => {
            if (autoMode && !isProcessing && net) {
                inactivityTimer++;
                if (inactivityTimer > 350) {
                    autoMode = false;
                    btnAuto.classList.remove('active-mode');
                    comunica("Scanner in pausa.");
                } else { 
                    analizza(false); 
                }
            }
        }, 2500);

        async function avviaCamera(mode) {
            if (track) track.stop();
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: mode, width: { ideal: 1280 } } 
                });
                video.srcObject = stream;
                track = stream.getVideoTracks()[0];
                currentFacingMode = mode;
                comunica("Fotocamera pronta.");
            } catch (err) { 
                comunica("Errore fotocamera."); 
            }
        }

        btnAuto.onclick = () => { autoMode = !autoMode; btnAuto.classList.toggle('active-mode'); comunica(autoMode ? "Auto-scan attivo." : "Auto-scan spento."); };
        btnMute.onclick = () => { voiceMuted = !voiceMuted; btnMute.classList.toggle('btn-mute'); btnMute.textContent = voiceMuted ? "Voce: OFF" : "Pausa Voce"; };
        document.getElementById('btn-torch').onclick = () => toggleTorch();
        document.getElementById('btn-switch').onclick = () => avviaCamera(currentFacingMode === "environment" ? "user" : "environment");
        document.getElementById('btn-ocr').onclick = () => analizza(true);
        document.getElementById('btn-money').onclick = () => analizza(true);
        document.getElementById('btn-light').onclick = () => {
            const canvas = document.createElement('canvas'); canvas.width = 10; canvas.height = 10;
            const ctx = canvas.getContext('2d'); ctx.drawImage(video, 0, 0, 10, 10);
            const d = ctx.getImageData(5, 5, 1, 1).data;
            const l = (d[0] + d[1] + d[2]) / 3 / 2.55;
            comunica("Luce: " + (l < 20 ? "Buio" : l < 50 ? "Scarsa" : "Buona"));
        };
        document.getElementById('btn-copy').onclick = async () => { if (lastResult) { await navigator.clipboard.writeText(lastResult); comunica("Copiato."); } };
        document.getElementById('btn-history').onclick = () => comunica("Ultimo: " + (localStorage.getItem('lastScan') || "vuoto"));
        document.getElementById('btn-color').onclick = () => comunica("Analisi colore attiva.");

        window.onload = async () => { 
            await avviaCamera("environment"); 
            comunica("Avvio sistemi di visione...");
            try {
                ocrWorker = await Tesseract.createWorker('ita');
                net = await mobilenet.load();
                comunica("Sistema pronto. Inquadra un oggetto.");
            } catch (e) {
                comunica("Errore di caricamento.");
            }
        };
    </script>
</body>
</html>