<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>AI Photo Hub v49 (FREE Local + Share + APIs + Social Goal + Overlay + Chat)</title>
<style>
  body{font-family:'Segoe UI',Roboto,Arial,sans-serif;margin:0;padding:0;background:#000;color:#fff;height:100vh;display:flex;flex-direction:column}
  .sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)}
  .hidden{display:none !important}
  #main-container{flex-grow:1;display:flex;flex-direction:column;padding:15px;gap:15px;justify-content:center}
  button{
    border:3px solid #555;border-radius:18px;font-size:1.2rem;font-weight:bold;text-transform:uppercase;
    color:#fff;background:#222;padding:20px 10px;width:100%;touch-action:manipulation;margin-bottom:10px;
    box-shadow:0 4px 10px rgba(0,0,0,0.5);
  }
  button:active{transform:scale(0.98);background:#444}

  .btn-cam-user{background:#004080;border-color:#4a90e2;height:22vh;font-size:1.55rem}
  .btn-cam-env{background:#4B0082;border-color:#9370DB;height:22vh;font-size:1.55rem}

  .btn-free{background:#5a8f00;border-color:#b7ff7a}
  .btn-share{background:#d93025;border-color:#f28b82}
  .btn-gemini{background:#1a73e8;border-color:#8ab4f8}
  .btn-openai{background:#10a37f;border-color:#55efc4}
  .btn-claude{background:#b85cff;border-color:#e3b3ff}

  .screen{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:#000;z-index:60;padding:20px;
    display:flex;flex-direction:column;justify-content:center;gap:10px;
    overflow-y:auto;
  }

  #result-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:120;padding:16px;display:flex;flex-direction:column;gap:12px;overflow-y:auto}
  #result-text{background:#111;border:1px solid #555;padding:14px;font-size:1.12rem;line-height:1.6;white-space:pre-wrap;border-radius:10px}
  .small-note{color:#aaa;font-size:0.9rem;font-weight:normal;text-transform:none}

  #chat-box{background:#0f0f0f;border:1px solid #333;border-radius:10px;padding:10px;max-height:30vh;overflow:auto}
  .chat-msg{padding:8px 10px;border-radius:10px;margin:8px 0;white-space:pre-wrap;line-height:1.5}
  .chat-user{background:#1b1b1b;border:1px solid #2a2a2a}
  .chat-ai{background:#121a14;border:1px solid #1e2a21}
  #chat-input{width:100%;padding:14px;background:#222;color:#fff;border:1px solid #555;border-radius:10px;font-size:1.05rem}
  .row{display:flex;gap:10px}
  .row > *{flex:1}

  #settings-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:#111;z-index:200;display:flex;flex-direction:column;padding:20px;overflow-y:auto}
  .setting-group{margin-bottom:20px;border-bottom:1px solid #333;padding-bottom:12px}
  .setting-label{display:block;color:#aaa;margin-bottom:5px;font-size:0.9rem}
  .setting-input{width:100%;padding:14px;background:#222;color:#fff;border:1px solid #555;border-radius:8px;font-size:1.02rem}

  #overlay-preview{width:100%;max-width:520px;border:1px solid #444;border-radius:10px}
  #overlay-text{width:100%;padding:14px;background:#222;color:#fff;border:1px solid #555;border-radius:10px;font-size:1.05rem}
  #overlay-status{color:#aaa;font-size:0.95rem}

  #inp-cam-env,#inp-cam-user{display:none}
</style>
</head>
<body>

<div id="sr-announcer" class="sr-only" aria-live="assertive"></div>

<div id="main-container">
  <h1 style="text-align:center;color:#D4AF37;margin:0;font-size:1.5rem">AI HUB</h1>

  <input type="file" id="inp-cam-env" accept="image/*" capture="environment" onchange="handlePhoto(this)">
  <input type="file" id="inp-cam-user" accept="image/*" capture="user" onchange="handlePhoto(this)">

  <button class="btn-cam-user" onclick="triggerCamera('user')">
    SELFIE<br><span style="font-size:1rem">(Frontale)</span>
  </button>

  <button class="btn-cam-env" onclick="triggerCamera('environment')">
    AMBIENTE<br><span style="font-size:1rem">(Posteriore)</span>
  </button>

  <button onclick="openSettings()" style="font-size:1rem;padding:15px;background:#111;border:1px solid #333">
    IMPOSTAZIONI API
  </button>
</div>

<!-- ACTION SCREEN -->
<div id="ai-screen" class="screen hidden" aria-hidden="true">
  <h2 style="text-align:center;margin:0 0 6px 0">Cosa vuoi fare?</h2>

  <button class="btn-free" onclick="runFreeLocal()">
    FREE (LOCALE)<br><span class="small-note">nessuna key • primo uso lento (download modello)</span>
  </button>

  <button class="btn-share" onclick="shareImageNative()">
    CONDIVIDI<br><span class="small-note">Be My Eyes / WhatsApp / qualsiasi app</span>
  </button>

  <h3 style="text-align:center;margin:6px 0;color:#D4AF37;font-size:1.05rem">Oppure analizza con API</h3>

  <button class="btn-gemini" onclick="chooseProvider('gemini')">
    GEMINI<br><span class="small-note" id="lbl-gemini-model">-</span>
  </button>

  <button class="btn-openai" onclick="chooseProvider('openai')">
    OPENAI (ChatGPT)<br><span class="small-note" id="lbl-openai-model">-</span>
  </button>

  <button class="btn-claude" onclick="chooseProvider('claude')">
    CLAUDE<br><span class="small-note" id="lbl-claude-model">-</span>
  </button>

  <button style="background:#333;margin-top:8px" onclick="discardPhoto()">ANNULLA</button>
</div>

<!-- CONTEXT SCREEN (only after API pick) -->
<div id="context-screen" class="screen hidden" aria-hidden="true">
  <h2 style="text-align:center;margin:0 0 6px 0">Scegli contesto</h2>

  <button onclick="setContextAndRun('selfie')">
    SELFIE<br><span class="small-note">taglio/centratura • sorriso/occhi • profilo • pubblicabile?</span>
  </button>

  <button onclick="setContextAndRun('objects')">
    OGGETTI / SCENA<br><span class="small-note">cosa è centrato • disordine • estetica • conservabile?</span>
  </button>

  <button onclick="openSocialGoal()">
    SOCIAL<br><span class="small-note">scegli obiettivo: Feed / Schermo intero / Decidi tu</span>
  </button>

  <button onclick="setContextAndRun('document')">
    DOCUMENTO / TESTO<br><span class="small-note">leggibilità + estrazione info</span>
  </button>

  <button onclick="setContextAndRun('safety')">
    SICUREZZA<br><span class="small-note">ostacoli, rischi, percorso</span>
  </button>

  <button onclick="setContextAndRun('product')">
    PRODOTTO<br><span class="small-note">identificazione, condizioni, foto da annuncio</span>
  </button>

  <button style="background:#333;margin-top:8px" onclick="backToAIScreen()">INDIETRO</button>
</div>

<!-- SOCIAL GOAL (simple) -->
<div id="social-goal-screen" class="screen hidden" aria-hidden="true">
  <h2 style="text-align:center;margin:0 0 6px 0">Social: obiettivo</h2>

  <button onclick="setSocialGoalAndRun('feed')">
    FEED<br><span class="small-note">quadrato 1:1 o verticale 4:5 (IG/FB)</span>
  </button>

  <button onclick="setSocialGoalAndRun('fullscreen')">
    SCHERMO INTERO<br><span class="small-note">verticale 9:16 (Stories/Reels/TikTok)</span>
  </button>

  <button onclick="setSocialGoalAndRun('auto')">
    NON LO SO / DECIDI TU<br><span class="small-note">l’AI propone l’opzione meno rischiosa</span>
  </button>

  <button style="background:#333;margin-top:8px" onclick="backToContextFromGoal()">INDIETRO</button>
</div>

<!-- OVERLAY EDITOR (social only) -->
<div id="overlay-screen" class="screen hidden" aria-hidden="true" style="z-index:150">
  <h2 style="text-align:center;margin:0">Testo in foto</h2>
  <div id="overlay-status">Scrivi il testo. Poi l’AI decide posizione/dimensione/colore per l’obiettivo social.</div>

  <textarea id="overlay-text" rows="3" placeholder="Scrivi il testo da mettere in foto..."></textarea>

  <div class="row">
    <button onclick="applyOverlayWithAI()" style="background:#006400;border-color:#4be38b">APPLICA CON AI</button>
    <button onclick="applyOverlayQuick()" style="background:#444">APPLICA RAPIDO</button>
  </div>

  <canvas id="overlay-preview" class="hidden"></canvas>

  <div class="row">
    <button onclick="downloadOverlay()" style="background:#1a73e8;border-color:#8ab4f8">SCARICA</button>
    <button onclick="shareOverlay()" class="btn-share">CONDIVIDI</button>
  </div>

  <button style="background:#333" onclick="closeOverlay()">CHIUDI</button>
</div>

<!-- RESULT + CHAT -->
<div id="result-screen" class="hidden" aria-hidden="true">
  <h2 style="color:#D4AF37;text-align:center;margin:0" id="res-title">Risultato</h2>

  <div id="result-text" tabindex="0">Elaborazione...</div>

  <div id="social-tools" class="hidden">
    <button onclick="openOverlay()" style="background:#b85cff;border-color:#e3b3ff">
      AGGIUNGI TESTO IN FOTO<br><span class="small-note">l’AI sceglie posizione/dimensione/colore</span>
    </button>
  </div>

  <h3 style="margin:8px 0 0 0;font-size:1.05rem;color:#D4AF37">Chat con l’AI scelta</h3>
  <div id="chat-box" aria-label="Chat"></div>
  <textarea id="chat-input" rows="2" placeholder="Scrivi una domanda... (es. 'Meglio 1:1 o 4:5?', 'Dove ritaglio?', 'Testo più leggibile?')"></textarea>

  <div class="row">
    <button onclick="sendChat()" style="background:#006400;border-color:#4be38b">INVIA</button>
    <button onclick="closeResult()" style="background:#555">CHIUDI</button>
  </div>
</div>

<!-- SETTINGS -->
<div id="settings-screen" class="hidden">
  <h2 style="text-align:center">Impostazioni API</h2>

  <div class="setting-group">
    <label class="setting-label">GOOGLE GEMINI API KEY</label>
    <input type="text" id="key-gemini" class="setting-input" placeholder="Incolla AIza...">
  </div>
  <div class="setting-group">
    <label class="setting-label">MODELLO GEMINI</label>
    <input type="text" id="model-gemini" class="setting-input" value="gemini-3-pro-preview">
  </div>

  <div class="setting-group">
    <label class="setting-label">OPENAI API KEY (sk-...)</label>
    <input type="text" id="key-openai" class="setting-input" placeholder="Incolla sk-...">
  </div>
  <div class="setting-group">
    <label class="setting-label">MODELLO OPENAI</label>
    <input type="text" id="model-openai" class="setting-input" value="gpt-5.2">
  </div>

  <div class="setting-group">
    <label class="setting-label">ANTHROPIC (CLAUDE) API KEY</label>
    <input type="text" id="key-claude" class="setting-input" placeholder="Incolla la tua key Anthropic...">
  </div>
  <div class="setting-group">
    <label class="setting-label">MODELLO CLAUDE</label>
    <input type="text" id="model-claude" class="setting-input" value="claude-sonnet-4-5">
  </div>

  <button onclick="saveSettings()" style="background:#006400">SALVA TUTTO</button>
  <button onclick="closeSettings()" style="background:#333;margin-top:10px">CHIUDI</button>
</div>

<script>
/* -------------------- STATE -------------------- */
let KEYS = {
  gemini: localStorage.getItem('key_gemini') || "",
  openai: localStorage.getItem('key_openai') || "",
  claude: localStorage.getItem('key_claude') || "",
  geminiModel: localStorage.getItem('model_gemini') || "gemini-3-pro-preview",
  openaiModel: localStorage.getItem('model_openai') || "gpt-5.2",
  claudeModel: localStorage.getItem('model_claude') || "claude-sonnet-4-5"
};

let currentPhotoBase64 = null;
let currentProvider = null;             // gemini|openai|claude
let currentContext = null;              // selfie|objects|social|document|safety|product
let socialGoal = null;                  // feed|fullscreen|auto
let currentCameraKind = 'environment';  // selfie/environment

let chatHistory = [];
let lastAnalysisText = "";

// overlay
let overlayCanvas = null;
let overlayBlob = null;

/* -------------------- UI HELPERS -------------------- */
function announce(m){
  const el = document.getElementById('sr-announcer');
  el.textContent = '';
  setTimeout(() => el.textContent = m, 50);
}
function show(id){
  const el = document.getElementById(id);
  el.classList.remove('hidden');
  el.removeAttribute('aria-hidden');
}
function hide(id){
  const el = document.getElementById(id);
  el.classList.add('hidden');
  el.setAttribute('aria-hidden','true');
}
function setResultText(t){
  document.getElementById('result-text').innerText = t;
  lastAnalysisText = t;
}
function resetChat(){
  chatHistory = [];
  document.getElementById('chat-box').innerHTML = "";
}
function addChat(role, text){
  chatHistory.push({role, text});
  const div = document.createElement('div');
  div.className = "chat-msg " + (role === 'user' ? 'chat-user' : 'chat-ai');
  div.innerText = (role === 'user' ? "TU: " : "AI: ") + text;
  const box = document.getElementById('chat-box');
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

/* -------------------- CAMERA -------------------- */
function triggerCamera(mode){
  currentCameraKind = (mode === 'user') ? 'selfie' : 'environment';
  if(mode === 'user') document.getElementById('inp-cam-user').click();
  else document.getElementById('inp-cam-env').click();
}
function handlePhoto(input){
  if (input.files && input.files[0]) {
    const file = input.files[0];
    const reader = new FileReader();
    announce("Foto presa. Scegli cosa fare.");
    reader.onload = function(e) {
      currentPhotoBase64 = e.target.result;

      document.getElementById('lbl-gemini-model').innerText = KEYS.geminiModel;
      document.getElementById('lbl-openai-model').innerText = KEYS.openaiModel;
      document.getElementById('lbl-claude-model').innerText = KEYS.claudeModel;

      document.getElementById('main-container').classList.add('hidden');
      show('ai-screen');
      setTimeout(() => document.querySelector('.btn-free').focus(), 200);
    }
    reader.readAsDataURL(file);
  }
}

/* -------------------- NAV -------------------- */
function chooseProvider(p){
  currentProvider = p;
  if(p === 'gemini' && !KEYS.gemini){ announce("Manca Key Gemini."); openSettings(); return; }
  if(p === 'openai' && !KEYS.openai){ announce("Manca Key OpenAI."); openSettings(); return; }
  if(p === 'claude' && !KEYS.claude){ announce("Manca Key Claude."); openSettings(); return; }
  hide('ai-screen');
  show('context-screen');
  announce("Scegli contesto.");
}
function backToAIScreen(){
  hide('context-screen'); hide('social-goal-screen');
  show('ai-screen');
  announce("Torno alla scelta.");
}
function setContextAndRun(ctx){
  currentContext = ctx;
  socialGoal = null;
  hide('context-screen');
  runSelectedProvider();
}

function openSocialGoal(){
  hide('context-screen');
  show('social-goal-screen');
  announce("Scegli obiettivo social.");
}
function backToContextFromGoal(){
  hide('social-goal-screen');
  show('context-screen');
  announce("Scegli contesto.");
}
function setSocialGoalAndRun(goal){
  currentContext = 'social';
  socialGoal = goal; // feed|fullscreen|auto
  hide('social-goal-screen');
  runSelectedProvider();
}

/* -------------------- PROMPTS -------------------- */
function goalLabel(){
  if(socialGoal === 'feed') return "FEED (preferisci 1:1 o 4:5 a seconda della foto; minimizza tagli e mantieni soggetto leggibile in anteprima)";
  if(socialGoal === 'fullscreen') return "SCHERMO INTERO 9:16 (Stories/Reels/TikTok; rispetta safe area UI)";
  return "AUTO (scegli l’opzione meno rischiosa: evita crop aggressivi se può tagliare parti importanti)";
}
function buildAnalysisPrompt(){
  const base = `
Rispondi in ITALIANO. Sii concreto e utile.
Non inventare dettagli: se non è chiaro scrivi "non è chiaro" e spiega cosa manca.
Formato risposta con sezioni:
A) VERDETTO (Pubblicabile: Sì/Quasi/No) + 1 frase
B) TAGLIO & CENTRATURA (cosa è tagliato / vicino ai bordi / decentrato; come migliorare)
C) QUALITÀ TECNICA (luce, fuoco, mosso, rumore, riflessi)
D) ESTETICA (sfondo, distrazioni, linee, ordine, colori)
E) AZIONI IMMEDIATE (max 5, super pratiche)
`;

  if(currentContext === 'selfie'){
    return `
Sei un "photo coach" per selfie e profili social. Valuta questa foto per una persona non vedente.
Obiettivo: dire se è venuta bene e se è pubblicabile.

${base}

In più includi SEMPRE:
- VISO: espressione, sorriso (naturale/forzato), occhi (aperti/chiusi, sguardo), ombre sul viso.
- INQUADRATURA: testa/mento tagliati? camera troppo alta/bassa? distanza giusta?
- PROFILO: adatta a foto profilo con possibile crop circolare? cosa rischia di sparire?
Concludi con: "VOTO 0-10 + 1 motivo".
`;
  }

  if(currentContext === 'objects'){
    return `
Sei un valutatore di foto di oggetti/scena per archiviazione e pubblicazione.
Obiettivo: capire soggetto, centratura, tagli, utilità.

${base}

In più:
- SOGGETTO PRINCIPALE: cos’è e dove sta (centro/bordi).
- TAGLI PROBLEMATICI: parti importanti tagliate? cosa manca?
- CONSERVABILE: Sì/No e perché.
`;
  }

  if(currentContext === 'social'){
    return `
Sei un social media editor. Obiettivo: consigli di crop/formato/safe-area e prontezza pubblicazione.
Obiettivo social scelto: ${goalLabel()}.

${base}

In più includi SEMPRE:
- FORMATO CONSIGLIATO: scegli tra 1:1, 4:5, 9:16, 16:9 (coerente con l’obiettivo). Se FEED, decidi tra 1:1 o 4:5.
- SAFE AREA: cosa è troppo vicino ai bordi (viso, mani, oggetto, testo).
- RISCHIO CROP: cosa può essere tagliato se si passa al formato consigliato (alto/basso/lati).
- CROP CONSIGLIATO: descrivi un ritaglio “a parole” (es. taglia un po’ sotto, lascia spazio sopra…).
Concludi con: "PRONTA PER SOCIAL: Sì/Quasi/No + 1 correzione top".
`;
  }

  if(currentContext === 'document'){
    return `
Sei un assistente per documenti in foto.
Obiettivo: estrarre contenuti e dire se la foto è leggibile.

${base}

In più:
- TESTO ESTRATTO (se leggibile) oppure "non leggibile" + motivo.
- DATI IMPORTANTI: date, importi, nomi, scadenze, indirizzi.
`;
  }

  if(currentContext === 'safety'){
    return `
Sei un assistente di orientamento e sicurezza per una persona non vedente.
Obiettivo: descrivere la scena evidenziando ostacoli e rischi.

${base}

In più:
- OSTACOLI/RISCHI (scale, gradini, spigoli, cavi, oggetti a terra).
- PERCORSO CONSIGLIATO (sinistra/destra/centro) se deducibile.
`;
  }

  if(currentContext === 'product'){
    return `
Sei un assistente per valutare un prodotto da foto (vendita/archivio).
Obiettivo: identificazione, condizioni, difetti e qualità delle foto.

${base}

In più:
- IDENTIFICAZIONE (marca/modello se visibile).
- CONDIZIONI (usura, graffi, rotture).
- FOTO DA ANNUNCIO: cosa manca per un annuncio perfetto.
`;
  }

  return `Descrivi l’immagine in modo utile. ${base}`;
}

function buildChatSystemHint(){
  return `
Sei l'assistente della stessa sessione foto. Mantieni coerenza con l'analisi precedente.
Contesto: ${currentContext || "generico"}.
${currentContext === 'social' ? ("Obiettivo social: " + goalLabel() + ".") : ""}
Regola: risposte pratiche, con istruzioni operative su crop, centratura, testo, ecc.
`;
}

/* -------------------- RESULT SCREEN -------------------- */
function showResultScreen(msg){
  hide('ai-screen'); hide('context-screen'); hide('social-goal-screen');
  show('result-screen');
  setResultText(msg);
  resetChat();
  if(currentContext === 'social') show('social-tools'); else hide('social-tools');
  announce(msg);
}

/* -------------------- PROVIDERS -------------------- */
async function runSelectedProvider(){
  if(!currentProvider){ announce("Seleziona prima una API."); show('ai-screen'); return; }
  showResultScreen("Analisi in corso...");
  const prompt = buildAnalysisPrompt();

  if(currentProvider === 'gemini') return analyzeWithGemini(prompt);
  if(currentProvider === 'openai') return analyzeWithOpenAI(prompt);
  if(currentProvider === 'claude') return analyzeWithClaude(prompt);
}

async function analyzeWithGemini(prompt){
  const b64 = currentPhotoBase64.split(',')[1];
  try{
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(KEYS.geminiModel)}:generateContent`;
    const res = await fetch(url, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'x-goog-api-key': KEYS.gemini },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: 'image/jpeg', data: b64 } }] }]
      })
    });
    if(!res.ok) throw new Error("Errore API Google");
    const d = await res.json();
    const text = d.candidates?.[0]?.content?.parts?.map(p => p.text).filter(Boolean).join("\n") || "Nessun risultato.";
    setResultText(text.replace(/\*/g,''));
    addChat('assistant', "Dimmi cosa vuoi migliorare (crop, centratura, testo, ecc.).");
  }catch(e){
    setResultText("Errore con Gemini: " + (e?.message || e));
  }
}

async function analyzeWithOpenAI(prompt){
  try{
    const res = await fetch("https://api.openai.com/v1/responses", {
      method: "POST",
      headers: { "Content-Type":"application/json", "Authorization": `Bearer ${KEYS.openai}` },
      body: JSON.stringify({
        model: KEYS.openaiModel,
        input: [{ role: "user", content: [{ type: "input_text", text: prompt }, { type: "input_image", image_url: currentPhotoBase64 }] }],
        max_output_tokens: 900
      })
    });
    if(!res.ok) throw new Error("Errore API OpenAI");
    const d = await res.json();
    setResultText(d.output_text || "Nessuna risposta.");
    addChat('assistant', "Vuoi un crop preciso o testo in foto? Scrivimi qui.");
  }catch(e){
    setResultText("Errore con OpenAI: " + (e?.message || e));
  }
}

async function analyzeWithClaude(prompt){
  const b64 = currentPhotoBase64.split(',')[1];
  try{
    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type":"application/json", "x-api-key": KEYS.claude, "anthropic-version": "2023-06-01" },
      body: JSON.stringify({
        model: KEYS.claudeModel,
        max_tokens: 900,
        messages: [{ role: "user", content: [{ type: "image", source: { type: "base64", media_type: "image/jpeg", data: b64 } }, { type: "text", text: prompt }] }]
      })
    });
    if(!res.ok) throw new Error("Errore API Anthropic");
    const d = await res.json();
    const text = (d.content || []).filter(x => x.type === "text" && x.text).map(x => x.text).join("\n") || "Nessuna risposta.";
    setResultText(text);
    addChat('assistant', "Chiedimi: ‘meglio 1:1 o 4:5?’ oppure ‘dove mettere il testo?’");
  }catch(e){
    setResultText("Errore con Claude: " + (e?.message || e));
  }
}

/* -------------------- CHAT -------------------- */
async function sendChat(){
  const inp = document.getElementById('chat-input');
  const userText = (inp.value || "").trim();
  if(!userText) return;
  inp.value = "";
  addChat('user', userText);

  const hint = buildChatSystemHint();
  const summary = `Analisi precedente:\n${lastAnalysisText}\n`;

  try{
    if(currentProvider === 'openai'){
      const res = await fetch("https://api.openai.com/v1/responses", {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Authorization": `Bearer ${KEYS.openai}` },
        body: JSON.stringify({
          model: KEYS.openaiModel,
          input: [{ role:"user", content:[{ type:"input_text", text: hint + "\n" + summary + "\nDomanda: " + userText }] }],
          max_output_tokens: 450
        })
      });
      if(!res.ok) throw new Error("Errore chat OpenAI");
      const d = await res.json();
      addChat('assistant', d.output_text || "Nessuna risposta.");
      return;
    }

    if(currentProvider === 'gemini'){
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(KEYS.geminiModel)}:generateContent`;
      const res = await fetch(url, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'x-goog-api-key': KEYS.gemini },
        body: JSON.stringify({ contents: [{ parts: [{ text: hint + "\n" + summary + "\nDomanda: " + userText }] }] })
      });
      if(!res.ok) throw new Error("Errore chat Gemini");
      const d = await res.json();
      const text = d.candidates?.[0]?.content?.parts?.map(p => p.text).filter(Boolean).join("\n") || "Nessuna risposta.";
      addChat('assistant', text.replace(/\*/g,''));
      return;
    }

    if(currentProvider === 'claude'){
      const res = await fetch("https://api.anthropic.com/v1/messages", {
        method:"POST",
        headers:{ "Content-Type":"application/json", "x-api-key": KEYS.claude, "anthropic-version":"2023-06-01" },
        body: JSON.stringify({
          model: KEYS.claudeModel,
          max_tokens: 450,
          messages: [{ role:"user", content:[{ type:"text", text: hint + "\n" + summary + "\nDomanda: " + userText }] }]
        })
      });
      if(!res.ok) throw new Error("Errore chat Claude");
      const d = await res.json();
      const text = (d.content || []).filter(x => x.type === "text" && x.text).map(x => x.text).join("\n") || "Nessuna risposta.";
      addChat('assistant', text);
      return;
    }

    addChat('assistant', "Seleziona una API per la chat avanzata.");
  }catch(e){
    addChat('assistant', "Errore: " + (e?.message || e));
  }
}

/* -------------------- OVERLAY -------------------- */
function openOverlay(){
  if(currentContext !== 'social'){ announce("Disponibile solo in Social."); return; }
  document.getElementById('overlay-text').value = "";
  document.getElementById('overlay-status').innerText = "Scrivi il testo. Poi l’AI decide posizione/dimensione/colore per l’obiettivo social.";
  hide('result-screen');
  show('overlay-screen');
  overlayCanvas = document.getElementById('overlay-preview');
  overlayCanvas.classList.add('hidden');
  overlayBlob = null;
  announce("Editor testo aperto.");
}
function closeOverlay(){
  hide('overlay-screen');
  show('result-screen');
  announce("Torno al risultato.");
}

function applyOverlayQuick(){
  const text = (document.getElementById('overlay-text').value || "").trim();
  if(!text){ announce("Scrivi il testo."); return; }
  const isFullscreen = (socialGoal === 'fullscreen');
  drawOverlay({
    text,
    xPct: 50,
    yPct: isFullscreen ? 78 : 82,
    maxWidthPct: 86,
    fontSizePct: isFullscreen ? 6 : 6,
    fill: "#ffffff",
    boxFill: "rgba(0,0,0,0.55)",
    boxPadPct: 1.6,
    align: "center",
    stroke: "rgba(0,0,0,0.0)",
    strokeWidthPct: 0
  });
  document.getElementById('overlay-status').innerText = "Applicato rapido. Usa ‘Applica con AI’ per una scelta migliore.";
}

async function applyOverlayWithAI(){
  const text = (document.getElementById('overlay-text').value || "").trim();
  if(!text){ announce("Scrivi il testo."); return; }
  document.getElementById('overlay-status').innerText = "L’AI sta scegliendo stile e posizione…";

  const layoutPrompt = `
Sei un graphic editor per social. Devo mettere TESTO sopra questa foto.
Obiettivo social: ${goalLabel()}.
Testo (esatto): """${text}"""

Dammi SOLO un JSON valido, senza testo extra:
{
  "xPct": number,
  "yPct": number,
  "maxWidthPct": number,
  "fontSizePct": number,
  "fill": "#RRGGBB",
  "align": "left|center|right",
  "boxFill": "rgba(r,g,b,a)" o null,
  "boxPadPct": number,
  "stroke": "rgba(r,g,b,a)" o null,
  "strokeWidthPct": number
}

Regole:
- Mantieni safe area: non appiccicare ai bordi. In 9:16 evita alto e basso (UI).
- Evita di coprire viso/soggetto principale se evidente.
- Se sfondo è complesso, usa boxFill scuro semitrasparente.
- Scegli colori leggibili.
`;

  try{
    let jsonText = "";

    if(currentProvider === 'openai'){
      const res = await fetch("https://api.openai.com/v1/responses", {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Authorization": `Bearer ${KEYS.openai}` },
        body: JSON.stringify({
          model: KEYS.openaiModel,
          input: [{ role:"user", content:[{ type:"input_text", text: layoutPrompt }, { type:"input_image", image_url: currentPhotoBase64 }] }],
          max_output_tokens: 400
        })
      });
      if(!res.ok) throw new Error("Errore layout OpenAI");
      const d = await res.json();
      jsonText = (d.output_text || "").trim();
    }

    if(currentProvider === 'gemini'){
      const b64 = currentPhotoBase64.split(',')[1];
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(KEYS.geminiModel)}:generateContent`;
      const res = await fetch(url, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'x-goog-api-key': KEYS.gemini },
        body: JSON.stringify({
          contents: [{ parts: [{ text: layoutPrompt }, { inline_data: { mime_type: 'image/jpeg', data: b64 } }] }]
        })
      });
      if(!res.ok) throw new Error("Errore layout Gemini");
      const d = await res.json();
      jsonText = d.candidates?.[0]?.content?.parts?.map(p => p.text).filter(Boolean).join("\n").trim() || "";
    }

    if(currentProvider === 'claude'){
      const b64 = currentPhotoBase64.split(',')[1];
      const res = await fetch("https://api.anthropic.com/v1/messages", {
        method:"POST",
        headers:{ "Content-Type":"application/json", "x-api-key": KEYS.claude, "anthropic-version":"2023-06-01" },
        body: JSON.stringify({
          model: KEYS.claudeModel,
          max_tokens: 450,
          messages:[{ role:"user", content:[{ type:"image", source:{ type:"base64", media_type:"image/jpeg", data:b64 } }, { type:"text", text: layoutPrompt }] }]
        })
      });
      if(!res.ok) throw new Error("Errore layout Claude");
      const d = await res.json();
      jsonText = (d.content || []).filter(x => x.type === "text" && x.text).map(x => x.text).join("\n").trim();
    }

    const extracted = extractJsonObject(jsonText);
    if(!extracted) throw new Error("JSON non valido.");

    const spec = JSON.parse(extracted);
    const safe = normalizeOverlaySpec(spec, text);
    drawOverlay(safe);
    document.getElementById('overlay-status').innerText = "Applicato con AI. Puoi scaricare o condividere.";
  }catch(e){
    document.getElementById('overlay-status').innerText = "Non riesco a leggere le istruzioni dell’AI. Applico rapido.";
    applyOverlayQuick();
  }
}

function extractJsonObject(s){
  if(!s) return null;
  const first = s.indexOf("{");
  const last = s.lastIndexOf("}");
  if(first === -1 || last === -1 || last <= first) return null;
  return s.slice(first, last+1);
}
function normalizeOverlaySpec(spec, text){
  const isFullscreen = (socialGoal === 'fullscreen');
  const def = {
    text,
    xPct: 50,
    yPct: isFullscreen ? 78 : 82,
    maxWidthPct: 86,
    fontSizePct: 6,
    fill: "#ffffff",
    align: "center",
    boxFill: "rgba(0,0,0,0.55)",
    boxPadPct: 1.6,
    stroke: "rgba(0,0,0,0.0)",
    strokeWidthPct: 0
  };
  const out = {...def};

  const num = (v, lo, hi, fb) => {
    const x = Number(v);
    if(Number.isFinite(x)) return Math.min(hi, Math.max(lo, x));
    return fb;
  };
  out.xPct = num(spec.xPct, 5, 95, def.xPct);
  out.yPct = num(spec.yPct, 5, 95, def.yPct);
  out.maxWidthPct = num(spec.maxWidthPct, 30, 95, def.maxWidthPct);
  out.fontSizePct = num(spec.fontSizePct, 2, 12, def.fontSizePct);
  out.boxPadPct = num(spec.boxPadPct, 0, 4, def.boxPadPct);
  out.strokeWidthPct = num(spec.strokeWidthPct, 0, 1.5, def.strokeWidthPct);

  if(typeof spec.fill === "string" && spec.fill.startsWith("#")) out.fill = spec.fill;
  if(spec.align === "left" || spec.align === "center" || spec.align === "right") out.align = spec.align;
  out.boxFill = (typeof spec.boxFill === "string" || spec.boxFill === null) ? spec.boxFill : def.boxFill;
  out.stroke = (typeof spec.stroke === "string" || spec.stroke === null) ? spec.stroke : def.stroke;

  out.text = text;
  return out;
}

async function drawOverlay(spec){
  const img = await loadImage(currentPhotoBase64);
  const c = overlayCanvas;
  const ctx = c.getContext("2d");

  c.width = img.naturalWidth || img.width;
  c.height = img.naturalHeight || img.height;

  ctx.clearRect(0,0,c.width,c.height);
  ctx.drawImage(img, 0, 0, c.width, c.height);

  const minDim = Math.min(c.width, c.height);
  const fontPx = Math.max(14, Math.round((spec.fontSizePct/100) * minDim));
  ctx.font = `700 ${fontPx}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
  ctx.textBaseline = "middle";
  ctx.textAlign = spec.align;

  const maxWidth = (spec.maxWidthPct/100) * c.width;
  const lines = wrapText(ctx, spec.text, maxWidth);
  const lineH = Math.round(fontPx * 1.2);
  const blockH = lines.length * lineH;

  let blockW = 0;
  for(const ln of lines) blockW = Math.max(blockW, ctx.measureText(ln).width);

  const x = (spec.xPct/100) * c.width;
  const y = (spec.yPct/100) * c.height;

  const pad = (spec.boxPadPct/100) * minDim;

  let boxXLeft = x - blockW/2;
  if(spec.align === "left") boxXLeft = x;
  if(spec.align === "right") boxXLeft = x - blockW;

  const boxYTop = y - blockH/2;

  if(spec.boxFill){
    ctx.fillStyle = spec.boxFill;
    roundRect(ctx, boxXLeft - pad, boxYTop - pad, blockW + pad*2, blockH + pad*2, Math.max(8, pad));
    ctx.fill();
  }

  if(spec.stroke && spec.strokeWidthPct > 0){
    ctx.strokeStyle = spec.stroke;
    ctx.lineWidth = Math.max(1, (spec.strokeWidthPct/100) * minDim);
    for(let i=0;i<lines.length;i++){
      const yy = boxYTop + (i+0.5)*lineH;
      ctx.strokeText(lines[i], x, yy, maxWidth);
    }
  }

  ctx.fillStyle = spec.fill;
  for(let i=0;i<lines.length;i++){
    const yy = boxYTop + (i+0.5)*lineH;
    ctx.fillText(lines[i], x, yy, maxWidth);
  }

  overlayCanvas.classList.remove('hidden');
  overlayBlob = await new Promise(resolve => c.toBlob(resolve, "image/jpeg", 0.92));
}

function wrapText(ctx, text, maxWidth){
  const words = text.split(/\s+/);
  const lines = [];
  let line = "";
  for(const w of words){
    const test = line ? line + " " + w : w;
    if(ctx.measureText(test).width <= maxWidth){
      line = test;
    }else{
      if(line) lines.push(line);
      line = w;
    }
  }
  if(line) lines.push(line);
  return lines.slice(0, 8);
}
function roundRect(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}
function loadImage(src){
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = src;
  });
}
async function downloadOverlay(){
  if(!overlayBlob){ announce("Prima applica il testo."); return; }
  const url = URL.createObjectURL(overlayBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = "foto_testo.jpg";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  announce("Download avviato.");
}
async function shareOverlay(){
  if(!overlayBlob){ announce("Prima applica il testo."); return; }
  try{
    const f = new File([overlayBlob], "foto_testo.jpg", {type:"image/jpeg"});
    if(navigator.canShare && navigator.canShare({files:[f]})){
      await navigator.share({files:[f], title:"Foto con testo"});
      announce("Menu aperto.");
    } else announce("Condivisione non supportata.");
  }catch(e){
    announce("Errore condivisione.");
  }
}

/* -------------------- FREE LOCAL AI -------------------- */
let localPipeline = null;
let localLoading = false;

async function runFreeLocal(){
  showResultScreen("FREE locale: sto caricando il modello (prima volta lenta)…");
  try{
    const caption = await localCaption(currentPhotoBase64);
    const out =
`A) VERDETTO (FREE)
Modalità locale: nessuna key. Buona per descrizione, meno precisa per social avanzato.

B) DESCRIZIONE
${caption}

C) CONSIGLI RAPIDI
- Se vuoi FEED: spesso funziona 4:5 verticale; 1:1 può tagliare sopra/sotto.
- Se vuoi 9:16: lascia margini sopra/sotto (UI). Evita testo vicino ai bordi.
- Se vuoi davvero consigli crop precisi: usa una API (OpenAI/Gemini/Claude).`;
    setResultText(out);
    addChat('assistant', "Modalità FREE: per chat e consigli social avanzati usa una API.");
    hide('social-tools');
  }catch(e){
    setResultText("FREE locale: errore nel caricamento. Prova su Wi-Fi o usa una API.");
  }
}

async function localCaption(dataUrl){
  if(localLoading) return "Caricamento in corso…";
  localLoading = true;

  if(!window.__transformers_loaded){
    await loadScript("https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js");
    window.__transformers_loaded = true;
  }

  const { pipeline } = window.transformers;
  if(!localPipeline){
    localPipeline = await pipeline("image-to-text", "Xenova/vit-gpt2-image-captioning");
  }

  const result = await localPipeline(dataUrl);
  localLoading = false;

  const text = Array.isArray(result) && result[0]?.generated_text ? result[0].generated_text : JSON.stringify(result);
  return text;
}

function loadScript(src){
  return new Promise((resolve, reject) => {
    const s = document.createElement("script");
    s.src = src;
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

/* -------------------- SHARE ORIGINAL -------------------- */
async function shareImageNative(){
  try{
    const r = await fetch(currentPhotoBase64);
    const b = await r.blob();
    const f = new File([b], "foto.jpg", {type:"image/jpeg"});
    if(navigator.canShare && navigator.canShare({files:[f]})){
      await navigator.share({files:[f], title:'Foto'});
      announce("Menu aperto.");
    } else announce("Condivisione non supportata.");
  }catch(e){
    announce("Errore condivisione.");
  }
}

/* -------------------- CLOSE / RESET -------------------- */
function discardPhoto(){
  hide('ai-screen'); hide('context-screen'); hide('social-goal-screen'); hide('result-screen'); hide('overlay-screen');
  document.getElementById('main-container').classList.remove('hidden');
  document.getElementById('inp-cam-user').value = "";
  document.getElementById('inp-cam-env').value = "";
  currentProvider = null;
  currentContext = null;
  socialGoal = null;
  resetChat();
  announce("Home.");
}
function closeResult(){
  hide('result-screen');
  show('ai-screen');
  announce("Torno alla scelta.");
}

/* -------------------- SETTINGS -------------------- */
function openSettings(){
  document.getElementById('settings-screen').classList.remove('hidden');
  document.getElementById('key-gemini').value = KEYS.gemini;
  document.getElementById('model-gemini').value = KEYS.geminiModel;
  document.getElementById('key-openai').value = KEYS.openai;
  document.getElementById('model-openai').value = KEYS.openaiModel;
  document.getElementById('key-claude').value = KEYS.claude;
  document.getElementById('model-claude').value = KEYS.claudeModel;
}
function closeSettings(){ document.getElementById('settings-screen').classList.add('hidden'); }
function saveSettings(){
  KEYS.gemini = document.getElementById('key-gemini').value.trim();
  KEYS.geminiModel = document.getElementById('model-gemini').value.trim() || "gemini-3-pro-preview";
  KEYS.openai = document.getElementById('key-openai').value.trim();
  KEYS.openaiModel = document.getElementById('model-openai').value.trim() || "gpt-5.2";
  KEYS.claude = document.getElementById('key-claude').value.trim();
  KEYS.claudeModel = document.getElementById('model-claude').value.trim() || "claude-sonnet-4-5";

  localStorage.setItem('key_gemini', KEYS.gemini);
  localStorage.setItem('model_gemini', KEYS.geminiModel);
  localStorage.setItem('key_openai', KEYS.openai);
  localStorage.setItem('model_openai', KEYS.openaiModel);
  localStorage.setItem('key_claude', KEYS.claude);
  localStorage.setItem('model_claude', KEYS.claudeModel);

  document.getElementById('lbl-gemini-model').innerText = KEYS.geminiModel;
  document.getElementById('lbl-openai-model').innerText = KEYS.openaiModel;
  document.getElementById('lbl-claude-model').innerText = KEYS.claudeModel;

  closeSettings();
  announce("Impostazioni salvate.");
}

window.onload = function(){ announce("Hub Foto pronto."); };
</script>
</body>
</html>
