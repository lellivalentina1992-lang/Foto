<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Smart Photo Assistant - Il Tuo Occhio Fotografico</title>
<style>
/* STILE GENERALE */
body{font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:0;padding:0;background:#000;color:#fff;height:100vh;display:flex;flex-direction:column;overflow:hidden}
.sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)}

/* VIDEO */
#cam-container{position:relative;flex-grow:1;width:100%;background:#111;display:flex;justify-content:center;align-items:center}
video{width:100%;height:100%;object-fit:cover;opacity:.6}
canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}

/* STATUS VOCALE */
#voice-status{position:absolute;top:10px;right:10px;padding:5px 10px;border-radius:20px;background:rgba(0,0,0,0.7);border:1px solid #555;font-size:0.8rem;z-index:60;display:none}
.listening{border-color:#0f0!important;color:#0f0!important}

/* INTERFACCIA */
#main-interface{height:65vh;width:100%;background:#000;border-top:4px solid #333;position:relative;display:flex;flex-direction:column}
#camera-controls{flex-grow:1;width:100%;display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:min-content;gap:10px;padding:10px;box-sizing:border-box;overflow-y:auto}

/* UTILITÀ */
.full-width{grid-column:1/-1}
.top-bar{display:flex;gap:10px;width:100%}

/* RISULTATO */
#result-screen{height:100%;width:100%;display:flex;flex-direction:column;padding:15px;box-sizing:border-box;background:#111;position:absolute;top:0;left:0;z-index:50}
#result-content{flex-grow:1;overflow-y:auto;margin-bottom:15px;padding:15px;border:1px solid #555;border-radius:8px;background:#000;font-size:1.3rem;line-height:1.5;color:#fff;white-space:pre-wrap}
.result-actions{display:flex;flex-wrap:wrap;gap:10px;flex-shrink:0;min-height:70px}

/* BADGE QUALITÀ */
.quality-badge{display:inline-block;padding:5px 12px;border-radius:20px;font-weight:bold;font-size:0.9rem;margin:5px 5px 5px 0}
.badge-excellent{background:#006400;color:#0f0;border:2px solid #0f0}
.badge-good{background:#8B6914;color:#FFD700;border:2px solid #FFD700}
.badge-acceptable{background:#4B4B00;color:#FFFF00;border:2px solid #FFFF00}
.badge-poor{background:#8B0000;color:#ff5555;border:2px solid #ff5555}

/* GALLERIA FOTO */
#photo-gallery{display:none;flex-direction:column;gap:10px;max-height:400px;overflow-y:auto;margin-top:15px;padding:10px;border:2px solid #555;border-radius:8px;background:#1a1a1a}
.gallery-item{display:flex;align-items:center;gap:10px;padding:10px;background:#000;border:1px solid #444;border-radius:8px}
.gallery-item.selected{border-color:#0f0;background:#002200}
.gallery-thumbnail{width:60px;height:60px;object-fit:cover;border-radius:4px;border:2px solid #555}
.gallery-info{flex-grow:1}
.gallery-controls{display:flex;gap:5px}

/* PULSANTI */
button{border:2px solid #555;border-radius:12px;font-size:1rem;font-weight:bold;text-transform:uppercase;color:#fff;background:#222;cursor:pointer;min-height:60px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;touch-action:manipulation}
button:active{background:#555;transform:scale(.98)}
.small-btn{flex:1;font-size:.9rem;background:#111;border:1px solid #444;color:#ccc;min-width:80px}

/* COLORI E STATI */
#btn-voice{background:#00008B;border-color:#4169E1} 
#btn-guide{border:2px solid #fff;background:#002200;font-size:1.1rem}
#btn-find{background:#2F4F4F;border-color:#008080;color:#fff}
#btn-custom{background:#4B0082;border-color:#DA70D6}
.active-tool{background:#006400!important;border-color:#0f0!important}
.guiding{background:#8B0000!important;border-color:#f00!important}
.searching{background:#DAA520!important;border-color:#FFD700!important;color:#000!important}

/* STILE SOCIAL / RISULTATO */
.btn-primary-wide{flex:1 1 100%;font-size:1rem;background:#004080;border-color:#88b4ff}
.btn-analyze{flex:1 1 45%;font-size:.9rem;background:#333;border-color:#777}
.btn-danger{flex:1 1 45%;background:#8B0000;border-color:#ff5555}
.btn-social-check{flex:1 1 45%;background:#E1306C!important;border-color:#fff!important;color:#fff!important}
.btn-use-photo{flex:1 1 45%;background:#006400!important;border-color:#0f0!important;color:#0f0!important}
.btn-view-gallery{flex:1 1 45%;background:#4B0082!important;border-color:#DA70D6!important}

/* OVERLAY AVVIO */
.overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;z-index:100;display:flex;flex-direction:column;justify-content:center;align-items:center}
.hidden{display:none!important}
.loader{border:6px solid #333;border-top:6px solid #D4AF37;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin-bottom:20px}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
input{background:#333;color:#fff;border:1px solid #777}
#download-link{text-align:center;font-size:.9rem;color:#D4AF37;text-decoration:underline;margin-bottom:10px}

/* SELEZIONE OGGETTI */
#selected-objects-container{display:none;flex-direction:column;gap:8px;padding:10px;border:2px solid #0f0;border-radius:8px;background:#001100;margin-bottom:10px}
#selected-objects-list{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.selected-object-tag{padding:6px 12px;background:#004400;border:1px solid #0f0;border-radius:20px;font-size:0.9rem;color:#0f0;display:flex;align-items:center;gap:6px}
.remove-object-btn{background:transparent;border:none;color:#ff5555;font-size:1.2rem;cursor:pointer;padding:0;min-height:auto}

/* LISTA OGGETTI RILEVATI */
#detected-objects-list{display:flex;flex-direction:column;gap:6px;max-height:200px;overflow-y:auto}
.object-item-btn{min-height:50px;background:#222;border:1px solid #555;font-size:0.95rem;text-align:left;padding:10px;justify-content:flex-start}
.object-item-btn:active{background:#444}
</style>
</head>
<body>
<div id="sr-announcer" class="sr-only" aria-live="assertive" role="status"></div>

<div id="cam-container">
  <video id="webcam" playsinline muted autoplay></video>
  <canvas id="overlay"></canvas>
  <div id="voice-status">Ascolto in corso...</div>
</div>

<div id="main-interface" class="hidden" aria-hidden="true">
  <div id="camera-controls">
    
    <button class="full-width" id="btn-find" onclick="manualFind()" aria-label="Cerca un oggetto specifico ignorando gli altri.">CERCA OGGETTO</button>

    <div class="full-width" style="height:1px;background:#333;margin:5px 0"></div>

    <button class="full-width" id="btn-guide" onclick="startObjectSelection()" aria-label="Seleziona oggetti da fotografare e avvia guida intelligente.">SELEZIONA E FOTOGRAFA</button>
    
    <div id="selected-objects-container" class="full-width">
      <div style="font-weight:bold;margin-bottom:5px">Elementi selezionati:</div>
      <div id="selected-objects-list"></div>
      <button onclick="startLiveGuidance()" style="background:#006400;border-color:#0f0;color:#0f0;min-height:50px">AVVIA GUIDA FOTOGRAFICA</button>
    </div>

    <div id="detected-objects-list" class="full-width"></div>
    
    <div class="top-bar full-width">
       <button class="small-btn" id="btn-shot" onclick="startCountdown()" aria-label="Scatta foto manuale con conto alla rovescia di 5 secondi">SCATTA MANUALE</button>
       <button class="small-btn" onclick="flipCamera()" aria-label="Ruota fotocamera">RUOTA CAMERA</button>
    </div>

    <button id="btn-custom" class="full-width" onclick="askCustomDetail()" aria-label="Scatta e poni una domanda specifica sulla scena">CHIEDI DETTAGLIO</button>

    <button id="btn-describe" class="full-width" onclick="quickDescribeScene()" aria-label="Descrizione rapida di cosa vede la fotocamera">COSA VEDE LA CAMERA</button>

    <div class="full-width" style="height:1px;background:#333;margin:5px 0"></div>
    <div class="top-bar full-width">
      <button class="small-btn" id="btn-light" onclick="toggleLight()" aria-label="Sonda luce">LUCE</button>
      <button class="small-btn" id="btn-color" onclick="toggleColor()" aria-label="Colore">COLORE</button>
      <button class="small-btn" id="btn-level" onclick="toggleLevel()" aria-label="Livella">LIVELLA</button>
    </div>

    <div class="top-bar full-width" style="margin-top:10px">
      <button class="small-btn" id="btn-voice" onclick="toggleVoiceControl()" aria-label="Comandi vocali opzionali">COMANDI VOCALI</button>
      <button class="small-btn" id="btn-guide-mode" onclick="cycleGuideMode()" aria-label="Cambia livello di dettaglio">GUIDA: STANDARD</button>
      <button class="small-btn" onclick="openSettings()" aria-label="Impostazioni">IMPOSTAZIONI</button>
    </div>
  </div>

  <div id="result-screen" class="hidden" aria-hidden="true" inert role="main">
    <h2 style="margin:0 0 10px;color:#D4AF37;font-size:1.1rem">Foto Acquisita</h2>
    <div id="result-content" tabindex="0">In attesa...</div>
    <a id="download-link" href="#" class="hidden">Scarica foto</a>
    
    <div class="result-actions" id="action-buttons"></div>
    
    <div id="photo-gallery"></div>
  </div>
</div>

<div id="start-screen" class="overlay">
  <h1 style="color:#fff;margin-bottom:20px">Smart Photo Assistant</h1>
  <p style="color:#ccc;text-align:center;max-width:80%;margin-bottom:30px">Il tuo occhio fotografico personale per selfie perfetti e foto pubblicabili</p>
  <button id="btn-start" onclick="startApp()" style="padding:40px;font-size:1.8rem;background:#D4AF37;color:#000;border-radius:15px;width:95%;border:4px solid #fff;font-weight:bold">AVVIA SISTEMA</button>
</div>

<div id="key-screen" class="overlay hidden" aria-hidden="true" inert>
  <h2 style="color:#fff">Chiave Gemini API</h2>
  <input type="text" id="key-input" placeholder="Incolla chiave qui..." style="width:80%;padding:15px;font-size:1.2rem;margin-bottom:20px;border-radius:8px">
  <button onclick="saveKey()" style="padding:15px;background:#fff;color:#000;width:50%;font-weight:bold;border-radius:8px;margin-bottom:10px">SALVA</button>
  <button onclick="closeSettings()" style="padding:15px;background:#333;color:#fff;width:50%;border-radius:8px">CHIUDI</button>
  <p style="width:80%;margin-top:20px;font-size:0.9rem;color:#ddd;text-align:center">
    Le foto vengono analizzate da Gemini AI per valutarne qualità e pubblicabilità.
  </p>
</div>

<script>
let GEMINI_KEY = localStorage.getItem('gemini_key') || "";
const MODEL_NAME = "gemini-2.0-flash-exp"; 
const API_ENDPOINT = "v1beta";

// MODELLI VISIVI
let audioCtx, lightOsc, lightGain;
let objectDetector = null;
let poseLandmarker = null;
let faceLandmarker = null;

let modelsReady = {detector:false, pose:false, face:false};

const video = document.getElementById('webcam');
const canvas = document.getElementById('overlay');
const ctx = canvas.getContext('2d');
const tempCanvas = document.createElement('canvas');
const tempCtx = tempCanvas.getContext('2d');

let stream = null;
let currentFacingMode = 'user';
let isRunning = false;

// STATI
let lightActive = false;
let colorActive = false;
let levelActive = false;
let voiceActive = false;
let countdown = 0;
let countdownInterval = null;

let currentDetections = [];
let selectedObjects = [];
let isGuiding = false;
let guidanceInterval = null;
let lastGuidanceTime = 0;

let recognition = null;
let guideVerbosity = 'standard';

let photoStorage = [];
let currentPhotoData = null;

// ============================================
// ANNUNCIO SCREEN READER (NO SINTESI VOCALE)
// ============================================
function announce(text){
  const ann = document.getElementById('sr-announcer');
  ann.textContent = '';
  setTimeout(() => {ann.textContent = text;}, 50);
}

// ============================================
// GESTIONE CAMERA
// ============================================
async function setupCamera(mode){
  try{
    if(stream){
      stream.getTracks().forEach(t => t.stop());
    }
    
    const constraints = {
      video:{
        facingMode:mode,
        width:{ideal:1920},
        height:{ideal:1080}
      },
      audio:false
    };
    
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    
    await new Promise(resolve => {
      video.onloadedmetadata = () => resolve();
    });
    
    currentFacingMode = mode;
    announce(`Camera ${mode === 'user' ? 'frontale' : 'posteriore'} attivata`);
    
  }catch(err){
    console.error("setupCamera error", err);
    if(err.name === 'NotAllowedError'){
      announce("Permesso fotocamera negato. Abilita i permessi dalle impostazioni del browser");
    }else if(err.name === 'NotFoundError'){
      announce("Nessuna fotocamera trovata sul dispositivo");
    }else{
      announce("Errore accesso fotocamera: " + err.message);
    }
  }
}

function flipCamera(){
  const newMode = currentFacingMode === 'user' ? 'environment' : 'user';
  setupCamera(newMode);
}

// ============================================
// LUCE/COLORE/LIVELLA
// ============================================
function toggleLight(){
  lightActive = !lightActive;
  const btn = document.getElementById('btn-light');
  if(lightActive){
    btn.classList.add('active-tool');
    announce("Sonda luce attiva");
    if(!lightOsc){
      lightOsc = audioCtx.createOscillator();
      lightGain = audioCtx.createGain();
      lightOsc.connect(lightGain);
      lightGain.connect(audioCtx.destination);
      lightOsc.start();
      lightGain.gain.value = 0;
    }
  }else{
    btn.classList.remove('active-tool');
    announce("Sonda luce disattivata");
    if(lightGain) lightGain.gain.value = 0;
  }
}

function processLight(){
  if(!tempCanvas.width) return;
  const data = tempCtx.getImageData(0,0,tempCanvas.width,tempCanvas.height).data;
  let sum = 0;
  for(let i=0; i<data.length; i+=4){
    sum += (data[i] + data[i+1] + data[i+2])/3;
  }
  const brightness = sum / (data.length/4);
  const freq = 200 + brightness*2;
  if(lightOsc) lightOsc.frequency.value = freq;
  if(lightGain) lightGain.gain.value = 0.1;
}

function toggleColor(){
  colorActive = !colorActive;
  const btn = document.getElementById('btn-color');
  if(colorActive){
    btn.classList.add('active-tool');
    announce("Analisi colore attiva");
  }else{
    btn.classList.remove('active-tool');
    announce("Analisi colore disattivata");
  }
}

function processColor(){
  if(!tempCanvas.width) return;
  const data = tempCtx.getImageData(tempCanvas.width/2-50, tempCanvas.height/2-50, 100, 100).data;
  let r=0, g=0, b=0, count=0;
  for(let i=0; i<data.length; i+=4){
    r += data[i];
    g += data[i+1];
    b += data[i+2];
    count++;
  }
  r = Math.round(r/count);
  g = Math.round(g/count);
  b = Math.round(b/count);
  
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = `rgb(${r},${g},${b})`;
  ctx.fillRect(canvas.width/2-60, canvas.height/2-60, 120, 120);
  ctx.strokeStyle = '#fff';
  ctx.lineWidth = 3;
  ctx.strokeRect(canvas.width/2-60, canvas.height/2-60, 120, 120);
  
  const name = getColorName(r,g,b);
  announce(`Colore centro: ${name}`);
}

function getColorName(r,g,b){
  if(r>200 && g>200 && b>200) return 'bianco';
  if(r<50 && g<50 && b<50) return 'nero';
  if(r>150 && g<100 && b<100) return 'rosso';
  if(r<100 && g>150 && b<100) return 'verde';
  if(r<100 && g<100 && b>150) return 'blu';
  if(r>150 && g>150 && b<100) return 'giallo';
  if(r>150 && g<100 && b>150) return 'magenta';
  if(r<100 && g>150 && b>150) return 'ciano';
  if(r>150 && g>100 && b<100) return 'arancione';
  return 'colore misto';
}

function toggleLevel(){
  levelActive = !levelActive;
  const btn = document.getElementById('btn-level');
  if(levelActive){
    btn.classList.add('active-tool');
    announce("Livella attiva");
    if(typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function'){
      DeviceOrientationEvent.requestPermission().then(perm => {
        if(perm === 'granted'){
          window.addEventListener('deviceorientation', handleOrientation);
        }else{
          announce("Permesso orientamento negato");
          levelActive = false;
          btn.classList.remove('active-tool');
        }
      });
    }else{
      window.addEventListener('deviceorientation', handleOrientation);
    }
  }else{
    btn.classList.remove('active-tool');
    announce("Livella disattivata");
    window.removeEventListener('deviceorientation', handleOrientation);
    ctx.clearRect(0,0,canvas.width,canvas.height);
  }
}

function handleOrientation(e){
  if(!levelActive) return;
  const beta = e.beta || 0;
  const gamma = e.gamma || 0;
  
  ctx.clearRect(0,0,canvas.width,canvas.height);
  
  const cx = canvas.width/2;
  const cy = canvas.height/2;
  const offsetX = gamma*3;
  const offsetY = beta*3;
  
  ctx.strokeStyle = '#fff';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(cx-50, cy);
  ctx.lineTo(cx+50, cy);
  ctx.moveTo(cx, cy-50);
  ctx.lineTo(cx, cy+50);
  ctx.stroke();
  
  ctx.fillStyle = '#0f0';
  ctx.beginPath();
  ctx.arc(cx+offsetX, cy+offsetY, 20, 0, Math.PI*2);
  ctx.fill();
  
  if(Math.abs(beta)<5 && Math.abs(gamma)<5){
    announce("Dispositivo in piano");
  }
}

// ============================================
// SCATTO FOTO
// ============================================
function startCountdown(){
  if(countdown > 0) return;
  countdown = 5;
  announce("Conto alla rovescia: 5 secondi");
  
  countdownInterval = setInterval(() => {
    countdown--;
    if(countdown > 0){
      announce(countdown + " secondi");
    }else{
      clearInterval(countdownInterval);
      capturePhoto();
    }
  }, 1000);
}

function capturePhoto(){
  if(!video.videoWidth) return;
  
  const photoCanvas = document.createElement('canvas');
  photoCanvas.width = video.videoWidth;
  photoCanvas.height = video.videoHeight;
  const photoCtx = photoCanvas.getContext('2d');
  photoCtx.drawImage(video, 0, 0);
  
  currentPhotoData = photoCanvas.toDataURL('image/jpeg', 0.9);
  
  savePhotoToGallery(currentPhotoData);
  
  announce("Foto scattata. Caricamento risultato...");
  
  showResult("Foto acquisita. Premi 'Analizza Qualità' per valutazione AI.");
  
  const actionBtns = document.getElementById('action-buttons');
  actionBtns.innerHTML = `
    <button class="btn-analyze" onclick="analyzePhoto()">ANALIZZA QUALITA'</button>
    <button class="btn-danger" onclick="deleteCurrentPhoto()">ELIMINA FOTO</button>
    <button class="btn-use-photo" onclick="usePhoto()">USA QUESTA FOTO</button>
    <button class="btn-view-gallery" onclick="toggleGallery()">VEDI GALLERIA</button>
  `;
}

function savePhotoToGallery(dataUrl){
  const stored = localStorage.getItem('photo_gallery');
  photoStorage = stored ? JSON.parse(stored) : [];
  
  photoStorage.push({
    data: dataUrl,
    timestamp: Date.now(),
    quality: null
  });
  
  // PULIZIA MEMORIA: mantieni solo ultime 50 foto
  if(photoStorage.length > 50){
    photoStorage = photoStorage.slice(-50);
    announce("Galleria ripulita, mantenute ultime 50 foto");
  }
  
  localStorage.setItem('photo_gallery', JSON.stringify(photoStorage));
}

function loadGallery(){
  const stored = localStorage.getItem('photo_gallery');
  photoStorage = stored ? JSON.parse(stored) : [];
}

function toggleGallery(){
  const gallery = document.getElementById('photo-gallery');
  if(gallery.style.display === 'none' || !gallery.style.display){
    gallery.style.display = 'flex';
    renderGallery();
    announce("Galleria aperta con " + photoStorage.length + " foto");
  }else{
    gallery.style.display = 'none';
    announce("Galleria chiusa");
  }
}

function renderGallery(){
  const gallery = document.getElementById('photo-gallery');
  gallery.innerHTML = '';
  
  if(photoStorage.length === 0){
    gallery.innerHTML = '<p style="color:#ccc">Nessuna foto salvata</p>';
    return;
  }
  
  photoStorage.forEach((photo, idx) => {
    const item = document.createElement('div');
    item.className = 'gallery-item';
    
    const img = document.createElement('img');
    img.src = photo.data;
    img.className = 'gallery-thumbnail';
    img.alt = `Foto ${idx+1}`;
    
    const info = document.createElement('div');
    info.className = 'gallery-info';
    const date = new Date(photo.timestamp);
    info.innerHTML = `
      <div style="font-weight:bold">Foto ${idx+1}</div>
      <div style="font-size:0.85rem;color:#ccc">${date.toLocaleString('it-IT')}</div>
      ${photo.quality ? `<div style="font-size:0.85rem;color:#0f0">Qualità: ${photo.quality}</div>` : ''}
    `;
    
    const controls = document.createElement('div');
    controls.className = 'gallery-controls';
    controls.innerHTML = `
      <button class="small-btn" onclick="viewGalleryPhoto(${idx})" style="min-height:40px">VEDI</button>
      <button class="small-btn" onclick="deleteGalleryPhoto(${idx})" style="min-height:40px;background:#8B0000">ELIMINA</button>
    `;
    
    item.appendChild(img);
    item.appendChild(info);
    item.appendChild(controls);
    gallery.appendChild(item);
  });
}

function viewGalleryPhoto(idx){
  const photo = photoStorage[idx];
  if(!photo) return;
  
  currentPhotoData = photo.data;
  showResult(`Foto ${idx+1} dalla galleria.`);
  
  const actionBtns = document.getElementById('action-buttons');
  actionBtns.innerHTML = `
    <button class="btn-analyze" onclick="analyzePhoto()">ANALIZZA QUALITA'</button>
    <button class="btn-danger" onclick="deleteCurrentPhoto()">ELIMINA FOTO</button>
    <button class="btn-use-photo" onclick="usePhoto()">USA QUESTA FOTO</button>
    <button class="btn-view-gallery" onclick="toggleGallery()">VEDI GALLERIA</button>
  `;
  
  announce(`Visualizzata foto ${idx+1} dalla galleria`);
}

function deleteGalleryPhoto(idx){
  if(confirm(`Eliminare la foto ${idx+1}?`)){
    photoStorage.splice(idx, 1);
    localStorage.setItem('photo_gallery', JSON.stringify(photoStorage));
    renderGallery();
    announce(`Foto ${idx+1} eliminata`);
  }
}

function deleteCurrentPhoto(){
  if(confirm("Eliminare questa foto?")){
    currentPhotoData = null;
    hideResult();
    announce("Foto eliminata");
  }
}

function usePhoto(){
  if(!currentPhotoData) return;
  
  const link = document.getElementById('download-link');
  link.href = currentPhotoData;
  link.download = `photo_${Date.now()}.jpg`;
  link.classList.remove('hidden');
  link.textContent = 'Scarica foto sul dispositivo';
  announce("Link download disponibile. Premi per scaricare la foto.");
}

// ============================================
// ANALISI AI CON GEMINI
// ============================================
async function analyzePhoto(){
  if(!GEMINI_KEY){
    announce("Nessuna chiave API configurata. Vai in Impostazioni.");
    return;
  }
  
  if(!currentPhotoData){
    announce("Nessuna foto da analizzare");
    return;
  }
  
  announce("Analisi in corso...");
  
  const base64 = currentPhotoData.split(',')[1];
  
  const prompt = `Analizza questa foto e fornisci:
1. Valutazione qualità (Eccellente/Buona/Accettabile/Scarsa)
2. Composizione e inquadratura
3. Illuminazione e esposizione
4. Messa a fuoco e nitidezza
5. Se adatta per social media
6. Suggerimenti miglioramento

Rispondi in italiano, in modo conciso e pratico.`;

  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 30000);
    
    const response = await fetch(`https://generativelanguage.googleapis.com/${API_ENDPOINT}/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      signal: controller.signal,
      body: JSON.stringify({
        contents: [{
          parts: [
            {text: prompt},
            {inline_data: {mime_type: 'image/jpeg', data: base64}}
          ]
        }]
      })
    });
    
    clearTimeout(timeout);
    
    if(!response.ok){
      const errText = await response.text();
      throw new Error(`API Error ${response.status}: ${errText}`);
    }
    
    const data = await response.json();
    
    if(!data.candidates || !data.candidates[0] || !data.candidates[0].content){
      throw new Error("Risposta API non valida");
    }
    
    const text = data.candidates[0].content.parts[0].text;
    
    const qualityMatch = text.match(/qualità[:\s]*(eccellente|buona|accettabile|scarsa)/i);
    let quality = 'accettabile';
    if(qualityMatch){
      quality = qualityMatch[1].toLowerCase();
    }
    
    let badge = '';
    if(quality.includes('eccellente')){
      badge = '<span class="quality-badge badge-excellent">ECCELLENTE</span>';
    }else if(quality.includes('buona')){
      badge = '<span class="quality-badge badge-good">BUONA</span>';
    }else if(quality.includes('accettabile')){
      badge = '<span class="quality-badge badge-acceptable">ACCETTABILE</span>';
    }else{
      badge = '<span class="quality-badge badge-poor">SCARSA</span>';
    }
    
    showResult(badge + '\n\n' + text);
    
    const idx = photoStorage.findIndex(p => p.data === currentPhotoData);
    if(idx !== -1){
      photoStorage[idx].quality = quality;
      localStorage.setItem('photo_gallery', JSON.stringify(photoStorage));
    }
    
    announce("Analisi completata. Qualità: " + quality);
    
  } catch(err) {
    console.error("analyzePhoto error", err);
    if(err.name === 'AbortError'){
      announce("Timeout: richiesta troppo lunga. Riprova.");
    }else{
      announce("Errore analisi: " + err.message);
    }
    showResult("Errore durante l'analisi: " + err.message);
  }
}

// ============================================
// CHIEDI DETTAGLIO
// ============================================
async function askCustomDetail(){
  const question = prompt("Cosa vuoi sapere sulla scena?");
  if(!question) return;
  
  announce("Acquisizione immagine...");
  
  if(!video.videoWidth) return;
  
  const photoCanvas = document.createElement('canvas');
  photoCanvas.width = video.videoWidth;
  photoCanvas.height = video.videoHeight;
  const photoCtx = photoCanvas.getContext('2d');
  photoCtx.drawImage(video, 0, 0);
  
  currentPhotoData = photoCanvas.toDataURL('image/jpeg', 0.9);
  
  if(!GEMINI_KEY){
    announce("Nessuna chiave API configurata");
    return;
  }
  
  announce("Elaborazione domanda in corso...");
  
  const base64 = currentPhotoData.split(',')[1];
  
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 30000);
    
    const response = await fetch(`https://generativelanguage.googleapis.com/${API_ENDPOINT}/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      signal: controller.signal,
      body: JSON.stringify({
        contents: [{
          parts: [
            {text: question},
            {inline_data: {mime_type: 'image/jpeg', data: base64}}
          ]
        }]
      })
    });
    
    clearTimeout(timeout);
    
    if(!response.ok){
      throw new Error(`API Error ${response.status}`);
    }
    
    const data = await response.json();
    const text = data.candidates[0].content.parts[0].text;
    
    showResult(`Domanda: ${question}\n\nRisposta:\n${text}`);
    announce("Risposta ricevuta");
    
    const actionBtns = document.getElementById('action-buttons');
    actionBtns.innerHTML = `
      <button class="btn-primary-wide" onclick="hideResult()">CHIUDI</button>
    `;
    
  } catch(err) {
    console.error("askCustomDetail error", err);
    if(err.name === 'AbortError'){
      announce("Timeout richiesta");
    }else{
      announce("Errore: " + err.message);
    }
  }
}

// ============================================
// DESCRIZIONE RAPIDA
// ============================================
async function quickDescribeScene(){
  if(!GEMINI_KEY){
    announce("Nessuna chiave API configurata");
    return;
  }
  
  announce("Acquisizione frame...");
  
  if(!video.videoWidth) return;
  
  const photoCanvas = document.createElement('canvas');
  photoCanvas.width = video.videoWidth;
  photoCanvas.height = video.videoHeight;
  const photoCtx = photoCanvas.getContext('2d');
  photoCtx.drawImage(video, 0, 0);
  
  const dataUrl = photoCanvas.toDataURL('image/jpeg', 0.7);
  const base64 = dataUrl.split(',')[1];
  
  announce("Elaborazione in corso...");
  
  const prompt = "Descrivi brevemente cosa vedi in questa immagine in massimo 3 frasi. Rispondi in italiano.";
  
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 30000);
    
    const response = await fetch(`https://generativelanguage.googleapis.com/${API_ENDPOINT}/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      signal: controller.signal,
      body: JSON.stringify({
        contents: [{
          parts: [
            {text: prompt},
            {inline_data: {mime_type: 'image/jpeg', data: base64}}
          ]
        }]
      })
    });
    
    clearTimeout(timeout);
    
    if(!response.ok){
      throw new Error(`API Error ${response.status}`);
    }
    
    const data = await response.json();
    const text = data.candidates[0].content.parts[0].text;
    
    announce("Descrizione ricevuta: " + text);
    
  } catch(err) {
    console.error("quickDescribeScene error", err);
    if(err.name === 'AbortError'){
      announce("Timeout richiesta");
    }else{
      announce("Errore: " + err.message);
    }
  }
}

// ============================================
// CERCA OGGETTO
// ============================================
async function manualFind(){
  const target = prompt("Quale oggetto vuoi cercare?");
  if(!target) return;
  
  const btnFind = document.getElementById('btn-find');
  btnFind.classList.add('searching');
  
  announce(`Ricerca ${target} in corso...`);
  
  let found = false;
  const startTime = Date.now();
  
  const searchInterval = setInterval(() => {
    if(!objectDetector || !modelsReady.detector){
      clearInterval(searchInterval);
      btnFind.classList.remove('searching');
      announce("Riconoscimento oggetti non disponibile");
      return;
    }
    
    if(Date.now() - startTime > 30000){
      clearInterval(searchInterval);
      btnFind.classList.remove('searching');
      announce(`${target} non trovato dopo 30 secondi`);
      return;
    }
    
    if(video.readyState !== 4) return;
    
    try{
      const detections = objectDetector.detectForVideo(video, performance.now());
      
      for(const det of detections.detections){
        const label = det.categories[0].categoryName.toLowerCase();
        if(label.includes(target.toLowerCase())){
          found = true;
          clearInterval(searchInterval);
          btnFind.classList.remove('searching');
          
          const beep = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          beep.connect(gain);
          gain.connect(audioCtx.destination);
          beep.frequency.value = 800;
          gain.gain.value = 0.3;
          beep.start();
          setTimeout(() => beep.stop(), 200);
          
          announce(`${target} trovato!`);
          return;
        }
      }
    }catch(e){
      console.error("Detection error", e);
    }
    
  }, 500);
}

// ============================================
// SELEZIONE E GUIDA MULTIPLA
// ============================================
function startObjectSelection(){
  if(!objectDetector || !modelsReady.detector){
    announce("Riconoscimento oggetti non disponibile");
    return;
  }
  
  selectedObjects = [];
  document.getElementById('selected-objects-container').style.display = 'flex';
  document.getElementById('detected-objects-list').style.display = 'flex';
  
  announce("Modalità selezione oggetti attiva. Rilevamento in corso...");
  
  const detectionInterval = setInterval(() => {
    if(document.getElementById('detected-objects-list').style.display === 'none'){
      clearInterval(detectionInterval);
      return;
    }
    
    if(video.readyState !== 4) return;
    
    try{
      const detections = objectDetector.detectForVideo(video, performance.now());
      currentDetections = detections.detections;
      
      const uniqueObjects = [...new Set(detections.detections.map(d => d.categories[0].categoryName))];
      
      const listEl = document.getElementById('detected-objects-list');
      listEl.innerHTML = '';
      
      if(uniqueObjects.length === 0){
        listEl.innerHTML = '<p style="color:#ccc;padding:10px">Nessun oggetto rilevato</p>';
        return;
      }
      
      uniqueObjects.forEach(obj => {
        const btn = document.createElement('button');
        btn.className = 'object-item-btn';
        btn.textContent = obj;
        btn.onclick = () => toggleObjectSelection(obj);
        
        if(selectedObjects.includes(obj)){
          btn.style.background = '#004400';
          btn.style.borderColor = '#0f0';
          btn.style.color = '#0f0';
        }
        
        listEl.appendChild(btn);
      });
      
    }catch(e){
      console.error("Detection error", e);
    }
    
  }, 1000);
}

function toggleObjectSelection(objName){
  const idx = selectedObjects.indexOf(objName);
  if(idx === -1){
    selectedObjects.push(objName);
    announce(`Aggiunto ${objName}`);
  }else{
    selectedObjects.splice(idx, 1);
    announce(`Rimosso ${objName}`);
  }
  
  updateSelectedObjectsList();
}

function updateSelectedObjectsList(){
  const container = document.getElementById('selected-objects-list');
  container.innerHTML = '';
  
  if(selectedObjects.length === 0){
    container.innerHTML = '<p style="color:#888">Nessuno</p>';
    return;
  }
  
  selectedObjects.forEach(obj => {
    const tag = document.createElement('div');
    tag.className = 'selected-object-tag';
    tag.innerHTML = `
      ${obj}
      <button class="remove-object-btn" onclick="toggleObjectSelection('${obj}')" aria-label="Rimuovi ${obj}">X</button>
    `;
    container.appendChild(tag);
  });
}

function startLiveGuidance(){
  if(selectedObjects.length === 0){
    announce("Seleziona almeno un oggetto");
    return;
  }
  
  document.getElementById('detected-objects-list').style.display = 'none';
  
  isGuiding = true;
  const btnGuide = document.getElementById('btn-guide');
  btnGuide.classList.add('guiding');
  btnGuide.textContent = 'STOP GUIDA';
  btnGuide.onclick = stopLiveGuidance;
  
  announce(`Guida attiva per: ${selectedObjects.join(', ')}`);
  
  guidanceInterval = setInterval(() => {
    if(!isGuiding) return;
    
    const now = Date.now();
    if(now - lastGuidanceTime < (guideVerbosity === 'minimo' ? 5000 : guideVerbosity === 'standard' ? 3000 : 2000)){
      return;
    }
    
    if(video.readyState !== 4) return;
    
    try{
      const detections = objectDetector.detectForVideo(video, performance.now());
      
      const found = [];
      const missing = [];
      
      selectedObjects.forEach(target => {
        const det = detections.detections.find(d => d.categories[0].categoryName === target);
        if(det){
          found.push({name: target, box: det.boundingBox});
        }else{
          missing.push(target);
        }
      });
      
      if(missing.length > 0){
        announce(`Mancano: ${missing.join(', ')}`);
      }else{
        const allCentered = found.every(obj => {
          const cx = obj.box.originX + obj.box.width/2;
          const cy = obj.box.originY + obj.box.height/2;
          const vcx = video.videoWidth/2;
          const vcy = video.videoHeight/2;
          return Math.abs(cx - vcx) < video.videoWidth*0.2 && Math.abs(cy - vcy) < video.videoHeight*0.2;
        });
        
        if(allCentered){
          announce("Composizione ottimale! Scatta ora.");
          if(modelsReady.face && modelsReady.pose){
            setTimeout(() => capturePhoto(), 1000);
            stopLiveGuidance();
          }
        }else{
          announce("Inquadra meglio gli oggetti al centro");
        }
      }
      
      lastGuidanceTime = now;
      
    }catch(e){
      console.error("Guidance error", e);
    }
    
  }, 500);
}

function stopLiveGuidance(){
  isGuiding = false;
  if(guidanceInterval){
    clearInterval(guidanceInterval);
    guidanceInterval = null;
  }
  
  const btnGuide = document.getElementById('btn-guide');
  btnGuide.classList.remove('guiding');
  btnGuide.textContent = 'SELEZIONA E FOTOGRAFA';
  btnGuide.onclick = startObjectSelection;
  
  document.getElementById('selected-objects-container').style.display = 'none';
  document.getElementById('detected-objects-list').style.display = 'none';
  
  announce("Guida disattivata");
}

// ============================================
// SHOW/HIDE RESULT
// ============================================
function showResult(text){
  const resultScreen = document.getElementById('result-screen');
  const resultContent = document.getElementById('result-content');
  
  resultContent.innerHTML = text;
  
  resultScreen.classList.remove('hidden');
  resultScreen.removeAttribute('aria-hidden');
  resultScreen.removeAttribute('inert');
  
  setTimeout(() => resultContent.focus(), 100);
}

function hideResult(){
  const resultScreen = document.getElementById('result-screen');
  resultScreen.classList.add('hidden');
  resultScreen.setAttribute('aria-hidden', 'true');
  resultScreen.setAttribute('inert', '');
  
  document.getElementById('download-link').classList.add('hidden');
  document.getElementById('photo-gallery').style.display = 'none';
}

// ============================================
// COMANDI VOCALI
// ============================================
function toggleVoiceControl(){
  voiceActive = !voiceActive;
  const btn = document.getElementById('btn-voice');
  const status = document.getElementById('voice-status');
  
  if(voiceActive){
    btn.classList.add('active-tool');
    status.style.display = 'block';
    status.classList.add('listening');
    
    if(!recognition){
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SpeechRecognition){
        announce("Riconoscimento vocale non supportato");
        voiceActive = false;
        btn.classList.remove('active-tool');
        status.style.display = 'none';
        return;
      }
      
      recognition = new SpeechRecognition();
      recognition.lang = 'it-IT';
      recognition.continuous = true;
      recognition.interimResults = false;
      
      recognition.onresult = (e) => {
        const transcript = e.results[e.results.length-1][0].transcript.toLowerCase().trim();
        handleVoiceCommand(transcript);
      };
      
      recognition.onerror = () => {
        announce("Errore riconoscimento vocale");
      };
    }
    recognition.start();
    announce("Comandi vocali attivi. Di' 'scatta', 'ruota', 'luce', 'colore', 'livella'");
  }else{
    if(recognition) recognition.stop();
    btn.classList.remove('active-tool');
    status.style.display = 'none';
    status.classList.remove('listening');
    announce("Comandi vocali disattivati");
  }
}

function handleVoiceCommand(cmd){
  if(cmd.includes('scatta')){
    startCountdown();
  }else if(cmd.includes('ruota') || cmd.includes('gira')){
    flipCamera();
  }else if(cmd.includes('luce')){
    toggleLight();
  }else if(cmd.includes('colore')){
    toggleColor();
  }else if(cmd.includes('livella')){
    toggleLevel();
  }else if(cmd.includes('guida')){
    startObjectSelection();
  }else{
    announce("Comando non riconosciuto");
  }
}

// ============================================
// MODALITÀ GUIDA
// ============================================

function cycleGuideMode(){
  const modes = ['minimo','standard','dettagliato'];
  const idx = modes.indexOf(guideVerbosity);
  guideVerbosity = modes[(idx+1)%modes.length];
  updateGuideModeLabel();
  announce(`Guida ${guideVerbosity}`);
}

function updateGuideModeLabel(){
  const btn = document.getElementById('btn-guide-mode');
  btn.textContent = `GUIDA: ${guideVerbosity.toUpperCase()}`;
}

// ============================================
// SETUP INIZIALE
// ============================================

async function startApp(){
  document.getElementById('main-interface').classList.remove('hidden');
  document.getElementById('main-interface').removeAttribute('aria-hidden');
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('start-screen').setAttribute('aria-hidden','true');
  document.getElementById('btn-shot').focus();
  updateGuideModeLabel();
  loadGallery();
  announce("Smart Photo Assistant avviato.");
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  await setupCamera('user');
  
  try{
    const {
      ObjectDetector,
      PoseLandmarker,
      FaceLandmarker,
      FilesetResolver
    } = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js");
    
    const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
    
    try{
      objectDetector = await ObjectDetector.createFromOptions(vision,{
        baseOptions:{
          modelAssetPath:"https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite",
          delegate:"GPU"
        },
        scoreThreshold:0.3,
        runningMode:"VIDEO"
      });
      modelsReady.detector = true;
    }catch(e){
      console.error("ObjectDetector error", e);
    }
    
    try{
      poseLandmarker = await PoseLandmarker.createFromOptions(vision,{
        baseOptions:{
          modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",
          delegate:"GPU"
        },
        runningMode:"VIDEO",
        numPoses:1
      });
      modelsReady.pose = true;
    }catch(e){
      console.error("PoseLandmarker error", e);
    }
    
    try{
      faceLandmarker = await FaceLandmarker.createFromOptions(vision,{
        baseOptions:{
          modelAssetPath:"https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
          delegate:"GPU"
        },
        runningMode:"VIDEO",
        numFaces:1
      });
      modelsReady.face = true;
    }catch(e){
      console.error("FaceLandmarker error", e);
    }
    
    if(modelsReady.face && modelsReady.pose){
      announce("Riconoscimento volto e corpo attivo. Pronto per selfie intelligenti.");
    }else if(modelsReady.detector){
      announce("Riconoscimento oggetti attivo.");
    }
    
  }catch(e){
    console.error("Errore import MediaPipe", e);
    announce("Modelli di riconoscimento limitati. Funzioni base disponibili.");
  }
  
  isRunning = true;
  loop();
}

function loop(){
  if(!isRunning){
    requestAnimationFrame(loop);
    return;
  }
  if(video.readyState===4 && tempCtx){
    if(tempCanvas.width!==video.videoWidth){
      tempCanvas.width=video.videoWidth;
      tempCanvas.height=video.videoHeight;
      canvas.width=video.videoWidth;
      canvas.height=video.videoHeight;
    }
    tempCtx.drawImage(video,0,0,tempCanvas.width,tempCanvas.height);
    if(lightActive)processLight();
    if(colorActive)processColor();
  }
  requestAnimationFrame(loop);
}

window.openSettings=()=>{
  const ks = document.getElementById('key-screen');
  ks.classList.remove('hidden');
  ks.removeAttribute('aria-hidden');
  ks.removeAttribute('inert');
  document.getElementById('key-input').value = GEMINI_KEY;
};

window.closeSettings=()=>{
  const ks = document.getElementById('key-screen');
  ks.classList.add('hidden');
  ks.setAttribute('aria-hidden','true');
  ks.setAttribute('inert','');
};

window.saveKey=()=>{
  const key = document.getElementById('key-input').value.trim();
  
  // VALIDAZIONE CHIAVE API
  if(!key || key.length < 20){
    announce("Chiave non valida. Lunghezza minima 20 caratteri.");
    return;
  }
  
  GEMINI_KEY = key;
  localStorage.setItem('gemini_key', GEMINI_KEY);
  closeSettings();
  announce("Chiave Gemini salvata correttamente.");
};
</script>
</body>
</html>