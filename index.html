<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Visione AI - PRO 3 (Finale)</title>
    <style>
        body {
            font-family: 'Arial', sans-serif; margin: 0; padding: 0;
            background-color: #000; color: #fff;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* Accessibilità: SR Only */
        .sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }

        /* Area Fotocamera */
        #cam-container {
            position: relative; flex-grow: 1; width: 100%;
            background: #111; display: flex; justify-content: center; align-items: center;
        }
        video { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        /* Griglia Comandi */
        #controls {
            height: 60vh; width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr auto auto; 
            gap: 8px; padding: 8px; box-sizing: border-box;
            background: #000; border-top: 4px solid #333;
        }

        button {
            border: 2px solid #555; border-radius: 12px;
            font-size: 1.1rem; font-weight: bold; text-transform: uppercase;
            color: #FFF; background: #222; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; touch-action: manipulation;
        }
        button:active { background: #555; transform: scale(0.98); }

        /* Colori e Stati Pulsanti */
        #btn-desc { background-color: #D4AF37; color: #000; border-color: #FFF; font-size: 1.3rem; }
        #btn-guide { background-color: #004080; border-color: #FFF; }
        
        .active-tool { background-color: #006400 !important; border-color: #00FF00 !important; }
        .guiding { background-color: #8B0000 !important; border-color: #FF0000 !important; }

        /* Barra inferiore impostazioni */
        .bottom-bar { grid-column: 1 / -1; display: flex; gap: 10px; }
        .small-btn { flex: 1; font-size: 0.9rem; background: #111; border: 1px solid #444; color: #CCC; }
        .active-discrete { border-color: #FF0000; color: #FF0000; }

        /* Barra azioni foto (usa / elimina) */
        .shot-bar { grid-column: 1 / -1; display: flex; gap: 10px; }

        /* Overlay Caricamento e Settings */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .hidden { display: none !important; }
        .loader { border: 6px solid #333; border-top: 6px solid #D4AF37; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        input { background: #333; color: #FFF; border: 1px solid #777; }

        /* Link download fallback */
        #download-link {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 0.9rem;
            color: #D4AF37;
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <div id="sr-announcer" class="sr-only" aria-live="assertive" role="status"></div>

    <div id="cam-container">
        <video id="webcam" playsinline muted autoplay></video>
        <canvas id="overlay"></canvas>
    </div>

    <div id="controls" class="hidden">
        <button id="btn-desc" onclick="quickDescribe()" aria-label="Scatta foto, descrivi la scena e poi scegli se usare o eliminare la foto">
            DESCRIVI SCENA
        </button>
        <button id="btn-guide" onclick="toggleGuidance()">GUIDA CENTRAGGIO</button>
        
        <button id="btn-light" onclick="toggleLight()">SONDA LUCE</button>
        <button id="btn-color" onclick="toggleColor()">SONDA COLORE</button>

        <button id="btn-level" onclick="toggleLevel()">LIVELLA</button>
        <button id="btn-torch" onclick="toggleTorch()">TORCIA</button>

        <!-- Barra azioni dopo lo scatto -->
        <div id="shot-actions" class="shot-bar hidden">
            <button class="small-btn" id="btn-use" onclick="usePhoto()">USA FOTO</button>
            <button class="small-btn" id="btn-delete" onclick="deletePhoto()">ELIMINA</button>
        </div>

        <div class="bottom-bar">
            <button class="small-btn" id="btn-discrete" onclick="toggleDiscrete()">MODO DISCRETO</button>
            <button class="small-btn" onclick="openSettings()">IMPOSTAZIONI API</button>
        </div>

        <!-- Link fallback per download foto -->
        <a id="download-link" href="#" class="hidden">
            Scarica la foto scattata
        </a>
    </div>

    <div id="start-screen" class="overlay">
        <h1 style="color: #FFF; margin-bottom: 20px;">Visione AI Pro 3</h1>
        <div id="loader" class="loader hidden"></div>
        <div id="load-msg" class="hidden" style="color:#FFF; font-size: 1.2rem;">Avvio sensori...</div>
        <button onclick="startApp()" style="padding: 30px; font-size: 1.5rem; background: #D4AF37; color: #000; border-radius: 12px; width: 90%; border:none; font-weight: bold;">AVVIA SISTEMA</button>
    </div>

    <div id="key-screen" class="overlay hidden">
        <h2 style="color: #FFF;">Chiave Gemini API</h2>
        <p style="color: #AAA; padding: 0 20px; text-align: center;">Inserisci la tua API Key (Gemini 3 Pro consigliata)</p>
        <input type="text" id="key-input" placeholder="Incolla chiave qui..." style="width: 80%; padding: 15px; font-size: 1.2rem; margin-bottom: 20px; border-radius: 8px;">
        <button onclick="saveKey()" style="padding: 15px; background: #FFF; color:#000; width: 50%; font-weight:bold; border-radius: 8px; margin-bottom: 10px;">SALVA</button>
        <button onclick="closeSettings()" style="padding: 15px; background:#333; color:#FFF; width:50%; border-radius: 8px;">CHIUDI</button>
    </div>

    <script>
        // --- CONFIGURAZIONE ---
        let GEMINI_KEY = localStorage.getItem('gemini_key') || "";
        // MODELLO: Gemini 3 Pro Preview (multimodale, reasoning avanzato).
        const MODEL_NAME = "gemini-3-pro-preview"; 
        // Endpoint preview per Gemini 3 Pro
        const API_ENDPOINT = "v1beta";

        let audioCtx, lightOsc, lightGain;
        let objectDetector = null;
        let isRunning = false;
        let videoTrack = null;
        
        // Canvas off-screen ottimizzato
        const tempCanvas = document.createElement('canvas');
        let tempCtx = null;

        // Stati applicazione
        let mode = 'idle'; 
        let lightActive = false, colorActive = false, levelActive = false, torchActive = false;
        let discreteMode = false;
        let lastSpeak = 0;
        let centeredCount = 0;
        const SNAP_THRESHOLD = 20; 

        const video = document.getElementById('webcam');
        const canvas = document.getElementById('overlay');
        const ctx = canvas.getContext('2d');

        // Stato ultima foto scattata
        let lastShotB64 = null;
        let lastShotUrl = null;

        // --- ACCESSIBILITÀ & OUTPUT ---
        function announce(text) {
            if(discreteMode) return;
            const el = document.getElementById('sr-announcer');
            el.textContent = ""; 
            setTimeout(() => el.textContent = text, 50);
        }

        function vibrate(pattern) {
            if(navigator.vibrate) navigator.vibrate(pattern);
        }

        // --- 1. AVVIO DEL SISTEMA ---
        async function startApp() {
            const startBtn = document.querySelector('#start-screen button');
            startBtn.style.display = 'none';
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('load-msg').classList.remove('hidden');
            
            announce("Avvio sistema Pro 3. Attendi.");
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            try {
                // MediaPipe (Visione locale veloce per guida)
                const { ObjectDetector, FilesetResolver } = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js");
                const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
                
                objectDetector = await ObjectDetector.createFromOptions(vision, {
                    baseOptions: { 
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite", 
                        delegate: "GPU" 
                    },
                    scoreThreshold: 0.1,   // più sensibile
                    maxResults: 5,
                    runningMode: "VIDEO"
                });

                // Gestione Fotocamera
                let stream;
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment', 
                            width: { ideal: 1280 }, 
                            height: { ideal: 720 },
                            focusMode: 'continuous' 
                        } 
                    });
                } catch (err) {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                }
                
                video.srcObject = stream;
                videoTrack = stream.getVideoTracks()[0];

                video.addEventListener('loadeddata', () => {
                    document.getElementById('start-screen').classList.add('hidden');
                    document.getElementById('controls').classList.remove('hidden');
                    
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    tempCanvas.width = video.videoWidth; tempCanvas.height = video.videoHeight;
                    tempCtx = tempCanvas.getContext('2d', { willReadFrequently: true });

                    isRunning = true;
                    announce("Sistema Pro 3 attivo.");
                    
                    if(!GEMINI_KEY) setTimeout(() => {
                        announce("Attenzione. Chiave A P I mancante.");
                        openSettings();
                    }, 1000);
                    
                    loop(); 
                });
            } catch(e) { 
                alert("Errore avvio: " + e.message); 
                announce("Errore critico avvio fotocamera.");
            }
        }

        function loop() {
            if(!isRunning) return;
            
            if(lightActive || colorActive) {
                if(tempCtx) tempCtx.drawImage(video, 0, 0);
            }

            if(lightActive) processLight();
            if(colorActive) processColor();
            if(mode === 'guiding') processGuidance();
            
            requestAnimationFrame(loop);
        }

        // --- 2. SCATTO + DESCRIZIONE GEMINI + SCELTA USA/ELIMINA ---
        async function quickDescribe() {
            if (mode === 'guiding') toggleGuidance(); 
            
            announce("Scatto. Attendi descrizione della scena.");
            playShutter();
            
            // Scatto dal video
            const b64 = captureFrame();
            lastShotB64 = b64;

            // reset eventuale URL precedente
            if (lastShotUrl) {
                URL.revokeObjectURL(lastShotUrl);
                lastShotUrl = null;
            }
            // nascondo link download vecchio
            const dlLink = document.getElementById('download-link');
            dlLink.classList.add('hidden');
            dlLink.removeAttribute('href');
            dlLink.removeAttribute('download');

            // Prompt per Gemini
            const prompt = "Descrivi in dettaglio e con alta precisione questa immagine per una persona non vedente. Identifica oggetti, testi (leggili tutti), colori e posizioni relative. Non essere troppo sintetico se ci sono dettagli importanti.";
            
            await callGemini(prompt, b64);

            // Dopo la descrizione mostro le azioni sulla foto
            const actions = document.getElementById('shot-actions');
            actions.classList.remove('hidden');
            announce("Descrizione completata. Puoi usare la foto oppure eliminarla.");
        }

        // --- 3. GUIDA AL CENTRAGGIO (potenziata) ---
        function toggleGuidance() {
            const btn = document.getElementById('btn-guide');
            if(mode === 'guiding') {
                mode = 'idle'; 
                btn.classList.remove('guiding'); 
                btn.innerText = "GUIDA CENTRAGGIO";
                ctx.clearRect(0,0,canvas.width,canvas.height); 
                announce("Guida spenta.");
            } else {
                mode = 'guiding'; 
                centeredCount = 0; 
                btn.classList.add('guiding'); 
                btn.innerText = "CERCO SOGGETTO...";
                announce("Guida centraggio attiva. Cerco un oggetto da centrare.");
            }
        }

        function processGuidance() {
            if (!objectDetector) return;

            const result = objectDetector.detectForVideo(video, performance.now());
            const detections = (result && result.detections) ? result.detections : [];

            ctx.clearRect(0,0,canvas.width,canvas.height);

            // Nessun oggetto rilevato proprio
            if (detections.length === 0) {
                if (Date.now() - lastSpeak > 1800) {
                    announce("Non vedo nessun oggetto distinto. Prova ad avvicinare o cambiare leggermente angolazione.");
                    lastSpeak = Date.now();
                }
                centeredCount = 0;
                return;
            }

            // Due livelli: detection forti, poi deboli
            let scored = detections.map(d => {
                const cat = (d.categories && d.categories[0]) ? d.categories[0] : null;
                const score = cat ? cat.score : 0;
                return { d, score };
            });

            let strong = scored.filter(x => x.score >= 0.5);
            if (strong.length === 0) {
                strong = scored.filter(x => x.score >= 0.2);
            }

            if (strong.length === 0) {
                // Modello molto incerto, meglio tacere
                centeredCount = 0;
                return;
            }

            // prendo l'oggetto più grande tra quelli filtrati
            const target = strong
                .sort((a, b) => {
                    const boxA = a.d.boundingBox;
                    const boxB = b.d.boundingBox;
                    return (boxB.width * boxB.height) - (boxA.width * boxA.height);
                })[0].d;

            const box = target.boundingBox;
            
            const cx = box.originX + box.width/2;
            const cy = box.originY + box.height/2;
            const sx = canvas.width/2, sy = canvas.height/2;
            const tolX = canvas.width * 0.15; 
            const tolY = canvas.height * 0.20; 

            ctx.strokeStyle = "#00FF00"; ctx.lineWidth = 6; 
            ctx.strokeRect(box.originX, box.originY, box.width, box.height);

            // etichetta -> italiano, con fallback “un oggetto”
            let label = null;
            if (target.categories && target.categories.length > 0) {
                label = target.categories[0].categoryName;
            }
            const oggetto = labelToItalian(label);

            let msg = "";

            if (cx < sx - tolX) {
                msg = oggetto + " un po' a sinistra. Sposta a sinistra.";
                centeredCount = 0;
            } else if (cx > sx + tolX) {
                msg = oggetto + " un po' a destra. Sposta a destra.";
                centeredCount = 0;
            } else if (cy < sy - tolY) {
                msg = oggetto + " in alto. Alza la fotocamera.";
                centeredCount = 0;
            } else if (cy > sy + tolY) {
                msg = oggetto + " in basso. Abbassa la fotocamera.";
                centeredCount = 0;
            } else {
                msg = oggetto + " centrato.";
                centeredCount++;
            }

            if (Date.now() - lastSpeak > 1200) {
                announce(msg);
                vibrate(30);
                lastSpeak = Date.now();
            }

            // Se rimane centrato per un po', puoi auto-scatto + descrizione
            if (centeredCount > SNAP_THRESHOLD) {
                mode = 'idle'; 
                document.getElementById('btn-guide').classList.remove('guiding');
                document.getElementById('btn-guide').innerText = "GUIDA CENTRAGGIO";
                announce("Oggetto centrato da tempo. Scatto e analizzo.");
                playShutter();

                const b64 = captureFrame();
                lastShotB64 = b64;

                if (lastShotUrl) {
                    URL.revokeObjectURL(lastShotUrl);
                    lastShotUrl = null;
                }

                callGemini("Descrivi molto dettagliatamente l'oggetto che ho appena inquadrato e centrato.", b64).then(()=>{
                    const actions = document.getElementById('shot-actions');
                    actions.classList.remove('hidden');
                    announce("Descrizione completata. Puoi usare la foto oppure eliminarla.");
                });

                centeredCount = 0;
            }
        }

        // --- 4. STRUMENTI SENSORIALI ---
        function toggleLight() {
            lightActive = !lightActive;
            const btn = document.getElementById('btn-light');
            
            if(lightActive) {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                lightOsc = audioCtx.createOscillator(); 
                lightGain = audioCtx.createGain();
                lightOsc.connect(lightGain); 
                lightGain.connect(audioCtx.destination);
                lightGain.gain.value = 0.05; 
                lightOsc.start();
                
                btn.classList.add('active-tool'); btn.innerText = "LUCE: ON"; 
                announce("Suono luce attivo.");
            } else {
                if(lightOsc) { lightOsc.stop(); lightOsc.disconnect(); }
                btn.classList.remove('active-tool'); btn.innerText = "SONDA LUCE"; 
                announce("Suono luce spento.");
            }
        }
        
        function processLight() {
            if(!tempCtx) return;
            const size = 20; 
            const cx = Math.floor(canvas.width / 2);
            const cy = Math.floor(canvas.height / 2);
            
            const x = Math.max(0, cx - size / 2);
            const y = Math.max(0, cy - size / 2);
            
            const p = tempCtx.getImageData(x, y, size, size).data;
            
            let sum=0; 
            for(let i=0; i<p.length; i+=4) sum += (p[i]+p[i+1]+p[i+2])/3;
            const level = sum/(p.length/4); 
            
            if(lightOsc) lightOsc.frequency.setValueAtTime(100+(level*4), audioCtx.currentTime);
        }

        function toggleColor() {
            colorActive = !colorActive;
            const btn = document.getElementById('btn-color');
            if(colorActive) { 
                btn.classList.add('active-tool'); btn.innerText = "COLORE: ON"; 
                announce("Lettura colore attiva."); 
            } else { 
                btn.classList.remove('active-tool'); btn.innerText = "SONDA COLORE"; 
                announce("Lettura colore spenta."); 
            }
        }
        
        function processColor() {
            if(Date.now()-lastSpeak<2000) return; 
            if(!tempCtx) return;

            const boxSize = 20; 
            const cx = Math.floor(canvas.width / 2);
            const cy = Math.floor(canvas.height / 2);
            
            const x = Math.max(0, cx - boxSize / 2);
            const y = Math.max(0, cy - boxSize / 2);
            
            const data = tempCtx.getImageData(x, y, boxSize, boxSize).data;
            let r=0, g=0, b=0;
            const pixelCount = (boxSize*boxSize);
            
            for(let i=0; i<data.length; i+=4) {
                r += data[i]; g += data[i+1]; b += data[i+2];
            }
            
            r = Math.round(r/pixelCount);
            g = Math.round(g/pixelCount);
            b = Math.round(b/pixelCount);

            announce(getColorName(r,g,b)); 
            lastSpeak=Date.now();
        }

        function toggleLevel() {
            levelActive = !levelActive;
            const btn = document.getElementById('btn-level');
            if(levelActive) {
                btn.classList.add('active-tool'); btn.innerText = "LIVELLA: ON"; 
                announce("Livella attiva.");
                if(typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(r=>{if(r==='granted') window.addEventListener('deviceorientation', handleLevel)})
                        .catch(()=>announce("Permesso sensori negato."));
                } else {
                    window.addEventListener('deviceorientation', handleLevel);
                }
            } else {
                btn.classList.remove('active-tool'); btn.innerText = "LIVELLA"; 
                announce("Livella spenta.");
                window.removeEventListener('deviceorientation', handleLevel);
            }
        }
        
        function handleLevel(e) {
            if(Date.now()-lastSpeak<1500) return;
            const tilt = e.gamma || 0; 
            
            if(tilt > 10) { announce("Pende a destra"); vibrate(50); lastSpeak=Date.now(); }
            else if(tilt < -10) { announce("Pende a sinistra"); vibrate(50); lastSpeak=Date.now(); }
        }

        function toggleTorch() {
            if(!videoTrack) { announce("Fotocamera non pronta."); return; }
            const targetState = !torchActive;
            const btn = document.getElementById('btn-torch');

            videoTrack.applyConstraints({advanced:[{torch: targetState}]})
            .then(() => {
                torchActive = targetState; 
                if(torchActive) {
                     btn.classList.add('active-tool'); btn.innerText = "TORCIA: ON"; announce("Torcia accesa.");
                } else {
                     btn.classList.remove('active-tool'); btn.innerText = "TORCIA"; announce("Torcia spenta.");
                }
            })
            .catch(err => {
                announce("Torcia non disponibile su questo dispositivo o in questa modalità.");
                torchActive = false;
                btn.classList.remove('active-tool'); btn.innerText = "TORCIA";
            });
        }

        function toggleDiscrete() {
            discreteMode = !discreteMode;
            const btn = document.getElementById('btn-discrete');
            if(discreteMode) { 
                btn.classList.add('active-discrete'); btn.innerText = "MODO DISCRETO: ON";
                vibrate([100,50,100]); 
            } else {
                btn.classList.remove('active-discrete'); btn.innerText = "MODO DISCRETO";
                announce("Modo discreto spento.");
            }
        }

        // --- UTILITIES ---
        function captureFrame() {
            tempCtx.drawImage(video, 0, 0);
            return tempCanvas.toDataURL('image/jpeg', 0.8).split(',')[1]; 
        }

        async function callGemini(prompt, b64) {
            if(!GEMINI_KEY) { announce("Chiave API mancante."); openSettings(); return; }
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/${API_ENDPOINT}/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        contents: [{ 
                            parts: [
                                { text: prompt }, 
                                { inline_data: { mime_type: "image/jpeg", data: b64 } }
                            ] 
                        }] 
                    })
                });
                
                const d = await res.json();
                
                if(d.error) {
                    console.error("Errore API Gemini:", d.error);
                    announce("Errore API: " + d.error.message);
                    alert("ERRORE API: " + d.error.message);
                    return;
                }
                
                if(!d.candidates || !d.candidates[0].content) throw new Error("Nessuna risposta dall'AI.");

                const text = d.candidates[0].content.parts[0].text;
                
                if(!discreteMode) announce(text);
                else alert("RISPOSTA AI:\n" + text); 

            } catch(e) { 
                console.error(e);
                announce("Si è verificato un errore generale nell'analisi. Riprova.");
            }
        }

        function playShutter() { 
            if(!discreteMode && audioCtx){ 
                const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); 
                g.gain.value=0.1; o.frequency.value=600; 
                o.connect(g); g.connect(audioCtx.destination); 
                o.start(); o.stop(audioCtx.currentTime+0.1); 
            } 
        }
        
        // --- 5. USA FOTO / ELIMINA FOTO ---

        async function usePhoto() {
            if (!lastShotB64) {
                announce("Nessuna foto disponibile da usare.");
                return;
            }

            let shared = false;

            try {
                if (navigator.share) {
                    const blob = await (await fetch(`data:image/jpeg;base64,${lastShotB64}`)).blob();
                    const file = new File([blob], "foto-visione-ai.jpg", { type: "image/jpeg" });

                    const canShareFiles = !navigator.canShare || navigator.canShare({ files: [file] });

                    if (canShareFiles) {
                        await navigator.share({
                            title: "Scatto Visione AI",
                            text: "Foto scattata da Visione AI.",
                            files: [file]
                        });
                        shared = true;
                        announce("Finestra di condivisione aperta. Scegli l'app con cui vuoi inviare la foto.");
                    }
                }
            } catch (e) {
                console.warn("Condivisione non riuscita o annullata:", e);
            }

            if (!shared) {
                try {
                    const blob = await (await fetch(`data:image/jpeg;base64,${lastShotB64}`)).blob();
                    lastShotUrl = URL.createObjectURL(blob);
                    const link = document.getElementById('download-link');
                    link.href = lastShotUrl;
                    link.download = "scatto-visione-ai.jpg";
                    link.classList.remove('hidden');
                    announce("Questo dispositivo non supporta la condivisione diretta della foto. Usa il link 'Scarica la foto scattata' per salvarla e condividerla dall'app Foto.");
                } catch (e) {
                    console.error(e);
                    announce("Errore nel preparare la foto per la condivisione.");
                }
            }
        }

        function deletePhoto() {
            lastShotB64 = null;
            if (lastShotUrl) {
                URL.revokeObjectURL(lastShotUrl);
                lastShotUrl = null;
            }

            const actions = document.getElementById('shot-actions');
            actions.classList.add('hidden');

            const dlLink = document.getElementById('download-link');
            dlLink.classList.add('hidden');
            dlLink.removeAttribute('href');
            dlLink.removeAttribute('download');

            announce("Foto eliminata. Sei tornata alla schermata principale. Puoi scattare una nuova foto quando vuoi.");
        }

        // Palette Colori per Non Vedenti (nomi stabili)
        const colors={
            '0,0,0':'Nero','255,255,255':'Bianco','200,200,200':'Grigio Chiaro','80,80,80':'Grigio Scuro',
            '255,0,0':'Rosso','0,255,0':'Verde','0,0,255':'Blu','255,255,0':'Giallo',
            '0,255,255':'Azzurro','255,0,255':'Fucsia','165,42,42':'Marrone','255,165,0':'Arancione',
            '128,0,128':'Viola','245,245,220':'Beige','255,192,203':'Rosa'
        };
        
        function getColorName(r,g,b){ 
            let min=Infinity,res="Indefinito"; 
            for(let k in colors){ 
                const[cr,cg,cb]=k.split(',').map(Number); 
                const d=Math.sqrt((r-cr)**2*0.3 + (g-cg)**2*0.59 + (b-cb)**2*0.11); 
                if(d<min){min=d;res=colors[k];}
            } 
            return res;
        }

        // Mappe etichette rilevatore -> italiano
        const labelMap = {
            person: "una persona",
            face: "un volto",
            bottle: "una bottiglia",
            cup: "una tazza",
            book: "un libro",
            cellphone: "un telefono",
            laptop: "un portatile",
            chair: "una sedia",
            tv: "un televisore"
            // puoi aggiungere altre etichette se ne trovi nei test
        };

        function labelToItalian(label) {
            if (!label) return "un oggetto";
            return labelMap[label] || "un oggetto";
        }

        // Settings Manager
        window.openSettings = () => { 
            document.getElementById('key-screen').classList.remove('hidden');
            announce("Impostazioni aperte.");
        };
        window.closeSettings = () => {
            document.getElementById('key-screen').classList.add('hidden');
            announce("Chiudo impostazioni.");
        };
        window.saveKey = () => { 
            const val = document.getElementById('key-input').value.trim();
            if(val.length > 10) {
                GEMINI_KEY=val; 
                localStorage.setItem('gemini_key',GEMINI_KEY); 
                closeSettings(); 
                announce("Chiave salvata."); 
            } else {
                announce("Chiave non valida.");
            }
        };

    </script>
</body>
</html>
