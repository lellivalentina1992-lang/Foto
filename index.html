<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Smart Photo Assistant - Selection Pro</title>
<style>
/* STILE BASE */
body{font-family:'Segoe UI',Roboto,Arial,sans-serif;margin:0;padding:0;background:#000;color:#fff;height:100vh;display:flex;flex-direction:column;overflow:hidden}
.sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)}

/* AREA CAMERA */
#cam-container{position:relative;flex-grow:1;background:#111;display:flex;justify-content:center;align-items:center}
video{width:100%;height:100%;object-fit:cover;opacity:.8}
canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}

/* STATUS E COUNTDOWN */
#voice-status{position:absolute;top:10px;right:10px;padding:8px 12px;border-radius:20px;background:rgba(0,0,0,0.8);border:1px solid #777;font-size:0.9rem;z-index:60;display:none}
.listening{border-color:#0f0!important;color:#0f0!important}
#countdown-overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:8rem;color:#fff;font-weight:bold;text-shadow:0 0 15px #000;z-index:70;display:none}

/* INTERFACCIA PRINCIPALE */
#main-interface{height:60vh;width:100%;background:#000;border-top:2px solid #333;display:flex;flex-direction:column}
#camera-controls{flex-grow:1;display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:min-content;gap:10px;padding:10px;overflow-y:auto}

/* AREA SELEZIONE OGGETTI */
#selection-panel{grid-column:1/-1;background:#111;border:1px solid #444;border-radius:8px;padding:10px;display:none;flex-direction:column;gap:5px}
#detected-list{display:flex;flex-wrap:wrap;gap:5px;max-height:100px;overflow-y:auto}
.obj-btn{padding:8px 12px;border:1px solid #555;background:#222;color:#fff;border-radius:20px;font-size:0.9rem}
.obj-btn.selected{background:#006400;border-color:#0f0;color:#0f0}

/* PULSANTI */
button{border:2px solid #555;border-radius:12px;font-size:1rem;font-weight:bold;text-transform:uppercase;color:#fff;background:#222;min-height:60px;touch-action:manipulation}
button:active{background:#555;transform:scale(.98)}
.full-width{grid-column:1/-1}
.btn-primary{background:#004080;border-color:#4a90e2}
.btn-action{background:#006400;border-color:#0f0;color:#0f0}
.btn-guide{background:#8B0000;border-color:#f00;font-size:1.1rem}
.active-tool{background:#DAA520!important;border-color:#FFD700!important;color:#000!important}

/* MENU CONTESTO */
#context-menu{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;z-index:80;padding:15px;display:flex;flex-direction:column;gap:10px;overflow-y:auto}
.context-title{font-size:1.2rem;color:#D4AF37;text-align:center;margin-bottom:10px}
.btn-share-now{background:#2F4F4F!important;border-color:#00CED1!important;color:#fff!important;min-height:80px;font-size:1.2rem}

/* SCHERMATA RISULTATO */
#result-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:#111;z-index:90;display:flex;flex-direction:column;padding:15px}
#result-text{flex-grow:1;background:#000;border:1px solid #555;padding:15px;overflow-y:auto;font-size:1.2rem;line-height:1.5;white-space:pre-wrap;margin-bottom:10px}

/* EDITOR TESTO */
#text-editor{position:absolute;bottom:0;left:0;width:100%;background:#222;padding:15px;z-index:100;border-top:2px solid #D4AF37;display:none}
#caption-input{width:100%;padding:15px;font-size:1.2rem;margin-bottom:10px}

/* SETTINGS */
.overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:200;display:flex;flex-direction:column;justify-content:center;align-items:center}
.hidden{display:none!important}
</style>
</head>
<body>

<div id="sr-announcer" class="sr-only" aria-live="assertive" role="status"></div>

<div id="cam-container">
  <video id="webcam" playsinline muted autoplay></video>
  <canvas id="overlay"></canvas>
  <div id="voice-status">Ascolto...</div>
  <div id="countdown-overlay"></div>
</div>

<div id="main-interface">
  <div id="camera-controls">
    
    <button class="full-width" id="btn-select-mode" onclick="toggleSelectionMode()" style="background:#333;border-color:#777">
      SELEZIONA COSA FOTOGRAFARE
    </button>
    
    <div id="selection-panel">
      <div style="font-size:0.9rem;color:#ccc;margin-bottom:5px">Oggetti visibili (clicca per selezionare):</div>
      <div id="detected-list">In attesa...</div>
      <button onclick="confirmSelection()" class="full-width btn-action" style="min-height:40px;margin-top:5px">CONFERMA E CHIUDI</button>
    </div>

    <button class="full-width btn-guide" id="btn-guide" onclick="toggleSmartGuide()">
      AVVIA GUIDA AUTO-SCATTO
    </button>

    <div id="local-ai-status" class="full-width" style="text-align:center;padding:10px;background:#222;border:1px solid #444;border-radius:8px;color:#ccc" aria-live="polite">
      In attesa...
    </div>

    <button onclick="toggleLight()" id="btn-light">SONDA LUCE</button>
    <button onclick="toggleColor()" id="btn-color">COLORE</button>
    <button class="full-width btn-action" onclick="startCountdown(5)">SCATTA MANUALE (5 SEC)</button>
    <button onclick="flipCamera()">RUOTA CAMERA</button>
    <button onclick="toggleVoiceControl()" id="btn-voice">COMANDI VOCALI</button>
    <button class="full-width" onclick="openSettings()" style="min-height:50px;font-size:0.9rem;background:#333">IMPOSTAZIONI API</button>
  </div>
</div>

<div id="context-menu" class="hidden" aria-hidden="true">
  <h2 class="context-title">Foto Acquisita</h2>
  <button class="btn-share-now full-width" onclick="shareImageNative()">USA / CONDIVIDI SUBITO</button>
  <div style="height:1px;background:#555;margin:10px 0"></div>
  <p style="text-align:center;color:#ccc;margin:5px">Analisi Gemini:</p>
  <button class="btn-primary" onclick="analyzeContext('selfie')">SELFIE / RITRATTO</button>
  <button class="btn-primary" onclick="analyzeContext('group')">GRUPPO</button>
  <button class="btn-primary" onclick="analyzeContext('environment')">AMBIENTE</button>
  <button class="btn-primary" onclick="analyzeContext('document')">LEGGI TESTO</button>
  <div style="height:1px;background:#555;margin:10px 0"></div>
  <button style="background:#E1306C;border-color:#fff" class="full-width" onclick="analyzeContext('social')">ANALISI SOCIAL (IG/TikTok)</button>
  <button onclick="discardPhoto()" style="background:#8B0000;margin-top:15px">ELIMINA</button>
</div>

<div id="result-screen" class="hidden" aria-hidden="true">
  <h2 style="color:#D4AF37;text-align:center;margin:0 0 10px 0">Risultato</h2>
  <div id="result-text" tabindex="0">Elaborazione...</div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
    <button onclick="openTextEditor()" class="full-width btn-primary">AGGIUNGI TESTO</button>
    <button onclick="shareImageNative()" class="full-width btn-action">CONDIVIDI</button>
    <button onclick="discardPhoto()" class="full-width" style="background:#8B0000">CHIUDI</button>
  </div>
</div>

<div id="text-editor">
  <h3 style="color:#fff;margin-top:0">Testo su foto</h3>
  <input type="text" id="caption-input" placeholder="Scrivi qui...">
  <div style="display:flex;gap:10px">
    <button onclick="applyTextToImage()" class="btn-action" style="flex:1">APPLICA</button>
    <button onclick="closeTextEditor()" style="flex:1">ANNULLA</button>
  </div>
</div>

<div id="key-screen" class="overlay hidden">
  <h2>Chiave Gemini API</h2>
  <input type="text" id="key-input" style="width:80%;padding:15px;margin-bottom:20px;color:#000">
  <button onclick="saveKey()" style="padding:20px;width:80%">SALVA</button>
  <button onclick="closeSettings()" style="margin-top:10px;padding:20px;width:80%;background:#333">CHIUDI</button>
</div>

<script>
let GEMINI_KEY = localStorage.getItem('gemini_key') || "";
const MODEL_NAME = "gemini-2.0-flash-exp"; 
const API_ENDPOINT = "v1beta";

// VARIABILI GLOBALI
let video = document.getElementById('webcam');
let canvas = document.getElementById('overlay');
let ctx = canvas.getContext('2d');
let tempCanvas = document.createElement('canvas');
let tempCtx = tempCanvas.getContext('2d');
let stream = null;
let currentPhotoBase64 = null;
let finalPhotoBase64 = null;
let textPositionSuggestion = "bottom";

// TOOLS
let audioCtx, lightOsc, lightGain;
let lightActive = false, colorActive = false;

// AI LOCAL
let objectDetector = null;
let faceLandmarker = null;

// STATI GUIDA
let isGuiding = false;
let isSelectionMode = false;
let guideInterval = null;
let lastGuideTime = 0;
let isCountdownRunning = false;
let countdownTimerIds = [];

// TARGETING
let selectedTargets = []; // Array di stringhe con i nomi degli oggetti scelti
let availableObjects = []; // Cosa vede la camera ora

async function init(){
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  await setupCamera();
  await loadLocalModels();
  announce("App pronta. Usa 'Seleziona cosa fotografare' oppure 'Avvia Guida Auto-Scatto'.");
  loopTools();
}

async function setupCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}}});
    video.srcObject = stream;
    await new Promise(r => video.onloadedmetadata = r);
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    tempCanvas.width = video.videoWidth; tempCanvas.height = video.videoHeight;
  }catch(e){ announce("Errore fotocamera."); }
}
function flipCamera(){ alert("Usa impostazioni browser."); }

async function loadLocalModels(){
  try{
    const { ObjectDetector, FaceLandmarker, FilesetResolver } = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js");
    const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
    objectDetector = await ObjectDetector.createFromOptions(vision, { baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite" }, scoreThreshold: 0.4, runningMode: "VIDEO" });
    faceLandmarker = await FaceLandmarker.createFromOptions(vision, { baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task" }, runningMode: "VIDEO", numFaces: 1 });
  }catch(e){ announce("AI Locale non disponibile."); }
}

function loopTools(){
  if(video.readyState===4){
    tempCtx.drawImage(video,0,0,tempCanvas.width,tempCanvas.height);
    if(lightActive) processLight();
  }
  requestAnimationFrame(loopTools);
}
// (Funzioni Luce/Colore omesse per brevità, sono identiche a prima, le reinserisco sotto compatte)
function toggleLight(){ lightActive=!lightActive; document.getElementById('btn-light').classList.toggle('active-tool'); announce(lightActive?"Luce ON":"Luce OFF"); if(lightActive && !lightOsc){lightOsc=audioCtx.createOscillator();lightGain=audioCtx.createGain();lightOsc.connect(lightGain);lightGain.connect(audioCtx.destination);lightOsc.start();lightGain.gain.value=0;} if(!lightActive && lightGain)lightGain.gain.value=0; }
function processLight(){ const d=tempCtx.getImageData(0,0,tempCanvas.width,tempCanvas.height).data; let s=0; for(let i=0;i<d.length;i+=4)s+=(d[i]+d[i+1]+d[i+2])/3; const b=s/(d.length/4); if(lightOsc)lightOsc.frequency.value=200+b*2; if(lightGain)lightGain.gain.value=0.1; }
function toggleColor(){ colorActive=!colorActive; document.getElementById('btn-color').classList.toggle('active-tool'); announce(colorActive?"Colore ON":"Colore OFF"); if(colorActive) processColor(); }
function processColor(){ const w=tempCanvas.width,h=tempCanvas.height; const d=tempCtx.getImageData(w/2-10,h/2-10,20,20).data; let r=0,g=0,b=0,c=0; for(let i=0;i<d.length;i+=4){r+=d[i];g+=d[i+1];b+=d[i+2];c++;} r=Math.round(r/c);g=Math.round(g/c);b=Math.round(b/c); announce(`Colore: ${r>200&&g>200&&b>200?'Bianco':r<50&&g<50&&b<50?'Nero':r>150&&g<100?'Rosso':g>150&&r<100?'Verde':b>150?'Blu':'Misto'}`); }

// --- GESTIONE SELEZIONE MANUALE ---
function toggleSelectionMode(){
  isSelectionMode = !isSelectionMode;
  const panel = document.getElementById('selection-panel');
  const btn = document.getElementById('btn-select-mode');
  
  if(isSelectionMode){
    // Ferma la guida se attiva
    if(isGuiding) toggleSmartGuide();
    
    panel.style.display = 'flex';
    btn.classList.add('active-tool');
    btn.textContent = "CHIUDI SELEZIONE";
    announce("Modalità selezione. Esploro la scena...");
    selectedTargets = []; // Reset selezione precedente
    updateSelectionUI();
    
    // Avvia loop di scansione per popolare la lista
    guideInterval = setInterval(scanForSelection, 1000);
  } else {
    panel.style.display = 'none';
    btn.classList.remove('active-tool');
    btn.textContent = "SELEZIONA COSA FOTOGRAFARE";
    clearInterval(guideInterval);
    announce("Selezione chiusa.");
  }
}

async function scanForSelection(){
  if(video.readyState !== 4 || !objectDetector) return;
  
  const detections = objectDetector.detectForVideo(video, performance.now());
  // Estrai nomi univoci
  const currentSet = new Set();
  detections.detections.forEach(d => currentSet.add(d.categories[0].categoryName));
  
  // Aggiungiamo anche 'person' se non c'è ma il faceLandmarker vede un volto?
  // Per semplicità usiamo l'object detector che vede 'person'.
  
  availableObjects = Array.from(currentSet);
  updateSelectionUI();
}

function updateSelectionUI(){
  const list = document.getElementById('detected-list');
  list.innerHTML = '';
  
  if(availableObjects.length === 0){
    list.innerHTML = '<span style="color:#777">Nessun oggetto rilevato...</span>';
    return;
  }
  
  availableObjects.forEach(objName => {
    // Traduzione semplice
    let display = objName;
    if(objName==='person') display='Persona';
    if(objName==='cup') display='Tazza';
    if(objName==='bottle') display='Bottiglia';
    if(objName==='chair') display='Sedia';
    if(objName==='laptop') display='Computer';
    if(objName==='cell phone') display='Telefono';
    
    const btn = document.createElement('button');
    btn.className = 'obj-btn';
    if(selectedTargets.includes(objName)) btn.classList.add('selected');
    
    btn.textContent = display + (selectedTargets.includes(objName) ? " (SCELTO)" : "");
    btn.onclick = () => {
      if(selectedTargets.includes(objName)){
        selectedTargets = selectedTargets.filter(t => t !== objName);
        announce(`Rimosso ${display}`);
      } else {
        selectedTargets.push(objName);
        announce(`Selezionato ${display}`);
      }
      updateSelectionUI();
    };
    list.appendChild(btn);
  });
}

function confirmSelection(){
  toggleSelectionMode(); // Chiude il pannello
  if(selectedTargets.length > 0){
    announce(`Hai scelto: ${selectedTargets.length} oggetti. Premi Avvia Guida.`);
    document.getElementById('btn-guide').textContent = "AVVIA GUIDA (SELEZIONE ATTIVA)";
  } else {
    announce("Nessuna selezione. Userò modalità automatica.");
    document.getElementById('btn-guide').textContent = "AVVIA GUIDA AUTO-SCATTO";
  }
}

// --- LOGICA GUIDA INTELLIGENTE (IBRIDA) ---
function toggleSmartGuide(){
  isGuiding = !isGuiding;
  const btn = document.getElementById('btn-guide');
  
  if(isGuiding){
    // Chiudi selezione se aperta
    if(isSelectionMode) toggleSelectionMode();
    
    btn.textContent = "STOP GUIDA"; 
    btn.style.background = "#006400";
    
    let msg = "Guida Automatica Attiva.";
    if(selectedTargets.length > 0) msg = "Guida Selettiva Attiva. Cerco i tuoi oggetti.";
    announce(msg);
    
    isCountdownRunning = false;
    guideInterval = setInterval(processLocalFrame, 200);
  }else{
    btn.textContent = selectedTargets.length > 0 ? "AVVIA GUIDA (SELEZIONE ATTIVA)" : "AVVIA GUIDA AUTO-SCATTO";
    btn.style.background = "#8B0000";
    clearInterval(guideInterval); cancelCountdown();
    announce("Guida fermata.");
  }
}

async function processLocalFrame(){
  if(video.readyState !== 4) return;
  const now = Date.now();
  if(!isCountdownRunning && now - lastGuideTime < 1800) return; 

  let targetsFound = [];
  let label = "";

  // 1. Rilevamento Volti (Sempre utile)
  if(faceLandmarker){
    const faces = faceLandmarker.detectForVideo(video, performance.now());
    if(faces.faceLandmarks.length > 0){
      // Se l'utente ha selezionato "person", il volto conta come persona
      if(selectedTargets.length === 0 || selectedTargets.includes('person')){
         let points = faces.faceLandmarks[0];
         let cx=0, cy=0;
         points.forEach(p => { cx += p.x; cy += p.y; });
         targetsFound.push({x: cx/points.length, y: cy/points.length, name: "Volto"});
      }
    }
  }

  // 2. Rilevamento Oggetti
  if(objectDetector){
    const detections = objectDetector.detectForVideo(video, performance.now());
    detections.detections.forEach(det => {
      const cat = det.categories[0].categoryName;
      const box = det.boundingBox;
      const cx = (box.originX + box.width/2) / video.videoWidth;
      const cy = (box.originY + box.height/2) / video.videoHeight;
      
      // LOGICA DI FILTRO
      if(selectedTargets.length > 0){
        // MODALITÀ SELETTIVA: Accetta solo se è nella lista
        if(selectedTargets.includes(cat)){
          targetsFound.push({x: cx, y: cy, name: cat});
        }
      } else {
        // MODALITÀ AUTOMATICA: Accetta persone o oggetti grandi
        if(cat === 'person' || targetsFound.length === 0){ 
           // Se non abbiamo ancora trovato nulla (es. niente volti), prendiamo il primo oggetto
           // O se è una persona (priorità)
           targetsFound.push({x: cx, y: cy, name: cat}); 
        }
      }
    });
  }

  // DECISIONE
  if(targetsFound.length > 0){
    // Calcola il centro di TUTTI i target trovati (media geometrica)
    let avgX = 0, avgY = 0;
    targetsFound.forEach(t => { avgX += t.x; avgY += t.y; });
    avgX /= targetsFound.length;
    avgY /= targetsFound.length;
    
    // Usa il nome del primo per il feedback
    let nameDisplay = targetsFound[0].name;
    if(targetsFound.length > 1) nameDisplay = "Oggetti scelti";
    if(nameDisplay==='person') nameDisplay='Persona';
    
    handleCentering(avgX, avgY, nameDisplay, now);
    
  } else {
    // NIENTE TROVATO
    if(isCountdownRunning){
      cancelCountdown();
      announce("Perso il soggetto! Timer annullato.");
    } else if (now - lastGuideTime > 3000) {
      if(selectedTargets.length > 0) announce(`Non vedo: ${selectedTargets.join(', ')}`);
      else document.getElementById('local-ai-status').innerText = "Scena vuota";
    }
  }
}

function handleCentering(x, y, label, now){
  const distX = Math.abs(x - 0.5);
  const distY = Math.abs(y - 0.5);
  const isPerfect = (distX < 0.05 && distY < 0.05);
  const isSafe = (distX < 0.20 && distY < 0.20);
  const isWayOff = (distX > 0.30 || distY > 0.30);

  if(isCountdownRunning){
    if(isWayOff){ cancelCountdown(); announce("Spostata troppo! Fermo timer."); return; }
    return; // Continua a contare
  }

  if(isPerfect){
    announce(`Perfetto! ${label} centrato. Scatto in 3 secondi.`);
    startCountdown(3);
    return;
  }
  
  if(isSafe){
    announce(`${label} in posizione buona. Scatto in 3 secondi.`);
    startCountdown(3);
    return;
  }

  let hDir = x < 0.3 ? "Sinistra" : x > 0.7 ? "Destra" : ""; 
  let vDir = y < 0.3 ? "Su" : y > 0.7 ? "Giù" : "";
  
  if(hDir || vDir){
    announce(`${label}: Sposta a ${hDir} ${vDir}`);
    document.getElementById('local-ai-status').innerText = `${label}: ${hDir} ${vDir}`;
    lastGuideTime = now;
  }
}

// --- SCATTO E COUNTDOWN ---
function startCountdown(seconds){
  if(isCountdownRunning) return;
  isCountdownRunning = true;
  const overlay = document.getElementById('countdown-overlay');
  overlay.style.display = 'block';
  announce(seconds.toString());
  overlay.innerText = seconds;
  
  let count = seconds;
  for(let i=1; i<=seconds; i++){
    let id = setTimeout(() => {
      count--;
      if(count > 0){ overlay.innerText = count; announce(count.toString()); }
      else { overlay.style.display = 'none'; captureAndOpenMenu(); }
    }, i * 1000);
    countdownTimerIds.push(id);
  }
}

function cancelCountdown(){
  if(!isCountdownRunning) return;
  isCountdownRunning = false;
  document.getElementById('countdown-overlay').style.display = 'none';
  countdownTimerIds.forEach(id => clearTimeout(id));
  countdownTimerIds = [];
}

function captureAndOpenMenu(){
  isCountdownRunning = false; countdownTimerIds = [];
  const c = document.createElement('canvas'); c.width = video.videoWidth; c.height = video.videoHeight;
  c.getContext('2d').drawImage(video, 0, 0);
  currentPhotoBase64 = c.toDataURL('image/jpeg', 0.85); finalPhotoBase64 = currentPhotoBase64;
  document.getElementById('main-interface').classList.add('hidden');
  document.getElementById('context-menu').classList.remove('hidden');
  document.getElementById('context-menu').removeAttribute('aria-hidden');
  if(isGuiding) toggleSmartGuide();
  announce("Foto scattata!");
  if(lightActive) toggleLight();
}

// --- GEMINI (SOCIAL) ---
async function analyzeContext(context){
  if(!GEMINI_KEY){ announce("Manca chiave API."); return; }
  document.getElementById('context-menu').classList.add('hidden');
  document.getElementById('result-screen').classList.remove('hidden');
  document.getElementById('result-screen').removeAttribute('aria-hidden');
  announce("Analisi Gemini...");
  
  let prompt = "";
  if(context === 'social'){
    prompt = `Social Media Manager per non vedenti. 1. Formato (Story/Post)? 2. Tagli/Rischi? 3. Spazio testo libero (TOP_LEFT, MIDDLE, BOTTOM_RIGHT etc)? 4. Caption.`;
  } else if (context === 'selfie') prompt = "Analizza selfie: espressione, luce, sfondo.";
  else if (context === 'environment') prompt = "Descrivi ambiente e ostacoli.";
  else if (context === 'document') prompt = "Leggi tutto il testo.";
  else prompt = "Descrivi scena.";

  try {
    const base64Clean = currentPhotoBase64.split(',')[1];
    const response = await fetch(`https://generativelanguage.googleapis.com/${API_ENDPOINT}/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ contents: [{ parts: [{text: prompt}, {inline_data: {mime_type: 'image/jpeg', data: base64Clean}}] }] })
    });
    const data = await response.json();
    const text = data.candidates[0].content.parts[0].text;
    if(text.includes("TOP_")) textPositionSuggestion = "top";
    if(text.includes("BOTTOM_")) textPositionSuggestion = "bottom";
    if(text.includes("MIDDLE")) textPositionSuggestion = "middle";
    document.getElementById('result-text').innerHTML = text.replace(/\*\*/g, '').replace(/\n/g, '<br>');
    announce("Risultato pronto.");
  } catch(e) { document.getElementById('result-text').innerText = "Errore."; announce("Errore analisi."); }
}

// UTILS
function openTextEditor(){ document.getElementById('text-editor').style.display = 'block'; document.getElementById('caption-input').focus(); announce("Scrivi testo."); }
function closeTextEditor(){ document.getElementById('text-editor').style.display = 'none'; }
function applyTextToImage(){
  const txt = document.getElementById('caption-input').value; if(!txt)return;
  const img = new Image(); img.onload = () => {
    const c = document.createElement('canvas'); c.width = img.width; c.height = img.height; const ctx = c.getContext('2d');
    ctx.drawImage(img, 0, 0);
    const fs = c.width * 0.05; ctx.font = `bold ${fs}px Arial`; ctx.fillStyle = "white"; ctx.strokeStyle = "black"; ctx.lineWidth = fs/4; ctx.textAlign = "center";
    let x = c.width/2; let y = c.height - (fs*2);
    if(textPositionSuggestion.includes("top")) y = fs*2; if(textPositionSuggestion.includes("middle")) y = c.height/2;
    ctx.strokeText(txt, x, y); ctx.fillText(txt, x, y);
    finalPhotoBase64 = c.toDataURL('image/jpeg', 0.9); announce("Testo applicato."); closeTextEditor();
  }; img.src = currentPhotoBase64;
}
async function shareImageNative(){
  if(!finalPhotoBase64) return;
  const res = await fetch(finalPhotoBase64); const blob = await res.blob(); const file = new File([blob], "smart.jpg", {type: "image/jpeg"});
  if(navigator.share && navigator.canShare({files:[file]})){ try{ await navigator.share({files:[file],title:'SmartPhoto'}); }catch(e){} }
  else { const a = document.createElement('a'); a.href = finalPhotoBase64; a.download = "smart.jpg"; document.body.appendChild(a); a.click(); document.body.removeChild(a); announce("Scarico foto."); }
}
function discardPhoto(){ document.getElementById('context-menu').classList.add('hidden'); document.getElementById('result-screen').classList.add('hidden'); document.getElementById('main-interface').classList.remove('hidden'); currentPhotoBase64=null; announce("Foto eliminata."); }
function announce(msg){ document.getElementById('sr-announcer').textContent = msg; }
function openSettings(){ document.getElementById('key-screen').classList.remove('hidden'); }
function closeSettings(){ document.getElementById('key-screen').classList.add('hidden'); }
function saveKey(){ GEMINI_KEY = document.getElementById('key-input').value; localStorage.setItem('gemini_key', GEMINI_KEY); closeSettings(); announce("Salvato."); }

let recognition = null; let voiceActive = false;
function toggleVoiceControl(){
  voiceActive = !voiceActive; const btn = document.getElementById('btn-voice');
  if(voiceActive){
    btn.classList.add('active-tool'); document.getElementById('voice-status').style.display='block';
    if(!recognition){
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)(); recognition.lang = 'it-IT'; recognition.continuous = true;
      recognition.onresult = (e) => { const cmd = e.results[e.results.length-1][0].transcript.toLowerCase();
        if(cmd.includes('scatta')) startCountdown(5); else if(cmd.includes('guida')) toggleSmartGuide();
        else if(cmd.includes('luce')) toggleLight(); else if(cmd.includes('colore')) toggleColor();
      };
    } recognition.start(); announce("Vocale attivo.");
  }else{ if(recognition) recognition.stop(); btn.classList.remove('active-tool'); document.getElementById('voice-status').style.display='none'; announce("Vocale spento."); }
}
window.onload = init;
</script>
</body>
</html>