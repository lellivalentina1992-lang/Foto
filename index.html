<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Smart Photo Assistant - Fixed</title>
<style>
/* STILE BASE */
body{font-family:'Segoe UI',Roboto,Arial,sans-serif;margin:0;padding:0;background:#000;color:#fff;height:100vh;display:flex;flex-direction:column;overflow:hidden}
.sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)}

/* AREA CAMERA */
#cam-container{position:relative;flex-grow:1;background:#111;display:flex;justify-content:center;align-items:center}
video{width:100%;height:100%;object-fit:cover;opacity:.8}
canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}

/* STATUS E COUNTDOWN */
#voice-status{position:absolute;top:10px;right:10px;padding:8px 12px;border-radius:20px;background:rgba(0,0,0,0.8);border:1px solid #777;font-size:0.9rem;z-index:60;display:none}
.listening{border-color:#0f0!important;color:#0f0!important}
#countdown-overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:8rem;color:#fff;font-weight:bold;text-shadow:0 0 15px #000;z-index:70;display:none}

/* INTERFACCIA PRINCIPALE */
#main-interface{height:60vh;width:100%;background:#000;border-top:2px solid #333;display:flex;flex-direction:column}
#camera-controls{flex-grow:1;display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:min-content;gap:10px;padding:10px;overflow-y:auto}

/* AREA SELEZIONE OGGETTI */
#selection-panel{grid-column:1/-1;background:#111;border:1px solid #444;border-radius:8px;padding:10px;display:none;flex-direction:column;gap:5px}
#detected-list{display:flex;flex-wrap:wrap;gap:5px;max-height:100px;overflow-y:auto}
.obj-btn{padding:8px 12px;border:1px solid #555;background:#222;color:#fff;border-radius:20px;font-size:0.9rem}
.obj-btn.selected{background:#006400;border-color:#0f0;color:#0f0}

/* PULSANTI */
button{border:2px solid #555;border-radius:12px;font-size:1rem;font-weight:bold;text-transform:uppercase;color:#fff;background:#222;min-height:60px;touch-action:manipulation}
button:active{background:#555;transform:scale(.98)}
.full-width{grid-column:1/-1}
.btn-primary{background:#004080;border-color:#4a90e2}
.btn-action{background:#006400;border-color:#0f0;color:#0f0}
.btn-download{background:#4B0082;border-color:#9370DB;color:#fff}
.btn-guide{background:#8B0000;border-color:#f00;font-size:1.1rem}
.active-tool{background:#DAA520!important;border-color:#FFD700!important;color:#000!important}

/* MENU CONTESTO */
#context-menu{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;z-index:80;padding:15px;display:flex;flex-direction:column;gap:10px;overflow-y:auto}
.context-title{font-size:1.2rem;color:#D4AF37;text-align:center;margin-bottom:10px}
.btn-share-now{background:#2F4F4F!important;border-color:#00CED1!important;color:#fff!important;min-height:60px;font-size:1.1rem}

/* SCHERMATA RISULTATO */
#result-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:#111;z-index:90;display:flex;flex-direction:column;padding:15px}
#result-text{flex-grow:1;background:#000;border:1px solid #555;padding:15px;overflow-y:auto;font-size:1.2rem;line-height:1.5;white-space:pre-wrap;margin-bottom:10px}

/* EDITOR TESTO */
#text-editor{position:absolute;bottom:0;left:0;width:100%;background:#222;padding:15px;z-index:100;border-top:2px solid #D4AF37;display:none}
#caption-input{width:100%;padding:15px;font-size:1.2rem;margin-bottom:10px}

/* SETTINGS */
.overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:200;display:flex;flex-direction:column;justify-content:center;align-items:center}
.hidden{display:none!important}
</style>
</head>
<body>

<div id="sr-announcer" class="sr-only" aria-live="assertive" role="status"></div>

<div id="cam-container">
  <video id="webcam" playsinline muted autoplay></video>
  <canvas id="overlay"></canvas>
  <div id="voice-status">Ascolto...</div>
  <div id="countdown-overlay"></div>
</div>

<div id="main-interface">
  <div id="camera-controls">
    <button class="full-width" id="btn-select-mode" onclick="toggleSelectionMode()" style="background:#333;border-color:#777">
      SELEZIONA COSA FOTOGRAFARE
    </button>
    <div id="selection-panel">
      <div style="font-size:0.9rem;color:#ccc;margin-bottom:5px">Oggetti visibili (clicca per selezionare):</div>
      <div id="detected-list">In attesa...</div>
      <button onclick="confirmSelection()" class="full-width btn-action" style="min-height:40px;margin-top:5px">CONFERMA E CHIUDI</button>
    </div>
    <button class="full-width btn-guide" id="btn-guide" onclick="toggleSmartGuide()">
      AVVIA GUIDA AUTO-SCATTO
    </button>
    <div id="local-ai-status" class="full-width" style="text-align:center;padding:10px;background:#222;border:1px solid #444;border-radius:8px;color:#ccc" aria-live="polite">
      In attesa...
    </div>
    <button onclick="toggleLight()" id="btn-light">SONDA LUCE</button>
    <button onclick="toggleColor()" id="btn-color">COLORE</button>
    <button class="full-width btn-action" onclick="startCountdown(5)">SCATTA MANUALE (5 SEC)</button>
    <button onclick="flipCamera()">RUOTA CAMERA</button>
    <button onclick="toggleVoiceControl()" id="btn-voice">COMANDI VOCALI</button>
    <button class="full-width" onclick="openSettings()" style="min-height:50px;font-size:0.9rem;background:#333">IMPOSTAZIONI API</button>
  </div>
</div>

<div id="context-menu" class="hidden" aria-hidden="true" role="dialog" aria-label="Menu foto acquisita">
  <h2 class="context-title">Foto Acquisita</h2>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px">
    <button class="btn-share-now" onclick="shareImageNative()">CONDIVIDI</button>
    <button class="btn-download" onclick="downloadImage()">SCARICA</button>
  </div>
  <div style="height:1px;background:#555;margin:5px 0"></div>
  <p style="text-align:center;color:#ccc;margin:5px">Scegli Analisi:</p>
  <button class="btn-primary" onclick="analyzeContext('selfie')">SELFIE / RITRATTO</button>
  <button class="btn-primary" onclick="analyzeContext('group')">GRUPPO</button>
  <button class="btn-primary" onclick="analyzeContext('environment')">AMBIENTE</button>
  <button class="btn-primary" onclick="analyzeContext('document')">LEGGI TESTO</button>
  <button style="background:#E1306C;border-color:#fff;margin-top:10px" class="full-width" onclick="analyzeContext('social')">ANALISI TECNICA SOCIAL</button>
  <div style="height:1px;background:#555;margin:10px 0"></div>
  <button onclick="discardPhoto()" style="background:#8B0000;margin-top:5px">ELIMINA E TORNA</button>
</div>

<div id="result-screen" class="hidden" aria-hidden="true" role="dialog" aria-label="Risultato analisi">
  <h2 style="color:#D4AF37;text-align:center;margin:0 0 10px 0">Risultato</h2>
  <div id="result-text" tabindex="0">Elaborazione...</div>
  
  <button onclick="analyzeContext('social')" class="full-width" style="background:#E1306C;margin-bottom:10px">VERIFICA IDONEITÀ SOCIAL</button>

  <div id="after-analysis-buttons">
    
    <button onclick="openTextEditor()" class="full-width btn-primary" style="background:#006400;border-color:#0f0;min-height:50px;margin-bottom:15px">AGGIUNGI TESTO (IA POSIZIONA)</button>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <button onclick="shareImageNative()" class="btn-action">CONDIVIDI</button>
        <button onclick="downloadImage()" class="btn-download">SCARICA</button>
        <button onclick="discardPhoto()" class="full-width" style="background:#8B0000;grid-column:1/-1">ELIMINA</button>
    </div>
  </div>
</div>

<div id="text-editor" role="dialog" aria-label="Editor testo immagine">
  <h3 style="color:#fff;margin-top:0">Scrivi Testo</h3>
  <input type="text" id="caption-input" placeholder="Il tuo messaggio..." style="color:black" aria-label="Testo da aggiungere all'immagine">
  <div style="display:flex;gap:10px">
    <button onclick="applyTextToImage()" class="btn-action" style="flex:1">CONFERMA</button>
    <button onclick="closeTextEditor()" style="flex:1">ANNULLA</button>
  </div>
</div>

<div id="key-screen" class="overlay hidden" role="dialog" aria-label="Impostazioni chiave API">
  <h2>Chiave Gemini API</h2>
  <input type="text" id="key-input" style="width:80%;padding:15px;margin-bottom:20px;color:#000" aria-label="Inserisci chiave API Gemini">
  <button onclick="saveKey()" style="padding:20px;width:80%">SALVA</button>
  <button onclick="closeSettings()" style="margin-top:10px;padding:20px;width:80%;background:#333">CHIUDI</button>
</div>

<script>
let GEMINI_KEY = localStorage.getItem('gemini_key') || "";
const MODEL_NAME = "gemini-2.0-flash-exp"; 
const API_ENDPOINT = "v1beta";

// COSTANTI CENTERING
const CENTERING_PERFECT_THRESHOLD = 0.05;
const CENTERING_SAFE_THRESHOLD = 0.20;
const CENTERING_WAYOFF_THRESHOLD = 0.30;

// VARIABILI GLOBALI
let video = document.getElementById('webcam');
let canvas = document.getElementById('overlay');
let ctx = canvas.getContext('2d');
let tempCanvas = document.createElement('canvas');
let tempCtx = tempCanvas.getContext('2d');
let stream = null;
let currentPhotoBase64 = null;
let finalPhotoBase64 = null;

// FRONT/BACK CAMERA
let currentFacingMode = 'environment';

// IA CONFIG PER TESTO
let aiTextConfig = { pos: "bottom", color: "white", bg: "box" };

// TOOLS
let audioCtx, lightOsc, lightGain;
let lightActive = false, colorActive = false;
let objectDetector = null;
let faceLandmarker = null;
let isGuiding = false;
let isSelectionMode = false;
let guideInterval = null;
let lastGuideTime = 0;
let isCountdownRunning = false;
let countdownTimerIds = [];
let selectedTargets = []; 
let availableObjects = []; 

// Speech recognition support check
const SpeechRecognitionClass = window.SpeechRecognition || window.webkitSpeechRecognition || null;

async function init(){
  // Inizializza AudioContext solo dopo interazione utente (best practice)
  document.body.addEventListener('click', initAudioContext, {once: true});
  document.body.addEventListener('touchstart', initAudioContext, {once: true});

  await setupCamera();
  await loadLocalModels();
  
  // Setup keyboard navigation per modali
  setupModalKeyboardHandlers();
  
  announce("App pronta. Usa 'Seleziona cosa fotografare' oppure 'Avvia Guida Auto-Scatto'.");
  loopTools();
}

function initAudioContext(){
  try{
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    if(audioCtx.state === 'suspended'){
      audioCtx.resume();
    }
  }catch(e){
    console.warn("AudioContext non disponibile:", e);
  }
}

async function setupCamera(){
  try{
    // Stop eventuale vecchio stream (utile su flip camera)
    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }

    stream = await navigator.mediaDevices.getUserMedia({
      video:{
        facingMode: currentFacingMode,
        width:{ideal:1280},
        height:{ideal:720}
      }
    });

    video.srcObject = stream;

    // FIX: Race condition su metadata
    await new Promise((resolve) => {
      if(video.readyState >= 2){
        resolve();
      } else {
        const handler = () => {
          video.removeEventListener('loadedmetadata', handler);
          resolve();
        };
        video.addEventListener('loadedmetadata', handler);
      }
    });

    // Assicura il play
    try{
      await video.play();
    }catch(e){
      // Autoplay bloccato - l'utente dovrà interagire
      console.warn("Autoplay bloccato, richiede interazione utente");
    }

    canvas.width = video.videoWidth; 
    canvas.height = video.videoHeight;
    tempCanvas.width = video.videoWidth; 
    tempCanvas.height = video.videoHeight;
  }catch(e){
    announce("Errore fotocamera. Controlla permessi o HTTPS.");
    document.getElementById('local-ai-status').innerText = "Errore fotocamera.";
    console.error("Camera error:", e);
  }
}

async function flipCamera(){
  currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
  announce(currentFacingMode === 'environment' ? "Uso camera posteriore." : "Uso camera frontale.");
  await setupCamera();
}

async function loadLocalModels(){
  try{
    document.getElementById('local-ai-status').innerText = "Carico AI locale...";
    const { ObjectDetector, FaceLandmarker, FilesetResolver } = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js");
    const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
    objectDetector = await ObjectDetector.createFromOptions(vision, { 
      baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite" }, 
      scoreThreshold: 0.4, 
      runningMode: "VIDEO" 
    });
    faceLandmarker = await FaceLandmarker.createFromOptions(vision, { 
      baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task" }, 
      runningMode: "VIDEO", 
      numFaces: 1 
    });
    document.getElementById('local-ai-status').innerText = "AI locale pronta.";
  }catch(e){
    announce("AI Locale non disponibile.");
    document.getElementById('local-ai-status').innerText = "AI locale non disponibile.";
    console.error("Model loading error:", e);
  }
}

function loopTools(){
  if(video.readyState===4){
    tempCtx.drawImage(video,0,0,tempCanvas.width,tempCanvas.height);
    if(lightActive) processLight();
  }
  requestAnimationFrame(loopTools);
}

function toggleLight(){
  lightActive=!lightActive;
  document.getElementById('btn-light').classList.toggle('active-tool');
  announce(lightActive?"Luce ON":"Luce OFF");
  
  if(lightActive){
    // FIX: Verifica AudioContext prima di usarlo
    if(!audioCtx || audioCtx.state === 'suspended'){
      announce("Audio non disponibile. Interagisci prima con la pagina.");
      lightActive = false;
      document.getElementById('btn-light').classList.remove('active-tool');
      return;
    }
    
    if(!lightOsc){
      lightOsc=audioCtx.createOscillator();
      lightGain=audioCtx.createGain();
      lightOsc.connect(lightGain);
      lightGain.connect(audioCtx.destination);
      lightOsc.start();
      lightGain.gain.value=0;
    }
  }
  
  if(!lightActive && lightGain) lightGain.gain.value=0;
}

function processLight(){
  const d=tempCtx.getImageData(0,0,tempCanvas.width,tempCanvas.height).data;
  let s=0;
  for(let i=0;i<d.length;i+=4)s+=(d[i]+d[i+1]+d[i+2])/3;
  const b=s/(d.length/4);
  if(lightOsc) lightOsc.frequency.value=200+b*2;
  if(lightGain) lightGain.gain.value=0.1;
}

function toggleColor(){
  colorActive=!colorActive;
  document.getElementById('btn-color').classList.toggle('active-tool');
  announce(colorActive?"Colore ON":"Colore OFF");
  if(colorActive) processColor();
}

function processColor(){
  const w=tempCanvas.width,h=tempCanvas.height;
  const d=tempCtx.getImageData(w/2-10,h/2-10,20,20).data;
  let r=0,g=0,b=0,c=0;
  for(let i=0;i<d.length;i+=4){r+=d[i];g+=d[i+1];b+=d[i+2];c++;}
  r=Math.round(r/c);g=Math.round(g/c);b=Math.round(b/c);
  announce(`Colore: ${
    r>200&&g>200&&b>200?'Bianco':
    r<50&&g<50&&b<50?'Nero':
    r>150&&g<100?'Rosso':
    g>150&&r<100?'Verde':
    b>150?'Blu':'Misto'
  }`);
}

// --- SELEZIONE ---
function toggleSelectionMode(){
  isSelectionMode = !isSelectionMode;
  const panel = document.getElementById('selection-panel');
  const btn = document.getElementById('btn-select-mode');
  if(isSelectionMode){
    if(isGuiding) toggleSmartGuide();
    panel.style.display = 'flex';
    btn.classList.add('active-tool');
    btn.textContent = "CHIUDI SELEZIONE";
    announce("Modalità selezione. Esploro la scena...");
    selectedTargets = []; 
    updateSelectionUI();
    
    // FIX: Clear previous interval
    if(guideInterval) clearInterval(guideInterval);
    guideInterval = setInterval(scanForSelection, 1000);
  } else {
    panel.style.display = 'none';
    btn.classList.remove('active-tool');
    btn.textContent = "SELEZIONA COSA FOTOGRAFARE";
    if(guideInterval) clearInterval(guideInterval);
    guideInterval = null;
    announce("Selezione chiusa.");
  }
}

async function scanForSelection(){
  if(video.readyState !== 4 || !objectDetector) return;
  try{
    const detections = objectDetector.detectForVideo(video, performance.now());
    const currentSet = new Set();
    detections.detections.forEach(d => currentSet.add(d.categories[0].categoryName));
    availableObjects = Array.from(currentSet);
    updateSelectionUI();
  }catch(e){
    console.error("Detection error:", e);
  }
}

function updateSelectionUI(){
  const list = document.getElementById('detected-list');
  list.innerHTML = '';
  if(availableObjects.length === 0){
    list.innerHTML = '<span style="color:#777">Nessun oggetto rilevato...</span>';
    return;
  }
  availableObjects.forEach(objName => {
    let display = objName;
    if(objName==='person') display='Persona';
    else if(objName==='cup') display='Tazza';
    else if(objName==='bottle') display='Bottiglia';
    else display = objName;
    
    const btn = document.createElement('button');
    btn.className = 'obj-btn';
    btn.setAttribute('aria-pressed', selectedTargets.includes(objName) ? 'true' : 'false');
    if(selectedTargets.includes(objName)) btn.classList.add('selected');
    btn.textContent = display + (selectedTargets.includes(objName) ? " (SCELTO)" : "");
    btn.onclick = () => {
      if(selectedTargets.includes(objName)){
        selectedTargets = selectedTargets.filter(t => t !== objName);
        announce(`Rimosso ${display}`);
      } else {
        selectedTargets.push(objName);
        announce(`Selezionato ${display}`);
      }
      updateSelectionUI();
    };
    list.appendChild(btn);
  });
}

function confirmSelection(){
  toggleSelectionMode(); 
  if(selectedTargets.length > 0){
    announce(`Hai scelto: ${selectedTargets.length} oggetti. Premi Avvia Guida.`);
    document.getElementById('btn-guide').textContent = "AVVIA GUIDA (SELEZIONE ATTIVA)";
  } else {
    announce("Nessuna selezione. Userò modalità automatica.");
    document.getElementById('btn-guide').textContent = "AVVIA GUIDA AUTO-SCATTO";
  }
}

// --- GUIDA ---
function toggleSmartGuide(){
  isGuiding = !isGuiding;
  const btn = document.getElementById('btn-guide');
  if(isGuiding){
    if(isSelectionMode) toggleSelectionMode();
    btn.textContent = "STOP GUIDA"; 
    btn.style.background = "#006400";
    let msg = "Guida Automatica Attiva.";
    if(selectedTargets.length > 0) msg = "Guida Selettiva Attiva. Cerco i tuoi oggetti.";
    announce(msg);
    isCountdownRunning = false;
    
    // FIX: Clear previous interval
    if(guideInterval) clearInterval(guideInterval);
    guideInterval = setInterval(processLocalFrame, 200);
  }else{
    btn.textContent = selectedTargets.length > 0 ? "AVVIA GUIDA (SELEZIONE ATTIVA)" : "AVVIA GUIDA AUTO-SCATTO";
    btn.style.background = "#8B0000";
    if(guideInterval) clearInterval(guideInterval);
    guideInterval = null;
    cancelCountdown();
    announce("Guida fermata.");
  }
}

async function processLocalFrame(){
  if(video.readyState !== 4) return;
  const now = Date.now();
  if(!isCountdownRunning && now - lastGuideTime < 1800) return; 

  let targetsFound = [];
  
  // Face detection
  if(faceLandmarker){
    try{
      const faces = faceLandmarker.detectForVideo(video, performance.now());
      if(faces.faceLandmarks && faces.faceLandmarks.length > 0){
        if(selectedTargets.length === 0 || selectedTargets.includes('person')){
           let points = faces.faceLandmarks[0];
           let cx=0, cy=0;
           points.forEach(p => { cx += p.x; cy += p.y; });
           targetsFound.push({x: cx/points.length, y: cy/points.length, name: "Volto"});
        }
      }
    }catch(e){
      console.error("Face detection error:", e);
    }
  }

  // Object detection
  if(objectDetector){
    try{
      const detections = objectDetector.detectForVideo(video, performance.now());
      detections.detections.forEach(det => {
        const cat = det.categories[0].categoryName;
        const box = det.boundingBox;
        const cx = (box.originX + box.width/2) / video.videoWidth;
        const cy = (box.originY + box.height/2) / video.videoHeight;
        if(selectedTargets.length > 0){
          if(selectedTargets.includes(cat)) targetsFound.push({x: cx, y: cy, name: cat});
        } else {
          if(cat === 'person' || targetsFound.length === 0) targetsFound.push({x: cx, y: cy, name: cat}); 
        }
      });
    }catch(e){
      console.error("Object detection error:", e);
    }
  }

  if(targetsFound.length > 0){
    let avgX = 0, avgY = 0;
    targetsFound.forEach(t => { avgX += t.x; avgY += t.y; });
    avgX /= targetsFound.length;
    avgY /= targetsFound.length;
    let nameDisplay = targetsFound[0].name;
    if(targetsFound.length > 1) nameDisplay = "Oggetti scelti";
    if(nameDisplay==='person') nameDisplay='Persona';
    handleCentering(avgX, avgY, nameDisplay, now);
  } else {
    if(isCountdownRunning){
      cancelCountdown();
      announce("Perso il soggetto! Timer annullato.");
    } else if (now - lastGuideTime > 3000) {
      if(selectedTargets.length > 0) announce(`Non vedo: ${selectedTargets.join(', ')}`);
      else document.getElementById('local-ai-status').innerText = "Scena vuota";
    }
  }
}

function handleCentering(x, y, label, now){
  const distX = Math.abs(x - 0.5);
  const distY = Math.abs(y - 0.5);
  const isPerfect = (distX < CENTERING_PERFECT_THRESHOLD && distY < CENTERING_PERFECT_THRESHOLD);
  const isSafe = (distX < CENTERING_SAFE_THRESHOLD && distY < CENTERING_SAFE_THRESHOLD);
  const isWayOff = (distX > CENTERING_WAYOFF_THRESHOLD || distY > CENTERING_WAYOFF_THRESHOLD);
  
  if(isCountdownRunning){
    if(isWayOff){ cancelCountdown(); announce("Spostata troppo! Fermo timer."); return; }
    return; 
  }
  if(isPerfect){ announce(`Perfetto! ${label} centrato. Scatto in 3 secondi.`); startCountdown(3); return; }
  if(isSafe){ announce(`${label} in posizione buona. Scatto in 3 secondi.`); startCountdown(3); return; }
  
  let hDir = x < 0.3 ? "Sinistra" : x > 0.7 ? "Destra" : ""; 
  let vDir = y < 0.3 ? "Su" : y > 0.7 ? "Giù" : "";
  if(hDir || vDir){
    announce(`${label}: Sposta a ${hDir} ${vDir}`);
    document.getElementById('local-ai-status').innerText = `${label}: ${hDir} ${vDir}`;
    lastGuideTime = now;
  }
}

// --- SCATTO ---
function startCountdown(seconds){
  if(isCountdownRunning) return;
  isCountdownRunning = true;
  const overlay = document.getElementById('countdown-overlay');
  overlay.style.display = 'block';
  overlay.setAttribute('aria-live', 'assertive');
  announce(seconds.toString());
  overlay.innerText = seconds;
  let count = seconds;
  
  // FIX: Clear previous timers
  countdownTimerIds.forEach(id => clearTimeout(id));
  countdownTimerIds = [];
  
  for(let i=1; i<=seconds; i++){
    const id = setTimeout(() => {
      count--;
      if(count > 0){ 
        overlay.innerText = count; 
        announce(count.toString()); 
      } else { 
        overlay.style.display = 'none'; 
        captureAndOpenMenu(); 
      }
    }, i * 1000);
    countdownTimerIds.push(id);
  }
}

function cancelCountdown(){
  if(!isCountdownRunning) return;
  isCountdownRunning = false;
  document.getElementById('countdown-overlay').style.display = 'none';
  countdownTimerIds.forEach(id => clearTimeout(id));
  countdownTimerIds = [];
}

function captureAndOpenMenu(){
  isCountdownRunning = false; 
  countdownTimerIds = [];
  const c = document.createElement('canvas'); 
  c.width = video.videoWidth; 
  c.height = video.videoHeight;
  c.getContext('2d').drawImage(video, 0, 0);
  currentPhotoBase64 = c.toDataURL('image/jpeg', 0.85); 
  finalPhotoBase64 = currentPhotoBase64;
  document.getElementById('main-interface').classList.add('hidden');
  document.getElementById('context-menu').classList.remove('hidden');
  document.getElementById('context-menu').removeAttribute('aria-hidden');
  if(isGuiding) toggleSmartGuide();
  announce("Foto scattata! Scegli azione. Premi Escape per tornare indietro.");
  if(lightActive) toggleLight();
  
  // Focus primo pulsante
  setTimeout(() => {
    const firstBtn = document.querySelector('#context-menu button');
    if(firstBtn) firstBtn.focus();
  }, 100);
}

// --- GEMINI (ANALISI + LAYOUT) ---
async function analyzeContext(context){
  if(!GEMINI_KEY){ 
    announce("Manca chiave API. Apri Impostazioni API."); 
    return; 
  }
  if(!currentPhotoBase64){
    announce("Nessuna foto da analizzare.");
    return;
  }

  document.getElementById('context-menu').classList.add('hidden');
  document.getElementById('result-screen').classList.remove('hidden');
  document.getElementById('result-screen').removeAttribute('aria-hidden');
  document.getElementById('result-text').textContent = "Gemini sta elaborando...";
  announce("Gemini elabora...");
  
  const layoutPrompt = `
  ALLA FINE DELLA RISPOSTA, aggiungi una riga speciale con questo formato ESATTO per dirmi come scrivere un testo sull'immagine in modo leggibile ed estetico:
  ###LAYOUT:POS|COLORE|SFONDO###
  Dove:
  POS = TOP (alto), MIDDLE (centro) o BOTTOM (basso). Scegli dove c'è spazio vuoto.
  COLORE = WHITE (testo bianco) o BLACK (testo nero).
  SFONDO = BOX (rettangolo semitrasparente se lo sfondo è caotico), SHADOW (solo ombra se uniforme), NONE (nessuno).
  Esempio: ###LAYOUT:TOP|BLACK|NONE###
  `;

  let prompt = "";
  if(context === 'social'){
    prompt = `Agisci come consulente tecnico. Analizza l'immagine per idoneità social. 1. Inquadratura. 2. Qualità. 3. Sfondo. ` + layoutPrompt;
  } else if (context === 'selfie') prompt = "Analizza selfie. Espressione, occhi, luce, estetica." + layoutPrompt;
  else if (context === 'group') prompt = "Analizza gruppo. Chiusi gli occhi? Tutti visibili?" + layoutPrompt;
  else if (context === 'environment') prompt = "Descrivi ambiente e ostacoli." + layoutPrompt;
  else if (context === 'document') prompt = "Estrai e trascrivi tutto il testo visibile." + layoutPrompt;
  else prompt = "Descrivi immagine." + layoutPrompt;

  try {
    const base64Clean = currentPhotoBase64.split(',')[1];
    const response = await fetch(`https://generativelanguage.googleapis.com/${API_ENDPOINT}/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ 
        contents: [{ 
          parts: [
            {text: prompt}, 
            {inline_data: {mime_type: 'image/jpeg', data: base64Clean}}
          ] 
        }] 
      })
    });
    
    if(!response.ok){
      throw new Error(`API error: ${response.status}`);
    }
    
    const data = await response.json();
    if(!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts){
      document.getElementById('result-text').textContent = "Risposta Gemini non valida.";
      announce("Errore analisi.");
      return;
    }

    let text = data.candidates[0].content.parts.map(p => p.text || "").join("\n");
    
    // Extract layout config
    if(text.includes("###LAYOUT:")){
      const extract = text.split("###LAYOUT:")[1].split("###")[0];
      const parts = extract.split("|");
      if(parts.length === 3){
        aiTextConfig.pos = parts[0].toLowerCase();
        aiTextConfig.color = parts[1].toLowerCase();
        aiTextConfig.bg = parts[2].toLowerCase();
      }
      text = text.split("###LAYOUT:")[0];
    }
    
    // FIX: Sanitizzazione XSS - rimuovi markup markdown e converti newline
    const sanitized = text
      .replace(/\*\*/g, '')
      .replace(/[<>]/g, '') // rimuove < e >
      .split('\n')
      .map(line => line.trim())
      .filter(line => line.length > 0)
      .join('<br><br>');
    
    const resultEl = document.getElementById('result-text');
    resultEl.textContent = ''; // clear first
    resultEl.innerHTML = sanitized;
    
    announce("Analisi completata. Puoi aggiungere testo, condividere, scaricare o eliminare. Premi Escape per tornare.");
    
    // Focus risultato
    setTimeout(() => resultEl.focus(), 100);
    
  } catch(e) { 
    document.getElementById('result-text').textContent = "Errore connessione Gemini: " + e.message; 
    announce("Errore analisi."); 
    console.error("Gemini error:", e);
  }
}

function downloadImage(){
  if(!finalPhotoBase64 && !currentPhotoBase64) return;
  const link = document.createElement('a');
  link.href = finalPhotoBase64 || currentPhotoBase64;
  const date = new Date();
  const hh = String(date.getHours()).padStart(2,"0");
  const mm = String(date.getMinutes()).padStart(2,"0");
  const ss = String(date.getSeconds()).padStart(2,"0");
  const timestamp = `${hh}${mm}${ss}`;
  link.download = `smart_foto_${timestamp}.jpg`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  announce("File scaricato.");
}

async function shareImageNative(){
  if(!finalPhotoBase64 && !currentPhotoBase64) return;
  const imgToUse = finalPhotoBase64 || currentPhotoBase64;
  
  try{
    const res = await fetch(imgToUse); 
    const blob = await res.blob(); 
    const file = new File([blob], "smart_foto.jpg", {type: "image/jpeg"});
    
    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){ 
      await navigator.share({files:[file], title:'Smart Photo'});
      announce("Immagine condivisa.");
    } else {
      announce("Condivisione non supportata, uso scarica.");
      downloadImage();
    }
  }catch(e){
    if(e.name !== 'AbortError'){ // L'utente ha annullato
      console.error("Share error:", e);
      announce("Errore condivisione, uso scarica.");
      downloadImage();
    }
  }
}

// UTILS TESTO
function openTextEditor(){
  document.getElementById('text-editor').style.display = 'block'; 
  setTimeout(() => {
    document.getElementById('caption-input').focus();
  }, 100);
  announce("Scrivi il testo da aggiungere. Premi Invio per confermare o Escape per annullare.");
}

function closeTextEditor(){ 
  document.getElementById('text-editor').style.display = 'none'; 
  announce("Editor chiuso.");
}

function applyTextToImage(){
  const txt = document.getElementById('caption-input').value.trim(); 
  if(!txt){
    announce("Nessun testo inserito.");
    return;
  }
  
  const img = new Image(); 
  img.onload = () => {
    const c = document.createElement('canvas'); 
    c.width = img.width; 
    c.height = img.height; 
    const ctx = c.getContext('2d');
    ctx.drawImage(img, 0, 0);
    
    const fontSize = c.width * 0.06; 
    ctx.font = `bold ${fontSize}px Arial`; 
    ctx.textAlign = "center";
    
    let x = c.width/2; 
    let y = c.height - (fontSize*2); 
    if(aiTextConfig.pos === "top") y = fontSize * 2.5;
    if(aiTextConfig.pos === "middle") y = c.height/2;

    const textWidth = ctx.measureText(txt).width;
    const padding = 20;

    if(aiTextConfig.bg === "box"){
      if(aiTextConfig.color === "white") ctx.fillStyle = "rgba(0,0,0,0.6)";
      else ctx.fillStyle = "rgba(255,255,255,0.7)";
      ctx.fillRect(x - textWidth/2 - padding/2, y - fontSize, textWidth + padding, fontSize * 1.4);
    } else if (aiTextConfig.bg === "shadow"){
      ctx.shadowColor = "rgba(0,0,0,0.8)"; 
      ctx.shadowBlur = 15;
    }

    ctx.fillStyle = aiTextConfig.color === "white" ? "#fff" : "#000"; 
    ctx.fillText(txt, x, y); 
    ctx.shadowBlur = 0;
    
    finalPhotoBase64 = c.toDataURL('image/jpeg', 0.9); 
    announce("Testo applicato. Ora puoi Condividere, Scaricare o Eliminare."); 
    closeTextEditor();
  }; 
  img.onerror = () => {
    announce("Errore caricamento immagine.");
  };
  img.src = currentPhotoBase64;
}

function discardPhoto(){ 
  document.getElementById('context-menu').classList.add('hidden'); 
  document.getElementById('result-screen').classList.add('hidden'); 
  document.getElementById('main-interface').classList.remove('hidden'); 
  closeTextEditor(); // FIX: Chiudi editor se aperto
  currentPhotoBase64=null; 
  finalPhotoBase64=null;
  announce("Foto eliminata."); 
}

function announce(msg){ 
  const announcer = document.getElementById('sr-announcer');
  announcer.textContent = ''; // Clear first per forzare ri-lettura
  setTimeout(() => {
    announcer.textContent = msg;
  }, 100);
}

function openSettings(){ 
  document.getElementById('key-screen').classList.remove('hidden'); 
  setTimeout(() => {
    document.getElementById('key-input').focus();
  }, 100);
}

function closeSettings(){ 
  document.getElementById('key-screen').classList.add('hidden'); 
}

function saveKey(){ 
  GEMINI_KEY = document.getElementById('key-input').value.trim(); 
  localStorage.setItem('gemini_key', GEMINI_KEY); 
  closeSettings(); 
  announce("Chiave salvata."); 
}

// --- COMANDI VOCALI ---
let recognition = null; 
let voiceActive = false;

function toggleVoiceControl(){
  if(!SpeechRecognitionClass){
    announce("Comandi vocali non supportati su questo dispositivo.");
    return;
  }

  voiceActive = !voiceActive; 
  const btn = document.getElementById('btn-voice');
  const voiceStatus = document.getElementById('voice-status');

  if(voiceActive){
    btn.classList.add('active-tool'); 
    voiceStatus.style.display='block';
    
    if(!recognition){
      recognition = new SpeechRecognitionClass(); 
      recognition.lang = 'it-IT'; 
      recognition.continuous = true;
      recognition.interimResults = false;
      
      recognition.onresult = (e) => { 
        const cmd = e.results[e.results.length-1][0].transcript.toLowerCase();
        announce(`Comando: ${cmd}`);
        
        if(cmd.includes('scatta')) startCountdown(5); 
        else if(cmd.includes('guida')) toggleSmartGuide();
        else if(cmd.includes('luce')) toggleLight(); 
        else if(cmd.includes('colore')) toggleColor();
        else announce("Comando non riconosciuto. Dì: scatta, guida, luce o colore.");
      };
      
      // FIX: Gestione errori migliorata
      recognition.onerror = (e) => {
        if(e.error === 'no-speech'){
          return; // Ignora silenzi
        }
        if(e.error === 'aborted'){
          return; // Ignora aborted (succede quando si ferma)
        }
        
        console.error("Speech recognition error:", e.error);
        announce(`Errore comandi vocali: ${e.error}. Disattivo.`);
        voiceActive = false;
        btn.classList.remove('active-tool'); 
        voiceStatus.style.display='none';
        try{recognition.stop();}catch(err){}
      };
      
      recognition.onend = () => {
        // Se ancora attivo, riavvia (continuous può interrompersi)
        if(voiceActive){
          try{
            recognition.start();
          }catch(e){
            console.error("Restart error:", e);
          }
        }
      };
    }
    
    try{
      recognition.start(); 
      announce("Vocale attivo. Dì: scatta, guida, luce o colore.");
    }catch(e){
      console.error("Start recognition error:", e);
      announce("Impossibile avviare i comandi vocali.");
      voiceActive = false;
      btn.classList.remove('active-tool'); 
      voiceStatus.style.display='none';
    }
  }else{ 
    if(recognition){
      try{ 
        recognition.stop(); 
      }catch(e){
        console.error("Stop recognition error:", e);
      }
    }
    btn.classList.remove('active-tool'); 
    voiceStatus.style.display='none'; 
    announce("Vocale spento."); 
  }
}

// --- KEYBOARD NAVIGATION ---
function setupModalKeyboardHandlers(){
  // Context menu
  document.getElementById('context-menu').addEventListener('keydown', (e) => {
    if(e.key === 'Escape'){
      discardPhoto();
    }
  });
  
  // Result screen
  document.getElementById('result-screen').addEventListener('keydown', (e) => {
    if(e.key === 'Escape'){
      discardPhoto();
    }
  });
  
  // Text editor
  document.getElementById('text-editor').addEventListener('keydown', (e) => {
    if(e.key === 'Escape'){
      closeTextEditor();
    }
    if(e.key === 'Enter' && e.target.id === 'caption-input'){
      applyTextToImage();
    }
  });
  
  // Settings
  document.getElementById('key-screen').addEventListener('keydown', (e) => {
    if(e.key === 'Escape'){
      closeSettings();
    }
    if(e.key === 'Enter' && e.target.id === 'key-input'){
      saveKey();
    }
  });
}

window.onload = init;
</script>
</body>
</html>