<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Accessibile Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>

    <style>
        body { margin: 0; background: #000; color: #FFFF00; font-family: system-ui, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        /* Barra di stato ottimizzata per contrasto elevato e accessibilità */
        #status-bar { background: #FFFF00; color: #000; padding: 25px; font-weight: bold; font-size: 1.6rem; text-align: center; border-bottom: 5px solid #000; min-height: 150px; display: flex; align-items: center; justify-content: center; }
        #camera-view { flex: 1; background: #111; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; background: #000; }
        button { padding: 25px 5px; font-size: 1.1rem; font-weight: bold; text-transform: uppercase; border: 5px solid #FFFF00; background: #000; color: #FFFF00; border-radius: 20px; cursor: pointer; }
        button:active { background: #FFFF00; color: #000; }
        #btn-open-link { display: none; background: #0044cc; color: white; border-color: white; grid-column: span 2; }
        .full-width { grid-column: span 2; }
        .active-mode { background: #FFFF00 !important; color: #000 !important; }
        .btn-mute { background: #550000; color: white; border-color: white; }
    </style>
</head>
<body>

    <div id="status-bar" role="status" aria-live="assertive" aria-atomic="true">
        Inizializzazione sistema...
    </div>

    <main id="camera-view">
        <video id="webcam" autoplay playsinline muted aria-hidden="true"></video>
    </main>

    <nav id="controls">
        <button id="btn-open-link">Apri Link Trovato</button>
        <button id="btn-auto" class="active-mode">Auto-Scan: ON</button>
        <button id="btn-mute">Pausa Voce</button>
        <button id="btn-switch" class="full-width">Cambia Camera</button>
        <button id="btn-light">Info Luce</button>
        <button id="btn-color">Colore</button>
        <button id="btn-money">Banconota</button>
        <button id="btn-ocr">Leggi Testo</button>
        <button id="btn-torch">Luce Flash</button>
        <button id="btn-zoom">Zoom</button>
        <button id="btn-copy">Copia</button>
        <button id="btn-history">Cronologia</button>
    </nav>

    <script>
        const video = document.getElementById('webcam');
        const statusDisplay = document.getElementById('status-bar');
        const btnAuto = document.getElementById('btn-auto');
        const btnMute = document.getElementById('btn-mute');
        const btnOpenLink = document.getElementById('btn-open-link');
        
        let track = null, ocrWorker = null, net = null;
        let lastResult = "", isProcessing = false;
        let autoMode = true, voiceMuted = false, lastAnnounced = "";
        let currentUrl = "", torchActive = false, currentFacingMode = "environment";
        let inactivityTimer = 0, lastObject = "";

        // Funzione centrale per la comunicazione vocale e testuale
        function comunica(messaggio, dato = "", tipo = "testo") {
            statusDisplay.textContent = messaggio;
            if (voiceMuted) return;
            
            // Evita di ripetere lo stesso dato ossessivamente, ma comunica cambi di stato
            if (dato && dato === lastAnnounced && tipo !== "colore" && tipo !== "luce") return;
            
            if (dato) {
                lastResult = dato;
                lastAnnounced = dato;
                localStorage.setItem('lastScan', dato);
                inactivityTimer = 0;
                if (tipo === "link") {
                    currentUrl = dato.startsWith('www') ? 'https://' + dato : dato;
                    btnOpenLink.style.display = "block";
                } else {
                    btnOpenLink.style.display = "none";
                }
            }

            // Sintesi vocale dell'app per supporto diretto
            const utterance = new SpeechSynthesisUtterance(messaggio);
            utterance.lang = 'it-IT';
            window.speechSynthesis.speak(utterance);
        }

        async function toggleTorch(forceState = null) {
            if (!track || currentFacingMode === "user") return;
            try {
                const capabilities = track.getCapabilities();
                if (!capabilities.torch) return;
                const newState = (forceState !== null) ? forceState : !torchActive;
                await track.applyConstraints({ advanced: [{ torch: newState }] });
                torchActive = newState;
                comunica(newState ? "Luce accesa." : "Luce spenta.");
            } catch (e) { console.error("Torcia non disponibile"); }
        }

        async function analizza(isManual = false) {
            // Impedisce sovrapposizioni e attende il caricamento dei modelli
            if (isProcessing || !net) return;
            isProcessing = true;

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Controllo luce automatico per migliorare la visibilità dell'IA
            const pLuce = ctx.getImageData(canvas.width/2, canvas.height/2, 1, 1).data;
            const lum = (pLuce[0] + pLuce[1] + pLuce[2]) / 3 / 2.55;
            if (lum < 20 && currentFacingMode === "environment" && !torchActive) {
                await toggleTorch(true);
            }

            try {
                // Riconoscimento oggetti (Veloce)
                const predictions = await net.classify(canvas);
                if (predictions.length > 0 && predictions[0].probability > 0.5) {
                    const ogg = predictions[0].className.split(',')[0];
                    if (ogg !== lastObject) { 
                        comunica("Vedo: " + ogg, ogg, "oggetto"); 
                        lastObject = ogg; 
                    }
                }

                // OCR (Lento) - Eseguito ogni 10 cicli in automatico o su richiesta
                if (isManual || (autoMode && inactivityTimer % 10 === 0)) {
                    if (ocrWorker) {
                        const { data: { text, confidence } } = await ocrWorker.recognize(canvas);
                        const filteredText = text.trim();
                        if (filteredText.length > 3 && confidence > 50) {
                            const money = filteredText.match(/\b(5|10|20|50|100|200)\b/);
                            if (money) comunica("Banconota da " + money[0] + " Euro");
                            else comunica("Testo: " + filteredText.substring(0, 70));
                        } else if (isManual) {
                            comunica("Nessun testo rilevato.");
                        }
                    }
                }
            } catch (e) { console.error("Errore durante l'analisi"); }
            isProcessing = false;
        }

        // Sensore inclinazione: avvisa solo se il telefono è quasi orizzontale
        window.addEventListener('deviceorientation', (e) => {
            if (Math.abs(e.beta) > 85 && inactivityTimer % 50 === 0) {
                comunica("Telefono troppo piatto. Sollevalo per inquadrare.");
            }
        });

        // Loop di scansione automatica
        setInterval(() => {
            if (autoMode && !isProcessing && net) {
                inactivityTimer++;
                // Pausa automatica dopo un lungo periodo di inattività
                if (inactivityTimer > 250) {
                    autoMode = false;
                    btnAuto.classList.remove('active-mode');
                    comunica("Scanner in pausa per risparmio batteria.");
                } else { 
                    analizza(false); 
                }
            }
        }, 2500);

        async function avviaCamera(mode) {
            if (track) track.stop();
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: mode, width: { ideal: 1280 }, height: { ideal: 720 } } 
                });
                video.srcObject = stream;
                track = stream.getVideoTracks()[0];
                currentFacingMode = mode;
                comunica("Fotocamera pronta.");
            } catch (err) { comunica("Errore: Impossibile accedere alla fotocamera."); }
        }

        // Gestione eventi pulsanti
        btnAuto.onclick = () => { 
            autoMode = !autoMode; 
            btnAuto.classList.toggle('active-mode'); 
            comunica(autoMode ? "Scansione automatica attivata." : "Scansione automatica disattivata."); 
        };
        
        btnMute.onclick = () => { 
            voiceMuted = !voiceMuted; 
            btnMute.classList.toggle('btn-mute'); 
            btnMute.textContent = voiceMuted ? "Voce: OFF" : "Pausa Voce"; 
        };

        document.getElementById('btn-torch').onclick = () => toggleTorch();
        document.getElementById('btn-switch').onclick = () => avviaCamera(currentFacingMode === "environment" ? "user" : "environment");
        document.getElementById('btn-ocr').onclick = () => analizza(true);
        document.getElementById('btn-money').onclick = () => analizza(true);
        
        document.getElementById('btn-light').onclick = () => {
            const canvas = document.createElement('canvas'); canvas.width = 10; canvas.height = 10;
            const ctx = canvas.getContext('2d'); ctx.drawImage(video, 0, 0, 10, 10);
            const d = ctx.getImageData(5, 5, 1, 1).data;
            const l = (d[0] + d[1] + d[2]) / 3 / 2.55;
            comunica("Luce ambientale: " + (l < 20 ? "Buio" : l < 50 ? "Luce scarsa" : "Luce buona"));
        };

        document.getElementById('btn-copy').onclick = async () => { 
            if (lastResult) { 
                await navigator.clipboard.writeText(lastResult); 
                comunica("Copiato negli appunti."); 
            } 
        };

        document.getElementById('btn-history').onclick = () => {
            const last = localStorage.getItem('lastScan');
            comunica(last ? "Ultimo rilevamento: " + last : "Cronologia vuota.");
        };

        btnOpenLink.onclick = () => { if (currentUrl) window.open(currentUrl, '_blank'); };

        // Caricamento iniziale dei sistemi
        window.onload = async () => { 
            await avviaCamera("environment"); 
            comunica("Caricamento intelligenza artificiale...");
            try {
                // Inizializzazione corretta Tesseract v5
                ocrWorker = await Tesseract.createWorker('ita');
                // Caricamento MobileNet per gli oggetti
                net = await mobilenet.load();
                comunica("Sistema pronto. Sto scansionando l'ambiente.");
            } catch (e) {
                comunica("Errore nel caricamento dei motori di visione.");
                console.error(e);
            }
        };
    </script>
</body>
</html>